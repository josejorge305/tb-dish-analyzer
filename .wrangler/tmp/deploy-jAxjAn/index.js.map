{
  "version": 3,
  "sources": ["../../../index.js"],
  "sourceRoot": "/Users/josefigueroa/Desktop/tb-dish-analyzer/.wrangler/tmp/deploy-jAxjAn",
  "sourcesContent": ["\n/* eslint-disable no-undef, no-unused-vars, no-empty, no-useless-escape */\n\n// tb-dish-processor \u2014 Cloudflare Worker (Modules) \u2014 Uber Eats + Lexicon + Queue + Debug\n// Clean build: exact vendor body for /api/job, US bias + filter, proper Modules export.\n\n// ========== Version helper ==========\nfunction getVersion(env) {\n  const now = new Date().toLocaleString(\"en-US\", {\n    timeZone: \"America/New_York\"\n  });\n  const localDate = new Date(now).toISOString().slice(0, 10);\n  return env.RELEASE || env.VERSION || `prod-${localDate}`;\n}\nfunction tbWhoamiHeaders(env) {\n  return {\n    \"x-tb-worker\": env.WORKER_NAME || \"tb-dish-processor-production\",\n    \"x-tb-env\": env.ENV || \"production\",\n    \"x-tb-git\": env.GIT_SHA || \"n/a\",\n    \"x-tb-built\": env.BUILT_AT || \"n/a\"\n  };\n}\nfunction tbWhoami(env) {\n  const body = JSON.stringify(\n    {\n      worker: env.WORKER_NAME || \"tb-dish-processor-production\",\n      env: env.ENV || \"production\",\n      git_sha: env.GIT_SHA || \"n/a\",\n      built_at: env.BUILT_AT || \"n/a\"\n    },\n    null,\n    2\n  );\n  return new Response(body, {\n    headers: { \"content-type\": \"application/json\", ...tbWhoamiHeaders(env) }\n  });\n}\nfunction cid(h) {\n  return h.get(\"x-correlation-id\") || crypto.randomUUID();\n}\nconst _cid = (h) => h.get(\"x-correlation-id\") || crypto.randomUUID();\nfunction isBinaryContentType(contentType = \"\") {\n  if (!contentType) return false;\n  const ct = contentType.toLowerCase();\n  return (\n    ct.includes(\"application/octet-stream\") ||\n    ct.includes(\"application/pdf\") ||\n    ct.includes(\"application/zip\") ||\n    ct.startsWith(\"image/\") ||\n    ct.startsWith(\"audio/\") ||\n    ct.startsWith(\"video/\") ||\n    ct.startsWith(\"font/\")\n  );\n}\nfunction withTbWhoamiHeaders(response, env) {\n  if (!(response instanceof Response)) return response;\n  const ct =\n    (response.headers && response.headers.get\n      ? response.headers.get(\"content-type\")\n      : \"\") || \"\";\n  if (isBinaryContentType(ct)) return response;\n  const headers = new Headers(response.headers || undefined);\n  const baseHeaders = tbWhoamiHeaders(env);\n  for (const [key, value] of Object.entries(baseHeaders)) {\n    if (value == null) continue;\n    headers.set(key, value);\n  }\n  return new Response(response.body, {\n    status: response.status,\n    statusText: response.statusText,\n    headers\n  });\n}\n// Provider order: control fallback (e.g., \"edamam,spoonacular,openai\")\nfunction providerOrder(env) {\n  const raw =\n    env && env.PROVIDERS ? String(env.PROVIDERS) : \"edamam,spoonacular,openai\";\n  return raw\n    .toLowerCase()\n    .split(\",\")\n    .map((s) => s.trim())\n    .filter(Boolean);\n}\n\n// --- Simple Premium Gate (KV-backed) ---\n// Usage: add ?user_id=alice  AND set KV key: tier/user:alice -> \"premium\"\n// Dev override: ?dev=1 bypasses the check for quick testing.\nasync function requirePremium(env, url) {\n  // Dev bypass for quick testing\n  if (url.searchParams.get(\"dev\") === \"1\") {\n    return { ok: true, user: \"dev-bypass\" };\n  }\n\n  const userId = (url.searchParams.get(\"user_id\") || \"\").trim();\n  if (!userId) {\n    return {\n      ok: false,\n      status: 403,\n      body: {\n        ok: false,\n        error: \"premium_required\",\n        hint: \"Add ?user_id=YOUR_ID (and make it premium in KV) or use ?dev=1 during development.\"\n      }\n    };\n  }\n\n  const kvKey = `tier/user:${userId}`;\n  const tier = await (env.LEXICON_CACHE ? env.LEXICON_CACHE.get(kvKey) : null);\n  if (String(tier || \"\").toLowerCase() === \"premium\") {\n    return { ok: true, user: userId, tier: \"premium\" };\n  }\n  return {\n    ok: false,\n    status: 402,\n    body: {\n      ok: false,\n      error: \"upgrade_required\",\n      user_id: userId,\n      hint: \"This feature needs Premium. In dev, set KV key tier/user:YOUR_ID -> premium.\"\n    }\n  };\n}\n\n// ==== Step 41 Helpers: ctx + trace =========================================\n// Lightweight per-request context (for consistent analytics headers)\nfunction makeCtx(env) {\n  return {\n    served_at: new Date().toISOString(),\n    version: getVersion(env)\n  };\n}\n\n// === PATCH A: params + JSON helpers (safe commas, no trailing spread) ===\nfunction asURL(u) {\n  return u instanceof URL ? u : new URL(u, \"https://dummy.local\");\n}\nfunction pick(query, name, def) {\n  const v = query.get(name);\n  return v == null || v === \"\" ? def : v;\n}\nfunction pickInt(query, name, def) {\n  const v = query.get(name);\n  if (v == null || v === \"\") return def;\n  const n = Number(v);\n  return Number.isFinite(n) ? Math.trunc(n) : def;\n}\nfunction pickFloat(query, name, def) {\n  const v = query.get(name);\n  if (v == null || v === \"\") return def;\n  const n = Number(v);\n  return Number.isFinite(n) ? n : def;\n}\nasync function readJson(req) {\n  // --- enqueue minimal meal log (safe debug) ---\n  try {\n    return await req.json();\n  } catch {\n    return null;\n  }\n}\nasync function readJsonSafe(request) {\n  try {\n    return await request.json();\n  } catch {\n    return null;\n  }\n}\nasync function parseResSafe(res) {\n  const ct =\n    (res.headers && res.headers.get && res.headers.get(\"content-type\")) || \"\";\n  try {\n    if (ct.includes(\"application/json\")) return await res.json();\n    const txt = await res.text();\n    try {\n      return JSON.parse(txt);\n    } catch {\n      return { __nonjson__: txt };\n    }\n  } catch (e) {\n    try {\n      const txt = await res.text();\n      return {\n        __nonjson__: txt,\n        __parse_error__: String(e?.message || e)\n      };\n    } catch (e2) {\n      return {\n        __parse_error__: String(e?.message || e),\n        __read_error__: String(e2?.message || e2)\n      };\n    }\n  }\n}\nasync function callJson(url, opts = {}) {\n  const fetcher = opts.fetcher || fetch;\n  const resp = await fetcher(url, {\n    method: opts.method || \"GET\",\n    headers: {\n      \"content-type\": \"application/json\",\n      ...(opts.headers || {})\n    },\n    body: opts.body ? JSON.stringify(opts.body) : undefined\n  }).catch((err) => {\n    return { _fetchError: err?.message || String(err) };\n  });\n\n  if (!resp || resp._fetchError) {\n    return {\n      ok: false,\n      error: \"fetch_failed\",\n      detail: resp && resp._fetchError\n    };\n  }\n\n  const text = await resp.text().catch(() => \"\");\n  let json;\n  try {\n    json = JSON.parse(text);\n  } catch {\n    json = { raw: text };\n  }\n\n  return {\n    ok: resp.ok,\n    status: resp.status,\n    data: json\n  };\n}\nfunction okJson(obj, status = 200) {\n  return new Response(JSON.stringify(obj), {\n    status,\n    headers: { \"content-type\": \"application/json; charset=utf-8\" }\n  });\n}\nfunction badJson(obj, status = 400) {\n  const payload =\n    obj && typeof obj === \"object\" && obj.ok !== undefined\n      ? obj\n      : { ok: false, ...obj };\n  return okJson(payload, status);\n}\n\n/**\n * Build a normalized params object for handlers that accept both query/body.\n * Avoids parser errors VS Code was flagging and centralizes validation.\n */\nfunction buildCommonParams(url, body = {}, extras = {}) {\n  const q = url.searchParams;\n  return {\n    user_id: pick(q, \"user_id\", body?.user_id ?? undefined),\n    dish: pick(q, \"dish\", body?.dish ?? undefined),\n    method: pick(q, \"method\", body?.method ?? undefined),\n    weight_kg: pickFloat(q, \"weight_kg\", body?.weight_kg ?? undefined),\n    maxRows: pickInt(\n      q,\n      \"maxRows\",\n      pickInt(q, \"top\", body?.maxRows ?? undefined)\n    ),\n    lat: pickFloat(q, \"lat\", body?.lat ?? undefined),\n    lng: pickFloat(q, \"lng\", body?.lng ?? undefined),\n    radius: pickInt(q, \"radius\", body?.radius ?? undefined),\n    dev: pick(q, \"dev\", body?.dev ?? undefined) === \"1\" || body?.dev === 1,\n    used_path: undefined,\n    ...extras\n  };\n}\n\n// Standardized trace payload for analytics/debug mirrors\n// - endpoint: string (e.g. \"uber-test\" or \"menu-search\")\n// - searchParams: URLSearchParams from the current request URL\n// - env: worker env (optional, used only for host hint)\n// - extras: object to merge in later (e.g. { used_path, source, cache })\nfunction makeTrace(endpoint, searchParams, env, extras = {}) {\n  const host =\n    (env &&\n      (env.UBER_RAPID_HOST ||\n        env.RAPIDAPI_HOST ||\n        env.CF_PAGES_URL ||\n        env.HOSTNAME)) ||\n    undefined;\n\n  return {\n    endpoint,\n    query: pick(searchParams, \"query\", undefined),\n    address: pick(searchParams, \"address\", undefined),\n    locale: pick(searchParams, \"locale\", undefined),\n    page: pickInt(searchParams, \"page\", undefined),\n    maxRows: pickInt(\n      searchParams,\n      \"maxRows\",\n      pickInt(searchParams, \"top\", undefined)\n    ),\n    lat: pickFloat(searchParams, \"lat\", undefined),\n    lng: pickFloat(searchParams, \"lng\", undefined),\n    radius: pickInt(searchParams, \"radius\", undefined),\n    host,\n    used_path: undefined,\n    ...extras\n  };\n}\n\n// === PATCH B: stricter /user/prefs with schema ===\nfunction validatePrefs(payload) {\n  // Minimal, future-proof: pills (allergen/FODMAP keys) + diet_tags\n  const errors = [];\n  if (!payload || typeof payload !== \"object\") {\n    errors.push(\"payload must be a JSON object\");\n    return { ok: false, errors };\n  }\n  const out = {\n    user_id:\n      typeof payload.user_id === \"string\" && payload.user_id.trim()\n        ? payload.user_id.trim()\n        : null,\n    pills: Array.isArray(payload.pills)\n      ? payload.pills.filter((x) => typeof x === \"string\" && x.trim())\n      : [],\n    diet_tags: Array.isArray(payload.diet_tags)\n      ? payload.diet_tags.filter((x) => typeof x === \"string\" && x.trim())\n      : []\n  };\n  if (!out.user_id) errors.push(\"user_id is required\");\n  if (errors.length) return { ok: false, errors };\n  return { ok: true, value: out };\n}\n\nasync function handleGetUserPrefs(url, env) {\n  const q = url.searchParams;\n  const user_id = q.get(\"user_id\");\n  if (!user_id) return badJson({ error: \"user_id is required\" }, 400);\n  if (!env.USER_PREFS_KV)\n    return badJson({ error: \"USER_PREFS_KV binding missing\" }, 500);\n\n  const key = `user_prefs:${user_id}`;\n  const raw = await env.USER_PREFS_KV.get(key, \"json\");\n  return okJson({\n    ok: true,\n    user_id,\n    prefs: raw ?? { pills: [], diet_tags: [] }\n  });\n}\n\nasync function handlePostUserPrefs(request, env) {\n  if (!env.USER_PREFS_KV)\n    return badJson({ error: \"USER_PREFS_KV binding missing\" }, 500);\n  const body = await readJson(request);\n  const v = validatePrefs(body);\n  if (!v.ok)\n    return badJson({ error: \"invalid user prefs\", details: v.errors }, 400);\n\n  const key = `user_prefs:${v.value.user_id}`;\n  await env.USER_PREFS_KV.put(\n    key,\n    JSON.stringify({\n      pills: v.value.pills,\n      diet_tags: v.value.diet_tags\n    }),\n    { expirationTtl: 60 * 60 * 24 * 365 }\n  );\n  return okJson({\n    ok: true,\n    saved: {\n      user_id: v.value.user_id,\n      pills: v.value.pills,\n      diet_tags: v.value.diet_tags\n    }\n  });\n}\n\n// === PATCH C: clearer /organs/from-dish empty-card behavior ===\nasync function handleOrgansFromDish(url, env, request) {\n  try {\n    console.log(\n      JSON.stringify({\n        at: \"organs:enter\",\n        method: request.method,\n        q_dish: url.searchParams.get(\"dish\") || null\n      })\n    );\n  } catch {}\n\n  const dishQ = (url.searchParams.get(\"dish\") || \"\").trim();\n  const body = await readJsonSafe(request);\n  const dishB =\n    body && typeof body === \"object\" && typeof body.dish === \"string\"\n      ? body.dish.trim()\n      : \"\";\n\n  const finalDish = dishQ || dishB;\n  if (!finalDish) {\n    try {\n      console.log(\n        JSON.stringify({\n          at: \"organs:missing-dish\",\n          dishQ: dishQ || null,\n          dishB: dishB || null\n        })\n      );\n    } catch {}\n    const resp = new Response(\n      JSON.stringify({\n        ok: false,\n        error: \"dish is required (use ?dish= or JSON {dish})\",\n        debug: { query_dish: dishQ || null, body_dish: dishB || null }\n      }),\n      {\n        status: 400,\n        headers: { \"content-type\": \"application/json; charset=utf-8\" }\n      }\n    );\n    resp.headers.set(\"X-TB-Route\", \"/organs/from-dish\");\n    resp.headers.set(\"X-TB-Note\", \"missing-dish\");\n    return resp;\n  }\n\n  const params =\n    typeof buildCommonParams === \"function\"\n      ? buildCommonParams(url, body || {}, { dish: finalDish })\n      : { dish: finalDish };\n  params.used_path = \"/organs/from-dish\";\n\n  const userId =\n    url.searchParams.get(\"user_id\") || (body && body.user_id) || null;\n  const prefsKey = `prefs:user:${userId || \"anon\"}`;\n  const user_prefs =\n    (env.USER_PREFS_KV &&\n      (await env.USER_PREFS_KV.get(prefsKey, \"json\")).catch?.(() => null)) ||\n    (env.USER_PREFS_KV\n      ? await env.USER_PREFS_KV.get(prefsKey, \"json\")\n      : null) ||\n    {};\n  const ORGANS = await getOrgans(env);\n  const method =\n    (url.searchParams.get(\"method\") || (body && body.method) || \"saute\")\n      .toLowerCase()\n      .trim() || \"saute\";\n  const wq = url.searchParams.get(\"weight_kg\") || (body && body.weight_kg);\n  const weightNum = Number(wq);\n  const weight_kg =\n    Number.isFinite(weightNum) && weightNum > 0 ? weightNum : 70;\n\n  const card = await fetchRecipeCardWithFallback(finalDish, env, {\n    user_id: userId\n  });\n  const rawIngredients = Array.isArray(card?.ingredients)\n    ? card.ingredients\n    : [];\n  const recipe_debug = {\n    provider: card?.provider ?? null,\n    reason: card?.reason ?? null,\n    card_ingredients: rawIngredients.length,\n    providers_order: providerOrder(env),\n    attempts: card?.attempts ?? [],\n    user_prefs_present: !!user_prefs && !!Object.keys(user_prefs).length,\n    user_prefs_keys: Object.keys(user_prefs || {}),\n    assess_prefs_passed: !!user_prefs\n  };\n\n  if (!rawIngredients.length) {\n    const resp = new Response(\n      JSON.stringify({\n        ok: true,\n        dish: finalDish,\n        note: \"no ingredients found \u2014 recipe card empty and inference didn\u2019t yield ingredients\",\n        guidance:\n          \"Try a more specific dish name (e.g., 'Chicken Alfredo (Olive Garden)') or adjust PROVIDERS.\",\n        recipe_debug,\n        ingredients: [],\n        organ_levels: {},\n        organ_top_drivers: {}\n      }),\n      { headers: { \"content-type\": \"application/json; charset=utf-8\" } }\n    );\n    resp.headers.set(\"X-TB-Route\", \"/organs/from-dish\");\n    resp.headers.set(\"X-TB-Note\", \"empty-ingredients\");\n    return resp;\n  }\n\n  const ingredientsRaw = Array.isArray(card?.ingredients)\n    ? card.ingredients\n    : [];\n  const originalLines = ingredientsRaw.map((item) =>\n    typeof item === \"string\"\n      ? item\n      : item?.original || item?.name || item?.text || \"\"\n  );\n  let ingredients = normalizeIngredientsArray(ingredientsRaw).map((entry) => ({\n    name: canonicalizeIngredientName(entry.name),\n    grams: entry.grams\n  }));\n  const normalizedIngredients = ingredients.slice();\n\n  function snapToKnownIngredient(name) {\n    const s = name.toLowerCase();\n    if (s.includes(\"olive oil\")) return \"olive oil\";\n    if (s.includes(\"butter\")) return \"butter\";\n    if (s.includes(\"cream\")) return \"cream\";\n    if (s.includes(\"parmesan\") || s.includes(\"parm\")) return \"parmesan cheese\";\n    if (s.includes(\"chicken thigh\")) return \"chicken thigh\";\n    if (s.includes(\"chicken\")) return \"chicken thighs\";\n    if (s.includes(\"fettuccine\")) return \"fettuccine\";\n    if (s.includes(\"tagliatelle\")) return \"tagliatelle\";\n    return name;\n  }\n\n  // --- organ assessment (inline) ---\n  let organLevels = {};\n  let organDrivers = {};\n  try {\n    if (typeof assessOrgansFromIngredients === \"function\") {\n      console.log(\n        \"[ORGANS] assessing\",\n        normalizedIngredients.length,\n        \"ingredients\"\n      );\n      const assessRes = await assessOrgansFromIngredients(\n        normalizedIngredients,\n        { weightKg: weight_kg }\n      );\n      organLevels = assessRes?.levels || {};\n      organDrivers = assessRes?.top_drivers || {};\n    } else {\n      organLevels = {};\n      organDrivers = {};\n    }\n  } catch {\n    organLevels = {};\n    organDrivers = {};\n  }\n\n  let calories_kcal = null;\n  if (\n    (env.EDAMAM_NUTRITION_APP_ID || env.EDAMAM_APP_ID) &&\n    (env.EDAMAM_NUTRITION_APP_KEY || env.EDAMAM_APP_KEY) &&\n    originalLines.length\n  ) {\n    try {\n      const nut = await callEdamamNutritionAnalyze(\n        { title: finalDish, ingr: originalLines },\n        env\n      );\n      console.log(\"[NUTRITION] keys\", Object.keys(nut || {}));\n      console.log(\n        \"[NUTRITION] ingredients_n\",\n        Array.isArray(nut?.ingredients) ? nut.ingredients.length : null\n      );\n      console.log(\"[NUTRITION] totalWeight\", nut?.totalWeight);\n      console.log(\"[NUTRITION] lines_sent\", originalLines);\n      console.log(\n        \"[NUTRITION] reason:\",\n        nut?.reason,\n        \"calA:\",\n        nut?.calories,\n        \"calB:\",\n        nut?.nutrition?.calories\n      );\n      calories_kcal =\n        typeof nut?.calories === \"number\"\n          ? Math.round(nut.calories)\n          : typeof nut?.nutrition?.calories === \"number\"\n            ? Math.round(nut.nutrition.calories)\n            : calories_kcal;\n      if (Array.isArray(nut?.ingredients) && nut.ingredients.length) {\n        const byName = new Map(\n          nut.ingredients\n            .filter((i) => i?.name)\n            .map((i) => [canonicalizeIngredientName(i.name), i.grams])\n        );\n        ingredients = ingredients.map((item) => {\n          const grams = byName.has(item.name)\n            ? byName.get(item.name)\n            : item.grams;\n          return { name: item.name, grams };\n        });\n      }\n    } catch {\n      // non-fatal enrichment failure\n    }\n  }\n  console.log(\"[CALORIES] kcal\", calories_kcal);\n\n  ingredients = ingredients.map((it) => ({\n    ...it,\n    name: snapToKnownIngredient(it.name)\n  }));\n\n  let organ = null;\n  const origin = url.origin;\n  let assessResp = null;\n  const payload = JSON.stringify({\n    ingredients,\n    user_id: userId,\n    method,\n    weight_kg,\n    user_prefs\n  });\n\n  try {\n    if (env.SELF && typeof env.SELF.fetch === \"function\") {\n      console.log(\"[ASSESS] internal SELF.fetch /organs/assess\");\n      assessResp = await env.SELF.fetch(\n        new Request(\"https://internal/organs/assess?user_id=\" + userId, {\n          method: \"POST\",\n          headers: { \"content-type\": \"application/json\" },\n          body: payload\n        })\n      );\n    } else {\n      const assessUrl = url.origin.replace(/\\/$/, \"\") + \"/organs/assess\";\n      console.log(\"[ASSESS] external fetch\", assessUrl);\n      assessResp = await fetch(assessUrl, {\n        method: \"POST\",\n        headers: { \"content-type\": \"application/json\" },\n        body: payload\n      });\n    }\n  } catch (err) {\n    return okJson({\n      ok: true,\n      dish: finalDish,\n      note: \"assess_call_failed\",\n      detail: String(err?.message || err),\n      recipe_debug,\n      ingredients\n    });\n  }\n\n  const data = await parseResSafe(assessResp);\n  console.log(\"[ASSESS] status\", assessResp.status);\n  if (!assessResp.ok || !data || typeof data !== \"object\") {\n    return okJson({\n      ok: true,\n      dish: finalDish,\n      note: \"assess_upstream_error\",\n      status: assessResp.status,\n      detail: data?.__nonjson__ || data,\n      recipe_debug,\n      ingredients\n    });\n  }\n  organ = data;\n\n  if (!organLevels || !Object.keys(organLevels).length) {\n    organLevels = organ?.levels ?? organ?.organ_levels ?? {};\n  }\n  if (!organDrivers || !Object.keys(organDrivers).length) {\n    organDrivers = organ?.top ?? organ?.organ_top_drivers ?? organDrivers ?? {};\n  }\n  console.log(\"[ORGANS] filled\", {\n    levels_keys: Object.keys(organLevels || {}).length,\n    top_keys: Object.keys(organDrivers || {}).length\n  });\n  const driversSlim = slimTopDrivers(organDrivers || {});\n  const driversText = topDriversText(driversSlim);\n\n  const organ_summaries = organ?.summaries ?? {};\n  const organ_top_drivers = { ...(organDrivers || {}) };\n  const scoring = organ?.scoring || {};\n  const filled = { organ_levels: organLevels || {} };\n  const levels =\n    (typeof organ_levels !== \"undefined\" && organ_levels) ||\n    filled?.organ_levels ||\n    scoring?.organ_levels ||\n    scoring?.levels ||\n    {};\n  for (const organName of ORGANS) {\n    if (!(organName in levels)) levels[organName] = \"Neutral\";\n    if (!Array.isArray(organ_top_drivers[organName]))\n      organ_top_drivers[organName] = [];\n  }\n  const levelToBar = (s) =>\n    ({\n      \"High Benefit\": 80,\n      Benefit: 40,\n      Neutral: 0,\n      Caution: -40,\n      \"High Caution\": -80\n    })[s] ?? 0;\n  const levelToColor = (s) =>\n    ({\n      \"High Benefit\": \"#16a34a\",\n      Benefit: \"#22c55e\",\n      Neutral: \"#a1a1aa\",\n      Caution: \"#f59e0b\",\n      \"High Caution\": \"#dc2626\"\n    })[s] ?? \"#a1a1aa\";\n  const barometerToColor = (n) =>\n    n >= 40\n      ? \"#16a34a\"\n      : n > 0\n        ? \"#22c55e\"\n        : n === 0\n          ? \"#a1a1aa\"\n          : n <= -40\n            ? \"#dc2626\"\n            : \"#f59e0b\";\n  const buildInsights = ({ top, prefs, organs = [] }) => {\n    const lines = [];\n    for (const organKey of organs) {\n      const arr = Array.isArray(top?.[organKey]) ? top[organKey] : [];\n      if (arr.length) {\n        const title =\n          organKey.charAt(0).toUpperCase() +\n          organKey.slice(1).replace(/_/g, \" \");\n        lines.push(`${title}: ${arr.join(\", \")}`);\n        if (lines.length >= 3) break;\n      }\n    }\n    if (prefs?.allergens?.dairy === false) {\n      lines.push(\"Preference: dairy-sensitive applied\");\n    }\n    if (\n      prefs?.allergens?.garlic_onion === true ||\n      prefs?.fodmap?.strict === true\n    ) {\n      lines.push(\"Preference: FODMAP applied\");\n    }\n    return lines.slice(0, 3);\n  };\n  const organ_bars = ORGANS.reduce((acc, organKey) => {\n    acc[organKey] = levelToBar(levels[organKey]);\n    return acc;\n  }, {});\n  const organ_colors = ORGANS.reduce((acc, organKey) => {\n    acc[organKey] = levelToColor(levels[organKey]);\n    return acc;\n  }, {});\n  const tummy_barometer = computeBarometerFromLevelsAll(ORGANS, levels);\n  const barometer_color = barometerToColor(tummy_barometer);\n  const insight_lines = buildInsights({\n    organs: ORGANS,\n    top: organ_top_drivers,\n    prefs: user_prefs\n  });\n  const result = {\n    ok: true,\n    dish: finalDish,\n    ingredients,\n    organ_summaries,\n    organ_levels: levels,\n    organ_top_drivers,\n    drivers_slim: driversSlim,\n    calories_kcal,\n    tummy_barometer,\n    barometer_color,\n    organ_bars,\n    organ_colors,\n    insight_lines,\n    recipe_debug\n  };\n\n  try {\n    const names = ingredients.map((i) => i.name).filter(Boolean);\n\n    console.log(\"[ENQUEUE] meal_log preview:\", {\n      levels_keys: Object.keys(organLevels || {}).length,\n      top_keys: Object.keys(organDrivers || {}).length\n    });\n\n    if (env.ANALYSIS_QUEUE && names.length) {\n      await env.ANALYSIS_QUEUE.send({\n        kind: \"meal_log\",\n        dish: finalDish,\n        user_id: userId,\n        ingredients: names,\n        organs_summary: { levels: organLevels, top_drivers: organDrivers },\n        organ_levels: organLevels,\n        organ_top_drivers: organDrivers,\n        calories_kcal: result.calories_kcal ?? null,\n        created_at: new Date().toISOString()\n      });\n      recipe_debug.enqueue = { ok: true };\n    } else {\n      recipe_debug.enqueue = {\n        ok: false,\n        reason: \"no_queue_or_no_ingredients\"\n      };\n    }\n  } catch (e) {\n    recipe_debug.enqueue = { ok: false, reason: String(e?.message || e) };\n  }\n\n  try {\n    console.log(JSON.stringify({ at: \"organs:return\", dish: finalDish }));\n  } catch {}\n  return okJson(result);\n}\n\nasync function handleDebugEcho(url, request) {\n  const body = await readJson(request);\n  const query = {};\n  for (const [k, v] of url.searchParams.entries()) query[k] = v;\n  return okJson({\n    ok: true,\n    method: request.method,\n    query,\n    body: body ?? null\n  });\n}\n\n// [38.10] \u2014 shared CORS headers  (HOISTED so it's available everywhere)\nconst CORS_ALL = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\"\n};\n\n// Build a safe preview object for debug=1 (no CORS needed)\nfunction buildDebugPreview(raw, env, rowsUS = null, titles = null) {\n  const usedHost =\n    env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n  const sample =\n    (Array.isArray(raw?.results) && raw.results[0]) ||\n    (Array.isArray(raw?.data?.results) && raw.data.results[0]) ||\n    (Array.isArray(raw?.data?.data?.results) && raw.data.data.results[0]) ||\n    (Array.isArray(raw?.payload?.results) && raw.payload.results[0]) ||\n    (Array.isArray(raw?.job?.results) && raw.job.results[0]) ||\n    (rowsUS && Array.isArray(rowsUS) && rowsUS[0]) ||\n    raw;\n\n  return {\n    ok: true,\n    source: \"debug-preview\",\n    host: usedHost,\n    topLevelKeys: raw && typeof raw === \"object\" ? Object.keys(raw) : [],\n    has_results: Array.isArray(raw?.results),\n    has_data_results: Array.isArray(raw?.data?.results),\n    has_data_data_results: Array.isArray(raw?.data?.data?.results),\n    has_payload_results: Array.isArray(raw?.payload?.results),\n    has_job_results: Array.isArray(raw?.job?.results),\n    has_returnvalue_data: Array.isArray(raw?.returnvalue?.data),\n    ...(Array.isArray(titles)\n      ? { count: titles.length, titles: titles.slice(0, 25) }\n      : {}),\n    sample\n  };\n}\n\n// Safe helper: always returns an object (never throws if 'trace' is missing)\nfunction safeTrace(t) {\n  return t && typeof t === \"object\" ? t : {};\n}\n// ==========================================================================\n\n// Simple sleep\nconst sleep = (ms) => new Promise((r) => setTimeout(r, ms));\n\n// ===== LLM SAFE GLOBAL HELPERS (always defined) =====\n(function ensureLLMHelpers() {\n  function _isValidUrl(u) {\n    try {\n      new URL(String(u || \"\").trim());\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  if (typeof globalThis.normalizeLLMItems !== \"function\") {\n    globalThis.normalizeLLMItems = function normalizeLLMItems(\n      rawItems = [],\n      tag = \"llm\"\n    ) {\n      return (Array.isArray(rawItems) ? rawItems : [])\n        .map((it) => ({\n          title: String(it.title || it.name || \"\").trim() || null,\n          description: String(it.description || it.desc || \"\").trim() || null,\n          section: String(it.section || it.category || \"\").trim() || null,\n          price_cents: Number.isFinite(Number(it.price_cents))\n            ? Number(it.price_cents)\n            : null,\n          price_text: it.price_text\n            ? String(it.price_text)\n            : Number.isFinite(it.price_cents)\n              ? `$${(Number(it.price_cents) / 100).toFixed(2)}`\n              : null,\n          calories_text: it.calories_text ? String(it.calories_text) : null,\n          source: tag,\n          confidence: typeof it.confidence === \"number\" ? it.confidence : 0.7\n        }))\n        .filter((r) => r.title);\n    };\n  }\n\n  if (typeof globalThis.dedupeItemsByTitleSection !== \"function\") {\n    globalThis.dedupeItemsByTitleSection = function dedupeItemsByTitleSection(\n      items = []\n    ) {\n      const seen = new Map(),\n        keep = [];\n      for (const it of items) {\n        const k = `${(it.section || \"\").toLowerCase()}|${(it.title || \"\").toLowerCase()}`;\n        if (!seen.has(k)) {\n          seen.set(k, keep.length);\n          keep.push(it);\n        } else {\n          const i = seen.get(k),\n            cur = keep[i];\n          const curScore =\n            (cur.price_cents ? 1 : 0) +\n            (cur.price_text ? 1 : 0) +\n            (cur.description ? cur.description.length / 100 : 0);\n          const nxtScore =\n            (it.price_cents ? 1 : 0) +\n            (it.price_text ? 1 : 0) +\n            (it.description ? it.description.length / 100 : 0);\n          if (nxtScore > curScore) keep[i] = it;\n        }\n      }\n      return keep;\n    };\n  }\n\n  if (typeof globalThis.callGrokExtract !== \"function\") {\n    globalThis.callGrokExtract = async function callGrokExtract(\n      env,\n      query,\n      address\n    ) {\n      const url = (env.GROK_API_URL || \"\").trim();\n      const key = (env.GROK_API_KEY || env.Tummy_Buddy_Grok || \"\").trim();\n      if (!url) return { ok: true, items: [], note: \"grok_missing_url\" };\n      if (!_isValidUrl(url))\n        return { ok: true, items: [], note: \"grok_invalid_url\" };\n      if (!key) return { ok: true, items: [], note: \"grok_missing_key\" };\n      try {\n        const res = await fetch(url, {\n          method: \"POST\",\n          headers: {\n            \"content-type\": \"application/json\",\n            authorization: `Bearer ${key}`\n          },\n          body: JSON.stringify({\n            task: \"menu_extract\",\n            query,\n            address,\n            schema: \"menu_items_v1\"\n          })\n        });\n        if (!res.ok)\n          return { ok: false, items: [], error: `grok HTTP ${res.status}` };\n        const js = await res.json().catch(() => ({}));\n        const items = Array.isArray(js.items) ? js.items : [];\n        return { ok: true, items };\n      } catch (e) {\n        return {\n          ok: false,\n          items: [],\n          error: `grok fetch error: ${String(e?.message || e)}`\n        };\n      }\n    };\n  }\n\n  if (typeof globalThis.callOpenAIExtract !== \"function\") {\n    globalThis.callOpenAIExtract = async function callOpenAIExtract(\n      env,\n      query,\n      address\n    ) {\n      const key = (env.OPENAI_API_KEY || \"\").trim();\n      const base = (\n        (env.OPENAI_API_BASE || \"https://api.openai.com\") + \"\"\n      ).replace(/\\/+$/, \"\");\n      if (!key) return { ok: true, items: [], note: \"openai_missing_key\" };\n      try {\n        new URL(base);\n      } catch {\n        return { ok: true, items: [], note: \"openai_invalid_base\" };\n      }\n\n      const prompt = `You are extracting a restaurant's MENU ITEMS.\nRestaurant: ${query}\nLocation: ${address}\nReturn JSON with an \"items\" array. Each item: {title, description, section, price_text?, calories_text?}.`;\n\n      try {\n        const res = await fetch(`${base}/v1/chat/completions`, {\n          method: \"POST\",\n          headers: {\n            \"content-type\": \"application/json\",\n            authorization: `Bearer ${key}`\n          },\n          body: JSON.stringify({\n            model: env.OPENAI_MODEL || \"gpt-4o-mini\",\n            messages: [{ role: \"user\", content: prompt }],\n            temperature: 0.2,\n            response_format: { type: \"json_object\" }\n          })\n        });\n        if (!res.ok)\n          return { ok: false, items: [], error: `openai HTTP ${res.status}` };\n        const js = await res.json().catch(() => ({}));\n        let payload = {};\n        try {\n          payload = JSON.parse(js?.choices?.[0]?.message?.content || \"{}\");\n        } catch {}\n        const items = Array.isArray(payload.items) ? payload.items : [];\n        return { ok: true, items };\n      } catch (e) {\n        return {\n          ok: false,\n          items: [],\n          error: `openai fetch error: ${String(e?.message || e)}`\n        };\n      }\n    };\n  }\n})();\n\nconst normalizeLLMItems = globalThis.normalizeLLMItems;\nconst dedupeItemsByTitleSection = globalThis.dedupeItemsByTitleSection;\nconst callGrokExtract = globalThis.callGrokExtract;\nconst callOpenAIExtract = globalThis.callOpenAIExtract;\n\n// [37B] \u2500\u2500 Tiny validators + friendly 400 helper\nconst isNonEmptyString = (v) => typeof v === \"string\" && v.trim().length > 0;\n\n// Accepts: \"City, ST\" or \"City, ST 12345\"  (e.g., \"Miami, FL\" / \"Miami, FL 33131\")\nconst looksLikeCityState = (s) => {\n  if (typeof s !== \"string\") return false;\n  return /^[A-Za-z .'-]+,\\s*[A-Z]{2}(\\s*\\d{5})?$/.test(s.trim());\n};\n\n// Address helpers used by /menu/search\nfunction hasLowercaseState(address) {\n  // Detect \", fl\" or \", ny\" etc.\n  const m = String(address || \"\").match(/,\\s*([A-Za-z]{2})(\\b|[^A-Za-z]|$)/);\n  if (!m) return false;\n  const st = m[1];\n  return st !== st.toUpperCase();\n}\nfunction normalizeCityStateAddress(address) {\n  // Convert \", fl\" -> \", FL\" (keep the rest intact)\n  return String(address || \"\").replace(\n    /,\\s*([A-Za-z]{2})(\\b|[^A-Za-z]|$)/,\n    (_, st, tail) => `, ${st.toUpperCase()}${tail || \"\"}`\n  );\n}\n\nfunction badRequest(\n  message,\n  hint,\n  envOrCtx,\n  request_id = null,\n  examples = null\n) {\n  const body = { ok: false, error: message, hint };\n  if (Array.isArray(examples) && examples.length) body.examples = examples;\n  return errorResponseWith(body, 400, envOrCtx, {}, request_id);\n}\n\nfunction json(data, init = {}) {\n  return new Response(JSON.stringify(data), {\n    headers: { \"content-type\": \"application/json; charset=utf-8\" },\n    ...init\n  });\n}\n\n// === New helpers (ported from newer index) ================================\nfunction slimTopDrivers(drivers) {\n  // Input shape (V6): { OrganName: [\"+ Compound A\", \"- Compound B\"], ... }\n  // Output: compact array of up to 8 entries [{ organ, label }]\n  const out = [];\n  if (!drivers || typeof drivers !== \"object\") return out;\n  for (const [organ, arr] of Object.entries(drivers)) {\n    if (!Array.isArray(arr)) continue;\n    for (const label of arr) {\n      out.push({ organ, label: String(label) });\n    }\n  }\n  return out.slice(0, 8);\n}\n\nfunction topDriversText(slim) {\n  // Turn first two items into a short natural label: \"Compound A; Compound B\"\n  if (!Array.isArray(slim) || slim.length === 0) return \"\";\n  const names = slim.map((x) => {\n    // strip \"+ \" / \"- \" prefix for readability\n    const t = String(x?.label || \"\");\n    return t.replace(/^([+\\-]\\s*)/, \"\");\n  });\n  const firstTwo = names.slice(0, 2).filter(Boolean);\n  return firstTwo.join(\"; \");\n}\n// ========================================================================\n\n// [37B] \u2500\u2500 Flag/number validators\nconst is01 = (v) => v === \"0\" || v === \"1\";\nconst isPositiveInt = (s) => /^\\d+$/.test(String(s));\n\n// Simple request-id helper (used by /meta, /debug/status, etc.)\nfunction newRequestId() {\n  if (typeof crypto?.randomUUID === \"function\") return crypto.randomUUID();\n  return `${Date.now()}-${Math.random().toString(36).slice(2)}`;\n}\n\nfunction isOcrEnabled(env) {\n  return String(env.OCR_TIER_ENABLED || \"\").trim() === \"1\";\n}\n\n// Friendly upstream error explainer (maps vendor HTTP to user-facing text)\nfunction friendlyUpstreamMessage(status) {\n  switch (Number(status)) {\n    case 429:\n      return \"Our menu provider is rate-limiting right now.\";\n    case 502:\n    case 503:\n    case 504:\n      return \"Our menu provider is temporarily unavailable.\";\n    default:\n      return \"Upstream error.\";\n  }\n}\n\n// Flatten Uber Eats to simple items (normalized + deduped)\nfunction extractMenuItemsFromUber(raw, queryText = \"\") {\n  const q = (queryText || \"\").toLowerCase().trim();\n\n  const results =\n    (raw?.data?.results &&\n      Array.isArray(raw.data.results) &&\n      raw.data.results) ||\n    (Array.isArray(raw?.results) && raw.results) ||\n    (Array.isArray(raw?.data?.data?.results) && raw.data.data.results) ||\n    [];\n\n  // Choose best-matching restaurant(s) if query given\n  let chosen = results;\n  if (q && results.length) {\n    const scored = results.map((r) => {\n      const title = (r.title || r.sanitizedTitle || r.name || \"\").toLowerCase();\n      let score = 0;\n      if (title === q) score = 3;\n      else if (title.startsWith(q)) score = 2;\n      else if (title.includes(q)) score = 1;\n      return { r, score, title };\n    });\n    scored.sort((a, b) => b.score - a.score);\n    const bestScore = scored[0]?.score || 0;\n    chosen =\n      bestScore > 0\n        ? scored.filter((s) => s.score === bestScore).map((s) => s.r)\n        : [scored[0].r];\n  }\n\n  // --- normalization helpers ---\n  function normalizePriceFields(mi) {\n    // vendor sometimes gives cents as number; sometimes only a display string\n    const asNum = typeof mi.price === \"number\" ? mi.price : undefined;\n    const price = Number.isFinite(asNum) ? asNum : undefined;\n    const price_display =\n      mi.priceTagline ||\n      (Number.isFinite(price)\n        ? `$${(price / 100).toFixed(2)}`\n        : mi.price_display || \"\") ||\n      \"\";\n    return { price, price_display };\n  }\n\n  function deriveCaloriesDisplay(mi, price_display) {\n    // Prefer explicit numeric calories if vendor exposes them\n    // (some shapes may have mi.nutrition?.calories or mi.calories)\n    const calNum =\n      (mi?.nutrition &&\n        Number.isFinite(mi.nutrition.calories) &&\n        mi.nutrition.calories) ||\n      (Number.isFinite(mi?.calories) && mi.calories) ||\n      null;\n\n    if (Number.isFinite(calNum)) return `${Math.round(calNum)} Cal`;\n\n    // Fallback: parse from price_display (e.g., \"$4.79 \u2022 320 Cal.\")\n    const t = String(\n      price_display || mi?.itemDescription || mi?.description || \"\"\n    );\n    const m = t.match(/\\b(\\d{2,4})\\s*Cal\\.?\\b/i);\n    return m ? `${m[1]} Cal` : null;\n  }\n\n  function normalizeItemFields(it) {\n    const clean = (s) =>\n      String(s ?? \"\")\n        .normalize(\"NFKC\")\n        .replace(/\\s+/g, \" \")\n        .trim();\n    const out = { ...it };\n    out.name = clean(it.name);\n    out.section = clean(it.section);\n    out.description = clean(it.description);\n    out.price_display = clean(it.price_display);\n    if (out.calories_display != null)\n      out.calories_display = clean(out.calories_display);\n    out.restaurant_name = clean(it.restaurant_name);\n\n    // keep price only if it\u2019s a non-negative finite number\n    if (!(Number.isFinite(out.price) && out.price >= 0)) delete out.price;\n\n    // enforce source field\n    out.source = \"uber_eats\";\n    return out;\n  }\n\n  function makeItem(mi, sectionName, restaurantName) {\n    const { price, price_display } = normalizePriceFields(mi);\n    const calories_display = deriveCaloriesDisplay(mi, price_display);\n    return {\n      name: mi.title || mi.name || \"\",\n      description: mi.itemDescription || mi.description || \"\",\n      price,\n      price_display,\n      section: sectionName || \"\",\n      calories_display,\n      restaurant_name: restaurantName || \"\",\n      source: \"uber_eats\"\n    };\n  }\n\n  // prefer items that have price/calories/longer description when de-duping\n  function better(a, b) {\n    const ap = hasPrice(a) ? 1 : 0;\n    const bp = hasPrice(b) ? 1 : 0;\n    if (ap !== bp) return ap > bp;\n    const ac = hasCalories(a) ? 1 : 0;\n    const bc = hasCalories(b) ? 1 : 0;\n    if (ac !== bc) return ac > bc;\n    const ad = (a.description || \"\").length;\n    const bd = (b.description || \"\").length;\n    if (ad !== bd) return ad > bd;\n    // keep earlier (stable) otherwise\n    return false;\n  }\n\n  const items = [];\n  const seen = new Map(); // key = `${section}|${name}` lowercased\n\n  function addItem(it) {\n    const item = normalizeItemFields(it);\n    const key = `${(item.section || \"\").toLowerCase()}|${(item.name || \"\").toLowerCase()}`;\n    const prevIdx = seen.get(key);\n    if (prevIdx == null) {\n      seen.set(key, items.length);\n      items.push(item);\n    } else {\n      const prev = items[prevIdx];\n      if (better(item, prev)) items[prevIdx] = item;\n    }\n  }\n\n  // --- collect items from all vendor shapes, then dedupe via addItem() ---\n  for (const r of chosen) {\n    const restaurantName = r.title || r.sanitizedTitle || r.name || \"\";\n\n    // catalogs / menu sections\n    let sections = [];\n    if (Array.isArray(r.menu)) sections = r.menu;\n    else if (Array.isArray(r.catalogs)) sections = r.catalogs;\n\n    for (const section of sections) {\n      const sectionName = section.catalogName || section.name || \"\";\n      const catalogItems =\n        (Array.isArray(section.catalogItems) && section.catalogItems) ||\n        (Array.isArray(section.items) && section.items) ||\n        [];\n      for (const mi of catalogItems)\n        addItem(makeItem(mi, sectionName, restaurantName));\n    }\n\n    // featured\n    if (Array.isArray(r.featuredItems)) {\n      for (const mi of r.featuredItems)\n        addItem(makeItem(mi, \"Featured\", restaurantName));\n    }\n  }\n\n  return items;\n}\n\nconst SECTION_PRIORITY = [\n  \"most popular\",\n  \"popular items\",\n  \"featured\",\n  \"bestsellers\",\n  \"recommended\"\n];\n\nfunction sectionScore(section = \"\") {\n  const s = section.toLowerCase();\n  for (let i = 0; i < SECTION_PRIORITY.length; i++) {\n    if (s.includes(SECTION_PRIORITY[i])) return 100 - i * 2; // 100,98,96...\n  }\n  return 0;\n}\n\nfunction hasCalories(item) {\n  // Many Uber items expose \"Cal.\" inside price_display, e.g. \"$4.79 \u2022 320 Cal.\"\n  const t = `${item.price_display || item.description || \"\"}`.toLowerCase();\n  return /\\bcal\\b|\\bcal\\.\\b/.test(t);\n}\n\nfunction hasPrice(item) {\n  return (\n    typeof item.price === \"number\" || /\\$\\d/.test(item.price_display || \"\")\n  );\n}\n\nfunction baseNameScore(name = \"\") {\n  // Prefer clearer names over generic\u2014simple heuristic\n  const n = name.toLowerCase();\n  let sc = 0;\n  if (/\\bcombo\\b|\\bmeal\\b/.test(n)) sc += 2; // combos often user-intent\n  if (/\\bfamily\\b|\\bparty\\b/.test(n)) sc -= 2; // de-prioritize huge packs\n  if (/\\bside\\b/.test(n)) sc -= 1;\n  return sc;\n}\n\nfunction scoreItem(item) {\n  let score = 0;\n  score += sectionScore(item.section);\n  if (hasCalories(item)) score += 4;\n  if (hasPrice(item)) score += 3;\n  score += baseNameScore(item.name || item.title || \"\");\n  return score;\n}\n\nfunction rankTop(items, n) {\n  return (\n    [...items]\n      .map((it, idx) => ({ it, idx, score: scoreItem(it) }))\n      // stable: by score desc, then original index asc\n      .sort((a, b) => b.score - a.score || a.idx - b.idx)\n      .slice(0, Math.max(0, n))\n      .map((x) => x.it)\n  );\n}\n\n// ---- Step 41.7: normalize filters + ranking for analyze ----\nfunction filterAndRankItems(items, searchParams, env) {\n  let candidates = Array.isArray(items) ? items : [];\n\n  const skipDrinks = searchParams.get(\"skip_drinks\") === \"1\";\n  const skipParty = searchParams.get(\"skip_party\") === \"1\";\n\n  if (skipDrinks) {\n    candidates = candidates.filter(\n      (it) => !isDrink(it.name || it.title || \"\", it.section)\n    );\n  }\n  if (skipParty) {\n    candidates = candidates.filter(\n      (it) => !isPartyPack(it.name || it.title || \"\")\n    );\n  }\n\n  const HITS_LIMIT = Number(searchParams.get(\"top\") || env.HITS_LIMIT || \"25\");\n  return rankTop(candidates, HITS_LIMIT);\n}\n\nfunction isDrink(name = \"\", section = \"\") {\n  const n = name.toLowerCase();\n  const s = (section || \"\").toLowerCase();\n  return (\n    /\\b(drink|beverage|soda|coke|sprite|fanta|tea|coffee|juice|shake|mcflurry|water)\\b/.test(\n      n\n    ) || /\\b(drinks|beverages)\\b/.test(s)\n  );\n}\n\nfunction isPartyPack(name = \"\") {\n  const n = name.toLowerCase();\n  // Look for big counts or party/family cues\n  return (\n    /\\b(20|30|40|50)\\s*(pc|piece|pieces)\\b/.test(n) ||\n    /\\b(family|party|bundle|pack)\\b/.test(n)\n  );\n}\n\n// Turns Uber items into our simple, clean shape\nfunction normalizeUberItems(rawItems = []) {\n  return rawItems.map((it) => ({\n    title: it.name || \"\",\n    description: it.description || \"\",\n    section: it.section || \"\",\n    price_cents: typeof it.price === \"number\" ? it.price : null,\n    price_text: it.price_display || null,\n    calories_text: it.calories_display || null,\n    source: \"uber\",\n    confidence: 1.0\n  }));\n}\n\n// Canonical item shape for /menu/extract\n// { title, description, section, price_cents, price_text, calories_text, source, confidence }\nfunction toCanonFromUber(it) {\n  return {\n    title: it.name || \"\",\n    description: it.description || \"\",\n    section: it.section || \"\",\n    price_cents: typeof it.price === \"number\" ? it.price : null,\n    price_text: it.price_display || null,\n    calories_text: it.calories_display || null,\n    source: \"uber\",\n    confidence: 1.0\n  };\n}\nfunction toCanonFromLLM(it) {\n  return {\n    title: (it.title || it.name || \"\").trim(),\n    description: (it.description || it.desc || \"\").trim() || null,\n    section: (it.section || it.category || \"\").trim() || \"\",\n    price_cents: Number.isFinite(Number(it.price_cents))\n      ? Number(it.price_cents)\n      : null,\n    price_text: it.price_text ? String(it.price_text) : null,\n    calories_text: it.calories_text ? String(it.calories_text) : null,\n    source: it.source || \"llm\",\n    confidence: typeof it.confidence === \"number\" ? it.confidence : 0.7\n  };\n}\n\nfunction toCanonFromOCR(it) {\n  return {\n    title: (it.title || it.name || \"\").trim(),\n    description: null,\n    section: (it.section || \"\").trim(),\n    price_cents: null,\n    price_text: it.price_text ? String(it.price_text) : null,\n    calories_text: null,\n    source: \"ocr\",\n    confidence: 0.6\n  };\n}\n\nfunction parseOCRToCandidates(fullText) {\n  const text = String(fullText || \"\")\n    .replace(/\\r/g, \"\")\n    .replace(/[ \\t]+/g, \" \")\n    .trim();\n\n  const KNOWN_SECTIONS = new Set([\n    \"APPETIZERS\",\n    \"STARTERS\",\n    \"SIDES\",\n    \"SALADS\",\n    \"SOUPS\",\n    \"ENTREES\",\n    \"MAINS\",\n    \"DESSERTS\",\n    \"DRINKS\",\n    \"BEVERAGES\",\n    \"PASTA\",\n    \"PIZZA\",\n    \"SANDWICHES\",\n    \"BURGERS\",\n    \"SPECIALS\",\n    \"BREAKFAST\",\n    \"LUNCH\",\n    \"DINNER\"\n  ]);\n\n  let currentSection = null;\n  const items = [];\n  const lines = text\n    .split(/\\n+/)\n    .map((s) => s.trim())\n    .filter(Boolean);\n\n  function pushItem(title, price, section) {\n    const t = String(title || \"\")\n      .replace(/\\s+/g, \" \")\n      .trim();\n    if (!t) return;\n    let name = t;\n    const firstWord = t.split(\" \")[0];\n    if (KNOWN_SECTIONS.has(firstWord)) name = t.slice(firstWord.length).trim();\n    if (!name) return;\n    items.push({\n      title: name,\n      price_text: `$${price}`,\n      section: section || null\n    });\n  }\n\n  if (lines.length > 1) {\n    for (const line of lines) {\n      const cap = line.toUpperCase();\n      if (!/\\$/.test(line) && KNOWN_SECTIONS.has(cap)) {\n        currentSection = cap;\n        continue;\n      }\n      const m = line.match(/(.+?)\\s*\\$?\\s*([0-9]+(?:\\.[0-9]{2})?)\\b/);\n      if (m) pushItem(m[1], m[2], currentSection);\n    }\n  }\n\n  if (items.length === 0) {\n    const re = /([A-Z0-9][A-Z0-9 &'\u2019\\-]+?)\\s*\\$?\\s*([0-9]+(?:\\.[0-9]{2})?)\\b/g;\n    let m;\n    while ((m = re.exec(text))) pushItem(m[1], m[2], currentSection);\n  }\n\n  const seen = new Set();\n  const out = [];\n  for (const it of items) {\n    const k = `${(it.section || \"\").toLowerCase()}|${it.title.toLowerCase()}|${it.price_text}`;\n    if (seen.has(k)) continue;\n    seen.add(k);\n    out.push(it);\n  }\n  return out;\n}\n\n// Tiny bridge: image URL -> Vision full text -> parsed OCR menu items\nasync function fetchOCRCandidates(env, imageUrl) {\n  const { fullText } = await callVisionForText(env, imageUrl);\n  const parsed = parseOCRToCandidates(fullText);\n  return Array.isArray(parsed) ? parsed : [];\n}\n\n// ---- WEB SCRAPER TINY HELPERS (HTML -> best menu image URL) ----\n\n// Download an HTML page as text (best-effort)\nasync function fetchHtml(env, pageUrl) {\n  const res = await fetch(pageUrl, {\n    headers: {\n      \"User-Agent\": \"TummyBuddyWorker/1.0 (+https://tummybuddy.app)\",\n      Accept: \"text/html,application/xhtml+xml;q=0.9,*/*;q=0.8\"\n    }\n  });\n  if (!res.ok) throw new Error(`html fetch failed: ${res.status}`);\n  return await res.text();\n}\n\n// Parse srcset and pick the largest candidate\nfunction pickLargestFromSrcset(srcset, baseUrl) {\n  try {\n    const parts = String(srcset || \"\")\n      .split(\",\")\n      .map((s) => s.trim())\n      .filter(Boolean);\n\n    let best = null;\n    for (const p of parts) {\n      // formats like: \"image.jpg 800w\" or \"image.jpg 2x\"\n      const m = p.match(/(.+?)\\s+(\\d+)(w|x)\\b/i);\n      const urlPart = m ? m[1].trim() : p;\n      const size = m ? parseInt(m[2], 10) : 0;\n      const abs = new URL(urlPart, baseUrl).toString();\n      if (!best || size > best.size) best = { url: abs, size };\n    }\n    return best ? best.url : null;\n  } catch {\n    return null;\n  }\n}\n\n// Pick the most likely menu image from <img> tags\nfunction pickMenuImageFromHtml(html, baseUrl) {\n  if (typeof html !== \"string\" || !html) return null;\n\n  // 0) Try OpenGraph first (very reliable on many sites)\n  const og =\n    /<meta\\s+(?:property|name)\\s*=\\s*[\"']og:image[\"'][^>]*?\\scontent\\s*=\\s*[\"']([^\"']+)[\"'][^>]*?>/i.exec(\n      html\n    ) ||\n    /<meta\\s+content\\s*=\\s*[\"']([^\"']+)[\"'][^>]*?(?:property|name)\\s*=\\s*[\"']og:image[\"'][^>]*?>/i.exec(\n      html\n    );\n  if (og && og[1]) {\n    try {\n      return new URL(og[1].trim(), baseUrl).toString();\n    } catch {\n      /* fall through */\n    }\n  }\n\n  // 1) Collect <img> candidates from src and (if present) srcset\n  const candidates = [];\n  const imgRe = /<img\\b([^>]+)>/gi;\n  let m;\n  while ((m = imgRe.exec(html))) {\n    const tag = m[1] || \"\";\n    const srcM = /\\bsrc\\s*=\\s*[\"']([^\"']+)[\"']/i.exec(tag);\n    const setM = /\\bsrcset\\s*=\\s*[\"']([^\"']+)[\"']/i.exec(tag);\n\n    let abs = null;\n\n    if (setM && setM[1]) {\n      const picked = pickLargestFromSrcset(setM[1], baseUrl);\n      if (picked) abs = picked;\n    }\n    if (!abs && srcM && srcM[1]) {\n      try {\n        abs = new URL(srcM[1].trim(), baseUrl).toString();\n      } catch {}\n    }\n\n    if (abs) candidates.push(abs);\n  }\n\n  if (!candidates.length) return null;\n\n  // 2) Score images by menu-like hints and deprioritize obvious non-menus\n  function score(url) {\n    const u = url.toLowerCase();\n    let s = 0;\n    if (/\\bmenu\\b/.test(u)) s += 6;\n    if (\n      /\\b(food|foods|dishes|lunch|dinner|brunch|dessert|beverage|drinks|wine|beer)\\b/.test(\n        u\n      )\n    )\n      s += 3;\n    if (/\\.(jpg|jpeg|png|webp)(\\?|$)/.test(u)) s += 2;\n\n    // down-rank sprites, logos, favicons, tiny thumbs, social, tracking\n    if (\n      /sprite|icon|logo|favicon|thumb|tracking|pixel|social|twitter|facebook|instagram/.test(\n        u\n      )\n    )\n      s -= 5;\n\n    // mild up-rank if looks like a full-size image\n    if (/(\\bfull\\b|\\blarge\\b|\\bxl\\b|@2x|@3x)/.test(u)) s += 1;\n\n    return s;\n  }\n\n  candidates.sort((a, b) => score(b) - score(a));\n  return candidates[0] || null;\n}\n\n// Turn common gallery/page URLs into a direct image URL when possible\nfunction normalizeGalleryToDirectImage(pageUrl) {\n  try {\n    const u = new URL(pageUrl);\n    const host = u.hostname.toLowerCase();\n    const parts = u.pathname.split(\"/\").filter(Boolean); // e.g., [\"gallery\",\"abc123\"] or [\"abc123\"]\n\n    // Imgur patterns:\n    // https://imgur.com/abc123       -> https://i.imgur.com/abc123.jpg\n    // https://imgur.com/gallery/abc  -> https://i.imgur.com/abc.jpg\n    if (host === \"imgur.com\" && parts.length >= 1) {\n      const id = parts[parts.length - 1];\n      if (/^[A-Za-z0-9]+$/.test(id)) {\n        return `https://i.imgur.com/${id}.jpg`;\n      }\n    }\n\n    return null;\n  } catch {\n    return null;\n  }\n}\n\n// Decide which of two items with the same (section|title) to keep\nfunction preferBetter(a, b) {\n  const score = (x) =>\n    (x.price_cents ? 3 : 0) +\n    (x.price_text ? 2 : 0) +\n    (x.calories_text ? 1 : 0) +\n    Math.min(3, (x.description || \"\").length / 60) +\n    (x.source === \"uber\" ? 1 : 0) +\n    (typeof x.confidence === \"number\" ? x.confidence : 0);\n  return score(b) > score(a) ? b : a;\n}\n\n// Merge + de-dup by (section|title), keeping the richer one\nfunction mergeCanonItems(uberItems = [], llmItems = [], ocrItems = []) {\n  const all = [];\n\n  for (const u of uberItems || []) all.push(toCanonFromUber(u));\n  for (const l of llmItems || []) all.push(toCanonFromLLM(l));\n  for (const o of ocrItems || []) all.push(toCanonFromOCR(o));\n\n  const byKey = new Map();\n  for (const it of all) {\n    const key = `${(it.section || \"\").toLowerCase()}|${(it.title || \"\").toLowerCase()}`;\n    if (!byKey.has(key)) byKey.set(key, it);\n    else byKey.set(key, preferBetter(byKey.get(key), it));\n  }\n  return Array.from(byKey.values());\n}\n\nfunction rankCanon(items = [], topN = 25) {\n  const scored = items.map((it, idx) => {\n    let score = 0;\n    const s = (it.section || \"\").toLowerCase();\n    if (\n      /\\bmost popular\\b|\\bpopular items\\b|\\bfeatured\\b|\\bbestsellers\\b|\\brecommended\\b/.test(\n        s\n      )\n    )\n      score += 100;\n    if (it.price_cents) score += 6;\n    if (it.price_text) score += 3;\n    if (it.calories_text) score += 2;\n    if ((it.description || \"\").length > 30) score += 2;\n    if (it.source === \"uber\") score += 2;\n    if (typeof it.confidence === \"number\") score += Math.min(4, it.confidence);\n    return { it, idx, score };\n  });\n  return scored\n    .sort((a, b) => b.score - a.score || a.idx - b.idx)\n    .slice(0, Math.max(0, topN))\n    .map((x) => x.it);\n}\n\n// ---- Recipe cache helpers (KV) ----\nfunction recipeCacheKey(dish, lang = \"en\") {\n  const base = String(dish || \"\")\n    .toLowerCase()\n    .trim()\n    .replace(/[^a-z0-9]+/g, \"-\")\n    .replace(/^-+|-+$/g, \"\");\n  return `recipe/${lang}/${base || \"unknown\"}.json`;\n}\n\nasync function recipeCacheRead(env, key) {\n  const kv = env.MENUS_CACHE || env.LEXICON_CACHE;\n  if (!kv) return null;\n  try {\n    const raw = await kv.get(key);\n    return raw ? JSON.parse(raw) : null;\n  } catch {\n    return null;\n  }\n}\n\nasync function recipeCacheWrite(env, key, payload) {\n  const kv = env.MENUS_CACHE || env.LEXICON_CACHE;\n  if (!kv) return false;\n  try {\n    await kv.put(\n      key,\n      JSON.stringify({ savedAt: new Date().toISOString(), ...payload }),\n      {\n        expirationTtl: 365 * 24 * 3600\n      }\n    );\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nfunction defaultPrefs() {\n  return { allergens: [], fodmap: {}, units: \"us\" };\n}\n\nfunction normalizePrefs(input) {\n  const out = defaultPrefs();\n  const src = input?.prefs ? input.prefs : input || {};\n  if (Array.isArray(src.allergens)) out.allergens = src.allergens.map(String);\n  if (src.fodmap && typeof src.fodmap === \"object\")\n    out.fodmap = { ...src.fodmap };\n  if (Array.isArray(src.pills)) {\n    const al = new Set(out.allergens);\n    const fm = { ...(out.fodmap || {}) };\n    for (const p of src.pills) {\n      const s = String(p);\n      if (s.startsWith(\"allergen:\")) al.add(s.slice(9));\n      if (s.startsWith(\"fodmap:\")) fm[s.slice(7)] = true;\n    }\n    out.allergens = Array.from(al);\n    out.fodmap = fm;\n  }\n  if (typeof src.units === \"string\") out.units = src.units;\n  return out;\n}\n\nasync function loadUserPrefs(env, user_id) {\n  const id = (user_id || \"\").trim();\n  if (!id || !env?.USER_PREFS_KV) return defaultPrefs();\n  try {\n    const raw = await env.USER_PREFS_KV.get(`user_prefs:${id}`, \"json\");\n    return normalizePrefs(raw || {});\n  } catch {\n    return defaultPrefs();\n  }\n}\n\nfunction derivePillsForUser(hits = [], prefs = { allergens: [], fodmap: {} }) {\n  const safeHits = Array.isArray(hits) ? hits : [];\n  const safePrefs =\n    prefs && typeof prefs === \"object\" ? prefs : { allergens: [], fodmap: {} };\n\n  const baseAllergens = new Set();\n  const baseClasses = new Set();\n\n  for (const hit of safeHits) {\n    if (Array.isArray(hit?.allergens)) {\n      for (const allergen of hit.allergens) {\n        if (allergen != null && allergen !== \"\")\n          baseAllergens.add(String(allergen));\n      }\n    }\n    if (Array.isArray(hit?.classes)) {\n      for (const cls of hit.classes) {\n        if (cls != null && cls !== \"\")\n          baseClasses.add(String(cls).toLowerCase());\n      }\n    }\n  }\n\n  const pills = [];\n  const allergenPrefs = new Set(\n    Array.isArray(safePrefs.allergens)\n      ? safePrefs.allergens.map((a) => String(a))\n      : []\n  );\n\n  for (const allergen of baseAllergens) {\n    pills.push({\n      key: `allergen:${allergen}`,\n      label: allergen,\n      active: allergenPrefs.has(allergen)\n    });\n  }\n\n  const fodmapPrefs =\n    safePrefs.fodmap && typeof safePrefs.fodmap === \"object\"\n      ? safePrefs.fodmap\n      : {};\n  if (baseClasses.has(\"onion\"))\n    pills.push({\n      key: \"fodmap:onion\",\n      label: \"Onion\",\n      active: !!fodmapPrefs.onion\n    });\n  if (baseClasses.has(\"garlic\"))\n    pills.push({\n      key: \"fodmap:garlic\",\n      label: \"Garlic\",\n      active: !!fodmapPrefs.garlic\n    });\n\n  return pills;\n}\n\nfunction inferHitsFromRecipeCard(card = {}) {\n  const text = JSON.stringify(card).toLowerCase();\n  const hits = [];\n\n  const push = (o) =>\n    hits.push({\n      allergens: o.allergens || [],\n      classes: o.classes || [],\n      source: \"infer\"\n    });\n\n  if (/\\bgarlic\\b/.test(text)) push({ classes: [\"garlic\"] });\n  if (/\\bonion\\b|shallot|scallion/.test(text)) push({ classes: [\"onion\"] });\n\n  if (\n    /(milk|cream|butter|cheese|parmesan|mozzarella|yogurt|whey|casein)\\b/.test(\n      text\n    )\n  )\n    push({ allergens: [\"dairy\"] });\n\n  if (/\\bshrimp|prawn|lobster|crab|shellfish\\b/.test(text))\n    push({ allergens: [\"shellfish\"] });\n\n  return hits;\n}\n\nfunction inferHitsFromText(title = \"\", desc = \"\") {\n  const text = `${title} ${desc}`.toLowerCase();\n  const hits = [];\n  const push = (o) =>\n    hits.push({\n      allergens: o.allergens || [],\n      classes: o.classes || [],\n      source: \"infer:title\"\n    });\n\n  if (/\\bgarlic\\b/.test(text)) push({ classes: [\"garlic\"] });\n  if (/\\bonion\\b|shallot|scallion/.test(text)) push({ classes: [\"onion\"] });\n  if (\n    /(milk|cream|butter|cheese|parmesan|mozzarella|yogurt|whey|casein)\\b/.test(\n      text\n    )\n  )\n    push({ allergens: [\"dairy\"] });\n  if (/\\bshrimp|prawn|lobster|crab|shellfish\\b/.test(text))\n    push({ allergens: [\"shellfish\"] });\n\n  return hits;\n}\n\nfunction inferHitsFromIngredients(ingredients = []) {\n  const hits = [];\n  const push = (o) =>\n    hits.push({\n      allergens: o.allergens || [],\n      classes: o.classes || [],\n      source: \"infer:ingredients\"\n    });\n\n  for (const ing of ingredients) {\n    const name = String(ing?.name || \"\").toLowerCase();\n\n    if (\n      /(milk|cream|butter|cheese|parmesan|mozzarella|yogurt|whey|casein)\\b/.test(\n        name\n      )\n    )\n      push({ allergens: [\"dairy\"] });\n    if (/\\bgarlic\\b/.test(name)) push({ classes: [\"garlic\"] });\n    if (/\\bonion\\b|shallot|scallion/.test(name)) push({ classes: [\"onion\"] });\n    if (/\\bshrimp|prawn|lobster|crab|shellfish\\b/.test(name))\n      push({ allergens: [\"shellfish\"] });\n    if (/\\bflour|wheat\\b/.test(name)) push({ allergens: [\"gluten\"] });\n  }\n  return hits;\n}\n\nasync function fetchRecipeCard(env, dishTitle, urlOrigin) {\n  try {\n    const base = (\n      urlOrigin || \"https://tb-dish-processor.tummybuddy.workers.dev\"\n    ).replace(/\\/$/, \"\");\n    const u = new URL(\"/recipe/resolve\", base);\n    u.searchParams.set(\"dish\", dishTitle);\n    u.searchParams.set(\"shape\", \"recipe_card\");\n    u.searchParams.set(\"force_reanalyze\", \"1\");\n    const r = await fetch(u, { headers: { accept: \"application/json\" } });\n    if (!r.ok) return null;\n    const j = await r.json();\n    return j && typeof j === \"object\" ? j : null;\n  } catch {\n    return null;\n  }\n}\n\n// ============== EDAMAM: RECIPE SEARCH V2 + NUTRITION ANALYSIS ==============\nasync function callEdamamRecipe(dish, env, opts = {}) {\n  const id = env.EDAMAM_APP_ID;\n  const key = env.EDAMAM_APP_KEY;\n  if (!id || !key)\n    return { ingredients: [], reason: \"EDAMAM_APP_ID/KEY missing\" };\n\n  const url = new URL(\"https://api.edamam.com/api/recipes/v2\");\n  url.searchParams.set(\"type\", \"public\");\n  url.searchParams.set(\"q\", dish);\n  url.searchParams.set(\"app_id\", id);\n  url.searchParams.set(\"app_key\", key);\n\n  let data;\n  const accountUser =\n    typeof opts?.user_id === \"string\" && opts.user_id.trim()\n      ? opts.user_id.trim()\n      : \"anon\";\n\n  try {\n    const res = await fetch(url.toString(), {\n      method: \"GET\",\n      headers: {\n        accept: \"application/json\",\n        \"Edamam-Account-User\": accountUser\n      }\n    });\n    data = await parseResSafe(res);\n    if (res.status === 401) {\n      return {\n        ingredients: [],\n        reason: \"edamam 401 unauthorized - check Recipe v2 app_id/app_key\",\n        debug: data\n      };\n    }\n    if (!res.ok) {\n      return {\n        ingredients: [],\n        reason: `edamam http ${res.status}`,\n        debug: data\n      };\n    }\n  } catch (e) {\n    return {\n      ingredients: [],\n      reason: `edamam fetch err ${String(e?.message || e)}`\n    };\n  }\n\n  const hit = data?.hits?.[0]?.recipe;\n  const lines = Array.isArray(hit?.ingredientLines) ? hit.ingredientLines : [];\n  const ingredients = lines.map((s) => String(s).trim()).filter(Boolean);\n\n  return {\n    ingredients,\n    reason: ingredients.length ? \"ok\" : \"no ingredients\",\n    raw: { label: hit?.label || null }\n  };\n}\n\nasync function callEdamamNutritionAnalyze(payload, env) {\n  const nid = env.EDAMAM_NUTRITION_APP_ID || env.EDAMAM_APP_ID;\n  const nkey = env.EDAMAM_NUTRITION_APP_KEY || env.EDAMAM_APP_KEY;\n  if (!nid || !nkey)\n    return { ingredients: [], reason: \"nutrition keys missing\" };\n\n  const body = {\n    title: payload?.title || \"Recipe\",\n    ingr: Array.isArray(payload?.ingr) ? payload.ingr : []\n  };\n\n  const url = `https://api.edamam.com/api/nutrition-details?app_id=${encodeURIComponent(\n    nid\n  )}&app_key=${encodeURIComponent(nkey)}`;\n\n  let data = null;\n  let status = 0;\n\n  try {\n    const res = await fetch(url, {\n      method: \"POST\",\n      headers: { \"content-type\": \"application/json\" },\n      body: JSON.stringify(body)\n    });\n    status = res.status;\n    data = await parseResSafe(res);\n  } catch (e) {\n    data = { error: String(e?.message || e) };\n  }\n\n  const norm = [];\n  const src = Array.isArray(data?.ingredients) ? data.ingredients : [];\n  for (const ing of src) {\n    const name = String(ing?.parsed?.[0]?.food || ing?.text || \"\").trim();\n    const grams = Number(ing?.parsed?.[0]?.weight || ing?.weight || 0);\n    if (!name) continue;\n    norm.push({\n      name: name.toLowerCase(),\n      grams: grams > 0 ? grams : undefined\n    });\n  }\n\n  let calories =\n    typeof data?.calories === \"number\" ? Math.round(data.calories) : null;\n\n  const needFallback =\n    calories === null ||\n    !Array.isArray(body.ingr) ||\n    body.ingr.length === 0 ||\n    !Array.isArray(data?.ingredients) ||\n    data.ingredients.length === 0 ||\n    (status && status !== 200);\n\n  if (needFallback && Array.isArray(body.ingr) && body.ingr.length) {\n    let sum = 0;\n    for (const line of body.ingr) {\n      try {\n        const u = `https://api.edamam.com/api/nutrition-data?app_id=${encodeURIComponent(\n          nid\n        )}&app_key=${encodeURIComponent(nkey)}&ingr=${encodeURIComponent(line)}`;\n        const r = await fetch(u);\n        const d = await r.json();\n        if (typeof d?.calories === \"number\") sum += d.calories;\n      } catch {}\n    }\n    if (sum > 0) {\n      calories = Math.round(sum);\n    }\n  }\n\n  return {\n    ingredients: norm,\n    nutrition: {\n      calories,\n      totalNutrients: data?.totalNutrients ?? null,\n      totalWeight: data?.totalWeight ?? null\n    },\n    calories,\n    reason:\n      calories !== null ? \"ok\" : `no calories (status ${status || \"n/a\"})`,\n    debug: calories === null ? data : undefined\n  };\n}\n\nfunction normalizeIngredientLine(s) {\n  let x = String(s || \"\")\n    .toLowerCase()\n    .trim();\n  x = x.replace(/^[\u2022\\-\\\u2013\\\u2014\\*]+\\s*/g, \"\");\n  x = x.replace(/\\([^)]*\\)/g, \" \");\n  x = x.replace(\n    /\\b(\\d+[\\/\\.\\-]?\\d*)\\s*(cups?|tbsp|tsp|tablespoons?|teaspoons?|oz|ounce?s?|lb|pounds?|g|grams?|kg|ml|l|liters?)\\b/gi,\n    \" \"\n  );\n  x = x.replace(\n    /\\b(to taste|optional|finely|roughly|minced|chopped|fresh|juice of|zest of|divided)\\b/gi,\n    \" \"\n  );\n  x = x\n    .replace(/\\s*,\\s*/g, \" \")\n    .replace(/\\s+/g, \" \")\n    .trim();\n  x = x\n    .replace(/\\bparm(e|a)san\\b/g, \"parmesan\")\n    .replace(/\\bboneless\\b/g, \"\")\n    .replace(/\\bskinless\\b/g, \"\");\n  x = x\n    .replace(/\\b(cloves?|bunch|bunches|handful|pinch|pinches)\\b/g, \"\")\n    .trim();\n  return x;\n}\nfunction guessGrams(name) {\n  const n = String(name || \"\").toLowerCase();\n  if (/(chicken|beef|pork|salmon|tuna|shrimp)\\b/.test(n)) return 120;\n  if (/(pasta|fettuccine|spaghetti|noodle|rice)\\b/.test(n)) return 180;\n  if (/(heavy cream|cream|milk)\\b/.test(n)) return 60;\n  if (/(parmesan|cheese)\\b/.test(n)) return 28;\n  if (/\\bbutter\\b/.test(n)) return 14;\n  if (/(olive oil|oil)\\b/.test(n)) return 10;\n  if (/\\bgarlic\\b/.test(n)) return 6;\n  if (/(onion|shallot)\\b/.test(n)) return 50;\n  if (\n    /(salt|black pepper|pepper|paprika|cumin|oregano|parsley|basil|chili)\\b/.test(\n      n\n    )\n  )\n    return 2;\n  if (/(tomato|mushroom|spinach|broccoli|bell pepper)\\b/.test(n)) return 60;\n  return 12;\n}\nfunction normalizeIngredientsArray(raw) {\n  const out = [];\n  const seen = new Set();\n  for (const it of raw || []) {\n    const text =\n      typeof it === \"string\" ? it : it?.original || it?.name || it?.text || \"\";\n    const name = normalizeIngredientLine(text);\n    if (!name || seen.has(name)) continue;\n    seen.add(name);\n    out.push({ name, grams: guessGrams(name) });\n  }\n  return out;\n}\n\nfunction titleizeIngredient(text) {\n  return text\n    .split(/\\s+/)\n    .filter(Boolean)\n    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))\n    .join(\" \");\n}\n\nfunction sanitizeIngredientForCookbook(raw) {\n  const base =\n    typeof raw === \"string\"\n      ? raw\n      : raw?.name || raw?.original || raw?.text || \"\";\n  const lower = String(base || \"\").toLowerCase();\n  const optional =\n    /\\boptional\\b/.test(lower) ||\n    /\\bfor (serving|garnish)\\b/.test(lower) ||\n    /\\bto taste\\b/.test(lower);\n\n  const cleaned = normalizeIngredientLine(base)\n    .replace(/\\b(optional|undefined|to taste)\\b/gi, \"\")\n    .replace(/\\s+/g, \" \")\n    .trim();\n  if (!cleaned) return null;\n\n  const withoutPrefix = cleaned.replace(\n    /^\\s*[\\d\\/\\.\\-\u00BC\u00BD\u00BE\u2153\u2154\u215B\u215C\u215D\u215E]+\\s*(cups?|cup|tbsp|tablespoons?|tsp|teaspoons?|ounces?|oz|grams?|g|kg|pounds?|lb|ml|l|liters?)?\\s+/i,\n    \"\"\n  );\n  const name = titleizeIngredient(\n    withoutPrefix\n      .replace(/^[\\d\\s\\.\\/\\-]+/, \"\")\n      .replace(/\\s+/g, \" \")\n      .trim()\n  );\n  if (!name) return null;\n\n  const entry = { name, optional };\n  const n = name.toLowerCase();\n  const catMatch = (patterns) => patterns.some((re) => re.test(n));\n  if (\n    catMatch([\n      /\\b(chicken|beef|pork|salmon|tuna|shrimp|lobster|crab|prawn|turkey|lamb|tofu|tempeh|egg|steak|ham|bacon|sausage)\\b/\n    ])\n  ) {\n    entry.category = \"protein\";\n  } else if (\n    catMatch([\n      /\\b(rice|noodles?|pasta|spaghetti|fettuccine|linguine|macaroni|quinoa|couscous|tortilla|bread|bun|potato|potatoes|yuca|cassava|gnocchi|grain|lentils?)\\b/,\n      /\\b(greens?|spinach|kale|lettuce|arugula|cabbage)\\b/\n    ])\n  ) {\n    entry.category = \"base\";\n  } else if (\n    catMatch([\n      /\\b(onion|garlic|shallot|scallion|leek|ginger|chili|jalapeno|pepper|bell pepper)\\b/,\n      /\\b(parsley|cilantro|basil|oregano|thyme|rosemary|sage|dill)\\b/\n    ])\n  ) {\n    entry.category = \"aromatic\";\n  } else if (\n    catMatch([\n      /\\b(oil|olive oil|vinegar|broth|stock|soy sauce|coconut milk|milk|cream|wine)\\b/,\n      /\\b(sauce|dressing)\\b/\n    ])\n  ) {\n    entry.category = \"liquid\";\n  } else if (\n    catMatch([\n      /\\b(salt|black pepper|pepper|paprika|cumin|turmeric|curry|chili powder|flakes|oregano|parsley|basil|spice|seasoning|sugar|honey)\\b/\n    ])\n  ) {\n    entry.category = \"seasoning\";\n  } else {\n    entry.category = \"other\";\n  }\n\n  return entry;\n}\n\nfunction arrangeCookbookIngredients(rawList = []) {\n  const cleaned = [];\n  const seen = new Set();\n  for (const it of rawList) {\n    const entry = sanitizeIngredientForCookbook(it);\n    if (!entry) continue;\n    const key = entry.name.toLowerCase();\n    if (seen.has(key)) continue;\n    seen.add(key);\n    cleaned.push(entry);\n  }\n\n  const order = (cat) =>\n    cleaned.filter((c) => c.category === cat && !c.optional);\n  const optional = cleaned.filter((c) => c.optional);\n  const others = cleaned.filter(\n    (c) =>\n      !c.optional &&\n      ![\"protein\", \"base\", \"aromatic\", \"liquid\", \"seasoning\"].includes(\n        c.category\n      )\n  );\n\n  const ordered = [\n    ...order(\"protein\"),\n    ...order(\"base\"),\n    ...order(\"aromatic\"),\n    ...order(\"liquid\"),\n    ...order(\"seasoning\"),\n    ...others\n  ];\n\n  const bullets = ordered.map((c) => `- ${c.name}`);\n  if (optional.length) {\n    bullets.push(\n      `- Optional: ${optional.map((c) => c.name).join(\", \")}`\n    );\n  }\n  return bullets.length ? bullets : [\"- Ingredients not available\"];\n}\n\nfunction naturalList(arr = [], fallback = \"the ingredients\") {\n  const clean = arr.map((s) => s.trim()).filter(Boolean);\n  if (!clean.length) return fallback;\n  if (clean.length === 1) return clean[0];\n  if (clean.length === 2) return `${clean[0]} and ${clean[1]}`;\n  return `${clean.slice(0, -1).join(\", \")}, and ${clean[clean.length - 1]}`;\n}\n\nfunction inferCookbookDescription(dishName, bullets = []) {\n  const name = (dishName || \"\").trim();\n  const proteins = bullets\n    .filter((b) => b.startsWith(\"- \") && /chicken|beef|pork|salmon|shrimp|tofu|egg/i.test(b))\n    .map((b) => b.replace(/^- /, \"\").replace(/^Optional: /i, \"\"));\n  const bases = bullets\n    .filter((b) => b.startsWith(\"- \") && /rice|pasta|noodle|potato|quinoa|couscous|tortilla|greens|spinach|kale/i.test(b))\n    .map((b) => b.replace(/^- /, \"\").replace(/^Optional: /i, \"\"));\n  const accents = bullets\n    .filter((b) => b.startsWith(\"- \") && /garlic|onion|herb|oregano|basil|parsley|sauce|broth|oil|vinegar/i.test(b))\n    .map((b) => b.replace(/^- /, \"\").replace(/^Optional: /i, \"\"));\n\n  const subject = name || \"This dish\";\n  if (proteins.length && bases.length) {\n    return `*${subject} brings ${naturalList(proteins)} together with ${naturalList(bases)} and warm pantry flavors.*`;\n  }\n  if (proteins.length) {\n    return `*${subject} highlights ${naturalList(proteins)} with simple herbs and spices.*`;\n  }\n  if (bases.length) {\n    return `*${subject} leans on ${naturalList(bases)} with cozy aromatics and a gentle sauce.*`;\n  }\n  const accent = accents.length ? naturalList(accents) : \"bright aromatics\";\n  return `*${subject} uses everyday ingredients with ${accent} for an easy, cozy plate.*`;\n}\n\nfunction cleanCookbookStep(text) {\n  let s = String(text || \"\");\n  s = s.replace(/^\\s*(step\\s*\\d+[:\\.\\)]?\\s*)/i, \"\");\n  s = s.replace(/^\\s*\\d+[\\.\\)]\\s*/, \"\");\n  s = s.replace(/\\s+/g, \" \").trim();\n  s = s.replace(/\\byou\\b/gi, \"\").replace(/\\byour\\b/gi, \"\").trim();\n  if (!s) return null;\n  const capped = s.charAt(0).toUpperCase() + s.slice(1);\n  return /[.!?]$/.test(capped) ? capped : `${capped}.`;\n}\n\nfunction inferCookbookSteps(rawSteps = [], ingredientBullets = []) {\n  const cleanedRaw = Array.isArray(rawSteps)\n    ? rawSteps.map((s) => cleanCookbookStep(s)).filter(Boolean)\n    : [];\n\n  const proteins = ingredientBullets\n    .filter((b) => /^- /.test(b) && /chicken|beef|pork|salmon|shrimp|tofu|egg/i.test(b))\n    .map((b) => b.replace(/^- /, \"\").replace(/^Optional: /i, \"\"));\n  const bases = ingredientBullets\n    .filter((b) => /^- /.test(b) && /rice|pasta|noodle|potato|quinoa|couscous|tortilla|greens|spinach|kale/i.test(b))\n    .map((b) => b.replace(/^- /, \"\").replace(/^Optional: /i, \"\"));\n  const aromatics = ingredientBullets\n    .filter((b) => /^- /.test(b) && /garlic|onion|shallot|ginger|herb|pepper/i.test(b))\n    .map((b) => b.replace(/^- /, \"\").replace(/^Optional: /i, \"\"));\n  const liquids = ingredientBullets\n    .filter((b) => /^- /.test(b) && /oil|vinegar|broth|stock|sauce|milk|cream/i.test(b))\n    .map((b) => b.replace(/^- /, \"\").replace(/^Optional: /i, \"\"));\n\n  const inferred = [];\n  if (aromatics.length || bases.length) {\n    inferred.push(\n      `Ingredients are prepped; aromatics like ${naturalList(aromatics, \"onion and garlic\")} and vegetables are chopped.`\n    );\n  } else {\n    inferred.push(\"Ingredients are prepped and cut into bite-size pieces.\");\n  }\n\n  if (proteins.length) {\n    inferred.push(\n      `${naturalList(proteins)} ${proteins.length > 1 ? \"are\" : \"is\"} seasoned and cooked until browned.`\n    );\n  }\n\n  if (bases.length) {\n    inferred.push(\n      `${naturalList(bases)} ${bases.length > 1 ? \"are\" : \"is\"} cooked until tender.`\n    );\n  }\n\n  if (liquids.length || aromatics.length) {\n    inferred.push(\n      `${liquids.length ? naturalList(liquids) : \"Sauce\"} is stirred in with the cooked ingredients until flavors meld.`\n    );\n  }\n\n  inferred.push(\"The dish is assembled, tasted, and served warm.\");\n\n  let steps = cleanedRaw.length && cleanedRaw.length <= 6 ? cleanedRaw : [];\n  if (!steps.length || steps.length > 6) {\n    steps = inferred;\n  }\n\n  if (steps.length < 3) {\n    for (const inf of inferred) {\n      if (steps.length >= 3) break;\n      if (!steps.includes(inf)) steps.push(inf);\n    }\n  }\n\n  return steps.slice(0, 6);\n}\n\nfunction formatLikelyRecipeMarkdown({\n  dishName,\n  rawIngredients = [],\n  rawSteps = [],\n  servingInfo = null\n}) {\n  const title = dishName ? `### Likely recipe: ${dishName}` : \"### Likely recipe\";\n  const ingredients = arrangeCookbookIngredients(rawIngredients);\n  const description = inferCookbookDescription(dishName, ingredients);\n  const steps = inferCookbookSteps(rawSteps, ingredients);\n\n  const lines = [\n    title,\n    description,\n    \"\",\n    \"**Ingredients**\",\n    ...ingredients,\n    \"\",\n    \"**How it's prepared**\",\n    ...steps.map((s, idx) => `${idx + 1}. ${s}`)\n  ];\n\n  if (servingInfo && (servingInfo.servings || servingInfo.grams)) {\n    const bits = [];\n    if (servingInfo.servings)\n      bits.push(`${servingInfo.servings} serving${servingInfo.servings > 1 ? \"s\" : \"\"}`);\n    if (servingInfo.grams) bits.push(`${servingInfo.grams} g`);\n    const joined =\n      bits.length === 2 ? `${bits[0]} (${bits[1]})` : bits.join(\"\");\n    if (joined) lines.push(\"\", `**Estimated serving size:** about ${joined}`);\n  }\n\n  lines.push(\n    \"\",\n    \"**Based on typical recipes from Edamam and Spoonacular. Restaurant versions may vary.**\"\n  );\n\n  return lines.join(\"\\n\");\n}\n\nfunction safeJson(s, fallback) {\n  try {\n    return s ? JSON.parse(s) : fallback;\n  } catch {\n    return fallback;\n  }\n}\nfunction barometerFromOrgans(levelsObj) {\n  const vals = Object.values(levelsObj || {});\n  if (!vals.length) return 0;\n  const map = {\n    \"High Benefit\": 40,\n    Benefit: 20,\n    Neutral: 0,\n    Caution: -20,\n    \"High Caution\": -40\n  };\n  const nums = vals.map((v) => map[v] ?? 0);\n  const avg = nums.reduce((a, b) => a + b, 0) / nums.length;\n  return Math.max(-100, Math.min(100, Math.round(avg)));\n}\n\nasync function getOrgans(env) {\n  const fallback = [\"gut\", \"liver\", \"heart\"];\n  if (!env?.D1_DB) return fallback;\n  try {\n    const { results } = await env.D1_DB.prepare(\n      \"SELECT organ FROM organ_systems\"\n    ).all();\n    const arr = (results || []).map((r) => r?.organ).filter(Boolean);\n    return arr.length ? arr : fallback;\n  } catch {\n    return fallback;\n  }\n}\n\nfunction computeBarometerFromLevelsAll(ORGANS, lv) {\n  const levelToBar = (s) =>\n    ({\n      \"High Benefit\": 80,\n      Benefit: 40,\n      Neutral: 0,\n      Caution: -40,\n      \"High Caution\": -80\n    })[s] ?? 0;\n  if (!Array.isArray(ORGANS) || !ORGANS.length) return 0;\n  const nums = ORGANS.map((o) => levelToBar(lv?.[o]));\n  const sum = nums.reduce((acc, val) => acc + val, 0);\n  return Math.round(sum / Math.max(nums.length, 1));\n}\n\nasync function fetchRecipeCardWithFallback(dish, env, opts = {}) {\n  const attempts = [];\n\n  async function tryEdamam() {\n    if (typeof callEdamamRecipe !== \"function\") return null;\n    const r = await callEdamamRecipe(dish, env, opts);\n    const count = Array.isArray(r?.ingredients) ? r.ingredients.length : 0;\n    attempts.push({\n      provider: \"edamam\",\n      ok: count > 0,\n      reason: r?.reason,\n      count\n    });\n    if (count > 0) {\n      return {\n        provider: \"edamam\",\n        reason: r?.reason,\n        ingredients: r.ingredients,\n        attempts,\n        label: r?.raw?.label || null\n      };\n    }\n    return null;\n  }\n\n  async function trySpoonacular() {\n    if (typeof callSpoonacularRecipe !== \"function\") return null;\n    const r = await callSpoonacularRecipe(dish, env, opts);\n    const count = Array.isArray(r?.ingredients) ? r.ingredients.length : 0;\n    attempts.push({\n      provider: \"spoonacular\",\n      ok: count > 0,\n      reason: r?.reason,\n      count\n    });\n    if (count > 0) {\n      return {\n        provider: \"spoonacular\",\n        reason: r?.reason,\n        ingredients: r.ingredients,\n        attempts\n      };\n    }\n    return null;\n  }\n\n  async function tryOpenAI() {\n    if (typeof callOpenAIRecipe !== \"function\") return null;\n    const r = await callOpenAIRecipe(dish, env, opts);\n    const count = Array.isArray(r?.ingredients) ? r.ingredients.length : 0;\n    attempts.push({\n      provider: \"openai\",\n      ok: count > 0,\n      reason: r?.reason,\n      count\n    });\n    if (count > 0) {\n      return {\n        provider: \"openai\",\n        reason: r?.reason,\n        ingredients: r.ingredients,\n        attempts\n      };\n    }\n    return null;\n  }\n\n  let hit = await tryEdamam();\n  if (hit) return hit;\n  hit = await trySpoonacular();\n  if (hit) return hit;\n  hit = await tryOpenAI();\n  if (hit) return hit;\n\n  return {\n    provider: null,\n    reason: \"all providers yielded no ingredients\",\n    ingredients: [],\n    attempts\n  };\n}\n\nfunction personalizeDishForUser(dish, prefs) {\n  if (!dish || typeof dish !== \"object\") return dish;\n  const safePrefs =\n    prefs && typeof prefs === \"object\" ? prefs : { allergens: [], fodmap: {} };\n\n  const hits = Array.isArray(dish.hits) ? dish.hits : [];\n  const hasHits = hits.length > 0;\n\n  const pills_user = hasHits ? derivePillsForUser(hits, safePrefs) : [];\n\n  let baseScore = dish?.score?.base ?? null;\n  let personalScore = dish?.score?.personal ?? null;\n\n  if (baseScore == null && typeof scoreDishFromHits === \"function\" && hasHits) {\n    const base = scoreDishFromHits(hits);\n    baseScore = base?.tummy_barometer?.score ?? null;\n  }\n\n  if (personalScore == null && baseScore != null && hasHits) {\n    const tracked = new Set(\n      Array.isArray(safePrefs.allergens) ? safePrefs.allergens.map(String) : []\n    );\n    const anyTracked = hits.some(\n      (h) =>\n        Array.isArray(h.allergens) &&\n        h.allergens.some((a) => tracked.has(String(a)))\n    );\n    const onionFlag =\n      !!safePrefs?.fodmap?.onion &&\n      hits.some((h) => (h.classes || []).map(String).includes(\"onion\"));\n    const garlicFlag =\n      !!safePrefs?.fodmap?.garlic &&\n      hits.some((h) => (h.classes || []).map(String).includes(\"garlic\"));\n\n    let penalty = 0;\n    if (anyTracked) penalty += 5;\n    if (onionFlag) penalty += 2;\n    if (garlicFlag) penalty += 2;\n    personalScore = Math.max(1, Math.min(100, baseScore - penalty));\n  }\n\n  const personal_reasons = (() => {\n    const out = [];\n    const tracked = new Set(\n      Array.isArray(safePrefs.allergens) ? safePrefs.allergens.map(String) : []\n    );\n    if (tracked.size)\n      out.push(`You're tracking: ${Array.from(tracked).join(\", \")}`);\n    if (safePrefs?.fodmap?.onion) out.push(\"You track onion.\");\n    if (safePrefs?.fodmap?.garlic) out.push(\"You track garlic.\");\n    if (!out.length) out.push(\"No tracked triggers selected.\");\n    return out;\n  })();\n\n  dish.score = { base: baseScore, personal: personalScore };\n  dish.pills_user = pills_user;\n  dish.personal_reasons = personal_reasons;\n  return dish;\n}\n\n// ==== Step 47.1 \u2014 Forever-cache skip helpers (R2 preflight) ====\n\nfunction normalizeTitle(s = \"\") {\n  return s.toLowerCase().trim().replace(/\\s+/g, \" \");\n}\n\nfunction resultIdForDish(place_id, title) {\n  const base = `${(place_id || \"\").trim()}::${normalizeTitle(title || \"\")}`;\n  // Deterministic tiny hash (no crypto import needed in CF)\n  let hash = 0;\n  for (let i = 0; i < base.length; i++) {\n    hash = (hash << 5) - hash + base.charCodeAt(i);\n    hash |= 0;\n  }\n  return `dish_${Math.abs(hash)}`;\n}\n\nasync function r2Head(env, key) {\n  if (!env?.R2_BUCKET) return false;\n  try {\n    const obj = await env.R2_BUCKET.head(key);\n    return !!obj;\n  } catch {\n    return false;\n  }\n}\n\nfunction normKey(s = \"\") {\n  return s\n    .toLowerCase()\n    .trim()\n    .replace(/[^a-z0-9]+/g, \"-\")\n    .replace(/^-|-$/g, \"\");\n}\n\nasync function getCachedNutrition(env, name) {\n  if (!env?.R2_BUCKET) return null;\n  const key = `nutrition/${normKey(name)}.json`;\n  const head = await r2Head(env, key);\n  if (!head) return null;\n  const obj = await env.R2_BUCKET.get(key);\n  if (!obj) return null;\n  try {\n    return await obj.json();\n  } catch {\n    return null;\n  }\n}\n\nasync function putCachedNutrition(env, name, data) {\n  if (!env?.R2_BUCKET) return null;\n  const key = `nutrition/${normKey(name)}.json`;\n  const payload = { ...data, _cachedAt: new Date().toISOString() };\n  await r2WriteJSON(env, key, payload);\n  return payload;\n}\n\nasync function enrichWithNutrition(env, rows = []) {\n  for (const row of rows) {\n    const q = (row?.name || row?.original || \"\").trim();\n    if (!q) continue;\n    let hit = await getCachedNutrition(env, q);\n    if (!hit) {\n      hit = await callUSDAFDC(env, q);\n      if (!hit) hit = await callOFF(env, q);\n      if (hit) {\n        try {\n          await putCachedNutrition(env, q, hit);\n        } catch {}\n      }\n    }\n    if (hit?.nutrients) {\n      row.nutrition = hit.nutrients;\n      row._fdc = {\n        id: hit.fdcId,\n        description: hit.description || null,\n        dataType: hit.dataType || null,\n        source: hit.source || \"USDA_FDC\"\n      };\n    }\n  }\n  return rows;\n}\n\nasync function maybeReturnCachedResult(req, env, { place_id, title }) {\n  if (!env?.R2_BUCKET) return null;\n  const url = new URL(req.url);\n  const force = url.searchParams.get(\"force_reanalyze\") === \"1\";\n  if (!place_id || !title || force) return null;\n\n  const id = resultIdForDish(place_id, title);\n  const key = `results/${id}.json`;\n  const exists = await r2Head(env, key);\n  if (!exists) return null;\n\n  const obj = await env.R2_BUCKET.get(key);\n  if (!obj) return null;\n\n  const body = await obj.text();\n  return new Response(body, {\n    status: 200,\n    headers: {\n      \"content-type\": \"application/json; charset=utf-8\",\n      \"x-tb-source\": \"cache:r2\",\n      \"x-tb-result-id\": id,\n      \"x-tb-skip\": \"1\"\n    }\n  });\n}\n\nasync function callVisionForText(env, imageUrl) {\n  if (!env.GCP_VISION_API_KEY) throw new Error(\"Missing GCP_VISION_API_KEY\");\n  const endpoint = `https://vision.googleapis.com/v1/images:annotate?key=${env.GCP_VISION_API_KEY}`;\n\n  const imgRes = await fetch(imageUrl, {\n    headers: {\n      \"User-Agent\": \"TummyBuddyWorker/1.0 (+https://tummybuddy.app)\",\n      Accept: \"image/*,*/*;q=0.8\"\n    }\n  });\n  if (!imgRes.ok) throw new Error(`fetch image failed: ${imgRes.status}`);\n  const buf = await imgRes.arrayBuffer();\n  const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));\n\n  const body = {\n    requests: [\n      {\n        image: { content: b64 },\n        features: [{ type: \"DOCUMENT_TEXT_DETECTION\" }],\n        imageContext: { languageHints: [\"en\", \"es\"] }\n      }\n    ]\n  };\n\n  const res = await fetch(endpoint, {\n    method: \"POST\",\n    headers: { \"content-type\": \"application/json\" },\n    body: JSON.stringify(body)\n  });\n\n  if (!res.ok) {\n    const msg = await res.text().catch(() => \"\");\n    throw new Error(`Vision HTTP ${res.status}: ${msg.slice(0, 500)}`);\n  }\n\n  const data = await res.json();\n  const resp =\n    data && data.responses && data.responses[0] ? data.responses[0] : {};\n\n  const fullText =\n    (resp.fullTextAnnotation && resp.fullTextAnnotation.text) ||\n    (Array.isArray(resp.textAnnotations) &&\n      resp.textAnnotations[0] &&\n      resp.textAnnotations[0].description) ||\n    \"\";\n\n  const lines = fullText\n    .split(/\\r?\\n/)\n    .map((s) => s.trim())\n    .filter(Boolean);\n\n  return { fullText, lines, raw: resp };\n}\n\nasync function handleDebugVision(request, env) {\n  const url = new URL(request.url);\n  const img = (url.searchParams.get(\"url\") || \"\").trim();\n  if (!img) return json({ ok: false, error: \"Missing ?url=\" }, { status: 400 });\n  if (!env.GCP_VISION_API_KEY)\n    return json(\n      { ok: false, error: \"Missing GCP_VISION_API_KEY\" },\n      { status: 500 }\n    );\n\n  const endpoint = `https://vision.googleapis.com/v1/images:annotate?key=${env.GCP_VISION_API_KEY}`;\n  const body = {\n    requests: [\n      {\n        image: { source: { imageUri: img } },\n        features: [{ type: \"DOCUMENT_TEXT_DETECTION\" }],\n        imageContext: { languageHints: [\"en\", \"es\"] }\n      }\n    ]\n  };\n\n  const r = await fetch(endpoint, {\n    method: \"POST\",\n    headers: { \"content-type\": \"application/json\" },\n    body: JSON.stringify(body)\n  });\n  const rawText = await r.text();\n  return json(\n    {\n      ok: r.ok,\n      status: r.status,\n      raw_text_first_800: rawText.slice(0, 800)\n    },\n    { status: r.ok ? 200 : 502 }\n  );\n}\n\nfunction classifyStampKey(dish, place_id = \"\", lang = \"en\") {\n  const base = String(dish || \"\")\n    .toLowerCase()\n    .trim()\n    .replace(/[^a-z0-9]+/g, \"-\")\n    .replace(/^-+|-+$/g, \"\");\n  const pid = String(place_id || \"\")\n    .toLowerCase()\n    .trim()\n    .replace(/[^a-z0-9]+/g, \"-\")\n    .replace(/^-+|-+$/g, \"\");\n  return `classify/${lang}/${pid || \"unknown\"}/${base || \"unknown\"}.json`;\n}\n\nasync function getClassifyStamp(env, key) {\n  const kv = env.MENUS_CACHE || env.LEXICON_CACHE;\n  if (!kv) return null;\n  try {\n    const raw = await kv.get(key);\n    return raw ? JSON.parse(raw) : null;\n  } catch {\n    return null;\n  }\n}\n\nasync function setClassifyStamp(env, key, payload, ttlSeconds = 6 * 3600) {\n  const kv = env.MENUS_CACHE || env.LEXICON_CACHE;\n  if (!kv) return false;\n  try {\n    await kv.put(\n      key,\n      JSON.stringify({ savedAt: new Date().toISOString(), ...payload }),\n      {\n        expirationTtl: ttlSeconds\n      }\n    );\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n// ---- Edamam Tier 1 (safe) ----\n// expects env.EDAMAM_APP_ID and env.EDAMAM_APP_KEY\nasync function callEdamam(env, dish, cuisine = \"\", lang = \"en\") {\n  const appId = (env.EDAMAM_APP_ID || \"\").trim();\n  const appKey = (env.EDAMAM_APP_KEY || \"\").trim();\n  if (!appId || !appKey) {\n    return {\n      ok: true,\n      items: [],\n      note: \"edamam_missing_keys\",\n      provider: \"edamam\"\n    };\n  }\n\n  const base = \"https://api.edamam.com/api/recipes/v2\";\n  const u = new URL(base);\n  u.searchParams.set(\"type\", \"public\");\n  u.searchParams.set(\"q\", dish);\n  u.searchParams.set(\"app_id\", appId);\n  u.searchParams.set(\"app_key\", appKey);\n  if (cuisine) u.searchParams.set(\"cuisineType\", cuisine);\n\n  const accountUser = \"anon\";\n\n  try {\n    const r = await fetch(u.toString(), {\n      headers: {\n        accept: \"application/json\",\n        \"Edamam-Account-User\": accountUser\n      }\n    });\n    if (!r.ok) {\n      return {\n        ok: false,\n        items: [],\n        error: `edamam HTTP ${r.status}`,\n        provider: \"edamam\"\n      };\n    }\n    const js = await r.json().catch(() => ({}));\n    const hits = Array.isArray(js.hits) ? js.hits : [];\n    const items = hits.map((h) => h.recipe).filter(Boolean);\n    return { ok: true, items, provider: \"edamam\" };\n  } catch (e) {\n    return {\n      ok: false,\n      items: [],\n      error: `edamam fetch error: ${String(e?.message || e)}`,\n      provider: \"edamam\"\n    };\n  }\n}\n\nfunction normalizeEdamamRecipe(rec) {\n  const name = String(rec?.label || \"\").trim();\n  const lines = Array.isArray(rec?.ingredientLines) ? rec.ingredientLines : [];\n  const ingredients = (Array.isArray(rec?.ingredients) ? rec.ingredients : [])\n    .map((it) => ({\n      name: String(it?.food || it?.text || \"\").trim(),\n      qty: typeof it?.quantity === \"number\" ? it.quantity : null,\n      unit: String(it?.measure || \"\").trim() || null\n    }))\n    .filter((x) => x.name);\n\n  const steps = lines.length ? [`Combine: ${lines.join(\"; \")}`] : [];\n\n  return {\n    recipe: { name: name || null, steps, notes: lines.length ? lines : null },\n    ingredients\n  };\n}\n\nfunction ingredientEntryToLine(entry) {\n  if (typeof entry === \"string\") return entry.trim();\n  if (!entry || typeof entry !== \"object\") return \"\";\n  const qty =\n    entry.qty ?? entry.quantity ?? entry.amount ?? entry.count ?? undefined;\n  const unit = entry.unit || entry.measure || entry.metricUnit || \"\";\n  const name =\n    entry.name ||\n    entry.product ||\n    entry.ingredient ||\n    entry.original ||\n    entry.food ||\n    entry.text ||\n    \"\";\n  const comment =\n    entry.comment ||\n    entry.preparation ||\n    entry.preparationNotes ||\n    entry.note ||\n    entry.extra ||\n    \"\";\n  const parts = [];\n  if (qty !== undefined && qty !== null && qty !== \"\") {\n    parts.push(String(qty).trim());\n  }\n  if (unit) parts.push(String(unit).trim());\n  if (name) parts.push(String(name).trim());\n  let line = parts.join(\" \").trim();\n  const commentTxt = String(comment || \"\").trim();\n  if (commentTxt) line = line ? `${line}, ${commentTxt}` : commentTxt;\n  return line.trim();\n}\n\nfunction normalizeProviderRecipe(\n  payload = {},\n  fallbackDish = \"\",\n  provider = \"unknown\"\n) {\n  const base = payload && typeof payload === \"object\" ? { ...payload } : {};\n  const structuredCandidates = Array.isArray(base.ingredients_structured)\n    ? base.ingredients_structured\n    : Array.isArray(base.ingredients) &&\n        base.ingredients.every((row) => row && typeof row === \"object\")\n      ? base.ingredients\n      : null;\n  const rawIngredients = Array.isArray(base.ingredients)\n    ? base.ingredients\n    : Array.isArray(base.ingredients_lines)\n      ? base.ingredients_lines\n      : Array.isArray(structuredCandidates)\n        ? structuredCandidates\n        : [];\n  const ingredients = rawIngredients\n    .map((entry) => ingredientEntryToLine(entry))\n    .filter(Boolean);\n\n  const recipeSrc = base.recipe || {};\n  const recipe = {\n    name: recipeSrc.name || recipeSrc.title || fallbackDish || null,\n    steps: Array.isArray(recipeSrc.steps)\n      ? recipeSrc.steps\n      : recipeSrc.instructions\n        ? [recipeSrc.instructions]\n        : [],\n    notes:\n      Array.isArray(recipeSrc.notes) && recipeSrc.notes.length\n        ? recipeSrc.notes\n        : recipeSrc.image\n          ? [recipeSrc.image]\n          : null\n  };\n\n  const extras = { ...base };\n  delete extras.ingredients;\n  delete extras.ingredients_lines;\n  delete extras.ingredients_structured;\n  delete extras.recipe;\n\n  return {\n    ...extras,\n    provider,\n    recipe,\n    ingredients,\n    ingredients_structured: structuredCandidates || null\n  };\n}\n\n// ---- OpenAI Recipe fallback (safe) ----\n\n// === PATCH 3: Minimal Spoonacular recipe shim (skip if you already have one) ===\n// === PATCH A: provider adapters (map old names to new) ===\n// === PATCH C: OpenAI recipe extractor (JSON output) ===\n// Needs env.OPENAI_API_KEY\nasync function callOpenAIRecipe(dish, env, opts = {}) {\n  const key = env.OPENAI_API_KEY;\n  if (!key) return { ingredients: [], reason: \"OPENAI_API_KEY missing\" };\n\n  const system =\n    'You extract probable ingredient lines for a named dish. Respond ONLY as strict JSON: {\"ingredients\": [\"...\"]}. No prose.';\n  const user = `Dish: ${dish}\nReturn 10-25 concise ingredient lines a home cook would list (no steps). Use plain names (e.g., \"fettuccine\", \"heavy cream\", \"parmesan\", \"chicken breast\", \"garlic\", \"butter\", \"olive oil\", \"salt\", \"black pepper\").`;\n\n  try {\n    const res = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n      method: \"POST\",\n      headers: {\n        \"content-type\": \"application/json\",\n        authorization: `Bearer ${key}`\n      },\n      body: JSON.stringify({\n        model: \"gpt-4o-mini\",\n        temperature: 0.2,\n        response_format: { type: \"json_object\" },\n        messages: [\n          { role: \"system\", content: system },\n          { role: \"user\", content: user }\n        ]\n      })\n    });\n    const data = await parseResSafe(res);\n    if (!res.ok)\n      return {\n        ingredients: [],\n        reason: `openai http ${res.status}`,\n        debug: data\n      };\n    const txt = data?.choices?.[0]?.message?.content || \"{}\";\n    let parsed = {};\n    try {\n      parsed = JSON.parse(txt);\n    } catch {\n      parsed = data && data.ingredients ? data : {};\n    }\n    const ingredients = Array.isArray(parsed.ingredients)\n      ? parsed.ingredients.map((s) => String(s).trim()).filter(Boolean)\n      : [];\n    return {\n      ingredients,\n      reason: ingredients.length ? \"ok\" : \"no ingredients\",\n      debug: data && data.__nonjson__ ? { nonjson: true } : undefined\n    };\n  } catch (e) {\n    return { ingredients: [], reason: String(e?.message || e) };\n  }\n}\n\n// === PATCH C: OpenAI recipe extractor (JSON output) ===\n// Needs env.OPENAI_API_KEY\n\nasync function callSpoonacularRecipe(dish, env) {\n  const key = env.SPOONACULAR_KEY;\n  if (!key) return { ingredients: [], reason: \"SPOONACULAR_KEY missing\" };\n\n  const searchUrl = new URL(\n    \"https://api.spoonacular.com/recipes/complexSearch\"\n  );\n  searchUrl.searchParams.set(\"query\", dish);\n  searchUrl.searchParams.set(\"number\", \"1\");\n  searchUrl.searchParams.set(\"addRecipeInformation\", \"true\");\n  searchUrl.searchParams.set(\"fillIngredients\", \"true\");\n  searchUrl.searchParams.set(\"instructionsRequired\", \"false\");\n  searchUrl.searchParams.set(\"apiKey\", key);\n\n  let search;\n  try {\n    const r = await fetch(searchUrl, { method: \"GET\" });\n    search = await parseResSafe(r);\n    if (!r.ok)\n      return {\n        ingredients: [],\n        reason: `spoonacular search http ${r.status}`,\n        debug: search\n      };\n  } catch (e) {\n    return {\n      ingredients: [],\n      reason: `spoonacular search err ${String(e?.message || e)}`\n    };\n  }\n\n  const item = search?.results?.[0];\n  if (!item) return { ingredients: [], reason: \"no results\" };\n\n  const ext = Array.isArray(item.extendedIngredients)\n    ? item.extendedIngredients\n    : [];\n  const ingredients = ext\n    .map((x) => {\n      const original = typeof x?.original === \"string\" ? x.original.trim() : \"\";\n      if (original) return original;\n      const fallback = [x?.amount, x?.unit, x?.nameClean || x?.name]\n        .filter(Boolean)\n        .join(\" \")\n        .trim();\n      return fallback || null;\n    })\n    .filter(Boolean);\n\n  return { ingredients, reason: ingredients.length ? \"ok\" : \"no ingredients\" };\n}\n\nasync function spoonacularFetch(env, dish, cuisine = \"\", lang = \"en\") {\n  const apiKey = (env.SPOONACULAR_API_KEY || \"\").trim();\n  if (!apiKey) return null;\n\n  const searchUrl = `https://api.spoonacular.com/recipes/complexSearch?query=${encodeURIComponent(dish)}&number=1&addRecipeInformation=true&apiKey=${encodeURIComponent(apiKey)}`;\n\n  try {\n    const r = await fetch(searchUrl, {\n      headers: { \"x-api-key\": apiKey, accept: \"application/json\" }\n    });\n    if (!r.ok) {\n      const t = await r.text().catch(() => \"\");\n      console.log(\"Spoonacular error\", r.status, t.slice(0, 180));\n      return null;\n    }\n    const data = await r.json();\n    const res = data?.results?.[0];\n    if (!res) return null;\n\n    let extended = Array.isArray(res.extendedIngredients)\n      ? res.extendedIngredients\n      : null;\n    if (!extended || !extended.length) {\n      try {\n        const infoUrl = `https://api.spoonacular.com/recipes/${res.id}/information?includeNutrition=false&apiKey=${encodeURIComponent(apiKey)}`;\n        const infoRes = await fetch(infoUrl, {\n          headers: { \"x-api-key\": apiKey, accept: \"application/json\" }\n        });\n        if (infoRes.ok) {\n          const info = await infoRes.json();\n          extended = Array.isArray(info.extendedIngredients)\n            ? info.extendedIngredients\n            : null;\n        } else {\n          const t = await infoRes.text().catch(() => \"\");\n          console.log(\n            \"Spoonacular info error\",\n            infoRes.status,\n            t.slice(0, 180)\n          );\n        }\n      } catch (e) {\n        console.log(\"Spoonacular info fetch failed:\", e?.message || String(e));\n      }\n    }\n\n    const ingredientsLines = extended\n      ? extended.map((i) => i.original || i.name || \"\").filter(Boolean)\n      : [];\n\n    return {\n      recipe: {\n        title: res.title || dish,\n        instructions: res.instructions || \"\",\n        image: res.image || null,\n        cuisine: (res.cuisines && res.cuisines[0]) || cuisine || null\n      },\n      ingredients: ingredientsLines,\n      provider: \"spoonacular\"\n    };\n  } catch (err) {\n    console.log(\"Spoonacular fail:\", err?.message || String(err));\n    return null;\n  }\n}\n\nasync function fetchFromEdamam(env, dish, cuisine = \"\", lang = \"en\") {\n  await recordMetric(env, \"provider:edamam:hit\");\n  try {\n    const res = await callEdamam(env, dish, cuisine, lang);\n    const best = Array.isArray(res?.items) ? res.items[0] : null;\n    if (!best) {\n      const reason = res?.error || res?.note || \"no_edamam_hits\";\n      return { ingredients: [], provider: \"edamam\", reason, _skip: \"edamam\" };\n    }\n    const normalized = normalizeEdamamRecipe(best);\n    return normalizeProviderRecipe(\n      {\n        recipe: normalized.recipe,\n        ingredients: normalized.ingredients,\n        raw: best\n      },\n      dish,\n      \"edamam\"\n    );\n  } catch (err) {\n    console.warn(\"edamam_fail\", err?.message || err);\n    return { ingredients: [], provider: \"edamam\", _skip: \"edamam\" };\n  }\n}\n\nasync function fetchFromSpoonacular(env, dish, cuisine = \"\", lang = \"en\") {\n  await recordMetric(env, \"provider:spoonacular:hit\");\n  try {\n    const r = await spoonacularFetch(env, dish, cuisine, lang);\n    if (!r || !Array.isArray(r.ingredients)) {\n      throw new Error(\"Bad spoonacular shape\");\n    }\n    return normalizeProviderRecipe(r, dish, \"spoonacular\");\n  } catch (e) {\n    console.warn(\"spoonacular_fail\", e?.message || e);\n    return { ingredients: [], provider: \"spoonacular\", _skip: \"spoonacular\" };\n  }\n}\n\nasync function fetchFromOpenAI(env, dish, cuisine = \"\", lang = \"en\") {\n  await recordMetric(env, \"provider:openai:hit\");\n  try {\n    const res = await callOpenAIRecipe(dish, env, { cuisine, lang });\n    if (!Array.isArray(res?.ingredients) || !res.ingredients.length) {\n      return {\n        ingredients: [],\n        provider: \"openai\",\n        reason: res?.reason || \"openai_empty\",\n        _skip: \"openai\"\n      };\n    }\n    const payload = {\n      recipe: res.recipe || { name: dish, steps: [], notes: null },\n      ingredients: res.ingredients,\n      reason: res.reason,\n      debug: res.debug\n    };\n    return normalizeProviderRecipe(payload, dish, \"openai\");\n  } catch (err) {\n    console.warn(\"openai_fail\", err?.message || err);\n    return { ingredients: [], provider: \"openai\", _skip: \"openai\" };\n  }\n}\n\nasync function callZestful(env, lines = []) {\n  if (!lines?.length) return null;\n\n  const host = (env.ZESTFUL_RAPID_HOST || \"zestful.p.rapidapi.com\").trim();\n  const url = `https://${host}/parseIngredients`;\n\n  try {\n    const res = await fetch(url, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-RapidAPI-Key\": env.ZESTFUL_RAPID_KEY,\n        \"X-RapidAPI-Host\": host\n      },\n      body: JSON.stringify({ ingredients: lines })\n    });\n\n    if (!res.ok) {\n      const t = await res.text().catch(() => \"\");\n      console.log(\"Zestful error\", res.status, t.slice(0, 180));\n      return null;\n    }\n    const data = await res.json();\n\n    const parsed = (data.results || []).map((r, i) => ({\n      original:\n        lines[i] || r.ingredientRaw || r.ingredientParsed?.ingredient || \"\",\n      name:\n        r.ingredientParsed?.product ||\n        r.ingredientParsed?.ingredient ||\n        r.ingredient ||\n        r.name ||\n        \"\",\n      qty: r.ingredientParsed?.quantity ?? r.quantity ?? null,\n      unit: r.ingredientParsed?.unit ?? r.unit ?? null,\n      comment:\n        r.ingredientParsed?.preparationNotes ??\n        r.ingredientParsed?.comment ??\n        r.comment ??\n        null,\n      _conf: r.confidence ?? null\n    }));\n\n    return parsed.length ? parsed : null;\n  } catch (err) {\n    console.log(\"Zestful fail:\", err?.message || String(err));\n    return null;\n  }\n}\n\n// --- Open Food Facts fallback ---\nasync function callOFF(env, name) {\n  const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(name)}&search_simple=1&action=process&json=1&page_size=1`;\n  try {\n    const res = await fetch(url, {\n      headers: { \"User-Agent\": \"TummyBuddyApp/1.0\" }\n    });\n    if (!res.ok) return null;\n    const data = await res.json();\n    const p = data?.products?.[0];\n    if (!p) return null;\n\n    return {\n      description: p.product_name || p.generic_name || name,\n      brand: p.brands || null,\n      source: \"OPEN_FOOD_FACTS\",\n      nutrients: {\n        energyKcal: p.nutriments[\"energy-kcal_100g\"] ?? null,\n        protein_g: p.nutriments.proteins_100g ?? null,\n        fat_g: p.nutriments.fat_100g ?? null,\n        carbs_g: p.nutriments.carbohydrates_100g ?? null,\n        sugar_g: p.nutriments.sugars_100g ?? null,\n        fiber_g: p.nutriments.fiber_100g ?? null,\n        sodium_mg:\n          p.nutriments.sodium_100g != null\n            ? p.nutriments.sodium_100g * 1000\n            : null\n      }\n    };\n  } catch (err) {\n    return null;\n  }\n}\n\nfunction sumNutrition(rows = []) {\n  const keys = [\n    \"energyKcal\",\n    \"protein_g\",\n    \"fat_g\",\n    \"carbs_g\",\n    \"sugar_g\",\n    \"fiber_g\",\n    \"sodium_mg\"\n  ];\n  const total = Object.fromEntries(keys.map((k) => [k, 0]));\n  for (const r of rows) {\n    const n = r?.nutrition || {};\n    for (const k of keys) {\n      if (typeof n[k] === \"number\") total[k] += n[k];\n    }\n  }\n  for (const k of keys) total[k] = Math.round(total[k] * 100) / 100;\n  return total;\n}\n\nfunction extractMacrosFromFDC(full) {\n  const empty = () => ({\n    energyKcal: null,\n    protein_g: null,\n    fat_g: null,\n    carbs_g: null,\n    sugar_g: null,\n    fiber_g: null,\n    sodium_mg: null\n  });\n\n  const scaleMacros = (macros, factor) => {\n    if (!macros || !Number.isFinite(factor) || factor <= 0) return null;\n    const out = empty();\n    for (const key of Object.keys(out)) {\n      const val = macros[key];\n      out[key] = val == null ? null : Math.round(val * factor * 1000) / 1000;\n    }\n    return out;\n  };\n\n  const deriveServing = () => {\n    let grams = null;\n    let unit = null;\n    let size = null;\n\n    const rawSize = Number(full?.servingSize);\n    if (Number.isFinite(rawSize) && rawSize > 0) size = rawSize;\n\n    const rawUnit =\n      typeof full?.servingSizeUnit === \"string\"\n        ? full.servingSizeUnit.trim()\n        : \"\";\n    if (rawUnit) unit = rawUnit;\n    if (size != null && rawUnit && rawUnit.toLowerCase() === \"g\") grams = size;\n\n    const portions = Array.isArray(full?.foodPortions) ? full.foodPortions : [];\n    let picked = null;\n    for (const portion of portions) {\n      if (!Number.isFinite(portion?.gramWeight) || portion.gramWeight <= 0)\n        continue;\n      const desc = String(\n        portion.portionDescription || portion.modifier || \"\"\n      ).toLowerCase();\n      const isServing =\n        desc.includes(\"serving\") ||\n        desc.includes(\"portion\") ||\n        desc.includes(\"piece\");\n      if (!picked || isServing) {\n        picked = portion;\n        if (isServing) break;\n      }\n    }\n\n    if (picked) {\n      if (grams == null) grams = Number(picked.gramWeight);\n      if (!unit) {\n        const mu = picked.measureUnit?.abbreviation || picked.measureUnit?.name;\n        if (mu) unit = String(mu);\n        else if (picked.portionDescription)\n          unit = String(picked.portionDescription);\n        else if (picked.modifier) unit = String(picked.modifier);\n      }\n      if (size == null && Number.isFinite(picked.amount))\n        size = Number(picked.amount);\n    }\n\n    if (grams != null) grams = Math.round(grams * 1000) / 1000;\n\n    if (grams == null && unit == null && size == null) return null;\n    return {\n      grams,\n      unit: unit ? unit.toLowerCase() : null,\n      size\n    };\n  };\n\n  const serving = deriveServing();\n  const servingGrams =\n    serving?.grams && Number.isFinite(serving.grams) && serving.grams > 0\n      ? serving.grams\n      : null;\n\n  const ln = full?.labelNutrients;\n  if (ln) {\n    const v = (k) => ln[k]?.value ?? null;\n    const perServing = empty();\n    perServing.energyKcal =\n      v(\"calories\") != null ? Math.round(v(\"calories\")) : null;\n    perServing.protein_g = v(\"protein\") != null ? Number(v(\"protein\")) : null;\n    perServing.fat_g = v(\"fat\") != null ? Number(v(\"fat\")) : null;\n    perServing.carbs_g =\n      v(\"carbohydrates\") != null ? Number(v(\"carbohydrates\")) : null;\n    perServing.sugar_g = v(\"sugars\") != null ? Number(v(\"sugars\")) : null;\n    perServing.fiber_g = v(\"fiber\") != null ? Number(v(\"fiber\")) : null;\n    perServing.sodium_mg = v(\"sodium\") != null ? Math.round(v(\"sodium\")) : null;\n\n    const per100g = servingGrams\n      ? scaleMacros(perServing, 100 / servingGrams)\n      : null;\n\n    return {\n      perServing,\n      per100g,\n      serving\n    };\n  }\n\n  const list = Array.isArray(full?.foodNutrients) ? full.foodNutrients : [];\n  const rows = list.map((n) => {\n    const name = (n.nutrient?.name || n.nutrientName || \"\").toLowerCase();\n    const number = (n.nutrient?.number || \"\").toString();\n    const unit = (n.nutrient?.unitName || n.unitName || \"\").toLowerCase();\n    const value = n.amount ?? n.value ?? null;\n    return { name, number, unit, value };\n  });\n\n  const find = (preds) => {\n    for (const r of rows) {\n      for (const p of preds) {\n        if (typeof p === \"string\") {\n          if (r.name.includes(p)) return r;\n        } else if (p.number && r.number === p.number) {\n          return r;\n        }\n      }\n    }\n    return null;\n  };\n\n  const energy = find([\"energy (kcal)\", \"energy\", { number: \"1008\" }]);\n  let energyKcal = null;\n  if (energy?.value != null) {\n    if (energy.unit === \"kj\") energyKcal = energy.value / 4.184;\n    else energyKcal = energy.value;\n  }\n\n  const prot = find([\"protein\", { number: \"1003\" }]);\n  const fat = find([\"total lipid (fat)\", \"fat\", { number: \"1004\" }]);\n  const carb = find([\n    \"carbohydrate, by difference\",\n    \"carbohydrate\",\n    { number: \"1005\" }\n  ]);\n  const sug = find([\n    \"sugars, total including nlea\",\n    \"sugars, total\",\n    \"sugars\",\n    { number: \"2000\" }\n  ]);\n  const fib = find([\"fiber, total dietary\", \"fiber\", { number: \"1079\" }]);\n  const sod = find([\"sodium, na\", \"sodium\", { number: \"1093\" }]);\n\n  const norm = (r, to = \"g\") => {\n    if (!r || r.value == null) return null;\n    if (to === \"g\") {\n      if (r.unit === \"mg\") return r.value / 1000;\n      return r.value;\n    }\n    if (to === \"mg\") {\n      if (r.unit === \"g\") return r.value * 1000;\n      return r.value;\n    }\n    return r.value;\n  };\n\n  const per100g = empty();\n  per100g.energyKcal = energyKcal != null ? Math.round(energyKcal) : null;\n  per100g.protein_g = norm(prot, \"g\");\n  per100g.fat_g = norm(fat, \"g\");\n  per100g.carbs_g = norm(carb, \"g\");\n  per100g.sugar_g = norm(sug, \"g\");\n  per100g.fiber_g = norm(fib, \"g\");\n  per100g.sodium_mg = norm(sod, \"mg\");\n\n  const perServing = servingGrams\n    ? scaleMacros(per100g, servingGrams / 100)\n    : null;\n\n  return {\n    perServing: perServing || (per100g ? { ...per100g } : empty()),\n    per100g,\n    serving\n  };\n}\n\n// --- USDA FoodData Central: search + prefer SR/Foundation + detail fetch ---\nasync function callUSDAFDC(env, name) {\n  const host = env.USDA_FDC_HOST || \"api.nal.usda.gov\";\n  const key = env.USDA_FDC_API_KEY;\n  if (!key || !name) return null;\n\n  const searchUrl = `https://${host}/fdc/v1/foods/search?query=${encodeURIComponent(name)}&pageSize=5&dataType=SR%20Legacy,Survey%20(FNDDS),Foundation,Branded&api_key=${key}`;\n  const sres = await fetch(searchUrl, {\n    headers: { accept: \"application/json\" }\n  });\n  if (!sres.ok) return null;\n\n  const sdata = await sres.json();\n  const foods = Array.isArray(sdata?.foods) ? sdata.foods : [];\n  if (!foods.length) return null;\n\n  const makeEmpty = () => ({\n    energyKcal: null,\n    protein_g: null,\n    fat_g: null,\n    carbs_g: null,\n    sugar_g: null,\n    fiber_g: null,\n    sodium_mg: null\n  });\n\n  const lowerName = name.toLowerCase();\n  const nameTokens = lowerName.split(/\\s+/).filter(Boolean);\n  const matchThreshold = lowerName ? (nameTokens.length >= 2 ? 4 : 2) : 1;\n\n  const dataTypePriority = new Map([\n    [\"sr legacy\", 4],\n    [\"survey (fndds)\", 3],\n    [\"foundation\", 2],\n    [\"branded\", 1]\n  ]);\n\n  const processedTerms = [\n    \"marinated\",\n    \"brined\",\n    \"seasoned\",\n    \"brine\",\n    \"breaded\",\n    \"fried\",\n    \"smoked\",\n    \"bbq\",\n    \"glazed\",\n    \"teriyaki\",\n    \"sauce\",\n    \"gravy\",\n    \"rotisserie\",\n    \"canned\",\n    \"frozen\",\n    \"packaged\",\n    \"pre-cooked\",\n    \"fully cooked\",\n    \"smothered\"\n  ];\n\n  const looksProcessed = (text = \"\") => {\n    const lower = String(text || \"\").toLowerCase();\n    return processedTerms.some((term) => lower.includes(term));\n  };\n\n  const scoreName = (text = \"\") => {\n    const lower = String(text || \"\").toLowerCase();\n    if (!lower) return 0;\n    let score = 0;\n    if (lower === lowerName) score += 6;\n    if (lower.includes(lowerName)) score += 4;\n    for (const token of nameTokens) {\n      if (token.length < 3) continue;\n      if (lower.includes(token)) score += 1;\n    }\n    return score;\n  };\n\n  const qualityScore = (f) => {\n    const dt = (f.dataType || \"\").toLowerCase();\n    const combined = [\n      f.description,\n      f.additionalDescriptions,\n      f.ingredientStatement\n    ]\n      .filter(Boolean)\n      .join(\" \");\n\n    let score = (dataTypePriority.get(dt) || 0) * 10;\n    score += scoreName(combined);\n    if (!f.brandOwner) score += 1;\n    else if (dt.includes(\"branded\")) score -= 1;\n    if (Array.isArray(f.foodNutrients) && f.foodNutrients.length > 0)\n      score += 2;\n    if (looksProcessed(combined)) score -= 6;\n    return score;\n  };\n\n  foods.sort((a, b) => qualityScore(b) - qualityScore(a));\n\n  let bestMatchEvenIfProcessed = null;\n  let bestWithMacros = null;\n  let firstPayload = null;\n\n  for (const food of foods) {\n    const detail = await fetch(\n      `https://${host}/fdc/v1/food/${food.fdcId}?api_key=${key}`,\n      {\n        headers: { accept: \"application/json\" }\n      }\n    );\n    if (!detail.ok) continue;\n    const full = await detail.json();\n    const macros = extractMacrosFromFDC(full);\n    const nutrients = macros?.perServing\n      ? { ...macros.perServing }\n      : macros?.per100g\n        ? { ...macros.per100g }\n        : makeEmpty();\n    const payload = {\n      fdcId: full.fdcId,\n      description: full.description,\n      brand: full.brandOwner || null,\n      dataType: full.dataType || null,\n      nutrients,\n      nutrients_per_serving: macros?.perServing\n        ? { ...macros.perServing }\n        : null,\n      nutrients_per_100g: macros?.per100g ? { ...macros.per100g } : null,\n      serving: macros?.serving || null,\n      source: \"USDA_FDC\"\n    };\n\n    const combinedDesc = [\n      full.description,\n      full.additionalDescriptions,\n      full.ingredientStatement\n    ]\n      .filter(Boolean)\n      .join(\" \");\n    const processed = looksProcessed(combinedDesc);\n    const nameScore = scoreName(combinedDesc);\n    const matches = nameScore >= matchThreshold;\n    const hasMacros =\n      nutrients.energyKcal != null || nutrients.protein_g != null;\n\n    if (!firstPayload) firstPayload = payload;\n    if (!bestWithMacros && hasMacros) bestWithMacros = payload;\n    if (!bestMatchEvenIfProcessed && hasMacros && matches)\n      bestMatchEvenIfProcessed = payload;\n\n    if (hasMacros && matches && !processed) {\n      return payload;\n    }\n  }\n\n  if (bestMatchEvenIfProcessed) return bestMatchEvenIfProcessed;\n  if (bestWithMacros) return bestWithMacros;\n  if (firstPayload) return firstPayload;\n\n  const best = foods[0];\n  if (!best) return null;\n  return {\n    fdcId: best.fdcId,\n    description: best.description,\n    brand: best.brandOwner || null,\n    dataType: best.dataType || null,\n    nutrients: makeEmpty(),\n    nutrients_per_serving: null,\n    nutrients_per_100g: null,\n    serving: null,\n    source: \"USDA_FDC\"\n  };\n}\n\n// Calls our own /menu/uber-test INTERNALLY (no network), returns { ok, source, items: [...] }\nasync function callUberForMenu(env, query, address, opts = {}, ctx) {\n  const params = new URLSearchParams({\n    query,\n    address,\n    maxRows: String(opts.maxRows || 250),\n    page: String(opts.page || 1),\n    us: \"1\",\n    locale: opts.locale || \"en-US\"\n  });\n\n  const innerReq = new Request(\n    `https://dummy.local/menu/uber-test?${params.toString()}`,\n    {\n      method: \"GET\",\n      headers: { accept: \"application/json\" }\n    }\n  );\n\n  const innerRes = await _worker_impl.fetch(innerReq, env, ctx);\n  if (!innerRes || !innerRes.ok) {\n    return { ok: false, error: `uber-test HTTP ${innerRes?.status || 500}` };\n  }\n  const js = await innerRes.json();\n\n  const items =\n    (js && js.data && Array.isArray(js.data.items) && js.data.items) ||\n    (Array.isArray(js.items) && js.items) ||\n    [];\n\n  return { ok: true, source: js?.source || \"live\", items };\n}\n\nasync function r2WriteJSON(env, key, obj) {\n  if (!env?.R2_BUCKET) throw new Error(\"R2_BUCKET not bound\");\n  await env.R2_BUCKET.put(key, JSON.stringify(obj), {\n    httpMetadata: { contentType: \"application/json\" }\n  });\n}\n\nasync function handleDebugFetchBytes(request) {\n  const u = new URL(request.url);\n  const img = (u.searchParams.get(\"url\") || \"\").trim();\n  if (!img) return json({ ok: false, error: \"Missing ?url=\" }, { status: 400 });\n\n  try {\n    const r = await fetch(img, {\n      headers: {\n        \"User-Agent\": \"TummyBuddyWorker/1.0 (+https://tummybuddy.app)\",\n        Accept: \"image/*,*/*;q=0.8\"\n      }\n    });\n    const ct = r.headers.get(\"content-type\") || \"\";\n    const ab = await r.arrayBuffer();\n    const len = ab.byteLength;\n\n    const view = new Uint8Array(ab.slice(0, Math.min(2048, len)));\n    let s = \"\";\n    for (let i = 0; i < view.length; i++) s += String.fromCharCode(view[i]);\n    const b64_head = btoa(s).slice(0, 120);\n\n    return json({\n      ok: true,\n      status: r.status,\n      content_type: ct,\n      byte_length: len,\n      b64_head_sample: b64_head\n    });\n  } catch (e) {\n    return json({ ok: false, error: String(e?.message || e) }, { status: 502 });\n  }\n}\n\n// Replace the old HTTP-based helper with a direct Queue send:\nasync function enqueueDishDirect(env, payload) {\n  const id =\n    (globalThis.crypto?.randomUUID && crypto.randomUUID()) ||\n    `${Date.now()}-${Math.random().toString(36).slice(2)}`;\n  // The consumer expects an `id` and the job body. Adjust keys to match your consumer.\n  const message = { id, ...payload };\n  await env.ANALYSIS_QUEUE.send(JSON.stringify(message));\n  return { ok: true, id };\n}\n\n// ---- Step 41.12: enqueue top items + write lean placeholders ----\nasync function enqueueTopItems(\n  env,\n  topItems,\n  { place_id, cuisine, query, address, forceUS }\n) {\n  const jobs = await Promise.allSettled(\n    (Array.isArray(topItems) ? topItems : []).map(async (item) => {\n      const dish_name = item.name || item.title || \"Unknown Dish\";\n      const dish_desc = item.description || \"\";\n      const { ok, id } = await enqueueDishDirect(env, {\n        place_id,\n        dish_name,\n        dish_desc,\n        cuisine\n      });\n\n      const now = new Date().toISOString();\n      const lean = {\n        id,\n        status: \"queued\",\n        created_at: now,\n        updated_at: now,\n        place_id,\n        dish_name,\n        dish_desc,\n        cuisine,\n        source: \"uber-us\",\n        meta: { query, address, forceUS: !!forceUS }\n      };\n      await r2WriteJSON(env, `results/${id}.json`, lean);\n\n      return { id, dish_name, status: ok ? \"queued\" : \"error\" };\n    })\n  );\n\n  const enqueued = jobs.map((j) =>\n    j.status === \"fulfilled\" ? j.value : { error: String(j.reason) }\n  );\n  return { enqueued };\n}\n\nasync function handleMenuExtract(env, request, url, ctx) {\n  try {\n    const query = (\n      url.searchParams.get(\"q\") ||\n      url.searchParams.get(\"query\") ||\n      \"\"\n    ).trim();\n\n    const address = (url.searchParams.get(\"address\") || \"Miami, FL\").trim();\n    const userId = (url.searchParams.get(\"user_id\") || \"\").trim();\n    let cachedUserPrefs = null;\n    const getUserPrefs = async () => {\n      if (cachedUserPrefs) return cachedUserPrefs;\n      cachedUserPrefs = await loadUserPrefs(env, userId);\n      return cachedUserPrefs;\n    };\n\n    // NEW: optional web page that contains a menu image\n    const webUrlRaw = (url.searchParams.get(\"web_url\") || \"\").trim();\n\n    let ocrUrl = (url.searchParams.get(\"ocr_url\") || \"\").trim();\n    const forceReanalyze = url.searchParams.get(\"force_reanalyze\") === \"1\";\n    const analyze = url.searchParams.get(\"analyze\") === \"1\";\n    const debug = (url.searchParams.get(\"debug\") || \"\").trim();\n    const ocrParse = url.searchParams.get(\"ocr_parse\") === \"1\";\n    const forceLLM = url.searchParams.get(\"force_llm\") === \"1\";\n    const dry = url.searchParams.get(\"dry\") === \"1\";\n\n    // If caller gave a web page but no ocr_url, try to extract a good image link\n    if (!ocrUrl && webUrlRaw) {\n      let picked = null;\n\n      // First: try HTML parse (og:image, srcset, imgs)\n      try {\n        const html = await fetchHtml(env, webUrlRaw);\n        picked = pickMenuImageFromHtml(html, webUrlRaw);\n      } catch (e) {\n        // ignore here; we\u2019ll try a heuristic next\n      }\n\n      // Second: if still nothing, try a direct-image heuristic (e.g., Imgur)\n      if (!picked) {\n        const guess = normalizeGalleryToDirectImage(webUrlRaw);\n        if (guess) picked = guess;\n      }\n\n      if (picked) {\n        ocrUrl = picked;\n        if (debug === \"web\") {\n          return json({\n            ok: true,\n            source: \"web_adapter\",\n            web_url: webUrlRaw,\n            picked_image_url: picked,\n            note: \"picked_via_html_or_heuristic\"\n          });\n        }\n      } else if (debug === \"web\") {\n        return json(\n          {\n            ok: false,\n            source: \"web_adapter\",\n            web_url: webUrlRaw,\n            error: \"no_image_found\"\n          },\n          { status: 404 }\n        );\n      }\n    }\n\n    if (ocrUrl && !isOcrEnabled(env)) {\n      return json(\n        {\n          ok: false,\n          error: \"OCR tier is disabled. Set OCR_TIER_ENABLED=1 to enable.\",\n          hint: \"Remove ?ocr_url=... or enable the flag.\"\n        },\n        { status: 400 }\n      );\n    }\n\n    if (ocrUrl && isOcrEnabled(env)) {\n      try {\n        console.log(\"[OCR] calling Vision for:\", ocrUrl);\n        const { fullText, lines, raw } = await callVisionForText(env, ocrUrl);\n\n        let parsed = null;\n        if (ocrParse) {\n          parsed = parseOCRToCandidates(fullText);\n        }\n\n        return json({\n          ok: true,\n          source: \"ocr_vision_text\",\n          received: {\n            query,\n            address,\n            ocr_url: ocrUrl,\n            force_reanalyze: forceReanalyze,\n            analyze\n          },\n          counts: { lines: lines.length, chars: fullText.length },\n          preview: fullText.slice(0, 200),\n          lines_first_20: lines.slice(0, 20),\n          ...(ocrParse\n            ? {\n                parsed_count: parsed.length,\n                parsed_first_10: parsed.slice(0, 10)\n              }\n            : {}),\n          ...(debug === \"vision\"\n            ? {\n                vision_keys: raw ? Object.keys(raw) : [],\n                vision_raw_first: raw || null\n              }\n            : {})\n        });\n      } catch (err) {\n        console.warn(\"[OCR] Vision error:\", err);\n        return json(\n          {\n            ok: false,\n            source: \"ocr_vision_text\",\n            error: String(err?.message || err)\n          },\n          { status: 502 }\n        );\n      }\n    }\n\n    if (!query || !address) {\n      return new Response(\n        JSON.stringify({\n          ok: false,\n          error: \"Missing required parameters: query and address\",\n          hint: \"/menu/extract?query=McDonald's&address=Miami, FL\"\n        }),\n        {\n          status: 400,\n          headers: {\n            \"content-type\": \"application/json; charset=utf-8\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        }\n      );\n    }\n\n    let pickedSource = \"pending\";\n    let items = [];\n    let notes = {};\n    let uberResult = null;\n    let gItems = [];\n    let oItems = [];\n\n    if (dry) {\n      pickedSource = forceLLM ? \"none\" : \"none\";\n      const rawPrefs = await getUserPrefs();\n      const safePrefs =\n        rawPrefs && typeof rawPrefs === \"object\"\n          ? rawPrefs\n          : { allergens: [], fodmap: {} };\n      const itemsPersonal = Array.isArray(items)\n        ? items.map((it) => personalizeDishForUser({ ...it }, safePrefs))\n        : [];\n      return json(\n        {\n          ok: true,\n          source: pickedSource,\n          query,\n          address,\n          items: itemsPersonal,\n          user_prefs: safePrefs,\n          ...(debug ? { notes: { dry_mode: true } } : {})\n        },\n        { status: 200, headers: { \"access-control-allow-origin\": \"*\" } }\n      );\n    }\n\n    if (!forceLLM) {\n      try {\n        const uber = await callUberForMenu(\n          env,\n          query,\n          address,\n          { maxRows: 250, page: 1, locale: \"en-US\" },\n          ctx\n        );\n        uberResult = uber;\n        if (\n          uber &&\n          uber.ok &&\n          Array.isArray(uber.items) &&\n          uber.items.length > 0\n        ) {\n          pickedSource = \"uber\";\n        } else {\n          pickedSource = \"none\";\n          notes.uber = \"empty\";\n        }\n      } catch (e) {\n        pickedSource = \"none\";\n        notes.uber_error = String(e?.message || e);\n      }\n    } else {\n      notes.forced = \"llm\";\n      pickedSource = \"none\";\n    }\n\n    if (pickedSource === \"none\" || forceLLM) {\n      try {\n        const [grokRes, openaiRes] = await Promise.allSettled([\n          callGrokExtract(env, query, address),\n          callOpenAIExtract(env, query, address)\n        ]);\n\n        const grok =\n          grokRes.status === \"fulfilled\"\n            ? grokRes.value\n            : { ok: false, items: [], error: String(grokRes.reason) };\n        const openai =\n          openaiRes.status === \"fulfilled\"\n            ? openaiRes.value\n            : { ok: false, items: [], error: String(openaiRes.reason) };\n\n        gItems = normalizeLLMItems(grok.items, \"grok\");\n        oItems = normalizeLLMItems(openai.items, \"openai\");\n\n        if (gItems.length > 0 && oItems.length > 0) pickedSource = \"mixed\";\n        else if (gItems.length > 0) pickedSource = \"grok\";\n        else if (oItems.length > 0) pickedSource = \"openai\";\n        else pickedSource = \"none\";\n\n        if (debug) {\n          notes.grok_ok = !!grok.ok;\n          if (grok.error) notes.grok_error = grok.error;\n          if (grok.note) notes.grok_note = grok.note;\n          notes.openai_ok = !!openai.ok;\n          if (openai.error) notes.openai_error = openai.error;\n          if (openai.note) notes.openai_note = openai.note;\n        }\n      } catch (e) {\n        notes.llm_block_error = String(e?.message || e);\n        pickedSource = pickedSource === \"pending\" ? \"none\" : pickedSource;\n        items = Array.isArray(items) ? items : [];\n      }\n    }\n\n    const uberCanon =\n      pickedSource === \"uber\" || pickedSource === \"mixed\"\n        ? Array.isArray(uberResult?.items)\n          ? uberResult.items\n          : []\n        : [];\n\n    const llmCanon =\n      pickedSource === \"grok\" ||\n      pickedSource === \"openai\" ||\n      pickedSource === \"mixed\"\n        ? [...(gItems || []), ...(oItems || [])]\n        : [];\n\n    // ----- Auto-fallback: if Uber+LLM empty, try web_url -> OCR (even without ocr_url)\n    const totalPre =\n      (Array.isArray(uberCanon) ? uberCanon.length : 0) +\n      (Array.isArray(llmCanon) ? llmCanon.length : 0);\n    if (totalPre === 0 && !ocrUrl && webUrlRaw && isOcrEnabled(env)) {\n      let picked = null;\n      let fetchError = null;\n\n      try {\n        const html = await fetchHtml(env, webUrlRaw);\n        picked = pickMenuImageFromHtml(html, webUrlRaw);\n      } catch (e) {\n        fetchError = String(e?.message || e);\n      }\n\n      if (!picked) {\n        const guess = normalizeGalleryToDirectImage(webUrlRaw);\n        if (guess) picked = guess;\n      }\n\n      if (picked) {\n        ocrUrl = picked;\n        if (debug) {\n          const note = {\n            picked_image_url: picked,\n            note: \"picked_via_html_or_heuristic\"\n          };\n          if (fetchError) note.fetch_error = fetchError;\n          notes.web_adapter = note;\n        }\n      } else if (debug) {\n        const note = { error: \"no_image_found\" };\n        if (fetchError) note.fetch_error = fetchError;\n        notes.web_adapter = note;\n      }\n    }\n\n    // --- SMART OCR: only trigger if needed or explicitly forced ---\n    const forceOCR = url.searchParams.get(\"force_ocr\") === \"1\";\n    let ocrItemsCanon = [];\n    const uberCount = Array.isArray(uberCanon) ? uberCanon.length : 0;\n    const llmCount = Array.isArray(llmCanon) ? llmCanon.length : 0;\n    const shouldTryOCR =\n      isOcrEnabled(env) &&\n      ocrUrl &&\n      (forceOCR || pickedSource === \"none\" || uberCount + llmCount === 0);\n\n    if (shouldTryOCR) {\n      try {\n        const ocrCandidates = await fetchOCRCandidates(env, ocrUrl);\n        ocrItemsCanon = Array.isArray(ocrCandidates)\n          ? ocrCandidates.map(toCanonFromOCR)\n          : [];\n        if (debug)\n          notes.ocr_items = Array.isArray(ocrItemsCanon)\n            ? ocrItemsCanon.length\n            : 0;\n        if (ocrItemsCanon.length) {\n          if (pickedSource === \"none\" || pickedSource === \"pending\")\n            pickedSource = \"ocr\";\n          else pickedSource = \"mixed\";\n        } else {\n          if (debug) notes.ocr_note = \"ocr_no_items\";\n        }\n      } catch (e) {\n        if (debug) notes.ocr_error = String(e?.message || e);\n      }\n    }\n\n    if (Array.isArray(uberCanon) && !uberCanon.length)\n      notes.uber_note = \"no_uber_items\";\n    if (Array.isArray(llmCanon) && !llmCanon.length)\n      notes.llm_note = \"no_llm_items\";\n\n    const merged = mergeCanonItems(uberCanon, llmCanon, ocrItemsCanon);\n    const MAX = 250;\n    items = merged.slice(0, MAX);\n\n    if (uberCanon.length && (gItems?.length || oItems?.length)) {\n      pickedSource = \"mixed\";\n    }\n\n    if (analyze && Array.isArray(items) && items.length) {\n      const top = rankCanon(items, Number(url.searchParams.get(\"top\") || 25));\n      const place_id = url.searchParams.get(\"place_id\") || \"place.unknown\";\n      const cuisine = url.searchParams.get(\"cuisine\") || \"\";\n\n      const filteredTop = [];\n      for (const it of top) {\n        const cached = await maybeReturnCachedResult(request, env, {\n          place_id,\n          title: it.title || it.name\n        });\n        if (cached) {\n          try {\n            const cachedJson = JSON.parse(await cached.clone().text());\n            it.analysis = cachedJson;\n            it.source = \"cache:r2\";\n          } catch {}\n          continue;\n        }\n        filteredTop.push(it);\n      }\n\n      const shimUberShape = filteredTop.map((it) => ({\n        name: it.title || \"\",\n        description: it.description || \"\",\n        section: it.section || \"\",\n        price: typeof it.price_cents === \"number\" ? it.price_cents : null,\n        price_display: it.price_text || null\n      }));\n\n      const { enqueued } = await enqueueTopItems(env, shimUberShape, {\n        place_id,\n        cuisine,\n        query,\n        address,\n        forceUS: true\n      });\n\n      for (const dish of Array.isArray(items) ? items : []) {\n        if (!Array.isArray(dish.hits)) {\n          dish.hits = [];\n        }\n        if (dish.hits.length === 0) {\n          const inferredText = inferHitsFromText(\n            dish.title || dish.name || \"\",\n            dish.description || \"\"\n          );\n          if (inferredText.length) {\n            dish.hits = inferredText;\n          }\n        }\n        if (dish.hits.length === 0) {\n          const card = await fetchRecipeCard(\n            env,\n            dish.title || dish.name || query,\n            url.origin\n          );\n          if (card) {\n            if (Array.isArray(card.ingredients)) {\n              const inferredIngredients = inferHitsFromIngredients(\n                card.ingredients\n              );\n              if (inferredIngredients.length) dish.hits = inferredIngredients;\n            }\n            if (dish.hits.length === 0) {\n              const inferred = inferHitsFromRecipeCard(card);\n              if (inferred.length) dish.hits = inferred;\n            }\n          }\n        }\n      }\n\n      for (const dish of Array.isArray(top) ? top : []) {\n        if (!Array.isArray(dish.hits)) {\n          dish.hits = [];\n        }\n        if (dish.hits.length === 0) {\n          const inferredText = inferHitsFromText(\n            dish.title || dish.name || \"\",\n            dish.description || \"\"\n          );\n          if (inferredText.length) {\n            dish.hits = inferredText;\n          }\n        }\n        if (dish.hits.length === 0) {\n          const card = await fetchRecipeCard(\n            env,\n            dish.title || dish.name || query,\n            url.origin\n          );\n          if (card) {\n            if (Array.isArray(card.ingredients)) {\n              const inferredIngredients = inferHitsFromIngredients(\n                card.ingredients\n              );\n              if (inferredIngredients.length) dish.hits = inferredIngredients;\n            }\n            if (dish.hits.length === 0) {\n              const inferred = inferHitsFromRecipeCard(card);\n              if (inferred.length) dish.hits = inferred;\n            }\n          }\n        }\n      }\n      const rawPrefs = await getUserPrefs();\n      const safePrefs =\n        rawPrefs && typeof rawPrefs === \"object\"\n          ? rawPrefs\n          : { allergens: [], fodmap: {} };\n      const itemsPersonal = Array.isArray(items)\n        ? items.map((it) => personalizeDishForUser({ ...it }, safePrefs))\n        : [];\n      const topPersonal = Array.isArray(top)\n        ? top\n            .slice(0, 3)\n            .map((it) => personalizeDishForUser({ ...it }, safePrefs))\n        : [];\n      return json(\n        {\n          ok: true,\n          source: pickedSource,\n          query,\n          address,\n          total: items.length,\n          enqueued,\n          top_sample: topPersonal,\n          user_prefs: safePrefs,\n          items: itemsPersonal\n        },\n        { status: 200, headers: { \"access-control-allow-origin\": \"*\" } }\n      );\n    }\n\n    for (const dish of Array.isArray(items) ? items : []) {\n      if (!Array.isArray(dish.hits)) {\n        dish.hits = [];\n      }\n      if (dish.hits.length === 0) {\n        const inferred = inferHitsFromText(\n          dish.title || dish.name || \"\",\n          dish.description || \"\"\n        );\n        if (inferred.length) {\n          dish.hits = inferred;\n        }\n      }\n      if (dish.hits.length === 0) {\n        const card = await fetchRecipeCard(\n          env,\n          dish.title || dish.name || query,\n          url.origin\n        );\n        if (card) {\n          if (Array.isArray(card.ingredients)) {\n            const inferredIngredients = inferHitsFromIngredients(\n              card.ingredients\n            );\n            if (inferredIngredients.length) dish.hits = inferredIngredients;\n          }\n          if (dish.hits.length === 0) {\n            const inferredCard = inferHitsFromRecipeCard(card);\n            if (inferredCard.length) dish.hits = inferredCard;\n          }\n        }\n      }\n    }\n\n    const prefs = await getUserPrefs();\n    const safePrefs =\n      prefs && typeof prefs === \"object\"\n        ? prefs\n        : { allergens: [], fodmap: {} };\n    const itemsPersonal = Array.isArray(items)\n      ? items.map((it) => personalizeDishForUser(it, safePrefs))\n      : [];\n\n    return json(\n      {\n        ok: true,\n        source: pickedSource,\n        query,\n        address,\n        items: itemsPersonal,\n        user_prefs: safePrefs,\n        ...(debug ? { notes } : {})\n      },\n      { status: 200, headers: { \"access-control-allow-origin\": \"*\" } }\n    );\n  } catch (fatal) {\n    return new Response(\n      JSON.stringify({\n        ok: false,\n        error: \"extract_handler_failed\",\n        message: String(fatal?.message || fatal)\n      }),\n      {\n        status: 200,\n        headers: {\n          \"content-type\": \"application/json; charset=utf-8\",\n          \"access-control-allow-origin\": \"*\"\n        }\n      }\n    );\n  }\n}\n\nasync function handleRecipeResolve(env, request, url, ctx) {\n  const method = request.method || \"GET\";\n  let dish =\n    url.searchParams.get(\"dish\") || url.searchParams.get(\"title\") || \"\";\n  let place_id = url.searchParams.get(\"place_id\") || \"\";\n  let cuisine = url.searchParams.get(\"cuisine\") || \"\";\n  let lang = url.searchParams.get(\"lang\") || \"en\";\n  let body = {};\n\n  const providersParse = (\n    env.PROVIDERS_PARSE ||\n    env.provider_parse ||\n    \"zestful,openai\"\n  )\n    .split(\",\")\n    .map((s) => s.trim().toLowerCase())\n    .filter(Boolean);\n\n  const recipeProviderFns = {\n    edamam: fetchFromEdamam,\n    spoonacular: fetchFromSpoonacular,\n    openai: fetchFromOpenAI\n  };\n\n  const parseProviderFns = {\n    zestful: async (env, ingLines) => callZestful(env, ingLines),\n    openai: async () => null // placeholder (skip for now)\n  };\n\n  if (method === \"POST\") {\n    try {\n      body = await request.json();\n    } catch {}\n    dish = String(body.dish || body.title || dish || \"\");\n    place_id = String(body.place_id || place_id || \"\");\n    cuisine = String(body.cuisine || cuisine || \"\");\n    lang = String(body.lang || lang || \"en\");\n  }\n\n  if (!dish.trim()) {\n    return new Response(\n      JSON.stringify({\n        ok: false,\n        error: 'Missing \"dish\" (dish name).',\n        hint: \"Use: /recipe/resolve?dish=Chicken%20Alfredo\"\n      }),\n      {\n        status: 400,\n        headers: {\n          \"content-type\": \"application/json\",\n          \"access-control-allow-origin\": \"*\"\n        }\n      }\n    );\n  }\n\n  const cacheKey = recipeCacheKey(dish, lang);\n  const force = url.searchParams.get(\"force_reanalyze\") === \"1\";\n  const classify = url.searchParams.get(\"classify\") === \"1\";\n  const wantShape = (url.searchParams.get(\"shape\") || \"\").toLowerCase();\n  let pickedSource = \"cache\";\n  let recipe = null;\n  let ingredients = [];\n  let notes = {};\n  let out = null;\n  let selectedProvider = null;\n  let cacheHit = false;\n\n  const cached = await recipeCacheRead(env, cacheKey);\n  if (cached && cached.recipe && Array.isArray(cached.ingredients) && !force) {\n    cacheHit = true;\n    pickedSource = cached.from || cached.provider || \"cache\";\n    recipe = cached.recipe;\n    ingredients = Array.isArray(cached.ingredients)\n      ? [...cached.ingredients]\n      : [];\n    notes =\n      typeof cached.notes === \"object\" && cached.notes\n        ? { ...cached.notes }\n        : {};\n    out = {\n      ...cached,\n      cache: true,\n      recipe,\n      ingredients\n    };\n    selectedProvider = pickedSource;\n\n    if (wantShape === \"recipe_card\") {\n      const dishTitle = dish;\n      const rc = {\n        ok: true,\n        component: \"RecipeCard\",\n        version: \"v1\",\n        dish: { name: dishTitle, cuisine: cuisine || null },\n        ingredients: ingredients.map((i) => ({\n          name: i.name,\n          qty: i.qty ?? null,\n          unit: i.unit ?? null\n        })),\n        recipe: {\n          steps:\n            recipe?.steps && Array.isArray(recipe.steps) ? recipe.steps : [],\n          notes:\n            recipe?.notes && Array.isArray(recipe.notes) ? recipe.notes : null\n        },\n        molecular: { compounds: [], organs: {}, organ_summary: {} } // will fill if Premium\n      };\n\n      // Premium gate (same logic as non-cached branch)\n      let isPremium = false;\n      const gateParams = new URLSearchParams(url.search);\n      const userId = (gateParams.get(\"user_id\") || \"\").trim();\n      if (gateParams.get(\"dev\") === \"1\") isPremium = true;\n      else if (userId && env.LEXICON_CACHE) {\n        const kvKey = `tier/user:${userId}`;\n        const tier = await env.LEXICON_CACHE.get(kvKey);\n        isPremium = String(tier || \"\").toLowerCase() === \"premium\";\n      }\n\n      if (isPremium && Array.isArray(ingredients) && ingredients.length) {\n        const foundCompounds = [];\n        const organMap = {};\n        // Quick bridge: map common ingredients to likely compounds before DB lookups\n        const BRIDGE = {\n          garlic: [\"allicin\"],\n          \"olive oil\": [\"oleocanthal\"],\n          turmeric: [\"curcumin\"],\n          parmesan: [\"histamine\"],\n          \"aged cheese\": [\"histamine\"],\n          cream: [\"lactose\"],\n          butter: [\"lactose\"],\n          milk: [\"lactose\"],\n          parsley: [\"apigenin\"],\n          nutmeg: [\"myristicin\"]\n        };\n        const seenCompounds = new Set();\n        for (const ing of ingredients) {\n          const term = (ing?.name || \"\").toLowerCase().trim();\n          if (!term) continue;\n\n          // Use ingredient term + any bridged compound hints\n          const searchTerms = [term, ...(BRIDGE[term] || [])];\n          for (const sTerm of searchTerms) {\n            const cRes = await env.D1_DB.prepare(\n              `SELECT id, name, common_name, cid\n                        FROM compounds\n                        WHERE LOWER(name) = ? OR LOWER(common_name) = ?\n                           OR LOWER(name) LIKE ? OR LOWER(common_name) LIKE ?\n                        ORDER BY name LIMIT 5`\n            )\n              .bind(sTerm, sTerm, `%${sTerm}%`, `%${sTerm}%`)\n              .all();\n\n            const comps = cRes?.results || [];\n            for (const c of comps) {\n              const key = (c.name || \"\").toLowerCase();\n              if (seenCompounds.has(key)) continue;\n              seenCompounds.add(key);\n\n              const eRes = await env.D1_DB.prepare(\n                `SELECT organ, effect, strength, notes\n                          FROM compound_organ_effects\n                          WHERE compound_id = ?`\n              )\n                .bind(c.id)\n                .all();\n              const effs = eRes?.results || [];\n\n              foundCompounds.push({\n                name: c.name,\n                from_ingredient: ing.name,\n                cid: c.cid || null\n              });\n              for (const e of effs) {\n                const k = e.organ || \"unknown\";\n                if (!organMap[k]) organMap[k] = [];\n                organMap[k].push({\n                  compound: c.name,\n                  effect: e.effect,\n                  strength: e.strength,\n                  notes: e.notes || null\n                });\n              }\n            }\n          }\n        }\n        // De-duplicate organ effects (ignore notes)\n        for (const [org, list] of Object.entries(organMap)) {\n          const seen = new Set();\n          organMap[org] = list.filter((row) => {\n            const key = `${org}|${row.compound}|${row.effect}`.toLowerCase();\n            if (seen.has(key)) return false;\n            seen.add(key);\n            return true;\n          });\n        }\n        const organSummary = {};\n        for (const [org, list] of Object.entries(organMap)) {\n          let plus = 0,\n            minus = 0,\n            neutral = 0;\n          for (const row of list) {\n            if (row.effect === \"benefit\") plus++;\n            else if (row.effect === \"risk\") minus++;\n            else neutral++;\n          }\n          organSummary[org] = { plus, minus, neutral };\n        }\n        // Build human headlines from organ_summary\n        function headlineFor({ plus = 0, minus = 0 }) {\n          if (minus > 0 && plus === 0) return \"\u26A0\uFE0F Risk\";\n          if (plus > 0 && minus === 0) return \"\uD83D\uDC4D Benefit\";\n          if (plus > 0 && minus > 0) return \"\u2194\uFE0F Mixed\";\n          return \"\u2139\uFE0F Neutral\";\n        }\n        const organ_headlines = Object.entries(organSummary).map(\n          ([org, counts]) =>\n            `${org[0].toUpperCase()}${org.slice(1)}: ${headlineFor(counts)}`\n        );\n\n        // UI: organ icons (fallback to \uD83E\uDDEC)\n        const ORG_ICON = {\n          heart: \"\u2764\uFE0F\",\n          gut: \"\uD83E\uDDA0\",\n          liver: \"\uD83E\uDDEA\",\n          brain: \"\uD83E\uDDE0\",\n          immune: \"\uD83D\uDEE1\uFE0F\"\n        };\n        rc.molecular_icons = Object.keys(organSummary).reduce((m, org) => {\n          m[org] = ORG_ICON[org] || \"\uD83E\uDDEC\";\n          return m;\n        }, {});\n\n        // Humanized Biology: simple, friendly tips per organ\n        function humanizeOrgans(summary) {\n          const tips = [];\n          for (const [org, { plus = 0, minus = 0 }] of Object.entries(\n            summary\n          )) {\n            const Org = org.charAt(0).toUpperCase() + org.slice(1);\n            let line = `${Org}: `;\n            if (minus > 0 && plus === 0)\n              line +=\n                \"may bother sensitive tummies\u2014consider smaller portions or swaps.\";\n            else if (plus > 0 && minus === 0)\n              line += \"generally friendly in normal portions.\";\n            else if (plus > 0 && minus > 0)\n              line += \"mixed signal\u2014portion size and add-ons matter.\";\n            else line += \"no clear signal\u2014use your judgment.\";\n            tips.push(line);\n          }\n          return tips;\n        }\n        rc.molecular_human = { organ_tips: humanizeOrgans(organSummary) };\n\n        // ---- Polishing block: overall summary + sentiment + version/timestamp ----\n        const totals = Object.entries(organSummary).reduce(\n          (a, [org, c]) => {\n            a.plus += c.plus || 0;\n            a.minus += c.minus || 0;\n            if ((c.minus || 0) > 0) a.riskOrgs.push(org);\n            if ((c.plus || 0) > 0) a.benefitOrgs.push(org);\n            return a;\n          },\n          { plus: 0, minus: 0, riskOrgs: [], benefitOrgs: [] }\n        );\n\n        function titleize(s) {\n          return s ? s.charAt(0).toUpperCase() + s.slice(1) : s;\n        }\n        const riskStr = totals.riskOrgs.map(titleize).join(\", \");\n        const benefitStr = totals.benefitOrgs.map(titleize).join(\", \");\n        let overall_label = \"Neutral\";\n        if (totals.minus > 0 && totals.plus === 0) overall_label = \"Caution\";\n        else if (totals.plus > 0 && totals.minus === 0)\n          overall_label = \"Supportive\";\n        else if (totals.plus > 0 && totals.minus > 0) overall_label = \"Mixed\";\n\n        const summary_sentence =\n          overall_label === \"Caution\"\n            ? `\u26A0\uFE0F May bother ${riskStr || \"sensitive tummies\"}.`\n            : overall_label === \"Supportive\"\n              ? `\uD83D\uDC4D Generally friendly for ${benefitStr || \"wellbeing\"} in normal portions.`\n              : overall_label === \"Mixed\"\n                ? `\u2194\uFE0F Mixed signal \u2014 supportive for ${benefitStr || \"some organs\"}, but caution for ${riskStr || \"others\"}.`\n                : `\u2139\uFE0F No clear signal \u2014 use your judgment.`;\n\n        // Add polished fields\n        rc.molecular_human = {\n          ...(rc.molecular_human || {}),\n          summary: summary_sentence,\n          sentiment: overall_label\n        };\n\n        // Version + timestamp for the card payload\n        rc.payload_version = \"recipe_card.v1.1\";\n        rc.generated_at = new Date().toISOString();\n\n        // Optional: tweak the badge when gated vs premium (keep your existing logic if present)\n        if (rc?.molecular?.compounds?.length >= 0 && !rc.molecular.gated) {\n          rc.molecular_badge = `Molecular Insights: ${rc.molecular.compounds.length} compounds \u2022 ${Object.keys(rc.molecular.organ_summary || {}).length} organs`;\n        } else if (rc?.molecular?.gated) {\n          rc.molecular_badge = \"Molecular Insights: upgrade for details\";\n        }\n\n        // include in payload\n        rc.molecular = {\n          compounds: foundCompounds,\n          organs: organMap,\n          organ_summary: organSummary,\n          organ_headlines\n        };\n        rc.molecular_badge = `Molecular Insights: ${foundCompounds.length} compounds \u2022 ${Object.keys(organSummary).length} organs`;\n\n        // Flags & counts (must run after rc.molecular is set)\n        rc.has_molecular =\n          !rc?.molecular?.gated &&\n          Array.isArray(rc?.molecular?.compounds) &&\n          rc.molecular.compounds.length > 0;\n\n        rc.molecular_counts = {\n          compounds: Array.isArray(rc?.molecular?.compounds)\n            ? rc.molecular.compounds.length\n            : 0,\n          organs: rc?.molecular?.organ_summary\n            ? Object.keys(rc.molecular.organ_summary).length\n            : 0\n        };\n\n        // If caller asked to classify, enqueue a job and include enqueued[]\n        const wantClassify = url.searchParams.get(\"classify\") === \"1\";\n        if (wantClassify) {\n          const dishTitleCard = rc?.dish?.name || dish || \"Unknown Dish\";\n          const payload = {\n            place_id: place_id || \"place.unknown\",\n            dish_name: dishTitleCard,\n            dish_desc:\n              (Array.isArray(rc?.recipe?.notes)\n                ? rc.recipe.notes.join(\"; \")\n                : rc?.recipe?.steps?.[0] || \"\") || \"\",\n            cuisine: cuisine || \"\",\n            ingredients: (rc?.ingredients || []).map((i) => ({\n              name: i.name,\n              qty: i.qty ?? null,\n              unit: i.unit ?? null\n            }))\n          };\n          const { ok: enqOk, id } = await enqueueDishDirect(env, payload);\n          rc.enqueued =\n            enqOk && id ? [{ id, dish_name: payload.dish_name }] : [];\n        }\n      } else {\n        rc.molecular = {\n          compounds: [],\n          organs: {},\n          organ_summary: {},\n          gated: true\n        };\n        rc.molecular_badge = \"Molecular Insights: upgrade for details\";\n      }\n\n      // attach dish nutrition to the card\n      if (!out?.nutrition_summary && Array.isArray(out?.ingredients_parsed)) {\n        out.nutrition_summary = sumNutrition(out.ingredients_parsed);\n      }\n      rc.nutrition_summary = out?.nutrition_summary || null;\n      if (rc.nutrition_summary) {\n        rc.nutrition_badges = [\n          `${Math.round(rc.nutrition_summary.energyKcal)} kcal`,\n          `${Math.round(rc.nutrition_summary.protein_g)} g protein`,\n          `${Math.round(rc.nutrition_summary.fat_g)} g fat`,\n          `${Math.round(rc.nutrition_summary.carbs_g)} g carbs`,\n          `${Math.round(rc.nutrition_summary.sodium_mg)} mg sodium`\n        ];\n      }\n\n      return new Response(JSON.stringify(rc, null, 2), {\n        status: 200,\n        headers: {\n          \"content-type\": \"application/json; charset=utf-8\",\n          \"access-control-allow-origin\": \"*\"\n        }\n      });\n    }\n  } else {\n    // Provider loop (deterministic order)\n    let lastAttempt = null;\n    for (const p of providerOrder(env)) {\n      const fn = recipeProviderFns[p];\n      if (!fn) continue;\n      let candidate = null;\n      try {\n        candidate = await fn(env, dish, cuisine, lang);\n      } catch (err) {\n        console.warn(`[provider:${p}]`, err?.message || err);\n        continue;\n      }\n      if (candidate) {\n        lastAttempt = candidate;\n      }\n      if (\n        candidate &&\n        Array.isArray(candidate.ingredients) &&\n        candidate.ingredients.length\n      ) {\n        out = candidate;\n        selectedProvider = candidate.provider || p;\n        break;\n      }\n    }\n    if (!out && lastAttempt) {\n      out = lastAttempt;\n      if (!selectedProvider) {\n        selectedProvider = lastAttempt.provider || null;\n      }\n    }\n  }\n\n  if (!cacheHit) {\n    if (\n      selectedProvider &&\n      out &&\n      Array.isArray(out.ingredients) &&\n      out.ingredients.length\n    ) {\n      recipe = out.recipe || recipe;\n      pickedSource = selectedProvider;\n    } else {\n      pickedSource = \"pending\";\n      if (out?.note) notes.openai_note = out.note;\n      if (out?.error) notes.openai_error = out.error;\n      if (out?.reason) notes.provider_reason = out.reason;\n    }\n  }\n\n  const wantParse = url.searchParams.get(\"parse\") !== \"0\";\n  // Normalize to lines no matter which provider filled 'out'\n  const sourceLines = Array.isArray(out?.ingredients)\n    ? out.ingredients\n    : Array.isArray(out?.ingredients_lines)\n      ? out.ingredients_lines\n      : [];\n\n  const ingLines = Array.isArray(sourceLines)\n    ? sourceLines.map(ingredientEntryToLine).filter(Boolean)\n    : [];\n\n  if (!out) out = {};\n  out.ingredients_lines = ingLines;\n\n  let parsed = null;\n  const kv = env.MENUS_CACHE || env.LEXICON_CACHE;\n  const dailyCap = parseInt(env.ZESTFUL_DAILY_CAP || \"0\", 10);\n\n  if (wantParse && ingLines.length && env.ZESTFUL_RAPID_KEY) {\n    const cached = [];\n    const missingIdx = [];\n    if (kv) {\n      for (let i = 0; i < ingLines.length; i++) {\n        const k = `zestful:${ingLines[i].toLowerCase()}`;\n        let row = null;\n        try {\n          row = await kv.get(k, \"json\");\n        } catch {}\n        if (row) cached[i] = row;\n        else missingIdx.push(i);\n      }\n    }\n\n    let filled = cached.slice();\n    if (missingIdx.length === ingLines.length || !kv) {\n      const linesToParse = ingLines;\n      const toParse = linesToParse.length;\n      if (dailyCap) {\n        const usedNow = await getZestfulCount(env);\n        if (usedNow + toParse > dailyCap) {\n          console.log(\n            \"[parse] zestful cap guard\",\n            usedNow,\n            \"+\",\n            toParse,\n            \">\",\n            dailyCap\n          );\n          return json(\n            {\n              ok: false,\n              error: \"ZESTFUL_CAP_REACHED\",\n              used: usedNow,\n              toParse,\n              cap: dailyCap\n            },\n            { status: 429 }\n          );\n        }\n      }\n      const zest = await callZestful(env, linesToParse);\n      if (Array.isArray(zest) && zest.length) {\n        filled = zest;\n        if (kv) {\n          for (let i = 0; i < linesToParse.length; i++) {\n            const k = `zestful:${linesToParse[i].toLowerCase()}`;\n            if (zest[i]) {\n              await kv.put(k, JSON.stringify(zest[i]), {\n                expirationTtl: 60 * 60 * 24 * 30\n              });\n            }\n          }\n        }\n        await incZestfulCount(env, toParse);\n      }\n    } else if (missingIdx.length) {\n      const linesToParse = missingIdx.map((i) => ingLines[i]);\n      const toParse = linesToParse.length;\n      if (dailyCap) {\n        const usedNow = await getZestfulCount(env);\n        if (usedNow + toParse > dailyCap) {\n          console.log(\n            \"[parse] zestful cap guard\",\n            usedNow,\n            \"+\",\n            toParse,\n            \">\",\n            dailyCap\n          );\n          return json(\n            {\n              ok: false,\n              error: \"ZESTFUL_CAP_REACHED\",\n              used: usedNow,\n              toParse,\n              cap: dailyCap\n            },\n            { status: 429 }\n          );\n        }\n      }\n      const zest = await callZestful(env, linesToParse);\n      if (Array.isArray(zest) && zest.length) {\n        for (let j = 0; j < linesToParse.length; j++) {\n          const i = missingIdx[j];\n          filled[i] = zest[j];\n          if (kv && zest[j]) {\n            const k = `zestful:${ingLines[i].toLowerCase()}`;\n            await kv.put(k, JSON.stringify(zest[j]), {\n              expirationTtl: 60 * 60 * 24 * 30\n            });\n          }\n        }\n        await incZestfulCount(env, toParse);\n      }\n    }\n\n    if (filled.filter(Boolean).length === ingLines.length) parsed = filled;\n  }\n\n  if (!parsed && wantParse && ingLines.length) {\n    for (const p of providersParse) {\n      if (p === \"zestful\") continue;\n      const fn = parseProviderFns[p];\n      if (!fn) continue;\n      try {\n        const got = await fn(env, ingLines);\n        if (Array.isArray(got) && got.length) {\n          parsed = got;\n          break;\n        }\n      } catch (e) {\n        console.log(`[parse] provider ${p} error:`, e?.message || String(e));\n      }\n    }\n  }\n\n  if (parsed?.length) {\n    await enrichWithNutrition(env, parsed);\n    ingredients = parsed.map((row) => ({\n      name: row.name || row.original || \"\",\n      qty:\n        typeof row.qty === \"number\"\n          ? row.qty\n          : row.qty != null\n            ? Number(row.qty) || null\n            : null,\n      unit: row.unit || null,\n      comment: row.comment || row.preparationNotes || null\n    }));\n    out.ingredients_parsed = parsed;\n    out.nutrition_summary = sumNutrition(parsed);\n  } else if (\n    Array.isArray(out?.ingredients_structured) &&\n    out.ingredients_structured.length\n  ) {\n    ingredients = out.ingredients_structured.map((row) => ({\n      name: row.name || row.original || \"\",\n      qty: row.qty ?? row.quantity ?? null,\n      unit: row.unit ?? null,\n      comment: row.comment || row.preparation || row.preparationNotes || null\n    }));\n  } else if (\n    Array.isArray(out?.ingredients) &&\n    out.ingredients.every(\n      (x) => x && typeof x === \"object\" && (\"name\" in x || \"original\" in x)\n    )\n  ) {\n    ingredients = out.ingredients.map((row) => ({\n      name: row.name || row.original || \"\",\n      qty: row.qty ?? row.quantity ?? null,\n      unit: row.unit ?? null,\n      comment: row.comment || row.preparation || row.preparationNotes || null\n    }));\n  } else if (ingLines.length) {\n    ingredients = ingLines.map((text) => ({\n      name: text,\n      qty: null,\n      unit: null,\n      comment: null\n    }));\n  }\n\n  if (!cacheHit && recipe && Array.isArray(ingredients) && ingredients.length) {\n    await recipeCacheWrite(env, cacheKey, {\n      recipe,\n      ingredients,\n      from: pickedSource\n    });\n  }\n\n  const responseSource = cacheHit ? \"cache\" : pickedSource;\n\n  // --- normalize cached payloads to the new shape ---\n  if (out) {\n    if (out.recipe && !out.recipe.title && out.recipe.name) {\n      out.recipe.title = out.recipe.name;\n    }\n    if (\n      Array.isArray(out.ingredients_structured) &&\n      out.ingredients_structured.length\n    ) {\n      out.ingredients_parsed = out.ingredients_structured;\n      if (\n        !Array.isArray(out.ingredients_lines) ||\n        !out.ingredients_lines.length\n      ) {\n        out.ingredients_lines = out.ingredients_structured\n          .map((x) => ingredientEntryToLine(x))\n          .filter(Boolean);\n      }\n    }\n    if (!Array.isArray(out.ingredients_lines)) {\n      if (Array.isArray(out.ingredients)) {\n        const looksStructured = out.ingredients.every(\n          (x) => x && typeof x === \"object\" && \"name\" in x\n        );\n        if (looksStructured) {\n          out.ingredients_parsed = out.ingredients;\n          out.ingredients_lines = out.ingredients.map((x) => {\n            const qty = x.qty !== undefined && x.qty !== null ? `${x.qty}` : \"\";\n            const unit = x.unit ? ` ${x.unit}` : \"\";\n            const name = x.name || \"\";\n            const comment = x.comment ? `, ${x.comment}` : \"\";\n            return [qty, unit, name, comment].join(\"\").trim();\n          });\n        } else {\n          out.ingredients_lines = out.ingredients;\n        }\n      } else {\n        out.ingredients_lines = [];\n      }\n    }\n  }\n\n  if (classify && recipe && Array.isArray(ingredients) && ingredients.length) {\n    const stampKey = classifyStampKey(dish, place_id, lang);\n    const recent = await getClassifyStamp(env, stampKey);\n    if (recent && recent.id) {\n      return new Response(\n        JSON.stringify({\n          ok: true,\n          source: responseSource || \"cache\",\n          dish,\n          place_id: place_id || null,\n          cuisine: cuisine || null,\n          lang,\n          cache: cacheHit,\n          enqueued: [{ id: recent.id, dish_name: dish, recent: true }],\n          recipe,\n          ingredients\n        }),\n        {\n          status: 200,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        }\n      );\n    }\n\n    const classifySource =\n      out?.ingredients_parsed || out?.ingredients_lines || ingredients;\n    const payload = {\n      place_id: place_id || \"place.unknown\",\n      dish_name: dish,\n      dish_desc:\n        (Array.isArray(recipe?.notes)\n          ? recipe.notes.join(\"; \")\n          : recipe?.steps?.[0] || \"\") || \"\",\n      cuisine: cuisine || \"\",\n      ingredients: (Array.isArray(classifySource) ? classifySource : []).map(\n        (i) => {\n          if (typeof i === \"string\") {\n            return { name: i, qty: null, unit: null };\n          }\n          return {\n            name: i.name || i.original || \"\",\n            qty: i.qty ?? null,\n            unit: i.unit ?? null\n          };\n        }\n      )\n    };\n    const { ok: enqueuedOk, id } = await enqueueDishDirect(env, payload);\n\n    if (enqueuedOk && id) {\n      await setClassifyStamp(\n        env,\n        stampKey,\n        { id, dish, place_id, when: Date.now() },\n        6 * 3600\n      );\n    }\n\n    return new Response(\n      JSON.stringify({\n        ok: true,\n        source: responseSource || \"edamam\",\n        dish,\n        place_id: payload.place_id,\n        cuisine,\n        cache: true,\n        enqueued: enqueuedOk ? [{ id, dish_name: payload.dish_name }] : [],\n        recipe,\n        ingredients\n      }),\n      {\n        status: 200,\n        headers: {\n          \"content-type\": \"application/json\",\n          \"access-control-allow-origin\": \"*\"\n        }\n      }\n    );\n  }\n\n  if (out && !out.provider) {\n    out.provider = out.cache ? \"cache\" : (out.provider ?? null);\n  }\n\n  const reply = {\n    ok: true,\n    source: responseSource,\n    dish,\n    place_id: place_id || null,\n    cuisine: cuisine || null,\n    lang,\n    cache: cacheHit,\n    recipe,\n    ingredients,\n    ...(out?.ingredients_lines\n      ? { ingredients_lines: out.ingredients_lines }\n      : {}),\n    ...(out?.ingredients_parsed\n      ? { ingredients_parsed: out.ingredients_parsed }\n      : {}),\n    ...(Object.keys(notes).length ? { notes } : {})\n  };\n\n  out = out ? { ...out, ...reply } : { ...reply };\n\n  if (wantShape === \"likely_recipe\" || wantShape === \"likely_recipe_md\") {\n    const ingForCookbook =\n      (out?.ingredients_lines && out.ingredients_lines.length\n        ? out.ingredients_lines\n        : ingredients) || [];\n    const stepSource =\n      (Array.isArray(recipe?.steps) && recipe.steps.length\n        ? recipe.steps\n        : Array.isArray(out?.recipe?.steps)\n          ? out.recipe.steps\n          : []) || [];\n    const servingInfo =\n      recipe && typeof recipe === \"object\"\n        ? {\n            servings: recipe.servings ?? recipe.yield ?? null,\n            grams: recipe.grams ?? null\n          }\n        : null;\n    const md = formatLikelyRecipeMarkdown({\n      dishName: dish,\n      rawIngredients: ingForCookbook,\n      rawSteps: stepSource,\n      servingInfo\n    });\n    return new Response(md, {\n      status: 200,\n      headers: {\n        \"content-type\": \"text/markdown; charset=utf-8\",\n        \"access-control-allow-origin\": \"*\"\n      }\n    });\n  }\n\n  // ==== OPTIONAL SHAPE: RecipeCard ===================================\n  // If caller requests ?shape=recipe_card, return the fixed UI payload.\n  if (wantShape === \"recipe_card\") {\n    const dishTitle =\n      dish || body?.dish || url.searchParams.get(\"dish\") || \"Unknown Dish\";\n    const rc = {\n      ok: true,\n      component: \"RecipeCard\",\n      version: \"v1\",\n      dish: { name: dishTitle, cuisine: cuisine || null },\n      ingredients: Array.isArray(ingredients)\n        ? ingredients.map((i) => ({\n            name: i.name,\n            qty: i.qty ?? null,\n            unit: i.unit ?? null\n          }))\n        : [],\n      recipe: {\n        steps: recipe?.steps && Array.isArray(recipe.steps) ? recipe.steps : [],\n        notes:\n          recipe?.notes && Array.isArray(recipe.notes) ? recipe.notes : null\n      },\n      molecular: { compounds: [], organs: {}, organ_summary: {} } // filled only for Premium\n    };\n\n    // Premium enrichment (ingredient -> compounds -> organ effects)\n    const gateParams = new URLSearchParams(url.search);\n    const userId = (gateParams.get(\"user_id\") || \"\").trim();\n    let isPremium = false;\n    if (gateParams.get(\"dev\") === \"1\") isPremium = true;\n    else if (userId) {\n      const kvKey = `tier/user:${userId}`;\n      const tier = await (env.LEXICON_CACHE\n        ? env.LEXICON_CACHE.get(kvKey)\n        : null);\n      isPremium = String(tier || \"\").toLowerCase() === \"premium\";\n    }\n\n    if (isPremium && Array.isArray(ingredients) && ingredients.length) {\n      const foundCompounds = [];\n      const organMap = {};\n      // Quick bridge: map common ingredients to likely compounds before DB lookups\n      const BRIDGE = {\n        garlic: [\"allicin\"],\n        \"olive oil\": [\"oleocanthal\"],\n        turmeric: [\"curcumin\"],\n        parmesan: [\"histamine\"],\n        \"aged cheese\": [\"histamine\"],\n        cream: [\"lactose\"],\n        butter: [\"lactose\"],\n        milk: [\"lactose\"],\n        parsley: [\"apigenin\"],\n        nutmeg: [\"myristicin\"]\n      };\n      const seenCompounds = new Set();\n      for (const ing of ingredients) {\n        const term = (ing?.name || \"\").toLowerCase().trim();\n        if (!term) continue;\n\n        const cRes = await env.D1_DB.prepare(\n          `SELECT id, name, common_name, cid\n           FROM compounds\n           WHERE LOWER(name) LIKE ? OR LOWER(common_name) LIKE ?\n           ORDER BY name LIMIT 5`\n        )\n          .bind(`%${term}%`, `%${term}%`)\n          .all();\n\n        const comps = cRes?.results || [];\n        for (const c of comps) {\n          const eRes = await env.D1_DB.prepare(\n            `SELECT organ, effect, strength, notes\n             FROM compound_organ_effects\n             WHERE compound_id = ?`\n          )\n            .bind(c.id)\n            .all();\n          const effs = eRes?.results || [];\n\n          foundCompounds.push({\n            name: c.name,\n            from_ingredient: ing.name,\n            cid: c.cid || null\n          });\n          for (const e of effs) {\n            const k = e.organ || \"unknown\";\n            if (!organMap[k]) organMap[k] = [];\n            organMap[k].push({\n              compound: c.name,\n              effect: e.effect,\n              strength: e.strength,\n              notes: e.notes || null\n            });\n          }\n        }\n      }\n\n      const organSummary = {};\n      for (const [org, list] of Object.entries(organMap)) {\n        let plus = 0,\n          minus = 0,\n          neutral = 0;\n        for (const row of list) {\n          if (row.effect === \"benefit\") plus++;\n          else if (row.effect === \"risk\") minus++;\n          else neutral++;\n        }\n        organSummary[org] = { plus, minus, neutral };\n      }\n\n      rc.molecular = {\n        compounds: foundCompounds,\n        organs: organMap,\n        organ_summary: organSummary\n      };\n    } else {\n      rc.molecular = {\n        compounds: [],\n        organs: {},\n        organ_summary: {},\n        gated: true\n      };\n    }\n\n    // attach dish nutrition to the card\n    if (!out?.nutrition_summary && Array.isArray(out?.ingredients_parsed)) {\n      out.nutrition_summary = sumNutrition(out.ingredients_parsed);\n    }\n    rc.nutrition_summary = out?.nutrition_summary || null;\n    if (rc.nutrition_summary) {\n      rc.nutrition_badges = [\n        `${Math.round(rc.nutrition_summary.energyKcal)} kcal`,\n        `${Math.round(rc.nutrition_summary.protein_g)} g protein`,\n        `${Math.round(rc.nutrition_summary.fat_g)} g fat`,\n        `${Math.round(rc.nutrition_summary.carbs_g)} g carbs`,\n        `${Math.round(rc.nutrition_summary.sodium_mg)} mg sodium`\n      ];\n    }\n\n    return new Response(JSON.stringify(rc, null, 2), {\n      status: 200,\n      headers: {\n        \"content-type\": \"application/json; charset=utf-8\",\n        \"access-control-allow-origin\": \"*\"\n      }\n    });\n  }\n  // ==================================================================\n\n  if (out) {\n    if (!out.provider && out.cache) out.provider = \"cache\";\n    if (!out.provider && !out.cache) out.provider = \"unknown\";\n  }\n\n  if (wantShape === \"insights_feed\") {\n    if (!out?.nutrition_summary && Array.isArray(out?.ingredients_parsed)) {\n      out.nutrition_summary = sumNutrition(out.ingredients_parsed);\n    }\n    if (out?.nutrition_summary) {\n      out.nutrition_badges = [\n        `${Math.round(out.nutrition_summary.energyKcal)} kcal`,\n        `${Math.round(out.nutrition_summary.protein_g)} g protein`,\n        `${Math.round(out.nutrition_summary.fat_g)} g fat`,\n        `${Math.round(out.nutrition_summary.carbs_g)} g carbs`\n      ];\n    }\n  }\n\n  return new Response(JSON.stringify(out), {\n    status: 200,\n    headers: {\n      \"content-type\": \"application/json; charset=utf-8\",\n      \"access-control-allow-origin\": \"*\"\n    }\n  });\n}\n\n// ========== Uber Eats (RapidAPI) \u2014 Address + GPS job/search, retries & polling ==========\nasync function fetchMenuFromUberEats(\n  env,\n  query,\n  address = \"Miami, FL, USA\",\n  maxRows = 15,\n  lat = null,\n  lng = null,\n  radius = 5000\n) {\n  const rapidKey = env.RAPIDAPI_KEY;\n  const host = env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n  const base = `https://${host}`;\n\n  async function postJob() {\n    const url = `${base}/api/job`;\n    const body = {\n      scraper: { maxRows, query, address, locale: \"en-US\", page: 1 }\n    };\n    const res = await fetch(url, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-RapidAPI-Key\": rapidKey,\n        \"X-RapidAPI-Host\": host,\n        Accept: \"application/json\",\n        \"User-Agent\": \"TummyBuddyWorker/1.0\"\n      },\n      body: JSON.stringify(body)\n    });\n    return res;\n  }\n\n  async function postJobByLocation() {\n    const url = `${base}/api/job/location`;\n    const body = {\n      scraper: {\n        maxRows,\n        query,\n        locale: \"en-US\",\n        page: 1,\n        location:\n          lat != null && lng != null ? { latitude: lat, longitude: lng } : null,\n        radius\n      }\n    };\n    const res = await fetch(url, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-RapidAPI-Key\": rapidKey,\n        \"X-RapidAPI-Host\": host,\n        Accept: \"application/json\",\n        \"User-Agent\": \"TummyBuddyWorker/1.0\"\n      },\n      body: JSON.stringify(body)\n    });\n    return res;\n  }\n\n  async function getById(id) {\n    const url = `${base}/api/job/${encodeURIComponent(id)}`;\n    const res = await fetch(url, {\n      method: \"GET\",\n      headers: {\n        \"X-RapidAPI-Key\": rapidKey,\n        \"X-RapidAPI-Host\": host,\n        Accept: \"application/json\",\n        \"User-Agent\": \"TummyBuddyWorker/1.0\"\n      }\n    });\n    return res;\n  }\n\n  // 1) create job once\n  const create = await postJob();\n  const created = await create.json();\n  const jobId =\n    created?.data?.jobId || created?.jobId || created?.id || created?.data?.id;\n  if (!jobId) throw new Error(\"UberEats: no jobId returned\");\n\n  // 2) poll job until results\n  let tries = 0,\n    resultsPayload = null;\n  while (tries++ < 10) {\n    const res = await fetch(`${base}/api/job/${jobId}`, {\n      headers: {\n        \"X-RapidAPI-Key\": rapidKey,\n        \"X-RapidAPI-Host\": host,\n        Accept: \"application/json\",\n        \"User-Agent\": \"TummyBuddyWorker/1.0\"\n      }\n    });\n\n    let j = {};\n    try {\n      j = await res.clone().json();\n    } catch {\n      await res.text().catch(() => {});\n    } finally {\n      if (res.body && typeof res.body.cancel === \"function\") {\n        res.body.cancel();\n      }\n    }\n\n    const results =\n      j?.data?.results || j?.results || j?.data?.data?.results || [];\n    if (Array.isArray(results) && results.length) {\n      resultsPayload = j;\n      break;\n    }\n    await sleep(800 * tries); // backoff\n  }\n\n  if (!resultsPayload)\n    throw new Error(\"UberEats: job finished with no results\");\n  let parsed = resultsPayload; // keep using `parsed` below\n\n  const hasCandidates =\n    (Array.isArray(parsed?.data?.results) && parsed.data.results.length) ||\n    (Array.isArray(parsed?.results) && parsed.results.length) ||\n    (Array.isArray(parsed?.data?.data?.results) &&\n      parsed.data.data.results.length);\n\n  if (!hasCandidates && lat != null && lng != null) {\n    const resLoc = await postJobByLocation();\n    const ctypeLoc = (resLoc.headers.get(\"content-type\") || \"\").toLowerCase();\n    if (ctypeLoc.includes(\"application/json\")) {\n      const locJson = await resLoc.json();\n      if (resLoc.ok) parsed = locJson;\n    }\n  }\n\n  return parsed;\n}\n\n// ---- UBER EATS: CREATE A LOCATION-BASED JOB (robust path-fallback) ----\nasync function postJobByLocation(\n  { query, lat, lng, radius = 6000, maxRows = 25 },\n  env\n) {\n  const host = env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n  const key = env.RAPIDAPI_KEY;\n  if (!key) throw new Error(\"Missing RAPIDAPI_KEY\");\n  if (!host) throw new Error(\"Missing UBER_RAPID_HOST\");\n  if (lat == null || lng == null) throw new Error(\"Missing lat/lng\");\n\n  const candidatePaths = [\n    \"/api/job/location\",\n    \"/api/jobs/location\",\n    \"/api/location\",\n    \"/api/search/location\",\n    \"/api/job\",\n    \"/location\"\n  ];\n\n  const body = {\n    query: query || \"\",\n    latitude: Number(lat),\n    longitude: Number(lng),\n    radius: Number(radius),\n    max: Number(maxRows) || 25\n  };\n\n  async function attemptOnce(url) {\n    const res = await fetch(url, {\n      method: \"POST\",\n      headers: {\n        \"content-type\": \"application/json\",\n        \"x-rapidapi-key\": key,\n        \"x-rapidapi-host\": host\n      },\n      body: JSON.stringify(body)\n    });\n    const text = await res.text();\n    const safeErr = () => {\n      if (text && text.startsWith(\"<\"))\n        return `UberEats non-JSON response (${res.status}): ${text.slice(0, 120)}...`;\n      return `UberEats ${res.status}: ${text}`;\n    };\n    if (res.status === 429) {\n      const retryAfter =\n        Number(res.headers.get(\"retry-after\")) ||\n        Number(res.headers.get(\"x-ratelimit-reset\")) ||\n        0;\n      const waitMs = retryAfter > 0 ? retryAfter * 1000 : 1500;\n      await sleep(waitMs);\n      throw new Error(\n        `RETRYABLE_429:${Math.max(0, Math.floor(waitMs / 1000))}`\n      );\n    }\n    if ([502, 503, 504].includes(res.status)) throw new Error(safeErr());\n    if (res.status === 404) throw new Error(\"HARD_404\");\n    if (!res.ok) throw new Error(safeErr());\n    let js;\n    try {\n      js = JSON.parse(text);\n    } catch {\n      throw new Error(\"UberEats: response was not JSON.\");\n    }\n    return js;\n  }\n\n  let lastErr;\n  for (const p of candidatePaths) {\n    const url = `https://${host}${p}`;\n    for (let i = 0; i < 4; i++) {\n      try {\n        const js = await attemptOnce(url);\n        const jobId =\n          js?.job_id || js?.id || js?.jobId || js?.data?.job_id || js?.data?.id;\n        if (!jobId) return js;\n        return { ok: true, job_id: jobId, raw: js, path: p };\n      } catch (err) {\n        lastErr = err;\n        const msg = String(err?.message || err);\n        if (msg === \"HARD_404\") break;\n        const retryable =\n          msg.includes(\"RETRYABLE_429\") || /UberEats (502|503|504)/.test(msg);\n        if (!retryable) break;\n        const backoff = 400 * (i + 1) + Math.floor(Math.random() * 200);\n        await sleep(backoff);\n      }\n    }\n  }\n  throw new Error(\n    lastErr ? String(lastErr) : \"UberEats: no working location endpoint found.\"\n  );\n}\n\n// ---- UBER EATS: SEARCH BY GPS (fallback when job/location 404s) ----\nasync function searchNearbyCandidates(\n  { query, lat, lng, radius = 6000, maxRows = 25 },\n  env\n) {\n  const host = env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n  const key = env.RAPIDAPI_KEY;\n  if (!key) throw new Error(\"Missing RAPIDAPI_KEY\");\n  if (!host) throw new Error(\"Missing UBER_RAPID_HOST\");\n  if (lat == null || lng == null) throw new Error(\"Missing lat/lng\");\n\n  const candidatePaths = [\n    \"/api/search\",\n    \"/api/restaurants/search\",\n    \"/api/stores/search\",\n    \"/api/search/location\",\n    \"/search\"\n  ];\n\n  const params = (p) => {\n    const u = new URL(`https://${host}${p}`);\n    u.searchParams.set(\"latitude\", String(Number(lat)));\n    u.searchParams.set(\"longitude\", String(Number(lng)));\n    if (query) u.searchParams.set(\"query\", query);\n    u.searchParams.set(\"radius\", String(Number(radius)));\n    u.searchParams.set(\"max\", String(Number(maxRows) || 25));\n    return u.toString();\n  };\n\n  async function attemptOnce(url) {\n    const res = await fetch(url, {\n      method: \"GET\",\n      headers: { \"x-rapidapi-key\": key, \"x-rapidapi-host\": host }\n    });\n    const text = await res.text();\n    const safeErr = () => {\n      if (text && text.startsWith(\"<\"))\n        return `UberEats non-JSON response (${res.status}): ${text.slice(0, 120)}...`;\n      return `UberEats ${res.status}: ${text}`;\n    };\n    if (res.status === 429) {\n      const retryAfter =\n        Number(res.headers.get(\"retry-after\")) ||\n        Number(res.headers.get(\"x-ratelimit-reset\")) ||\n        0;\n      const waitMs = retryAfter > 0 ? retryAfter * 1000 : 1200;\n      await sleep(waitMs);\n      throw new Error(\n        `RETRYABLE_429:${Math.max(0, Math.floor(waitMs / 1000))}`\n      );\n    }\n    if (res.status === 404) throw new Error(\"HARD_404\");\n    if ([502, 503, 504].includes(res.status)) throw new Error(safeErr());\n    if (!res.ok) throw new Error(safeErr());\n    let js;\n    try {\n      js = JSON.parse(text);\n    } catch {\n      throw new Error(\"UberEats: response was not JSON.\");\n    }\n    return js;\n  }\n\n  for (const p of candidatePaths) {\n    const url = params(p);\n    for (let i = 0; i < 4; i++) {\n      try {\n        const data = await attemptOnce(url);\n        const arrays = [\n          data?.stores,\n          data?.restaurants,\n          data?.data?.stores,\n          data?.data?.restaurants,\n          Array.isArray(data) ? data : null\n        ].filter(Boolean);\n\n        const flat = [];\n        for (const arr of arrays) {\n          for (const it of arr) {\n            flat.push({\n              id:\n                it?.id ||\n                it?.uuid ||\n                it?.storeUuid ||\n                it?.storeId ||\n                it?.restaurantId ||\n                it?.slug ||\n                it?.url,\n              title:\n                it?.title ||\n                it?.name ||\n                it?.displayName ||\n                it?.storeName ||\n                it?.restaurantName,\n              raw: it\n            });\n          }\n        }\n\n        const seen = new Set();\n        const clean = flat\n          .filter((x) => x && x.title)\n          .filter((x) => {\n            const k = (x.title + \"|\" + (x.id || \"\")).toLowerCase();\n            if (seen.has(k)) return false;\n            seen.add(k);\n            return true;\n          })\n          .slice(0, Number(maxRows) || 25);\n\n        return {\n          ok: true,\n          pathTried: p,\n          count: clean.length,\n          candidates: clean,\n          raw: data\n        };\n      } catch (err) {\n        const msg = String(err?.message || err);\n        const retryable =\n          msg.includes(\"RETRYABLE_429\") || /UberEats (502|503|504)/.test(msg);\n        if (!retryable) break;\n        await sleep(400 * (i + 1) + Math.floor(Math.random() * 200));\n      }\n    }\n  }\n  return { ok: false, error: \"No working GPS search endpoint found.\" };\n}\n\n// ---- UBER EATS: CREATE A JOB BY ADDRESS (exact vendor format) ----\nasync function postJobByAddress(\n  { query, address, maxRows = 15, locale = \"en-US\", page = 1, webhook = null },\n  env\n) {\n  const host = env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n  const key = env.RAPIDAPI_KEY || env.RAPID_API_KEY;\n  if (!key) throw new Error(\"Missing RAPIDAPI_KEY\");\n  if (!host) throw new Error(\"Missing UBER_RAPID_HOST\");\n  if (!address) throw new Error(\"Missing address\");\n\n  const url = `https://${host}/api/job`;\n\n  // \u2705 Exact body per vendor docs\n  const body = {\n    scraper: {\n      maxRows: Number(maxRows) || 15,\n      query: String(query || \"\"),\n      address: String(address),\n      locale: String(locale || \"en-US\"),\n      page: Number(page) || 1\n    },\n    ...(webhook ? { webhook } : {})\n  };\n\n  async function attemptOnce() {\n    const res = await fetch(url, {\n      method: \"POST\",\n      headers: {\n        accept: \"application/json\",\n        \"content-type\": \"application/json\",\n        \"x-rapidapi-key\": key,\n        \"x-rapidapi-host\": host\n      },\n      body: JSON.stringify(body)\n    });\n\n    const text = await res.text();\n    const safeErr = () => {\n      if (text && text.startsWith(\"<\"))\n        return `UberEats non-JSON response (${res.status}): ${text.slice(0, 120)}...`;\n      return `UberEats ${res.status}: ${text}`;\n    };\n\n    if (res.status === 429) {\n      const retryAfter =\n        Number(res.headers.get(\"retry-after\")) ||\n        Number(res.headers.get(\"x-ratelimit-reset\")) ||\n        0;\n      const waitMs = retryAfter > 0 ? retryAfter * 1000 : 1500;\n      await new Promise((r) => setTimeout(r, waitMs));\n      throw new Error(\n        `RETRYABLE_429:${Math.max(0, Math.floor(waitMs / 1000))}`\n      );\n    }\n    if ([500, 502, 503, 504].includes(res.status)) throw new Error(safeErr());\n    if (!res.ok) throw new Error(safeErr());\n\n    let js;\n    try {\n      js = JSON.parse(text);\n    } catch {\n      throw new Error(\"UberEats: response was not JSON.\");\n    }\n    return js; // may contain returnvalue.data OR id/job_id\n  }\n\n  for (let i = 0; i < 6; i++) {\n    try {\n      const js = await attemptOnce();\n\n      const immediateData = js?.returnvalue?.data;\n      if (immediateData) return { ok: true, immediate: true, raw: js };\n\n      const jobId = js?.id || js?.job_id || js?.data?.id;\n      if (!jobId) return { ok: true, immediate: true, raw: js };\n      return { ok: true, job_id: jobId, raw: js };\n    } catch (e) {\n      const msg = String(e?.message || e);\n      const retryable =\n        msg.includes(\"RETRYABLE\") || /UberEats (500|502|503|504)/.test(msg);\n      if (!retryable) throw e;\n      const backoff = 500 * Math.pow(1.8, i) + Math.floor(Math.random() * 300);\n      await new Promise((r) => setTimeout(r, backoff));\n    }\n  }\n  throw new Error(\"UberEats: address job failed after retries.\");\n}\n\n// ---- U.S. helpers (address hinting + result filtering) ----\nconst US_STATES = new Set([\n  \"AL\",\n  \"AK\",\n  \"AZ\",\n  \"AR\",\n  \"CA\",\n  \"CO\",\n  \"CT\",\n  \"DE\",\n  \"FL\",\n  \"GA\",\n  \"HI\",\n  \"ID\",\n  \"IL\",\n  \"IN\",\n  \"IA\",\n  \"KS\",\n  \"KY\",\n  \"LA\",\n  \"ME\",\n  \"MD\",\n  \"MA\",\n  \"MI\",\n  \"MN\",\n  \"MS\",\n  \"MO\",\n  \"MT\",\n  \"NE\",\n  \"NV\",\n  \"NH\",\n  \"NJ\",\n  \"NM\",\n  \"NY\",\n  \"NC\",\n  \"ND\",\n  \"OH\",\n  \"OK\",\n  \"OR\",\n  \"PA\",\n  \"RI\",\n  \"SC\",\n  \"SD\",\n  \"TN\",\n  \"TX\",\n  \"UT\",\n  \"VT\",\n  \"VA\",\n  \"WA\",\n  \"WV\",\n  \"WI\",\n  \"WY\",\n  \"DC\",\n  \"PR\",\n  \"GU\",\n  \"VI\",\n  \"AS\",\n  \"MP\"\n]);\nfunction looksLikeUSAddress(addr) {\n  const raw = String(addr || \"\");\n  const s = raw.toLowerCase();\n  // crude: contains \"usa\" / \"united states\" / \", us\" OR uppercase state code\n  return /usa|united states|, us\\b/.test(s) || /\\b[A-Z]{2}\\b/.test(raw);\n}\nfunction isUSRow(row) {\n  const country = (\n    row?.location?.country ||\n    row?.location?.geo?.country ||\n    row?.country ||\n    \"\"\n  )\n    .toString()\n    .toLowerCase();\n  const region = (\n    row?.location?.region ||\n    row?.location?.geo?.region ||\n    row?.region ||\n    \"\"\n  )\n    .toString()\n    .toUpperCase();\n  const currency = (row?.currencyCode || row?.currency || \"\")\n    .toString()\n    .toUpperCase();\n  const url = String(row?.url || row?.link || \"\").toLowerCase();\n  if (country === \"united states\" || country === \"us\" || country === \"usa\")\n    return true;\n  if (US_STATES.has(region)) return true;\n  if (currency === \"USD\") return true;\n  if (/\\/us\\//.test(url)) return true;\n  return false;\n}\nfunction filterRowsUS(rows, force) {\n  if (!Array.isArray(rows)) return [];\n  const filtered = rows.filter(isUSRow);\n  return force && filtered.length > 0\n    ? filtered\n    : filtered.length\n      ? filtered\n      : rows;\n}\n\n// ---- UBER EATS: POLL A JOB UNTIL COMPLETED ----\nasync function pollUberJobUntilDone({ jobId, env, maxTries = 12 }) {\n  const host = env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n  const key = env.RAPIDAPI_KEY;\n  if (!key) throw new Error(\"Missing RAPIDAPI_KEY\");\n  if (!host) throw new Error(\"Missing UBER_RAPID_HOST\");\n  if (!jobId) throw new Error(\"Missing jobId\");\n\n  for (let i = 0; i < maxTries; i++) {\n    const res = await fetch(\n      `https://${host}/api/job/${encodeURIComponent(jobId)}`,\n      {\n        method: \"GET\",\n        headers: {\n          accept: \"application/json\",\n          \"x-rapidapi-key\": key,\n          \"x-rapidapi-host\": host\n        }\n      }\n    );\n\n    const text = await res.text();\n    if (!res.ok) {\n      if ([429, 500, 502, 503, 504].includes(res.status)) {\n        await sleep(500 * (i + 1));\n        continue;\n      }\n      throw new Error(`UberEats ${res.status}: ${text.slice(0, 200)}`);\n    }\n\n    let js;\n    try {\n      js = JSON.parse(text);\n    } catch {\n      throw new Error(\"UberEats: poll returned non-JSON\");\n    }\n    if (js?.state === \"completed\") return js;\n    await sleep(600 * (i + 1));\n  }\n  throw new Error(\"UberEats: poll timed out before completion.\");\n}\n\n// ---- POST /api/job exactly like the working debug route ----\nasync function runAddressJobRaw(\n  {\n    query = \"seafood\",\n    address = \"South Miami, FL, USA\",\n    maxRows = 3,\n    locale = \"en-US\",\n    page = 1\n  },\n  env\n) {\n  const host = env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n  const key = env.RAPIDAPI_KEY || \"\";\n  const body = {\n    scraper: {\n      maxRows: Number(maxRows) || 3,\n      query,\n      address,\n      locale,\n      page: Number(page) || 1\n    }\n  };\n\n  const res = await fetch(`https://${host}/api/job`, {\n    method: \"POST\",\n    headers: {\n      accept: \"application/json\",\n      \"content-type\": \"application/json\",\n      \"x-rapidapi-key\": key,\n      \"x-rapidapi-host\": host\n    },\n    body: JSON.stringify(body)\n  });\n\n  const text = await res.text();\n  let js;\n  try {\n    js = JSON.parse(text);\n  } catch {\n    js = null;\n  }\n  return { status: res.status, text, json: js };\n}\n\n// ---- Choose the single best restaurant match by title similarity ----\nfunction pickBestRestaurant({ rows, query }) {\n  if (!Array.isArray(rows) || rows.length === 0) return null;\n  const q = (query || \"\").trim().toLowerCase();\n\n  function norm(s) {\n    return String(s || \"\")\n      .toLowerCase()\n      .replace(/\\s+/g, \" \")\n      .replace(/[^\\p{L}\\p{N}\\s&'-]/gu, \"\")\n      .trim();\n  }\n\n  function scoreRow(r) {\n    const title = norm(r?.title || r?.name || r?.displayName || r?.storeName);\n    if (!q || !title) return 0;\n    if (title === norm(q)) return 100;\n    if (title.startsWith(norm(q))) return 90;\n    if (title.includes(norm(q))) return 80;\n    const qtoks = new Set(norm(q).split(\" \").filter(Boolean));\n    const ttoks = new Set(title.split(\" \").filter(Boolean));\n    let overlap = 0;\n    for (const t of qtoks) if (ttoks.has(t)) overlap++;\n    const ratio = overlap / Math.max(1, qtoks.size);\n    return Math.round(60 * ratio);\n  }\n\n  let best = null;\n  for (const r of rows) {\n    const s = scoreRow(r);\n    if (!best || s > best.score) best = { row: r, score: s };\n  }\n  return best?.row || null;\n}\n\n// [38.6] \u2014 explain how we score/choose the best restaurant\nfunction explainRestaurantChoices({ rows, query, limit = 10 }) {\n  const q = (query || \"\").trim().toLowerCase();\n\n  function norm(s) {\n    return String(s || \"\")\n      .toLowerCase()\n      .replace(/\\s+/g, \" \")\n      .replace(/[^\\p{L}\\p{N}\\s&'-]/gu, \"\")\n      .trim();\n  }\n\n  function scoreRow(r) {\n    const title = norm(\n      r?.title || r?.name || r?.displayName || r?.storeName || \"\"\n    );\n    const qn = norm(q);\n    if (!qn || !title) return { score: 0, kind: \"no-query\" };\n    if (title === qn) return { score: 100, kind: \"exact\" };\n    if (title.startsWith(qn)) return { score: 90, kind: \"starts-with\" };\n    if (title.includes(qn)) return { score: 80, kind: \"contains\" };\n    const qtoks = new Set(qn.split(\" \").filter(Boolean));\n    const ttoks = new Set(title.split(\" \").filter(Boolean));\n    let overlap = 0;\n    for (const t of qtoks) if (ttoks.has(t)) overlap++;\n    const ratio = overlap / Math.max(1, qtoks.size);\n    return {\n      score: Math.round(60 * ratio),\n      kind: \"token-overlap\",\n      overlap,\n      denom: qtoks.size\n    };\n  }\n\n  const explained = (Array.isArray(rows) ? rows : []).map((r) => {\n    const s = scoreRow(r);\n    return {\n      title: r?.title || r?.name || r?.displayName || r?.storeName || \"\",\n      region: r?.region || r?.location?.region || null,\n      city: r?.city || r?.location?.city || null,\n      url: r?.url || null,\n      score: s.score,\n      match_kind: s.kind,\n      ...(s.overlap != null ? { overlap: s.overlap, tokens: s.denom } : {})\n    };\n  });\n\n  explained.sort((a, b) => b.score - a.score);\n  const top = explained.slice(0, Math.max(1, limit));\n  const winner = top[0] || null;\n  return { winner, top };\n}\n\n// ========== Lexicon & Shards (KV-backed with live fallback) ==========\nconst INDEX_KV_KEY = \"shards/INDEX.json\";\n\nconst STATIC_INGREDIENT_SHARDS = [\n  \"en_global_ingredients\",\n  \"en_global_oils_fats\",\n  \"en_global_noodles_pastas\",\n  \"en_global_grains_flours\",\n  \"en_global_bakery_desserts\",\n  \"en_global_condiments\",\n  \"en_global_herbs_spices\",\n  \"en_global_broths_stocks\",\n  \"en_global_batters_breading\",\n  \"en_global_beverages\",\n  \"en_global_cheeses_expanded\"\n];\n\nasync function refreshShardIndex(env) {\n  const base = normalizeBase(env.LEXICON_API_URL);\n  const key = env.LEXICON_API_KEY;\n  if (!base || !key)\n    throw new Error(\"Missing LEXICON_API_URL or LEXICON_API_KEY\");\n\n  const candidates = [`${base}/v1/index`, `${base}/v1/shards`];\n  let text = null;\n  const statusTried = [];\n  for (const url of candidates) {\n    try {\n      const r = await fetch(url, { headers: { \"x-api-key\": key } });\n      statusTried.push({ url, status: r.status });\n      if (!r.ok) continue;\n      text = await r.text();\n      break;\n    } catch (e) {\n      statusTried.push({ url, status: 0, error: String(e?.message || e) });\n    }\n  }\n  if (!text)\n    return {\n      ok: false,\n      error: \"No index endpoint succeeded\",\n      tried: statusTried\n    };\n\n  const js = parseJsonSafe(text, null);\n  if (!js)\n    return { ok: false, error: \"Index JSON invalid\", tried: statusTried };\n\n  if (env.LEXICON_CACHE) {\n    await env.LEXICON_CACHE.put(INDEX_KV_KEY, text, { expirationTtl: 86400 });\n  }\n  const size = Array.isArray(js) ? js.length : Object.keys(js).length;\n  return { ok: true, tried: statusTried, index_len: size };\n}\n\nasync function readShardIndexFromKV(env) {\n  if (!env.LEXICON_CACHE) return null;\n  const raw = await env.LEXICON_CACHE.get(INDEX_KV_KEY);\n  if (!raw) return null;\n  return parseJsonSafe(raw, null);\n}\n\nfunction pickIngredientShardNamesFromIndex(indexJson) {\n  const names = new Set();\n  if (Array.isArray(indexJson)) {\n    for (const n of indexJson) {\n      const s = String(n || \"\").trim();\n      if (s.startsWith(\"en_global_\")) names.add(s);\n    }\n  } else if (indexJson && typeof indexJson === \"object\") {\n    if (Array.isArray(indexJson.shards)) {\n      for (const n of indexJson.shards) {\n        const s = String(n || \"\").trim();\n        if (s.startsWith(\"en_global_\")) names.add(s);\n      }\n    } else {\n      for (const k of Object.keys(indexJson)) {\n        const s = String(k || \"\").trim();\n        if (s.startsWith(\"en_global_\")) names.add(s);\n      }\n    }\n  }\n  if (names.size === 0) for (const s of STATIC_INGREDIENT_SHARDS) names.add(s);\n  return Array.from(names);\n}\n\nasync function loadIngredientShards(env) {\n  const used_shards = [];\n  const used_shards_meta = {};\n  const entriesAll = [];\n\n  const indexJson = await readShardIndexFromKV(env);\n  const names = pickIngredientShardNamesFromIndex(indexJson) || [];\n  const list = names.length ? names : STATIC_INGREDIENT_SHARDS;\n\n  for (const name of list) {\n    let shard = null;\n    const key = `shards/${name}.json`;\n\n    if (env.LEXICON_CACHE) {\n      try {\n        const cached = await env.LEXICON_CACHE.get(key);\n        shard = cached ? parseJsonSafe(cached, null) : null;\n      } catch {}\n    }\n\n    if (!shard) {\n      const base = normalizeBase(env.LEXICON_API_URL);\n      const apiKey = env.LEXICON_API_KEY;\n      if (base && apiKey) {\n        try {\n          const res = await fetch(`${base}/v1/shards/${name}`, {\n            headers: { \"x-api-key\": apiKey, accept: \"application/json\" }\n          });\n          if (res.ok) {\n            shard = await res.json();\n            if (env.LEXICON_CACHE && shard) {\n              try {\n                await env.LEXICON_CACHE.put(key, JSON.stringify(shard), {\n                  expirationTtl: 86400\n                });\n              } catch {}\n            }\n          }\n        } catch (err) {\n          console.log(\n            \"[lexicon] shard fetch failed\",\n            name,\n            err?.message || err\n          );\n        }\n      }\n    }\n\n    if (shard && Array.isArray(shard.entries)) {\n      used_shards.push(name);\n      used_shards_meta[name] = {\n        version: shard.version ?? null,\n        entries_len: shard.entries.length\n      };\n      for (const e of shard.entries) entriesAll.push(e);\n    }\n  }\n\n  return { used_shards, used_shards_meta, entriesAll };\n}\n\n// ---- MINI FALLBACK TERMS (disabled; lexicon-only) ----\nconst FALLBACK_INGREDIENTS = [];\n\nfunction fallbackEntriesFromText(_corpus) {\n  // Super-brain mode: NO manual fallback list.\n  // All hits must come from Lexicon shards (entriesAll) or lexicon API.\n  return [];\n}\n\n// --- Tidy helpers ---\nfunction tidyIngredientHits(hits, limit = 25) {\n  const byCanon = new Map();\n  for (const h of hits) {\n    const key = lc(h.canonical || h.term || \"\");\n    if (!key) continue;\n    const prev = byCanon.get(key);\n    if (!prev || scoreHit(h) > scoreHit(prev)) byCanon.set(key, h);\n  }\n  const out = Array.from(byCanon.values()).sort((a, b) => {\n    const sa = scoreHit(a),\n      sb = scoreHit(b);\n    if (sb !== sa) return sb - sa;\n    const la = (a.term || \"\").length,\n      lb = (b.term || \"\").length;\n    if (lb !== la) return lb - la;\n    return (a.canonical || a.term || \"\").localeCompare(\n      b.canonical || b.term || \"\"\n    );\n  });\n  return out.slice(0, limit);\n}\n\nfunction scoreHit(h) {\n  const classes = Array.isArray(h.classes) ? h.classes.map(lc) : [];\n  let s = 0;\n  if (classes.includes(\"dairy\")) s += 3;\n  if (classes.includes(\"gluten\")) s += 3;\n  if (classes.includes(\"allium\")) s += 2;\n  if (h.source === \"kv_multi_shards\") s += 0.6;\n  if (h.source === \"fallback\") s += 0.2;\n  s += Math.min(2, (h.term || \"\").length / 10);\n  if (typeof h.weight === \"number\")\n    s += Math.max(-1, Math.min(1, h.weight - 0.5));\n  return s;\n}\n\n// ========== Queue Consumer + HTTP Router ==========\nconst _worker_impl = {\n  // ---- Queue consumer: pulls messages from tb-dish-analysis-queue ----\n  async queue(batch, env, ctx) {\n    console.log(\"[QUEUE] handler enter\", {\n      batchSize: (batch && batch.messages && batch.messages.length) || 0\n    });\n    for (const msg of batch.messages) {\n      let id = null;\n      try {\n        const job =\n          typeof msg.body === \"string\" ? JSON.parse(msg.body) : msg.body;\n        const body = (job && job.body) || job || {};\n        const {\n          kind,\n          user_id,\n          dish,\n          dish_name,\n          ingredients,\n          organ_levels,\n          organ_top_drivers,\n          tummy_barometer,\n          calories_kcal = null,\n          created_at\n        } = body;\n        // --- Minimal meal_log handler: write to D1 and ACK ---\n        if (kind === \"meal_log\") {\n          try {\n            const dishName = dish || dish_name || job?.dish_name || \"unknown\";\n            const userId = user_id || job?.user_id || \"UNKNOWN_USER\";\n            const createdAt =\n              created_at || job?.created_at || new Date().toISOString();\n            const calories = job?.calories_kcal ?? calories_kcal ?? null;\n\n            const organLevelsObj =\n              organ_levels ||\n              body?.organ_levels ||\n              (body?.organs_summary && body.organs_summary.levels) ||\n              (job?.organs_summary && job.organs_summary.levels) ||\n              {};\n            const topDriversObj =\n              organ_top_drivers ||\n              body?.organ_top_drivers ||\n              (body?.organs_summary && body.organs_summary.top_drivers) ||\n              (job?.organs_summary && job.organs_summary.top_drivers) ||\n              {};\n            const tummyBarometer =\n              tummy_barometer ||\n              body?.tummy_barometer ||\n              job?.tummy_barometer ||\n              barometerFromOrgans(organLevelsObj);\n\n            const ingredientList =\n              ingredients || body?.ingredients || job?.ingredients || [];\n            const ingredientsJson = JSON.stringify(ingredientList);\n            const organLevelsJson = JSON.stringify(organLevelsObj);\n            const topDriversJson = JSON.stringify(topDriversObj);\n            console.log(\"[QUEUE] meal_log preview:\", {\n              has_levels: !!Object.keys(organLevelsObj).length,\n              has_top: !!Object.keys(topDriversObj).length\n            });\n            console.log(\"[CONSUMER] calories_kcal =\", calories);\n\n            if (!env.D1_DB) throw new Error(\"D1_DB not bound\");\n\n            await env.D1_DB.prepare(\n              `INSERT INTO user_meal_logs\n       (user_id, dish, ingredients_json, organ_levels_json, top_drivers_json, calories_kcal, created_at)\n       VALUES (?, ?, ?, ?, ?, ?, ?)`\n            )\n              .bind(\n                userId,\n                dishName,\n                ingredientsJson,\n                organLevelsJson,\n                topDriversJson,\n                calories,\n                createdAt\n              )\n              .run();\n            await recordMetric(env, \"d1:user_meal_logs:insert_ok\");\n\n            console.log(\"[QUEUE] meal_log wrote to D1:\", {\n              dish,\n              userId,\n              createdAt\n            });\n            msg.ack();\n            continue;\n          } catch (e) {\n            await recordMetric(env, \"d1:user_meal_logs:insert_fail\");\n            console.error(\"[QUEUE] meal_log failed:\", e);\n            msg.retry();\n            continue;\n          }\n        }\n        // 47.1: Skip if result already exists in R2\n        const dummyUrl = new URL(\"https://dummy.local/cache-check\");\n        if (job?.force_reanalyze)\n          dummyUrl.searchParams.set(\"force_reanalyze\", \"1\");\n        const cachedResult = await maybeReturnCachedResult(\n          new Request(dummyUrl.toString()),\n          env,\n          {\n            place_id: job?.place_id,\n            title: job?.dish_name\n          }\n        );\n        if (cachedResult) {\n          console.log(\"[QUEUE] skip existing results in R2\");\n          msg.ack();\n          continue;\n        }\n\n        id = job?.id || crypto.randomUUID();\n        const key = `jobs/${id}.json`;\n\n        console.log(\"[QUEUE] received:\", { id, dish: job?.dish_name });\n\n        // Load shards (venue + ingredients)\n        const venueShard = await getShardFromKV(env, \"venue_mitigations\");\n        const { used_shards, used_shards_meta, entriesAll } =\n          await loadIngredientShards(env);\n        if (venueShard.ok) {\n          used_shards.push(\"venue_mitigations\");\n          used_shards_meta[\"venue_mitigations\"] = {\n            version: venueShard.version ?? null,\n            entries_len: venueShard.entries.length\n          };\n        }\n\n        // Build text corpus\n        const dishName = lc(job?.dish_name);\n        const dishDesc = lc(job?.dish_desc || job?.dish_description || \"\");\n        const cuisine = lc(job?.cuisine || \"\");\n        const ingNames = Array.isArray(job?.ingredients)\n          ? job.ingredients\n              .map((i) => i?.name || \"\")\n              .filter(Boolean)\n              .join(\" \")\n          : \"\";\n        const corpus = [dishName, dishDesc, cuisine, lc(ingNames)]\n          .filter(Boolean)\n          .join(\" \");\n\n        // Ingredient matching from KV shards\n        const ingredient_hits_raw = [];\n        const seenCanon = new Set();\n        if (entriesAll.length > 0) {\n          const stoplist = new Set([\n            \"and\",\n            \"with\",\n            \"of\",\n            \"in\",\n            \"a\",\n            \"the\",\n            \"or\"\n          ]);\n          for (const entry of entriesAll) {\n            const canonical = lc(\n              entry?.canonical ?? entry?.name ?? entry?.term ?? \"\"\n            );\n            const classes = Array.isArray(entry?.classes)\n              ? entry.classes.map(lc)\n              : [];\n            const tags = Array.isArray(entry?.tags) ? entry.tags.map(lc) : [];\n            const weight =\n              typeof entry?.weight === \"number\" ? entry.weight : undefined;\n\n            const terms = entryTerms(entry).filter((t) => !stoplist.has(t));\n            let matchedTerm = null;\n            for (const t of terms) {\n              if (t.length < 2) continue;\n              if (termMatches(corpus, t)) {\n                matchedTerm = t;\n                break;\n              }\n            }\n            if (!matchedTerm) continue;\n\n            const canonKey = canonical || matchedTerm;\n            if (seenCanon.has(canonKey)) continue;\n            seenCanon.add(canonKey);\n\n            ingredient_hits_raw.push({\n              term: matchedTerm,\n              canonical: canonical || matchedTerm,\n              classes,\n              tags,\n              weight,\n              allergens: Array.isArray(entry?.allergens)\n                ? entry.allergens\n                : undefined,\n              fodmap: entry?.fodmap ?? entry?.fodmap_level,\n              source: \"kv_multi_shards\"\n            });\n          }\n        }\n\n        // Fallback preview/application when shards are skinny\n        const FALLBACK_TRIGGER = getEnvInt(env, \"FALLBACK_TRIGGER_UNDER\", 50);\n        const fallback_debug = []; // no manual fallback in super-brain mode\n        let ingredient_hits = ingredient_hits_raw.slice();\n        // NOTE: entriesAll length no longer triggers any hard-coded additions.\n        // All ingredient_hits must come from Lexicon shards/API only.\n\n        // Tidy (dedupe + prioritize + top N)\n        const HITS_LIMIT = getEnvInt(env, \"HITS_LIMIT\", 25);\n        ingredient_hits = tidyIngredientHits(ingredient_hits, HITS_LIMIT);\n\n        // ---- Primary brain: Lexicon API (always runs first) ----\n        let lexiconResult = null;\n        try {\n          lexiconResult = await callLexicon(\n            env,\n            `${job?.dish_name ?? \"\"} ${job?.dish_desc ?? \"\"}`,\n            \"en\"\n          );\n          console.log(\"[LEXICON] success\");\n        } catch (e) {\n          lexiconResult = {\n            error: `Lexicon failed: ${e?.message || String(e)}`\n          };\n          console.log(\"[LEXICON] error:\", e?.message || e);\n        }\n\n        // Prefer Lexicon hits if present; else local ingredient_hits.\n        let resolvedHits = [];\n        if (lexiconResult?.ok && Array.isArray(lexiconResult?.data?.hits)) {\n          resolvedHits = lexiconResult.data.hits.map((h) => ({\n            term: h.term,\n            canonical: h.canonical,\n            classes: Array.isArray(h.classes) ? h.classes : [],\n            tags: Array.isArray(h.tags) ? h.tags : [],\n            allergens: Array.isArray(h.allergens) ? h.allergens : undefined,\n            fodmap: h.fodmap ?? h.fodmap_level\n          }));\n        } else {\n          resolvedHits = (ingredient_hits || []).map((h) => ({\n            term: h.term,\n            canonical: h.canonical,\n            classes: Array.isArray(h.classes) ? h.classes : [],\n            tags: Array.isArray(h.tags) ? h.tags : [],\n            allergens: Array.isArray(h.allergens) ? h.allergens : undefined,\n            fodmap: h.fodmap ?? h.fodmap_level\n          }));\n        }\n\n        const scoring = scoreDishFromHits(resolvedHits);\n\n        const legacyFlags = deriveFlags(ingredient_hits);\n        const tb_score = scoring.tummy_barometer;\n        const flags = {\n          ...legacyFlags,\n          allergens: scoring.flags.allergens,\n          fodmap: scoring.flags.fodmap\n        };\n        const sentences = buildHumanSentences(flags, tb_score);\n\n        // ---- Secondary (fallback) call: RapidAPI mirror (simple counter) ----\n        let rapidResult = null;\n        try {\n          rapidResult = await callRapid(\n            env,\n            job?.dish_name ?? \"\",\n            job?.address || \"\"\n          );\n          console.log(\"[RAPID] success\");\n        } catch (e) {\n          rapidResult = {\n            error: `RapidAPI failed: ${e?.message || String(e)}`\n          };\n          console.log(\"[RAPID] error:\", e?.message || e);\n        }\n\n        // Stats (best-effort)\n        try {\n          await bumpDaily(env, { jobs: 1 });\n          if (lexiconResult?.ok) {\n            const isLive = lexiconResult?.mode === \"live_shards\";\n            await bumpDaily(env, {\n              lex_ok: isLive ? 0 : 1,\n              lex_live: isLive ? 1 : 0\n            });\n            await bumpApi(env, \"lexicon\", { calls: 1, ok: 1 });\n          } else {\n            await bumpDaily(env, { lex_err: 1 });\n            await bumpApi(env, \"lexicon\", { calls: 1, err: 1 });\n          }\n          if (rapidResult && !rapidResult.error) {\n            await bumpDaily(env, { rap_ok: 1 });\n            await bumpApi(env, \"rapid\", { calls: 1, ok: 1 });\n          } else {\n            await bumpDaily(env, { rap_err: 1 });\n            await bumpApi(env, \"rapid\", { calls: 1, err: 1 });\n          }\n        } catch (e) {\n          console.log(\n            \"[STATS] bump error (non-fatal):\",\n            e?.message || String(e)\n          );\n        }\n\n        // Persist record to R2\n        if (env.R2_BUCKET) {\n          const lean = {\n            id,\n            receivedAt: Date.now(),\n            job,\n            dish_name: job?.dish_name ?? null,\n            dish_desc: job?.dish_desc ?? job?.dish_description ?? null,\n            cuisine: job?.cuisine ?? null,\n            used_shards,\n            used_shards_meta,\n            entries_all_len: entriesAll.length,\n            corpus,\n            fallback_terms_preview: fallback_debug.map((h) => h.term),\n            ingredient_hits: (ingredient_hits || []).map((h) => ({\n              term: h.term,\n              canonical: h.canonical,\n              classes: h.classes,\n              tags: h.tags,\n              allergens: h.allergens,\n              fodmap: h.fodmap,\n              source: h.source\n            })),\n            flags,\n            tummy_barometer: tb_score,\n            sentences,\n            rapidResult\n          };\n\n          const resultsKey = `results/${id}.json`;\n          await env.R2_BUCKET.put(resultsKey, JSON.stringify(lean, null, 2), {\n            httpMetadata: { contentType: \"application/json\" }\n          });\n        }\n\n        // KV bookmarks\n        if (env.LEXICON_CACHE) {\n          await env.LEXICON_CACHE.put(\"last_job_id\", id, {\n            expirationTtl: 3600\n          });\n          await env.LEXICON_CACHE.put(\"last_job_ts\", String(Date.now()), {\n            expirationTtl: 3600\n          });\n        }\n\n        // D1 log\n        if (env.D1_DB) {\n          try {\n            await env.D1_DB.prepare(\n              \"INSERT INTO logs (kind, ref, created_at) VALUES (?, ?, ?)\"\n            )\n              .bind(\"dish_job\", key, Date.now())\n              .run();\n            await recordMetric(env, \"d1:logs:insert_ok\");\n          } catch (e2) {\n            await recordMetric(env, \"d1:logs:insert_fail\");\n            console.log(\n              \"[QUEUE] D1 log error (non-fatal):\",\n              e2?.message || String(e2)\n            );\n          }\n        }\n\n        console.log(\"[QUEUE] done:\", { id, dish: job?.dish_name });\n        msg.ack();\n      } catch (e3) {\n        console.log(\"[QUEUE] error:\", { id, error: e3?.message || String(e3) });\n        msg.retry();\n      }\n    }\n  },\n\n  // ---- HTTP routes (health + debug + enqueue + results + uber-test) ----\n  async fetch(request, env, ctx) {\n    const url = new URL(request.url);\n    // async fire-and-forget metrics logging\n    try {\n      const bodyPreview =\n        request.method === \"POST\"\n          ? (await request.clone().text()).slice(0, 300)\n          : \"\";\n      const logPayload = JSON.stringify({\n        ts: Date.now(),\n        method: request.method,\n        path: url.pathname,\n        user_id: url.searchParams.get(\"user_id\") || null,\n        correlation_id:\n          request.headers.get(\"x-correlation-id\") || crypto.randomUUID(),\n        preview: bodyPreview\n      });\n      ctx.waitUntil(\n        env.metrics_core.fetch(\n          \"https://tb-metrics-core.tummybuddy.workers.dev/metrics/ingest\",\n          {\n            method: \"POST\",\n            headers: { \"content-type\": \"application/json\" },\n            body: logPayload\n          }\n        )\n      );\n    } catch (err) {\n      console.error(\"metrics error\", err);\n    }\n    const pathname = normPathname(url);\n    const searchParams = url.searchParams;\n\n    if (!(pathname === \"/healthz\" && request.method === \"GET\")) {\n      const limited = await rateLimit(env, request, { limit: 60 });\n      if (limited) return limited;\n    }\n\n    if (pathname === \"/healthz\" && request.method === \"GET\") {\n      return handleHealthz(env);\n    }\n\n    if (pathname === \"/pipeline/analyze-dish\" && request.method === \"POST\") {\n      const body = (await readJsonSafe(request)) || {};\n      let {\n        dishName,\n        restaurantName,\n        userFlags = {},\n        menuDescription = null,\n        menuSection = null\n      } = body || {};\n      let forceLLM = false;\n\n      dishName =\n        dishName ||\n        body?.dish ||\n        body?.title ||\n        body?.name ||\n        \"\";\n\n      if (!dishName || typeof dishName !== \"string\" || !dishName.trim()) {\n        return okJson({ ok: false, error: \"dishName is required\" }, 400);\n      }\n\n      const correlationId =\n        request.headers.get(\"x-correlation-id\") ||\n        (crypto && crypto.randomUUID\n          ? crypto.randomUUID()\n          : `tb-${Date.now()}`);\n\n      console.log(\n        \"bindings\",\n        JSON.stringify({\n          recipe_core: !!env.recipe_core,\n          recipe_core_fetch:\n            env.recipe_core && typeof env.recipe_core.fetch === \"function\",\n          allergen_organs: !!env.allergen_organs,\n          allergen_organs_fetch:\n            env.allergen_organs &&\n            typeof env.allergen_organs.fetch === \"function\",\n          ai: !!env.AI\n        })\n      );\n\n      // --- CANONICAL NAME FALLBACK (LLM NORMALIZATION) ---\n      let originalName = dishName;\n      let canonicalDishName = dishName;\n\n      // If dish name is too branded, vague, or short \u2192 canonicalize\n      if (!dishName || dishName.trim().length < 3 || /big mac|baconator|cheesy|loaded|signature|special/i.test(dishName)) {\n        try {\n          const llmRes = await env.AI.run('@cf/meta/llama-3.2-11b-instruct', {\n            prompt: `You are helping normalize restaurant menu items into generic dish names \nfor recipe databases like Edamam or Spoonacular.\n\nDish name: \"${dishName}\"\nMenu section: \"${menuSection || ''}\"\nMenu description: \"${menuDescription || ''}\"\n\nRewrite this into a generic, descriptive food name that captures the likely key ingredients \n(e.g. \"double bacon cheeseburger\", \"mozzarella pizza with buffalo sauce\").\n\nReturn ONLY the improved dish name, no explanations.`\n          });\n\n          if (llmRes && typeof llmRes === 'string' && llmRes.trim().length > 0) {\n            canonicalDishName = llmRes.trim();\n            console.log('canonicalDishName:', canonicalDishName);\n          }\n        } catch (err) {\n          console.log('Canonicalization failed, using original name.');\n          canonicalDishName = dishName;\n        }\n\n        forceLLM = true;\n      }\n\n      // replace dishName sent to recipe core\n      dishName = canonicalDishName;\n\n      // STEP 1: recipe-core /recipe/resolve\n      const recipeResolveUrl = env.recipe_core\n        ? \"https://recipe-core/recipe/resolve\"\n        : \"https://tb-recipe-core.tummybuddy.workers.dev/recipe/resolve\";\n      const recipeFetcher =\n        (env.recipe_core && typeof env.recipe_core.fetch === \"function\")\n          ? env.recipe_core.fetch.bind(env.recipe_core)\n          : fetch;\n      const recipeResp = await recipeFetcher(recipeResolveUrl, {\n        method: \"POST\",\n        headers: {\n          \"content-type\": \"application/json\",\n          \"x-correlation-id\": correlationId\n        },\n        body: JSON.stringify({\n          title: dishName,\n          restaurantName,\n          menuDescription,\n          menuSection,\n          forceLLM\n        })\n      });\n\n      const recipeText = await recipeResp.text();\n      let recipe;\n      try {\n        recipe = JSON.parse(recipeText);\n      } catch (e) {\n        recipe = {\n          ok: false,\n          error: \"recipe_core returned non-JSON\",\n          raw: recipeText\n        };\n      }\n\n      // STEP 2: recipe-core /ingredients/normalize\n      const ingredientLines = Array.isArray(recipe?.recipe?.ingredients)\n        ? recipe.recipe.ingredients\n            .map((row) =>\n              row.text ||\n              `${row.qty ?? row.quantity ?? \"\"} ${row.unit || \"\"} ${row.name || \"\"}`.trim()\n            )\n            .filter(Boolean)\n        : [];\n\n      const normResp = await recipeFetcher(\n        env.recipe_core\n          ? \"https://recipe-core/ingredients/normalize\"\n          : \"https://tb-recipe-core.tummybuddy.workers.dev/ingredients/normalize\",\n        {\n          method: \"POST\",\n          headers: {\n            \"content-type\": \"application/json\",\n            \"x-correlation-id\": correlationId\n          },\n          body: JSON.stringify({ lines: ingredientLines })\n        }\n      );\n\n      const normText = await normResp.text();\n      let normalized;\n      try {\n        normalized = JSON.parse(normText);\n      } catch (e) {\n        normalized = {\n          ok: false,\n          error: \"recipe_core.normalize returned non-JSON\",\n          raw: normText\n        };\n      }\n\n      // STEP 3: build ingredients array for organs_core\n      let ingredients = [];\n\n      if (\n        normalized &&\n        Array.isArray(normalized.items) &&\n        normalized.items.length > 0\n      ) {\n        // Normal path: use fully-normalized items (Zestful/USDA/molecular, when present)\n        ingredients = normalized.items.map((row) => ({\n          name: row.name || row.original || \"\",\n          qty: row.qty ?? null,\n          unit: row.unit || null,\n          comment: row.comment || null\n        }));\n      } else if (Array.isArray(recipe?.recipe?.ingredients)) {\n        // Fallback path (current reality): use heuristic/Edamam/Spoonacular recipe ingredients\n        // so organs_core + Lexicon have rich text to work with.\n        ingredients = recipe.recipe.ingredients.map((row) => ({\n          // Prefer the full text as 'name' so normalizeIngredientsArray picks up\n          // things like \"wheat burger bun (contains gluten)\", \"American cheese slices (dairy)\".\n          name: row.text || row.name || \"\",\n          qty: row.qty ?? row.quantity ?? null,\n          unit: row.unit || null,\n          comment: row.comment || null\n        }));\n      } else {\n        ingredients = [];\n      }\n\n      // Build ingredient list for per-ingredient Lex visibility\n      const ingredientsForLex = (() => {\n        if (normalized && Array.isArray(normalized.items) && normalized.items.length) {\n          return normalized.items\n            .map((it) => it.name || it.text || it.original || \"\")\n            .filter((s) => !!s && s.trim().length > 1);\n        }\n        if (recipe && recipe.recipe && Array.isArray(recipe.recipe.ingredients)) {\n          return recipe.recipe.ingredients\n            .map((i) => i.name || i.text || \"\")\n            .filter((s) => !!s && s.trim().length > 1);\n        }\n        const parts = [body.dishName, body.menuDescription]\n          .filter(Boolean)\n          .map((s) => s.trim());\n        return parts.length ? parts : [];\n      })();\n\n      const lexPerIngredient = await classifyIngredientsWithLex(\n        env,\n        ingredientsForLex,\n        \"en\"\n      );\n      const allIngredientLexHits = lexPerIngredient.allHits || [];\n\n      // STEP 3.5: precompute Lexicon hits to pass downstream\n      let lex = null;\n      let finalLexHits = [];\n      try {\n        const lexParts = [];\n        if (dishName) lexParts.push(dishName);\n        if (menuDescription) lexParts.push(menuDescription);\n        if (Array.isArray(recipe?.recipe?.ingredients)) {\n          lexParts.push(\n            recipe.recipe.ingredients\n              .map((row) => row.text || row.name || \"\")\n              .filter(Boolean)\n              .join(\", \")\n          );\n        }\n        const lexText = lexParts.filter(Boolean).join(\". \");\n\n        if (lexText) {\n          // callLexicon already knows how to use LEXICON_API_URL + LEXICON_API_KEY\n          lex = await callLexicon(env, lexText, \"en\");\n          const rawHits = Array.isArray(lex?.data?.hits) ? lex.data.hits : [];\n          const hits = rawHits.map((h) => ({\n            term: h.term,\n            canonical: h.canonical,\n            classes: Array.isArray(h.classes) ? h.classes : [],\n            tags: Array.isArray(h.tags) ? h.tags : [],\n            allergens: Array.isArray(h.allergens) ? h.allergens : undefined,\n            fodmap: h.fodmap ?? h.fodmap_level,\n            lactose_band: h.lactose_band || null,\n            milk_source: h.milk_source || null\n          }));\n          const finalLexHitsLocal = hits;\n          finalLexHits = finalLexHitsLocal;\n        }\n      } catch (e) {\n        // swallow lex errors here; later debug block records if needed\n      }\n\n      const blobHits = finalLexHits || [];\n      const primaryLexHits =\n        allIngredientLexHits && allIngredientLexHits.length\n          ? allIngredientLexHits\n          : blobHits;\n\n      // STEP 4: allergen-organs /organs/assess\n      const allergenUrl = env.allergen_organs\n        ? \"https://allergen-organs/organs/assess\"\n        : \"https://tb-allergen-organs-production.tummybuddy.workers.dev/organs/assess\";\n      const allergenFetcher =\n        (env.allergen_organs && typeof env.allergen_organs.fetch === \"function\")\n          ? env.allergen_organs.fetch.bind(env.allergen_organs)\n          : fetch;\n      const organsResp = await allergenFetcher(allergenUrl, {\n        method: \"POST\",\n        headers: {\n          \"content-type\": \"application/json\",\n          \"x-correlation-id\": correlationId\n        },\n        body: JSON.stringify({\n          ingredients,\n          user_flags: userFlags,\n          lex_hits: primaryLexHits\n        })\n      });\n\n      const organsText = await organsResp.text();\n      let organs;\n      try {\n        organs = JSON.parse(organsText);\n      } catch (e) {\n        organs = {\n          ok: false,\n          error: \"allergen_organs returned non-JSON\",\n          raw: organsText\n        };\n      }\n\n      // STEP 5 \u2014 Lexicon super-brain: FODMAP + allergens (no manual short list)\n      try {\n        if (!organs || typeof organs !== \"object\") organs = {};\n        if (!organs.flags) organs.flags = {};\n        if (!Array.isArray(organs.flags.allergens)) organs.flags.allergens = [];\n\n        // Attach raw lexicon payload for debugging (optional)\n        if (!organs.debug) organs.debug = {};\n        organs.debug.lexicon_raw = lex || null;\n\n        if (lex && lex.ok) {\n          // Normalize lex hits into the shape expected by scoreDishFromHits\n          const hits = primaryLexHits;\n\n          const scoring = scoreDishFromHits(hits);\n\n          // ---- FODMAP from lexicon only ----\n          if (scoring.flags && scoring.flags.fodmap) {\n            organs.flags.fodmap = {\n              level: scoring.flags.fodmap,\n              reason: `FODMAP level ${scoring.flags.fodmap} inferred from lexicon.`,\n              source: \"lexicon\"\n            };\n          }\n\n          // ---- Allergens from lexicon only ----\n          const existing = Array.isArray(organs.flags.allergens)\n            ? organs.flags.allergens.slice()\n            : [];\n          const existingKinds = new Set(\n            existing\n              .map((a) => (a && typeof a.kind === \"string\" ? a.kind : null))\n              .filter(Boolean)\n          );\n\n          const lexAllergenKinds = Array.isArray(scoring.flags?.allergens)\n            ? scoring.flags.allergens\n            : [];\n\n          for (const k of lexAllergenKinds) {\n            const kind = String(k || \"\").toLowerCase();\n            if (!kind || existingKinds.has(kind)) continue;\n            existingKinds.add(kind);\n            existing.push({\n              kind,\n              message: `Contains or may contain ${kind} (from lexicon).`,\n              source: \"lexicon\"\n            });\n          }\n\n          organs.flags.allergens = existing;\n\n          // ---- Lactose level from lexicon ----\n          const lactoseInfo = extractLactoseFromHits(hits);\n          if (lactoseInfo) {\n            organs.flags.lactose = lactoseInfo;\n\n            // If lactose is not \"none\", ensure milk allergen is present\n            if (lactoseInfo.level !== \"none\") {\n              const hasMilk = organs.flags.allergens.some(\n                (a) => a && a.kind === \"milk\"\n              );\n              if (!hasMilk) {\n                organs.flags.allergens.push({\n                  kind: \"milk\",\n                  message: \"Contains or may contain milk/lactose (from lexicon).\",\n                  source: \"lexicon\"\n                });\n              }\n            }\n          }\n        }\n      } catch (e) {\n        if (!organs.debug) organs.debug = {};\n        organs.debug.lexicon_error = String(e?.message || e);\n      }\n\n      // STEP 6: final combined response\n      return okJson(\n        {\n          ok: true,\n          source: \"pipeline.analyze-dish\",\n          dishName,\n          restaurantName,\n          recipe,\n          normalized,\n          organs,\n          debug: {\n            ...(organs && organs.debug ? organs.debug : {}),\n            lex_blob_raw: lex,\n            lex_blob_hits: blobHits,\n            lex_per_ingredient: lexPerIngredient,\n            lex_primary_hits: primaryLexHits\n          }\n        },\n        200\n      );\n    }\n\n    if (pathname === \"/organs/from-dish\" && request.method === \"GET\") {\n      const id = _cid(request.headers);\n      const init = { method: \"GET\", headers: new Headers(request.headers) };\n      init.headers.set(\"x-correlation-id\", id);\n      const res = await env.allergen_organs.fetch(\n        new Request(request.url, init)\n      );\n      const out = new Headers(res.headers);\n      out.set(\"x-correlation-id\", id);\n      out.set(\"x-tb-worker\", env.WORKER_NAME || \"tb-dish-processor-production\");\n      out.set(\"x-tb-env\", env.ENV || \"production\");\n      out.set(\"x-tb-git\", env.GIT_SHA || \"n/a\");\n      out.set(\"x-tb-built\", env.BUILT_AT || \"n/a\");\n      return new Response(res.body, { status: res.status, headers: out });\n    }\n    if (pathname === \"/organs/list\" && request.method === \"GET\") {\n      const ORGANS = await getOrgans(env);\n      return json({ ok: true, organs: ORGANS });\n    }\n    if (pathname === \"/debug/echo\") {\n      return handleDebugEcho(url, request);\n    }\n    if (pathname === \"/debug/whoami\" && request.method === \"GET\") {\n      return tbWhoami(env);\n    }\n    if (pathname === \"/debug/brain-health\" && request.method === \"GET\") {\n      const urlBase = new URL(request.url).origin;\n      const results = {};\n\n      results.gateway = {\n        ok: true,\n        env: env?.ENV || \"production\",\n        built_at: env?.BUILT_AT || \"n/a\",\n        base: urlBase\n      };\n\n      const restaurantFetch =\n        env.restaurant_core?.fetch?.bind(env.restaurant_core) || null;\n      const recipeFetch =\n        env.recipe_core?.fetch?.bind(env.recipe_core) || null;\n      const allergenFetch =\n        env.allergen_organs?.fetch?.bind(env.allergen_organs) || null;\n      const metricsFetch =\n        env.metrics_core?.fetch?.bind(env.metrics_core) || null;\n\n      const restaurantUrl =\n        env.RESTAURANT_CORE_URL ||\n        \"https://tb-restaurant-core.internal/debug/whoami\";\n      const recipeUrl =\n        env.RECIPE_CORE_URL ||\n        \"https://tb-recipe-core.internal/debug/whoami\";\n      const allergenUrl =\n        env.ALLERGEN_ORGANS_URL ||\n        \"https://tb-allergen-organs.internal/debug/whoami\";\n      const metricsUrl =\n        env.METRICS_CORE_URL ||\n        \"https://tb-metrics-core.internal/debug/whoami\";\n\n      results.restaurant_core = await callJson(restaurantUrl, {\n        fetcher: restaurantFetch\n      }).catch((e) => ({\n        ok: false,\n        error: String(e)\n      }));\n      results.recipe_core = await callJson(recipeUrl, {\n        fetcher: recipeFetch\n      }).catch((e) => ({\n        ok: false,\n        error: String(e)\n      }));\n      results.allergen_organs = await callJson(allergenUrl, {\n        fetcher: allergenFetch\n      }).catch((e) => ({\n        ok: false,\n        error: String(e)\n      }));\n      results.metrics_core = await callJson(metricsUrl, {\n        fetcher: metricsFetch\n      }).catch((e) => ({\n        ok: false,\n        error: String(e)\n      }));\n\n      const overallOk =\n        results.gateway.ok &&\n        results.restaurant_core.ok &&\n        results.recipe_core.ok &&\n        results.allergen_organs.ok &&\n        results.metrics_core.ok;\n\n      return new Response(\n        JSON.stringify(\n          {\n            ok: overallOk,\n            results\n          },\n          null,\n          2\n        ),\n        {\n          status: overallOk ? 200 : 503,\n          headers: { \"content-type\": \"application/json\" }\n        }\n      );\n    }\n    if (pathname === \"/debug/edamam-recipe\") {\n      const dish = (url.searchParams.get(\"dish\") || \"Chicken Alfredo\").trim();\n      const debugUser =\n        (url.searchParams.get(\"user_id\") || \"\").trim() || \"anon\";\n      const edamam =\n        typeof callEdamamRecipe === \"function\"\n          ? await callEdamamRecipe(dish, env, { user_id: debugUser })\n          : { error: \"callEdamamRecipe not available\" };\n      return okJson({ dish, edamam });\n    }\n    if (pathname === \"/debug/edamam-nutrition\" && request.method === \"POST\") {\n      const body = await readJsonSafe(request);\n      const edamam =\n        typeof callEdamamNutritionAnalyze === \"function\"\n          ? await callEdamamNutritionAnalyze(\n              {\n                title: body?.title || \"Recipe\",\n                ingr: Array.isArray(body?.lines) ? body.lines : []\n              },\n              env\n            )\n          : { error: \"callEdamamNutritionAnalyze not available\" };\n      return okJson(edamam);\n    }\n    if (pathname === \"/user/meals/recent\") {\n      const userId = url.searchParams.get(\"user_id\");\n      const limit = Math.max(\n        1,\n        Math.min(50, Number(url.searchParams.get(\"limit\") || 20))\n      );\n      if (!userId)\n        return okJson({ ok: false, error: \"user_id is required\" }, 400);\n      if (!env.D1_DB)\n        return okJson({ ok: false, error: \"D1_DB not bound\" }, 500);\n\n      const ORGANS = await getOrgans(env);\n\n      const { results } = await env.D1_DB.prepare(\n        `SELECT id, user_id, dish,\n            ingredients_json,\n            organ_levels_json,\n            top_drivers_json,\n            calories_kcal,\n            created_at\n     FROM user_meal_logs\n     WHERE user_id = ?\n     ORDER BY datetime(created_at) DESC\n     LIMIT ?`\n      )\n        .bind(userId, limit)\n        .all();\n\n      const levelToBar = (s) =>\n        ({\n          \"High Benefit\": 80,\n          Benefit: 40,\n          Neutral: 0,\n          Caution: -40,\n          \"High Caution\": -80\n        })[s] ?? 0;\n      const levelToColor = (s) =>\n        ({\n          \"High Benefit\": \"#16a34a\",\n          Benefit: \"#22c55e\",\n          Neutral: \"#a1a1aa\",\n          Caution: \"#f59e0b\",\n          \"High Caution\": \"#dc2626\"\n        })[s] ?? \"#a1a1aa\";\n      const barometerToColor = (n) =>\n        n >= 40\n          ? \"#16a34a\"\n          : n > 0\n            ? \"#22c55e\"\n            : n === 0\n              ? \"#a1a1aa\"\n              : n <= -40\n                ? \"#dc2626\"\n                : \"#f59e0b\";\n      const titleFor = (key) => {\n        if (!key) return \"\";\n        const nice = key.replace(/_/g, \" \");\n        return nice.charAt(0).toUpperCase() + nice.slice(1);\n      };\n      const items = [];\n      for (const row of results || []) {\n        const organ_levels = safeJson(row.organ_levels_json, {});\n        const top_drivers = safeJson(row.top_drivers_json, {});\n        const organ_bars = Object.fromEntries(\n          Object.entries(organ_levels).map(([k, v]) => [k, levelToBar(v)])\n        );\n        const organ_colors = Object.fromEntries(\n          Object.entries(organ_levels).map(([k, v]) => [k, levelToColor(v)])\n        );\n        const tummy = computeBarometerFromLevelsAll(ORGANS, organ_levels);\n        const barometer_color = barometerToColor(tummy);\n        const insight_lines = ORGANS.map((key) => {\n          if (!organ_levels[key]) return null;\n          const drivers = Array.isArray(top_drivers[key])\n            ? top_drivers[key]\n            : [];\n          if (!drivers.length) return null;\n          return `${titleFor(key)}: ${drivers.join(\", \")}`;\n        })\n          .filter(Boolean)\n          .slice(0, 3);\n        const dish_summary = `${\n          tummy >= 60 ? \"\uD83D\uDFE2\" : tummy >= 40 ? \"\uD83D\uDFE1\" : \"\uD83D\uDFE0\"\n        } ${insight_lines[0] || \"See details\"}`;\n        const item = {\n          id: row.id,\n          user_id: row.user_id,\n          dish: row.dish,\n          ingredients: safeJson(row.ingredients_json, []),\n          organ_levels,\n          organ_bars,\n          organ_colors,\n          top_drivers,\n          calories_kcal: row.calories_kcal ?? null,\n          tummy_barometer: tummy,\n          barometer_color,\n          created_at: row.created_at\n        };\n        item.insight_lines = insight_lines;\n        item.dish_summary = dish_summary;\n        items.push(item);\n      }\n      return json({ ok: true, count: items.length, items });\n    }\n    if (pathname === \"/debug/nutrition\") {\n      const test = await callEdamamNutritionAnalyze(\n        { title: \"Test\", ingr: [\"1 cup milk\"] },\n        env\n      );\n      return okJson({\n        ok: true,\n        reason: test?.reason,\n        calories: test?.calories ?? test?.nutrition?.calories ?? null,\n        has_ingredients: Array.isArray(test?.ingredients)\n          ? test.ingredients.length\n          : 0\n      });\n    }\n\n    // Enqueue (producer)\n    if (request.method === \"POST\" && pathname === \"/enqueue\") {\n      const body = await request.json().catch(() => ({}));\n      const id = body?.id || crypto.randomUUID();\n      body.id = id;\n\n      if (!env.ANALYSIS_QUEUE)\n        return jsonResponse(\n          { ok: false, error: \"ANALYSIS_QUEUE not bound\" },\n          500\n        );\n      await env.ANALYSIS_QUEUE.send(body);\n      return jsonResponse({ ok: true, id });\n    }\n\n    if (pathname === \"/health\") {\n      const version = getVersion(env);\n      return new Response(JSON.stringify({ ok: true, version }), {\n        headers: { \"content-type\": \"application/json\" }\n      });\n    }\n\n    if (pathname === \"/debug/vision\") {\n      return handleDebugVision(request, env);\n    }\n\n    if (pathname === \"/debug/fetch-bytes\") {\n      return handleDebugFetchBytes(request);\n    }\n\n    if (pathname === \"/metrics\") {\n      if (!env.D1_DB) {\n        return json({ ok: false, error: \"D1_DB not bound\" }, { status: 500 });\n      }\n      const ready = await ensureMetricsTable(env);\n      if (!ready) {\n        return json(\n          { ok: false, error: \"metrics_table_unavailable\" },\n          { status: 500 }\n        );\n      }\n      const totals = await env.D1_DB.prepare(\n        \"SELECT name, SUM(value) AS total FROM metrics GROUP BY name ORDER BY name\"\n      ).all();\n      const recent = await env.D1_DB.prepare(\n        \"SELECT ts, name, value FROM metrics ORDER BY ts DESC LIMIT 50\"\n      ).all();\n      return json({\n        ok: true,\n        totals: totals?.results || [],\n        recent: recent?.results || []\n      });\n    }\n\n    if (pathname === \"/meta\") {\n      const ctx = {\n        served_at: new Date().toISOString(),\n        version: getVersion(env)\n      };\n      const bootAt = await ensureBootTime(env);\n      const uptime_seconds = bootAt\n        ? Math.max(0, Math.floor((Date.now() - Date.parse(bootAt)) / 1000))\n        : null;\n\n      const body = {\n        ok: true,\n        version: ctx.version,\n        served_at: ctx.served_at,\n        uptime_seconds,\n        bindings: {\n          r2: !!env.R2_BUCKET,\n          kv: !!env.LEXICON_CACHE,\n          d1: !!env.D1_DB,\n          queue: !!env.ANALYSIS_QUEUE,\n          rapidapi_host: !!env.RAPIDAPI_HOST || !!env.UBER_RAPID_HOST,\n          rapidapi_key: !!env.RAPIDAPI_KEY,\n          lexicon_api_url: !!env.LEXICON_API_URL,\n          lexicon_api_key: !!env.LEXICON_API_KEY\n        }\n      };\n\n      const rid = newRequestId();\n      return jsonResponseWithTB(\n        withBodyAnalytics(body, ctx, rid, { endpoint: \"meta\" }),\n        200,\n        { ctx, rid, source: \"meta\", cache: \"\" }\n      );\n    }\n\n    if (pathname === \"/debug/status\") {\n      const ctx = {\n        served_at: new Date().toISOString(),\n        version: getVersion(env)\n      };\n      const status = (await readStatusKV(env)) || {\n        updated_at: null,\n        counts: {}\n      };\n      const rid = newRequestId();\n      const body = withBodyAnalytics({ ok: true, status }, ctx, rid, {\n        endpoint: \"debug-status\"\n      });\n      return jsonResponseWithTB(body, 200, {\n        ctx,\n        rid,\n        source: \"debug-status\"\n      });\n    }\n\n    if (pathname === \"/debug/ping\") {\n      const version = getVersion(env);\n      return new Response(\n        JSON.stringify({\n          ok: true,\n          version,\n          bindings: {\n            r2: !!env.R2_BUCKET,\n            kv: !!env.LEXICON_CACHE,\n            d1: !!env.D1_DB,\n            RAPIDAPI_HOST: !!env.RAPIDAPI_HOST,\n            RAPIDAPI_KEY: !!env.RAPIDAPI_KEY,\n            LEXICON_API_URL: !!env.LEXICON_API_URL,\n            LEXICON_API_KEY: !!env.LEXICON_API_KEY\n          }\n        }),\n        { headers: { \"content-type\": \"application/json\" } }\n      );\n    }\n\n    if (pathname === \"/debug/env\") {\n      return json({\n        ZESTFUL_DAILY_CAP: env.ZESTFUL_DAILY_CAP || null,\n        PROVIDERS_RECIPE: env.PROVIDERS_RECIPE || null,\n        PROVIDERS_PARSE: env.PROVIDERS_PARSE || null,\n        USDA_FDC_HOST: env.USDA_FDC_HOST || null,\n        has_SPOONACULAR_API_KEY: !!env.SPOONACULAR_API_KEY,\n        has_EDAMAM_KEYS: !!env.EDAMAM_APP_ID && !!env.EDAMAM_APP_KEY,\n        has_ZESTFUL_KEY: !!env.ZESTFUL_RAPID_KEY,\n        has_FDC_KEY: !!env.USDA_FDC_API_KEY\n      });\n    }\n\n    if (pathname === \"/debug/fdc\") {\n      const name = url.searchParams.get(\"name\") || \"\";\n      if (!name)\n        return json({ ok: false, error: \"MISSING_NAME\" }, { status: 400 });\n      const hit = await callUSDAFDC(env, name);\n      return json({ ok: !!hit, name, hit });\n    }\n\n    if (pathname === \"/debug/fdc-cache\") {\n      if (!env?.R2_BUCKET)\n        return json(\n          { ok: false, error: \"R2_BUCKET not bound\" },\n          { status: 400 }\n        );\n      const u = new URL(request.url);\n      const name = (u.searchParams.get(\"name\") || \"\").trim();\n      const prefix = (u.searchParams.get(\"prefix\") || \"nutrition/\").trim();\n      const limit = Math.min(\n        parseInt(u.searchParams.get(\"limit\") || \"50\", 10),\n        200\n      );\n\n      if (name) {\n        const key = `nutrition/${normKey(name)}.json`;\n        const head = await r2Head(env, key);\n        if (!head) return json({ ok: true, cached: false, key, data: null });\n        const obj = await env.R2_BUCKET.get(key);\n        const data = obj ? await obj.json().catch(() => null) : null;\n        return json({ ok: true, cached: !!data, key, data });\n      }\n\n      const listing = await env.R2_BUCKET.list({ prefix, limit });\n      return json({\n        ok: true,\n        prefix,\n        limit,\n        count: listing.objects?.length || 0,\n        objects: (listing.objects || []).map((o) => ({\n          key: o.key,\n          size: o.size,\n          uploaded: o.uploaded || null\n        }))\n      });\n    }\n\n    if (pathname === \"/debug/off\") {\n      const u = new URL(request.url);\n      const name = (u.searchParams.get(\"name\") || \"\").trim();\n      if (!name)\n        return json({ ok: false, error: \"missing name\" }, { status: 400 });\n      const hit = await callOFF(env, name);\n      return json({ ok: true, name, hit });\n    }\n\n    if (pathname === \"/debug/last\") {\n      const id = env.LEXICON_CACHE\n        ? await env.LEXICON_CACHE.get(\"last_job_id\")\n        : null;\n      const ts = env.LEXICON_CACHE\n        ? await env.LEXICON_CACHE.get(\"last_job_ts\")\n        : null;\n      return jsonResponse({ ok: true, last_job_id: id, last_job_ts: ts });\n    }\n\n    if (pathname === \"/debug/job\") {\n      const id = searchParams.get(\"id\");\n      if (!id) return jsonResponse({ ok: false, error: \"missing id\" }, 400);\n      if (!env.R2_BUCKET)\n        return jsonResponse({ ok: false, error: \"R2 not bound\" }, 500);\n\n      const keyNew = `jobs/${id}.json`;\n      const keyOld = `results/${id}.json`;\n      let obj = await env.R2_BUCKET.get(keyNew);\n      let keyUsed = keyNew;\n      if (!obj) {\n        obj = await env.R2_BUCKET.get(keyOld);\n        keyUsed = keyOld;\n      }\n      if (!obj)\n        return jsonResponse(\n          { ok: false, error: \"not_found\", key: keyNew },\n          404\n        );\n      const body = await obj.text();\n      return jsonResponse({ ok: true, key: keyUsed, data: JSON.parse(body) });\n    }\n\n    if (pathname === \"/debug/config\") {\n      const rapidHost = cleanHost(env.RAPIDAPI_HOST);\n      const lexBase = normalizeBase(env.LEXICON_API_URL);\n      const builtLexURL = buildLexiconAnalyzeURL(lexBase);\n      return jsonResponse({\n        ok: true,\n        rapidapi_host_preview: rapidHost || null,\n        lexicon_url_preview: lexBase || null,\n        lexicon_analyze_url_built: builtLexURL || null,\n        has_kv: !!env.LEXICON_CACHE,\n        has_queue: !!env.ANALYSIS_QUEUE,\n        has_d1: !!env.D1_DB,\n        has_r2: !!env.R2_BUCKET\n      });\n    }\n\n    if (pathname === \"/debug/llm-config\") {\n      return jsonResponse({\n        ok: true,\n        grok: {\n          has_url: !!(env.GROK_API_URL || \"\").trim(),\n          has_key: !!(env.GROK_API_KEY || env.Tummy_Buddy_Grok || \"\").trim()\n        },\n        openai: {\n          has_key: !!(env.OPENAI_API_KEY || \"\").trim(),\n          base: env.OPENAI_API_BASE || \"https://api.openai.com\"\n        }\n      });\n    }\n\n    if (pathname === \"/debug/ping-lexicon\") {\n      const lexBase = normalizeBase(env.LEXICON_API_URL);\n      const urlToCall = buildLexiconAnalyzeURL(lexBase);\n      const key = env.LEXICON_API_KEY;\n      if (!lexBase || !key)\n        return jsonResponse(\n          { ok: false, error: \"Missing LEXICON_API_URL or LEXICON_API_KEY\" },\n          400\n        );\n\n      const tryXKey = await fetch(urlToCall, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-api-key\": key,\n          \"Accept-Language\": \"en\"\n        },\n        body: JSON.stringify({\n          text: \"test chicken with rice\",\n          lang: \"en\",\n          normalize: { diacritics: \"fold\" }\n        })\n      }).catch((e) => ({ ok: false, status: 0, _err: e?.message }));\n      const tryBearer = await fetch(urlToCall, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${key}`,\n          \"Accept-Language\": \"en\"\n        },\n        body: JSON.stringify({\n          text: \"test chicken with rice\",\n          lang: \"en\",\n          normalize: { diacritics: \"fold\" }\n        })\n      }).catch((e) => ({ ok: false, status: 0, _err: e?.message }));\n\n      let bodyX = \"\";\n      try {\n        bodyX = typeof tryXKey.text === \"function\" ? await tryXKey.text() : \"\";\n      } catch {}\n      let bodyB = \"\";\n      try {\n        bodyB =\n          typeof tryBearer.text === \"function\" ? await tryBearer.text() : \"\";\n      } catch {}\n\n      return jsonResponse({\n        ok: (tryXKey?.ok || tryBearer?.ok) ?? false,\n        url_called: urlToCall,\n        used_env_LEXICON_API_URL: env.LEXICON_API_URL || null,\n        results: {\n          x_api_key: {\n            ok: !!tryXKey?.ok,\n            status: tryXKey?.status ?? 0,\n            preview: (bodyX || \"\").slice(0, 200)\n          },\n          bearer: {\n            ok: !!tryBearer?.ok,\n            status: tryBearer?.status ?? 0,\n            preview: (bodyB || \"\").slice(0, 200)\n          }\n        }\n      });\n    }\n\n    if (pathname === \"/debug/read-kv-shard\") {\n      const name = (searchParams.get(\"name\") || \"\").trim();\n      if (!name) return jsonResponse({ ok: false, error: \"missing name\" }, 400);\n      if (!env.LEXICON_CACHE)\n        return jsonResponse({ ok: false, error: \"KV not bound\" }, 500);\n\n      const key = `shards/${name}.json`;\n      const raw = await env.LEXICON_CACHE.get(key);\n      if (!raw)\n        return jsonResponse({ ok: false, error: \"not_in_kv\", key }, 404);\n\n      let js;\n      try {\n        js = JSON.parse(raw);\n      } catch {\n        return jsonResponse({ ok: false, error: \"bad_json\" }, 500);\n      }\n\n      const total = Array.isArray(js?.entries) ? js.entries.length : 0;\n      const sample = Array.isArray(js?.entries) ? js.entries.slice(0, 25) : [];\n      return jsonResponse({\n        ok: true,\n        name,\n        version: js?.version ?? null,\n        entries_len: total,\n        sample_count: sample.length,\n        sample_terms: sample.map((e) => ({\n          canonical: e?.canonical ?? e?.name ?? e?.term ?? null,\n          term: e?.term ?? null,\n          terms: Array.isArray(e?.terms) ? e.terms.slice(0, 5) : null,\n          synonyms: Array.isArray(e?.synonyms) ? e.synonyms.slice(0, 5) : null,\n          classes: e?.classes ?? null,\n          tags: e?.tags ?? null\n        }))\n      });\n    }\n\n    if (pathname === \"/debug/warm-lexicon\") {\n      const list = lc(searchParams.get(\"names\") || \"\")\n        .split(\",\")\n        .map((s) => s.trim())\n        .filter(Boolean);\n      if (!list.length)\n        return jsonResponse({ ok: false, error: \"missing names\" }, 400);\n\n      const base = normalizeBase(env.LEXICON_API_URL);\n      const key = env.LEXICON_API_KEY;\n      if (!base || !key)\n        return jsonResponse(\n          { ok: false, error: \"Missing LEXICON_API_URL or LEXICON_API_KEY\" },\n          400\n        );\n\n      const out = [];\n      for (const name of list) {\n        const url = `${base}/v1/shards/${name}`;\n        try {\n          const r = await fetch(url, { headers: { \"x-api-key\": key } });\n          if (!r.ok) {\n            out.push({ shard: name, url, status: r.status, ok: false });\n            continue;\n          }\n          const text = await r.text();\n          const js = parseJsonSafe(text, null);\n          const entries_len = Array.isArray(js?.entries)\n            ? js.entries.length\n            : 0;\n          if (env.LEXICON_CACHE) {\n            await env.LEXICON_CACHE.put(`shards/${name}.json`, text, {\n              expirationTtl: 86400\n            });\n          }\n          out.push({\n            shard: name,\n            url,\n            status: 200,\n            ok: true,\n            entries_len,\n            version: js?.version ?? null\n          });\n        } catch (e) {\n          out.push({\n            shard: name,\n            url,\n            status: 0,\n            ok: false,\n            error: e?.message || String(e)\n          });\n        }\n      }\n      return jsonResponse({ ok: true, warmed: out });\n    }\n\n    if (pathname === \"/debug/refresh-ingredient-shards\") {\n      try {\n        const idx = await refreshShardIndex(env);\n        const indexFromKV = await readShardIndexFromKV(env);\n        const names = indexFromKV\n          ? pickIngredientShardNamesFromIndex(indexFromKV)\n          : STATIC_INGREDIENT_SHARDS;\n\n        const base = normalizeBase(env.LEXICON_API_URL);\n        const key = env.LEXICON_API_KEY;\n        if (!base || !key)\n          return jsonResponse(\n            { ok: false, error: \"Missing LEXICON_API_URL or LEXICON_API_KEY\" },\n            400\n          );\n\n        const warmed = [];\n        for (const name of names) {\n          const url = `${base}/v1/shards/${name}`;\n          try {\n            const r = await fetch(url, { headers: { \"x-api-key\": key } });\n            if (!r.ok) {\n              warmed.push({ shard: name, url, status: r.status, ok: false });\n              continue;\n            }\n            const text = await r.text();\n            const js = parseJsonSafe(text, null);\n            const entries_len = Array.isArray(js?.entries)\n              ? js.entries.length\n              : 0;\n            if (env.LEXICON_CACHE) {\n              await env.LEXICON_CACHE.put(`shards/${name}.json`, text, {\n                expirationTtl: 86400\n              });\n            }\n            warmed.push({\n              shard: name,\n              url,\n              status: 200,\n              ok: true,\n              entries_len,\n              version: js?.version ?? null\n            });\n          } catch (e) {\n            warmed.push({\n              shard: name,\n              url,\n              status: 0,\n              ok: false,\n              error: e?.message || String(e)\n            });\n          }\n        }\n\n        return jsonResponse({\n          ok: true,\n          index_refresh: idx,\n          warmed_count: warmed.length,\n          warmed\n        });\n      } catch (e) {\n        return jsonResponse({ ok: false, error: e?.message || String(e) }, 500);\n      }\n    }\n\n    // --- Public lean results with CORS: GET /results/<id>.json (+ preflight) ---\n    if (pathname.startsWith(\"/results/\")) {\n      const CORS = {\n        \"Access-Control-Allow-Origin\": \"*\",\n        \"Access-Control-Allow-Methods\": \"GET, OPTIONS\",\n        \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\"\n      };\n      if (request.method === \"OPTIONS\")\n        return new Response(null, { status: 204, headers: CORS });\n\n      if (request.method === \"GET\") {\n        if (!env.R2_BUCKET) {\n          return new Response(\n            JSON.stringify({ ok: false, error: \"R2 not bound\" }),\n            {\n              status: 500,\n              headers: { ...CORS, \"content-type\": \"application/json\" }\n            }\n          );\n        }\n        const parts = pathname.split(\"/\");\n        const file = parts[parts.length - 1] || \"\";\n        const id = file.endsWith(\".json\") ? file.slice(0, -5) : file;\n        const key = `results/${id}.json`;\n        const obj = await env.R2_BUCKET.get(key);\n        if (!obj) {\n          return new Response(\n            JSON.stringify({ ok: false, error: \"not_found\", key }),\n            {\n              status: 404,\n              headers: { ...CORS, \"content-type\": \"application/json\" }\n            }\n          );\n        }\n        const body = await obj.text();\n        let payload = null;\n        try {\n          payload = JSON.parse(body);\n        } catch {}\n\n        if (payload) {\n          const userId = (url.searchParams.get(\"user_id\") || \"\").trim();\n          const rawPrefs = await loadUserPrefs(env, userId);\n          const safePrefs =\n            rawPrefs && typeof rawPrefs === \"object\"\n              ? rawPrefs\n              : { allergens: [], fodmap: {} };\n          const pills = derivePillsForUser(payload.ingredient_hits, safePrefs);\n          payload.pills_user = pills;\n          if (payload.dish && typeof payload.dish === \"object\") {\n            payload.dish.pills_user = pills;\n          }\n          payload.user_prefs = safePrefs;\n          return new Response(JSON.stringify(payload), {\n            status: 200,\n            headers: {\n              ...CORS,\n              \"content-type\": \"application/json\",\n              \"cache-control\": \"public, max-age=30\"\n            }\n          });\n        }\n\n        return new Response(body, {\n          status: 200,\n          headers: {\n            ...CORS,\n            \"content-type\": \"application/json\",\n            \"cache-control\": \"public, max-age=30\"\n          }\n        });\n      }\n    }\n\n    // --- DEBUG: RapidAPI health check ---\n    if (pathname === \"/debug/rapid\") {\n      const host =\n        env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n      const key = env.RAPIDAPI_KEY || \"\";\n      let status = 0,\n        text = \"\",\n        probe;\n\n      async function tryPath(p) {\n        const res = await fetch(`https://${host}${p}`, {\n          headers: {\n            \"x-rapidapi-key\": key,\n            \"x-rapidapi-host\": host,\n            accept: \"application/json\"\n          }\n        });\n        return { status: res.status, text: await res.text(), path: p };\n      }\n\n      try {\n        probe = await tryPath(\"/health\");\n        if (probe.status === 404) probe = await tryPath(\"/health/public\");\n        status = probe.status;\n        text = probe.text;\n      } catch (e) {\n        text = String(e);\n      }\n\n      return new Response(\n        JSON.stringify(\n          {\n            ok: status >= 200 && status < 400,\n            used_host: host,\n            has_key: !!key,\n            upstream_path: probe?.path || null,\n            upstream_status: status,\n            upstream_text: text.slice(0, 400)\n          },\n          null,\n          2\n        ),\n        { headers: { \"content-type\": \"application/json\" } }\n      );\n    }\n\n    // --- DEBUG: direct RapidAPI POST to /api/job ---\n    if (pathname === \"/debug/rapid-job\") {\n      const host =\n        env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n      const key = env.RAPIDAPI_KEY || \"\";\n\n      const q = searchParams.get(\"query\") || \"seafood\";\n      const addr = searchParams.get(\"address\") || \"South Miami, FL, USA\";\n      const max = Number(searchParams.get(\"maxRows\") || 3);\n      const locale = searchParams.get(\"locale\") || \"en-US\";\n      const page = Number(searchParams.get(\"page\") || 1);\n\n      const body = {\n        scraper: { maxRows: max, query: q, address: addr, locale, page }\n      };\n\n      let status = 0,\n        text = \"\",\n        js = null;\n      try {\n        const res = await fetch(`https://${host}/api/job`, {\n          method: \"POST\",\n          headers: {\n            accept: \"application/json\",\n            \"content-type\": \"application/json\",\n            \"x-rapidapi-key\": key,\n            \"x-rapidapi-host\": host\n          },\n          body: JSON.stringify(body)\n        });\n        status = res.status;\n        text = await res.text();\n        try {\n          js = JSON.parse(text);\n        } catch {}\n      } catch (e) {\n        text = String(e);\n      }\n\n      return new Response(\n        JSON.stringify(\n          {\n            used_host: host,\n            has_key: !!key,\n            sent_body: body,\n            upstream_status: status,\n            upstream_json: js ?? null,\n            upstream_text_sample: text.slice(0, 400)\n          },\n          null,\n          2\n        ),\n        { headers: { \"content-type\": \"application/json\" } }\n      );\n    }\n\n    if (pathname === \"/debug/r2-list\") {\n      const prefix = searchParams.get(\"prefix\") || \"\";\n      const limit = Number(searchParams.get(\"limit\") || \"25\");\n      const cursor = searchParams.get(\"cursor\") || undefined;\n\n      const listing = await env.R2_BUCKET.list({ prefix, limit, cursor });\n\n      return jsonResponse({\n        ok: true,\n        prefix,\n        limit,\n        truncated: listing.truncated,\n        cursor: listing.truncated ? listing.cursor : null,\n        objects: listing.objects.map((o) => ({\n          key: o.key,\n          size: o.size,\n          uploaded: o.uploaded ? new Date(o.uploaded).toISOString() : null\n        }))\n      });\n    }\n\n    if (pathname === \"/debug/r2-get\") {\n      const key = searchParams.get(\"key\");\n      if (!key) return jsonResponse({ ok: false, error: \"missing ?key=\" }, 400);\n\n      const obj = await env.R2_BUCKET.get(key);\n      if (!obj)\n        return jsonResponse({ ok: false, error: \"not_found\", key }, 404);\n\n      const text = await obj.text();\n      try {\n        return jsonResponse({ ok: true, key, json: JSON.parse(text) });\n      } catch {\n        return new Response(text, {\n          status: 200,\n          headers: { \"content-type\": \"application/json\" }\n        });\n      }\n    }\n\n    if (pathname === \"/menu/extract\" && request.method === \"GET\") {\n      const url = new URL(request.url);\n      const search = url.search || \"\";\n\n      const upstreamUrl =\n        \"https://tb-restaurant-core.internal/menu/extract\" + search;\n\n      const upstreamResp = await env.restaurant_core.fetch(upstreamUrl, {\n        method: \"GET\",\n        headers: request.headers\n      });\n\n      return upstreamResp;\n    }\n    if (pathname === \"/recipe/resolve\")\n      return handleRecipeResolve(env, request, url, ctx);\n\n    // Cleaner Uber Eats test endpoint (returns flattened items)\n    if (pathname === \"/menu/uber-test\" && request.method === \"GET\") {\n      let ctx = makeCtx(env);\n      let rid = newRequestId();\n      let trace = {}; // ensure 'trace' exists immediately\n      try {\n        const query = searchParams.get(\"query\") || \"\";\n        const addressRaw = searchParams.get(\"address\") || \"\";\n        const locale = searchParams.get(\"locale\") || \"en-US\";\n        const page = Number(searchParams.get(\"page\") || 1);\n        const maxRows = parseInt(searchParams.get(\"maxRows\") || \"15\", 10);\n        const lat = searchParams.get(\"lat\");\n        const lng = searchParams.get(\"lng\");\n        const radius = parseInt(searchParams.get(\"radius\") || \"5000\", 10);\n        const latNum = lat !== null ? parseFloat(lat) : null;\n        const lngNum = lng !== null ? parseFloat(lng) : null;\n        const debug = searchParams.get(\"debug\");\n        const forceUSFlag =\n          searchParams.get(\"us\") === \"1\" || looksLikeUSAddress(addressRaw);\n        // [41.2] \u2014 analytics context + ids + trace\n        trace = makeTrace(\"uber-test\", searchParams, env);\n        // --- make warning + respondTB available BEFORE any early returns (like debug=limits)\n        let _warnMsg = null;\n        function setWarn(msg) {\n          if (!msg) return;\n          _warnMsg = _warnMsg ? `${_warnMsg} ${msg}` : String(msg);\n        }\n        const warnPart = () => (_warnMsg ? { warning: _warnMsg } : {});\n        function respondTB(body, status = 200, opts = {}, extraHeaders = {}) {\n          // body should already be run through withBodyAnalytics(...) before calling here\n          const source = body?.source || opts.source || \"\";\n          const cache = body?.cache || opts.cache || \"\";\n          const warning = Boolean(body?.warning || opts.warning);\n          return jsonResponseWithTB(\n            body,\n            status,\n            { ctx, rid, source, cache, warning },\n            extraHeaders\n          );\n        }\n        trace.host =\n          trace.host ||\n          env.UBER_RAPID_HOST ||\n          \"uber-eats-scraper-api.p.rapidapi.com\"; // [38.9]\n\n        // [40.3] \u2014 local rate-limit simulation\n        if (searchParams.get(\"debug\") === \"ratelimit\") {\n          const secs = Number(searchParams.get(\"after\") || 42);\n          trace.used_path = \"debug-ratelimit\";\n          return rateLimitResponse(ctx, rid, trace, secs, \"debug-ratelimit\");\n        }\n        // [39.1a] Early validation: require ?query for address/GPS search\n        if (!isNonEmptyString(query)) {\n          await bumpStatusKV(env, { errors_4xx: 1 });\n          return errorResponseWith(\n            {\n              ok: false,\n              error: 'Missing \"query\" (restaurant name).',\n              hint: \"Example: /menu/uber-test?query=McDonald%27s&address=Miami,%20FL\",\n              examples: [\n                \"/menu/uber-test?query=McDonald%27s&address=Miami,%20FL\",\n                \"/menu/uber-test?query=Starbucks&address=Seattle,%20WA\",\n                \"/menu/uber-test?query=Chipotle&address=Austin,%20TX\"\n              ]\n            },\n            400,\n            ctx,\n            {\n              \"X-TB-Source\": \"input-missing\",\n              trace: safeTrace(trace)\n            },\n            rid\n          );\n        }\n        if ((lat && !lng) || (!lat && lng)) {\n          await bumpStatusKV(env, { errors_4xx: 1 });\n          return errorResponseWith(\n            {\n              ok: false,\n              error: 'GPS search needs both \"lat\" and \"lng\".',\n              hint: \"Example: /menu/uber-test?query=Pizza&lat=25.7617&lng=-80.1918&radius=5000&maxRows=10\",\n              examples: [\n                \"/menu/uber-test?query=McDonald%27s&address=Miami,%20FL\",\n                \"/menu/uber-test?query=Pizza&lat=25.7617&lng=-80.1918&radius=5000&maxRows=10\"\n              ]\n            },\n            400,\n            ctx,\n            {\n              \"X-TB-Source\": \"input-missing\",\n              trace: safeTrace(trace)\n            },\n            rid\n          );\n        }\n        // [38.8] \u2014 quick QA view of effective limits\n        if (debug === \"limits\") {\n          const snap = limitsSnapshot({ maxRows, radius });\n          await bumpStatusKV(env, { debug: 1 });\n          return respondTB(\n            withBodyAnalytics(\n              {\n                ok: true,\n                source: \"debug-limits\",\n                query,\n                address: addressRaw,\n                limits: snap\n              },\n              ctx,\n              rid,\n              trace\n            ),\n            200\n          );\n        }\n        // [38.3] \u2014 warning collector (already defined above; kept for clarity)\n\n        // --- Menu cache lookup ---\n        const cacheKey = cacheKeyForMenu(query, addressRaw, !!forceUSFlag);\n        const wantDebugCache = debug === \"cache\";\n        let cacheStatus = \"miss\";\n        let cached = null;\n        let cachedItems = null;\n        let cacheAgeSec = null;\n        try {\n          cached = await readMenuFromCache(env, cacheKey);\n          // [38.7] compute cache age (seconds)\n          cacheAgeSec = null;\n          if (cached?.savedAt) {\n            cacheAgeSec = Math.max(\n              0,\n              Math.floor((Date.now() - Date.parse(cached.savedAt)) / 1000)\n            );\n          }\n          // [38.3] age warning for cached data (>20h considered stale-ish)\n          if (cached?.savedAt) {\n            const ageSec = Math.max(\n              0,\n              (Date.now() - Date.parse(cached.savedAt)) / 1000\n            );\n            if (ageSec > 20 * 3600)\n              setWarn(\"Cached data is older than ~20 hours (may be stale).\");\n          }\n          // Allow inspecting the cached payload directly\n          if (wantDebugCache) {\n            return respondTB(\n              withBodyAnalytics(\n                {\n                  ok: true,\n                  source: \"cache\",\n                  cache: cached ? \"hit\" : \"miss\",\n                  cache_age_seconds: cacheAgeSec,\n                  ...cached,\n                  ...warnPart()\n                },\n                ctx,\n                rid,\n                trace\n              ),\n              200\n            );\n          }\n\n          // If cache has usable items, hydrate them as a fast-path\n          if (cached?.data) {\n            cachedItems = Array.isArray(cached.data.items)\n              ? cached.data.items\n              : null;\n            if (cachedItems) cacheStatus = \"hit\";\n\n            // Hydrate a local flattenedItems from cache so the same enqueue logic can use it\n            if (cachedItems) {\n              const flattenedItems = cachedItems;\n              // If the caller requested analysis, run the enqueue block against flattenedItems\n              // (this mirrors the enqueue behavior used for live fetches).\n              const wantAnalyze = searchParams.get(\"analyze\") === \"1\";\n              let enqueued = [];\n              if (flattenedItems && wantAnalyze) {\n                const top = filterAndRankItems(\n                  flattenedItems,\n                  searchParams,\n                  env\n                );\n                const place_id =\n                  searchParams.get(\"place_id\") || \"place.unknown\";\n                const cuisine = searchParams.get(\"cuisine\") || \"\";\n                ({ enqueued } = await enqueueTopItems(env, top, {\n                  place_id,\n                  cuisine,\n                  query,\n                  address: addressRaw,\n                  forceUS: !!forceUSFlag\n                }));\n              }\n\n              // If analyze was requested we consumed the cache and can return it with enqueued[]\n              if (flattenedItems && wantAnalyze) {\n                const address = addressRaw;\n                const forceUS = !!forceUSFlag;\n                trace.used_path = \"/api/job\"; // [38.9]\n                await bumpStatusKV(env, { cache: 1 });\n                return respondTB(\n                  withBodyAnalytics(\n                    {\n                      ok: true,\n                      source: \"cache\",\n                      cache: cacheStatus,\n                      cache_age_seconds: cacheAgeSec,\n                      data: {\n                        query,\n                        address,\n                        forceUS,\n                        items: flattenedItems.slice(0, maxRows)\n                      },\n                      enqueued,\n                      ...warnPart()\n                    },\n                    ctx,\n                    rid,\n                    trace\n                  ),\n                  200\n                );\n              }\n            }\n          }\n        } catch (e) {\n          // ignore cache errors and proceed to live\n        }\n\n        // Address-based job path\n        if (addressRaw) {\n          // US hint: append \", USA\" once if forcing US but address lacks it\n          let address = addressRaw;\n          if (forceUSFlag && !/usa|united states/i.test(address))\n            address = `${addressRaw}, USA`;\n\n          const job = await postJobByAddress(\n            { query, address, maxRows, locale, page },\n            env\n          );\n\n          // Immediate data\n          if (job?.immediate) {\n            let rows = job.raw?.returnvalue?.data || [];\n            const rowsUS = filterRowsUS(rows, forceUSFlag);\n            const titles = rowsUS.map((r) => r?.title).filter(Boolean);\n\n            if (debug === \"titles\") {\n              return respondTB(\n                withBodyAnalytics(\n                  {\n                    ok: true,\n                    source: \"address-immediate\",\n                    count: titles.length,\n                    titles,\n                    ...warnPart()\n                  },\n                  ctx,\n                  rid,\n                  trace\n                ),\n                200\n              );\n            }\n\n            // [38.11b] debug=1 preview for address-immediate\n            if (debug === \"1\") {\n              trace.used_path = \"/api/job\";\n              await bumpStatusKV(env, { debug: 1 });\n              const preview = buildDebugPreview(\n                job?.raw || {},\n                env,\n                rowsUS,\n                titles\n              );\n              return respondTB(\n                withBodyAnalytics(preview, ctx, rid, trace),\n                200\n              );\n            }\n\n            const best = pickBestRestaurant({ rows: rowsUS, query });\n            const chosen =\n              best ||\n              (Array.isArray(rowsUS) && rowsUS.length ? rowsUS[0] : null);\n            if (debug === \"why\") {\n              const exp = explainRestaurantChoices({\n                rows: rowsUS,\n                query,\n                limit: 10\n              });\n              await bumpStatusKV(env, { debug: 1 });\n              return respondTB(\n                withBodyAnalytics(\n                  {\n                    ok: true,\n                    source: \"debug-why-immediate\",\n                    explain: exp,\n                    query,\n                    address: addressRaw,\n                    ...warnPart()\n                  },\n                  ctx,\n                  rid,\n                  trace\n                ),\n                200\n              );\n            }\n            if (!chosen) {\n              await bumpStatusKV(env, { errors_4xx: 1 });\n              return notFoundCandidates(ctx, rid, trace, {\n                query,\n                address: addressRaw\n              });\n            }\n\n            const fake = { data: { results: [chosen] } };\n            const flattenedItems = extractMenuItemsFromUber(fake, query);\n\n            // Optional: enqueue for analysis when requested\n            const analyze = searchParams.get(\"analyze\") === \"1\";\n            let enqueued = [];\n            if (\n              analyze &&\n              Array.isArray(flattenedItems) &&\n              flattenedItems.length\n            ) {\n              const top = filterAndRankItems(flattenedItems, searchParams, env);\n              const place_id = searchParams.get(\"place_id\") || \"place.unknown\";\n              const cuisine = searchParams.get(\"cuisine\") || \"\";\n              ({ enqueued } = await enqueueTopItems(env, top, {\n                place_id,\n                cuisine,\n                query,\n                address: addressRaw,\n                forceUS: !!forceUSFlag\n              }));\n            }\n\n            // 2) Write to cache (best-effort)\n            try {\n              await writeMenuToCache(env, cacheKey, {\n                query,\n                address: addressRaw,\n                forceUS: !!forceUSFlag,\n                items: flattenedItems\n              });\n              cacheStatus = \"stored\";\n            } catch (e) {\n              cacheStatus = \"store-failed\";\n              setWarn(\"Could not store fresh cache (non-fatal).\");\n            }\n\n            // 3) Respond (include enqueued[] when present)\n            trace.used_path = \"/api/job\"; // [38.9]\n            await bumpStatusKV(env, { address_immediate: 1 });\n            return respondTB(\n              withBodyAnalytics(\n                {\n                  ok: true,\n                  source: \"address-immediate\",\n                  cache: cacheStatus,\n                  data: {\n                    query,\n                    address: addressRaw,\n                    forceUS: !!forceUSFlag,\n                    items: flattenedItems.slice(0, maxRows)\n                  },\n                  enqueued,\n                  ...warnPart()\n                },\n                ctx,\n                rid,\n                trace\n              ),\n              200\n            );\n          }\n\n          // Poll by job id\n          const jobId = job?.job_id;\n          if (!jobId) {\n            await bumpStatusKV(env, { errors_5xx: 1 });\n            return errorResponseWith(\n              {\n                ok: false,\n                error:\n                  \"Upstream didn\u2019t return a job_id for the address search.\",\n                hint: \"Please try again in a moment. If this keeps happening, try a nearby ZIP code.\",\n                raw: job\n              },\n              502,\n              ctx,\n              {\n                \"X-TB-Source\": \"job-missing-id\",\n                \"X-TB-Upstream-Status\": \"502\",\n                trace: safeTrace(trace)\n              },\n              rid\n            );\n          }\n\n          const finished = await pollUberJobUntilDone({ jobId, env });\n\n          let rows =\n            finished?.returnvalue?.data ||\n            finished?.data?.data ||\n            finished?.data ||\n            [];\n          const rowsUS = filterRowsUS(rows, forceUSFlag);\n\n          const best = pickBestRestaurant({ rows: rowsUS, query });\n          const chosen =\n            best || (Array.isArray(rowsUS) && rowsUS.length ? rowsUS[0] : null);\n          if (debug === \"why\") {\n            const exp = explainRestaurantChoices({\n              rows: rowsUS,\n              query,\n              limit: 10\n            });\n            await bumpStatusKV(env, { debug: 1 });\n            return respondTB(\n              withBodyAnalytics(\n                {\n                  ok: true,\n                  source: \"debug-why-job\",\n                  explain: exp,\n                  query,\n                  address: addressRaw,\n                  ...warnPart()\n                },\n                ctx,\n                rid,\n                trace\n              ),\n              200\n            );\n          }\n          if (!chosen) {\n            await bumpStatusKV(env, { errors_4xx: 1 });\n            return notFoundCandidates(ctx, rid, trace, {\n              query,\n              address: addressRaw\n            });\n          }\n\n          if (debug === \"titles\") {\n            const titles = (Array.isArray(rowsUS) ? rowsUS : [])\n              .map((r) => r?.title)\n              .filter(Boolean);\n            return respondTB(\n              withBodyAnalytics(\n                {\n                  ok: true,\n                  source: \"address-job\",\n                  picked: chosen?.title || null,\n                  count: titles.length,\n                  titles,\n                  ...warnPart()\n                },\n                ctx,\n                rid,\n                trace\n              ),\n              200\n            );\n          }\n\n          // [38.11b] debug=1 preview for address-job\n          if (debug === \"1\") {\n            trace.used_path = \"/api/job\";\n            const titles = (Array.isArray(rowsUS) ? rowsUS : [])\n              .map((r) => r?.title)\n              .filter(Boolean);\n            await bumpStatusKV(env, { debug: 1 });\n            const preview = buildDebugPreview(\n              finished || {},\n              env,\n              rowsUS,\n              titles\n            );\n            return respondTB(withBodyAnalytics(preview, ctx, rid, trace), 200);\n          }\n\n          const fake = { data: { results: [chosen] } };\n          const flattenedItems = extractMenuItemsFromUber(fake, query);\n\n          // Optional analyze enqueue\n          const analyze = searchParams.get(\"analyze\") === \"1\";\n          let enqueued = [];\n          if (\n            analyze &&\n            Array.isArray(flattenedItems) &&\n            flattenedItems.length\n          ) {\n            const top = filterAndRankItems(flattenedItems, searchParams, env);\n            const place_id = searchParams.get(\"place_id\") || \"place.unknown\";\n            const cuisine = searchParams.get(\"cuisine\") || \"\";\n            ({ enqueued } = await enqueueTopItems(env, top, {\n              place_id,\n              cuisine,\n              query,\n              address: addressRaw,\n              forceUS: !!forceUSFlag\n            }));\n          }\n\n          try {\n            await writeMenuToCache(env, cacheKey, {\n              query,\n              address: addressRaw,\n              forceUS: !!forceUSFlag,\n              items: flattenedItems\n            });\n            cacheStatus = \"stored\";\n          } catch (e) {\n            cacheStatus = \"store-failed\";\n            setWarn(\"Could not store fresh cache (non-fatal).\");\n          }\n          trace.used_path = \"/api/job\"; // [38.9]\n          await bumpStatusKV(env, { address_job: 1 });\n          return respondTB(\n            withBodyAnalytics(\n              {\n                ok: true,\n                source: \"address-job\",\n                cache: cacheStatus,\n                data: {\n                  query,\n                  address: addressRaw,\n                  forceUS: !!forceUSFlag,\n                  items: flattenedItems.slice(0, maxRows)\n                },\n                enqueued,\n                ...warnPart()\n              },\n              ctx,\n              rid,\n              trace\n            ),\n            200\n          );\n        }\n\n        // GPS flow\n        if (lat && lng) {\n          try {\n            const jobRes = await postJobByLocation(\n              { query, lat: Number(lat), lng: Number(lng), radius, maxRows },\n              env\n            );\n            if (jobRes?.path) trace.used_path = jobRes.path; // [38.9]\n            const jobId = jobRes?.job_id || jobRes?.id || jobRes?.jobId;\n            if (!jobId) {\n              await bumpStatusKV(env, { errors_5xx: 1 });\n              return errorResponseWith(\n                {\n                  ok: false,\n                  error:\n                    \"Upstream didn\u2019t return a job_id for the location search.\",\n                  hint: \"Please try again shortly. If it keeps failing, widen the radius or include a ZIP.\",\n                  raw: jobRes\n                },\n                502,\n                ctx,\n                {\n                  \"X-TB-Source\": \"job-missing-id\",\n                  \"X-TB-Upstream-Status\": \"502\",\n                  trace: safeTrace(trace)\n                },\n                rid\n              );\n            }\n\n            const finished = await pollUberJobUntilDone({ jobId, env });\n            const buckets = [\n              finished?.data?.stores,\n              finished?.data?.restaurants,\n              finished?.stores,\n              finished?.restaurants,\n              finished?.data\n            ].filter(Boolean);\n            const candidates = [];\n            for (const b of buckets)\n              if (Array.isArray(b)) candidates.push(...b);\n            const titles = candidates\n              .map((c) => c?.title || c?.name || c?.storeName || c?.displayName)\n              .filter(Boolean);\n\n            if (debug === \"titles\") {\n              return respondTB(\n                withBodyAnalytics(\n                  {\n                    ok: true,\n                    source: \"location-job\",\n                    count: titles.length,\n                    titles,\n                    ...warnPart()\n                  },\n                  ctx,\n                  rid,\n                  trace\n                ),\n                200\n              );\n            }\n\n            await bumpStatusKV(env, { location_job: 1 });\n            return respondTB(\n              withBodyAnalytics(\n                {\n                  ok: true,\n                  source: \"location-job\",\n                  candidates: titles.slice(0, maxRows),\n                  raw: finished,\n                  ...warnPart()\n                },\n                ctx,\n                rid,\n                trace\n              ),\n              200\n            );\n          } catch (e) {\n            const msg = String(e?.message || e);\n            if (msg.includes(\"HARD_404\")) {\n              const nearby = await searchNearbyCandidates(\n                { query, lat: Number(lat), lng: Number(lng), radius, maxRows },\n                env\n              );\n              setWarn(\n                \"Used GPS search fallback (vendor location job unavailable).\"\n              );\n              trace.used_path = nearby?.pathTried || \"gps-search\"; // [38.9]\n              if (debug === \"titles\") {\n                return respondTB(\n                  withBodyAnalytics(\n                    {\n                      ok: nearby.ok,\n                      source: \"gps-search\",\n                      count: nearby?.count || 0,\n                      titles: (nearby?.candidates || []).map((c) => c.title),\n                      ...warnPart()\n                    },\n                    ctx,\n                    rid,\n                    trace\n                  ),\n                  200\n                );\n              }\n              if (debug === \"raw\") {\n                return respondTB(\n                  withBodyAnalytics(\n                    {\n                      ok: nearby.ok,\n                      source: \"gps-search\",\n                      pathTried: nearby?.pathTried,\n                      raw: nearby?.raw,\n                      ...warnPart()\n                    },\n                    ctx,\n                    rid,\n                    trace\n                  ),\n                  200\n                );\n              }\n              await bumpStatusKV(env, { gps_search: 1 });\n              return respondTB(\n                withBodyAnalytics(\n                  {\n                    ok: nearby.ok,\n                    source: \"gps-search\",\n                    candidates: nearby?.candidates || [],\n                    ...warnPart()\n                  },\n                  ctx,\n                  rid,\n                  trace\n                ),\n                200\n              );\n            }\n            if (/\\b429\\b/.test(msg)) {\n              const mSecs = msg.match(/RETRYABLE_429:(\\d+)/);\n              const secs = mSecs ? Number(mSecs[1] || 0) : 30;\n              await bumpStatusKV(env, { ratelimits_429: 1 });\n              return rateLimitResponse(\n                ctx,\n                rid,\n                trace,\n                secs > 0 ? secs : 30,\n                \"upstream-failure\"\n              );\n            }\n            await bumpStatusKV(env, { errors_5xx: 1 });\n            return errorResponseWith(\n              {\n                ok: false,\n                error: friendlyUpstreamMessage(502),\n                upstream_error: msg.slice(0, 300),\n                hint: \"Please try again shortly.\"\n              },\n              502,\n              ctx,\n              {\n                \"X-TB-Source\": \"upstream-failure\",\n                \"X-TB-Upstream-Status\": \"502\",\n                trace: safeTrace(trace)\n              },\n              rid\n            );\n          }\n        }\n\n        if (!query) {\n          await bumpStatusKV(env, { errors_4xx: 1 });\n          return errorResponseWith(\n            {\n              ok: false,\n              error: 'Missing \"query\" (restaurant name).',\n              hint: \"Example: /menu/uber-test?query=McDonald%27s&address=Miami,%20FL\",\n              examples: [\n                \"/menu/uber-test?query=McDonald%27s&address=Miami,%20FL\",\n                \"/menu/uber-test?query=Starbucks&address=Seattle,%20WA\",\n                \"/menu/uber-test?query=Chipotle&address=Austin,%20TX\"\n              ]\n            },\n            400,\n            ctx,\n            {\n              \"X-TB-Source\": \"input-missing\",\n              trace: safeTrace(trace)\n            },\n            rid\n          );\n        }\n\n        const raw = await fetchMenuFromUberEats(\n          env,\n          query,\n          addressRaw,\n          maxRows,\n          latNum,\n          lngNum,\n          radius\n        );\n        if (searchParams.get(\"debug\") === \"1\") {\n          trace.used_path = trace.used_path || \"fetchMenuFromUberEats\"; // keep trace detail\n          await bumpStatusKV(env, { debug: 1 });\n          const preview = buildDebugPreview(raw || {}, env);\n          return respondTB(withBodyAnalytics(preview, ctx, rid, trace), 200);\n        }\n\n        const usedHost =\n          env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n        const flattenedItems = extractMenuItemsFromUber(raw, query);\n\n        if (debug === \"rank\") {\n          const preview = rankTop(flattenedItems, 10).map((x) => ({\n            section: x.section,\n            name: x.name || x.title,\n            price_display: x.price_display || null\n          }));\n          return respondTB(\n            withBodyAnalytics(\n              {\n                ok: true,\n                source: \"live\",\n                cache: cacheStatus,\n                preview,\n                ...warnPart()\n              },\n              ctx,\n              rid,\n              trace\n            ),\n            200,\n            {},\n            CORS_ALL\n          );\n        }\n\n        // Optional analyze enqueue\n        const analyze = searchParams.get(\"analyze\") === \"1\";\n        let enqueued = [];\n        if (analyze && Array.isArray(flattenedItems) && flattenedItems.length) {\n          const top = filterAndRankItems(flattenedItems, searchParams, env);\n          const place_id = searchParams.get(\"place_id\") || \"place.unknown\";\n          const cuisine = searchParams.get(\"cuisine\") || \"\";\n          ({ enqueued } = await enqueueTopItems(env, top, {\n            place_id,\n            cuisine,\n            query,\n            address: addressRaw,\n            forceUS: !!forceUSFlag\n          }));\n        }\n\n        // store into cache (best-effort)\n        try {\n          await writeMenuToCache(env, cacheKey, {\n            query,\n            address: addressRaw,\n            forceUS: !!forceUSFlag,\n            items: flattenedItems\n          });\n          cacheStatus = \"stored\";\n        } catch (e) {\n          cacheStatus = \"store-failed\";\n          setWarn(\"Could not store fresh cache (non-fatal).\");\n        }\n\n        if (!trace.used_path) trace.used_path = \"fetchMenuFromUberEats\"; // [38.9]\n        await bumpStatusKV(env, { live: 1 });\n        return respondTB(\n          withBodyAnalytics(\n            {\n              ok: true,\n              source: \"live\",\n              cache: cacheStatus,\n              data: {\n                query,\n                address: addressRaw,\n                forceUS: !!forceUSFlag,\n                maxRows,\n                host: usedHost,\n                count: flattenedItems.length,\n                items: flattenedItems.slice(0, 25)\n              },\n              enqueued,\n              ...warnPart()\n            },\n            ctx,\n            rid,\n            trace\n          ),\n          200,\n          {},\n          CORS_ALL\n        );\n      } catch (err) {\n        // [40.2] friendlier upstream error with analytics + real Retry-After on 429\n        const msg = String(err?.message || err || \"\");\n        const m = msg.match(/\\b(429|500|502|503|504)\\b/);\n        const upstreamStatus = m ? Number(m[1]) : 500;\n\n        // Pull seconds if the message was like \"RETRYABLE_429:NN\"\n        let retrySecs = 0;\n        const mSecs = msg.match(/RETRYABLE_429:(\\d+)/);\n        if (mSecs) retrySecs = Number(mSecs[1] || 0);\n\n        if (upstreamStatus === 429) {\n          await bumpStatusKV(env, { ratelimits_429: 1 });\n          return rateLimitResponse(\n            ctx,\n            rid,\n            trace,\n            retrySecs > 0 ? retrySecs : 30,\n            \"upstream-failure\"\n          );\n        }\n\n        await bumpStatusKV(env, { errors_5xx: 1 });\n        const hint =\n          upstreamStatus === 429\n            ? \"Please retry in ~30\u201360 seconds.\"\n            : \"Please try again shortly.\";\n\n        return errorResponseWith(\n          {\n            ok: false,\n            error: friendlyUpstreamMessage(upstreamStatus),\n            upstream_error: msg.slice(0, 300),\n            hint\n          },\n          upstreamStatus,\n          ctx,\n          {\n            \"X-TB-Source\": \"upstream-failure\",\n            \"X-TB-Upstream-Status\": String(upstreamStatus),\n            trace: safeTrace(trace)\n          },\n          rid\n        );\n      }\n    }\n\n    // Demo examples for clients\n    if (pathname === \"/menu/search/examples\" && request.method === \"GET\") {\n      const examples = [\n        \"/menu/search?query=McDonald%27s&address=Miami,%20FL&top=10\",\n        \"/menu/search?query=Starbucks&address=Seattle,%20WA&top=8\",\n        \"/menu/search?query=Chipotle&address=Austin,%20TX&skip_drinks=1&top=12\",\n        \"/menu/search?query=Panera&address=Orlando,%20FL&analyze=1&top=15\",\n        \"/menu/search?query=Chick-fil-A&address=Atlanta,%20GA&top=10\",\n        \"/menu/search?query=Shake%20Shack&address=New%20York,%20NY&skip_party=1&top=10\"\n      ];\n      // Reuse ctx for consistent headers\n      const ctx = {\n        served_at: new Date().toISOString(),\n        version: getVersion(env)\n      };\n      return jsonResponseWith(\n        { ok: true, examples, served_at: ctx.served_at, version: ctx.version },\n        200,\n        {\n          \"X-TB-Version\": String(ctx.version),\n          \"X-TB-Served-At\": String(ctx.served_at)\n        }\n      );\n    }\n\n    // NEW: App-friendly wrapper that internally calls our own handler (no external fetch)\n    if (pathname === \"/menu/search\") {\n      const query = (searchParams.get(\"query\") || \"\").trim();\n      const address = (searchParams.get(\"address\") || \"\").trim();\n      const top = searchParams.get(\"top\") || \"\";\n      const analyze = searchParams.get(\"analyze\") || \"\";\n      const place_id = searchParams.get(\"place_id\") || \"\";\n      const skip_drinks = searchParams.get(\"skip_drinks\") || \"\";\n      const skip_party = searchParams.get(\"skip_party\") || \"\";\n      // [41.13] unified ctx/rid helpers\n      const ctx = makeCtx(env);\n      const request_id = newRequestId();\n\n      function respondTB(body, status = 200, opts = {}, extraHeaders = {}) {\n        const source = body?.source || opts.source || \"\";\n        const cache = body?.cache || opts.cache || \"\";\n        const warning = Boolean(body?.warning || opts.warning);\n        return jsonResponseWithTB(\n          body,\n          status,\n          { ctx, rid: request_id, source, cache, warning },\n          extraHeaders\n        );\n      }\n\n      // [37B] \u2500\u2500 Validate inputs with friendly hints\n      if (!isNonEmptyString(query) && !isNonEmptyString(address)) {\n        return badRequest(\n          'Missing \"query\" and \"address\".',\n          [\n            \"Example 1: /menu/search?query=McDonald%27s&address=Miami,%20FL\",\n            \"Example 2: /menu/search?query=Starbucks&address=New%20York,%20NY\"\n          ].join(\"\\n\"),\n          ctx,\n          null,\n          [\n            \"/menu/search?query=McDonald%27s&address=Miami,%20FL\",\n            \"/menu/search?query=Chipotle&address=Austin,%20TX\"\n          ]\n        );\n      }\n\n      if (!isNonEmptyString(query)) {\n        return badRequest(\n          'Missing \"query\" (restaurant name).',\n          \"Example: /menu/search?query=McDonald%27s&address=Miami,%20FL\",\n          ctx,\n          null,\n          [\n            \"/menu/search?query=Starbucks&address=Seattle,%20WA\",\n            \"/menu/search?query=Panera&address=Orlando,%20FL\"\n          ]\n        );\n      }\n\n      if (!isNonEmptyString(address)) {\n        return badRequest(\n          'Missing \"address\" (city, state).',\n          \"Example: /menu/search?query=McDonald%27s&address=Miami,%20FL\",\n          ctx,\n          null,\n          [\n            \"/menu/search?query=McDonald%27s&address=Miami,%20FL\",\n            \"/menu/search?query=Chick-fil-A&address=Atlanta,%20GA\"\n          ]\n        );\n      }\n\n      // Soft warning if address shape looks unusual\n      let inputWarning = null;\n      if (!looksLikeCityState(address)) {\n        inputWarning =\n          'Address looks unusual. Try \"City, ST\" or \"City, ST 12345\".';\n      }\n\n      // [37B] \u2500\u2500 If a ZIP is present but no state code, hard error with a friendly hint\n      const hasZip = /\\b\\d{5}\\b/.test(address);\n      const hasState = /,\\s*[A-Za-z]{2}\\b/.test(address);\n      if (hasZip && !hasState) {\n        return badRequest(\n          \"Address has a ZIP but no state code (use two-letter state).\",\n          \"Example: /menu/search?query=McDonald%27s&address=Miami,%20FL%2033131\",\n          ctx,\n          null,\n          [\"/menu/search?query=McDonald%27s&address=Miami,%20FL%2033131\"]\n        );\n      }\n\n      // [37B] \u2500\u2500 If state code is lowercase, warn and create a preview with uppercased state\n      let address_preview = null;\n      if (hasLowercaseState(address)) {\n        const fixed = normalizeCityStateAddress(address);\n        if (fixed && fixed !== address) {\n          address_preview = fixed;\n          inputWarning = inputWarning\n            ? `${inputWarning} Also, we adjusted the state code to uppercase in address_preview.`\n            : 'State code looks lowercase; see \"address_preview\" for the uppercased version.';\n        }\n      }\n\n      // [37B] \u2500\u2500 Validate optional flags with friendly messages\n      if (analyze && !is01(analyze)) {\n        return badRequest(\n          'Bad \"analyze\" value. Use 0 or 1.',\n          \"Example: /menu/search?query=McDonald%27s&address=Miami,%20FL&analyze=1\",\n          ctx,\n          null,\n          [\"/menu/search?query=McDonald%27s&address=Miami,%20FL&analyze=1\"]\n        );\n      }\n\n      if (skip_drinks && !is01(skip_drinks)) {\n        return badRequest(\n          'Bad \"skip_drinks\" value. Use 0 or 1.',\n          \"Example: /menu/search?query=McDonald%27s&address=Miami,%20FL&skip_drinks=1\",\n          ctx,\n          null,\n          [\"/menu/search?query=McDonald%27s&address=Miami,%20FL&skip_drinks=1\"]\n        );\n      }\n\n      if (skip_party && !is01(skip_party)) {\n        return badRequest(\n          'Bad \"skip_party\" value. Use 0 or 1.',\n          \"Example: /menu/search?query=McDonald%27s&address=Miami,%20FL&skip_party=1\",\n          ctx,\n          null,\n          [\"/menu/search?query=McDonald%27s&address=Miami,%20FL&skip_party=1\"]\n        );\n      }\n\n      if (top) {\n        if (!isPositiveInt(top)) {\n          return badRequest(\n            'Bad \"top\" value. Must be a whole number.',\n            \"Example: /menu/search?query=McDonald%27s&address=Miami,%20FL&top=25\",\n            ctx,\n            null,\n            [\"/menu/search?query=McDonald%27s&address=Miami,%20FL&top=5\"]\n          );\n        }\n        const n = parseInt(top, 10);\n        if (n < 1) {\n          return badRequest(\n            'Out-of-range \"top\". Minimum is 1.',\n            \"Example: /menu/search?query=McDonald%27s&address=Miami,%20FL&top=5\",\n            ctx,\n            null,\n            [\"/menu/search?query=McDonald%27s&address=Miami,%20FL&top=5\"]\n          );\n        }\n        if (n > LIMITS.TOP_MAX) {\n          inputWarning = inputWarning\n            ? `${inputWarning} \"top\" was capped at ${LIMITS.TOP_MAX}.`\n            : `\"top\" was capped at ${LIMITS.TOP_MAX}.`;\n        }\n      }\n\n      // [37B] \u2500\u2500 Clamp top within safe range\n      const topNum = Math.min(\n        LIMITS.TOP_MAX,\n        Math.max(LIMITS.TOP_MIN, parseInt(top || LIMITS.DEFAULT_TOP, 10))\n      );\n      const trace = makeTrace(\"menu-search\", searchParams, env, {\n        place_id,\n        top: topNum,\n        analyze: analyze ? Number(analyze) : 0,\n        skip_drinks: skip_drinks ? Number(skip_drinks) : 0,\n        skip_party: skip_party ? Number(skip_party) : 0\n      });\n\n      // Always force U.S. for this endpoint\n      const params = new URLSearchParams({\n        query,\n        address,\n        us: \"1\"\n      });\n      params.set(\"top\", String(topNum));\n      if (analyze) params.set(\"analyze\", analyze);\n      if (place_id) params.set(\"place_id\", place_id);\n      if (skip_drinks) params.set(\"skip_drinks\", skip_drinks);\n      if (skip_party) params.set(\"skip_party\", skip_party);\n\n      // \uD83D\uDD27 INTERNAL DISPATCH: call our own route directly (no network), avoiding 404s\n      const innerReq = new Request(\n        new URL(`/menu/uber-test?${params.toString()}`, url),\n        {\n          method: \"GET\",\n          headers: { accept: \"application/json\" }\n        }\n      );\n      const innerRes = await _worker_impl.fetch(innerReq, env, ctx);\n      if (!innerRes || !innerRes.ok) {\n        const status = innerRes?.status ?? 502;\n\n        // Try to parse JSON body; fall back to text\n        let upstreamError = null;\n        try {\n          const raw = await innerRes.text();\n          try {\n            const parsed = JSON.parse(raw);\n            upstreamError = parsed?.error || parsed?.message || raw;\n          } catch {\n            upstreamError = raw;\n          }\n        } catch {\n          upstreamError = null;\n        }\n\n        const msg = friendlyUpstreamMessage(status);\n        const hint =\n          status === 429\n            ? \"Please retry in ~30\u201360 seconds.\"\n            : \"Please try again shortly.\";\n\n        return errorResponseWith(\n          {\n            ok: false,\n            error: msg,\n            status,\n            upstream_error: upstreamError\n              ? String(upstreamError).slice(0, 300)\n              : null,\n            hint\n          },\n          status,\n          ctx,\n          {\n            \"X-TB-Source\": \"inner-failure\",\n            \"X-TB-Upstream-Status\": String(status),\n            trace: safeTrace(trace)\n          },\n          request_id\n        );\n      }\n\n      const data = await innerRes.json();\n      if (data?.trace?.host) trace.host = data.trace.host;\n      if (data?.trace?.used_path) trace.used_path = data.trace.used_path;\n\n      const items = (data?.data?.items || []).map((it) => ({\n        name: it.name || it.title || \"\",\n        section: it.section || \"\",\n        price: typeof it.price === \"number\" ? it.price : null,\n        price_display: it.price_display || null,\n        calories_display:\n          (it.price_display || \"\").match(/\\b\\d+\\s*Cal/i)?.[0] || null,\n        source: \"uber_us\"\n      }));\n\n      return respondTB(\n        withBodyAnalytics(\n          {\n            ok: true,\n            source: String(data.source || \"search\"),\n            cache: String(data.cache || \"\"),\n            query,\n            address,\n            total: items.length,\n            items,\n            enqueued: data.enqueued || [],\n            ...(inputWarning ? { warning: inputWarning } : {}),\n            ...(address_preview ? { address_preview } : {}),\n            limits: LIMITS\n          },\n          ctx,\n          request_id,\n          trace\n        ),\n        200\n      );\n    }\n\n    // --- /molecular/analyze (Phase 1 MVP) ---\n    // Usage examples:\n    //   /molecular/analyze?ingredient=garlic\n    //   /molecular/analyze?compound=curcumin\n    if (pathname === \"/molecular/analyze\") {\n      const gate = await requirePremium(env, url);\n      if (!gate.ok) {\n        return new Response(JSON.stringify(gate.body), {\n          status: gate.status,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n      }\n      try {\n        const byIngredient = (url.searchParams.get(\"ingredient\") || \"\").trim();\n        const byCompound = (url.searchParams.get(\"compound\") || \"\").trim();\n\n        if (!byIngredient && !byCompound) {\n          return new Response(\n            JSON.stringify({\n              ok: false,\n              error: \"Provide ?ingredient= or ?compound=\",\n              examples: [\n                \"/molecular/analyze?ingredient=garlic\",\n                \"/molecular/analyze?compound=curcumin\"\n              ]\n            }),\n            {\n              status: 400,\n              headers: {\n                \"content-type\": \"application/json\",\n                \"access-control-allow-origin\": \"*\"\n              }\n            }\n          );\n        }\n\n        // 1) Pick a search term (lowercased)\n        const term = (byCompound || byIngredient).toLowerCase();\n\n        // 2) Find matching compounds (name/common_name LIKE)\n        const compRes = await env.D1_DB.prepare(\n          `SELECT id, name, common_name, formula, cid, description\n           FROM compounds\n           WHERE LOWER(name) LIKE ? OR LOWER(common_name) LIKE ?\n           ORDER BY name LIMIT 10`\n        )\n          .bind(`%${term}%`, `%${term}%`)\n          .all();\n\n        const compounds = compRes?.results || [];\n\n        // 3) Fetch organ effects for those compounds\n        let effects = [];\n        if (compounds.length) {\n          const ids = compounds.map((c) => c.id);\n          // Build a simple IN (?, ?, ?) clause\n          const qs = ids.map(() => \"?\").join(\", \");\n          const effRes = await env.D1_DB.prepare(\n            `SELECT e.compound_id, e.organ, e.effect, e.strength, e.notes,\n                    c.name AS compound_name, c.common_name, c.cid\n             FROM compound_organ_effects e\n             JOIN compounds c ON c.id = e.compound_id\n             WHERE e.compound_id IN (${qs})\n             ORDER BY c.name, e.organ`\n          )\n            .bind(...ids)\n            .all();\n          effects = effRes?.results || [];\n        }\n\n        // 4) Organize a tiny summary (organs \u2192 list of (compound, effect, strength))\n        const organs = {};\n        for (const row of effects) {\n          const key = row.organ || \"unknown\";\n          if (!organs[key]) organs[key] = [];\n          organs[key].push({\n            compound: row.compound_name,\n            common_name: row.common_name,\n            cid: row.cid,\n            effect: row.effect,\n            strength: row.strength,\n            notes: row.notes || null\n          });\n        }\n\n        const body = {\n          ok: true,\n          query: {\n            ingredient: byIngredient || null,\n            compound: byCompound || null\n          },\n          found_compounds: compounds.length,\n          compounds,\n          organs\n        };\n\n        return new Response(JSON.stringify(body, null, 2), {\n          status: 200,\n          headers: {\n            \"content-type\": \"application/json; charset=utf-8\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n      } catch (e) {\n        return new Response(\n          JSON.stringify({ ok: false, error: String(e?.message || e) }),\n          {\n            status: 500,\n            headers: {\n              \"content-type\": \"application/json\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      }\n    }\n\n    // --- /molecular/map (ingredient -> compounds + organ summary) ---\n    // Usage:\n    //   /molecular/map?ingredient=garlic\n    if (pathname === \"/molecular/map\") {\n      const gate = await requirePremium(env, url);\n      if (!gate.ok) {\n        return new Response(JSON.stringify(gate.body), {\n          status: gate.status,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n      }\n      try {\n        const ingredient = (url.searchParams.get(\"ingredient\") || \"\")\n          .trim()\n          .toLowerCase();\n        if (!ingredient) {\n          return new Response(\n            JSON.stringify({\n              ok: false,\n              error: \"Provide ?ingredient=\",\n              example: \"/molecular/map?ingredient=garlic\"\n            }),\n            {\n              status: 400,\n              headers: {\n                \"content-type\": \"application/json\",\n                \"access-control-allow-origin\": \"*\"\n              }\n            }\n          );\n        }\n\n        // Find compounds where name or common_name matches the ingredient term\n        const compRes = await env.D1_DB.prepare(\n          `SELECT id, name, common_name, formula, cid, description\n           FROM compounds\n           WHERE LOWER(name) LIKE ? OR LOWER(common_name) LIKE ?\n           ORDER BY name LIMIT 15`\n        )\n          .bind(`%${ingredient}%`, `%${ingredient}%`)\n          .all();\n\n        const compounds = compRes?.results || [];\n        const ids = compounds.map((c) => c.id);\n\n        // Pull organ effects for those compounds\n        let effects = [];\n        if (ids.length) {\n          const qs = ids.map(() => \"?\").join(\", \");\n          const effRes = await env.D1_DB.prepare(\n            `SELECT e.compound_id, e.organ, e.effect, e.strength, e.notes,\n                    c.name AS compound_name, c.common_name, c.cid\n             FROM compound_organ_effects e\n             JOIN compounds c ON c.id = e.compound_id\n             WHERE e.compound_id IN (${qs})\n             ORDER BY c.name, e.organ`\n          )\n            .bind(...ids)\n            .all();\n          effects = effRes?.results || [];\n        }\n\n        // Build organ -> [effects] map\n        const organs = {};\n        for (const row of effects) {\n          const key = row.organ || \"unknown\";\n          if (!organs[key]) organs[key] = [];\n          organs[key].push({\n            compound: row.compound_name,\n            common_name: row.common_name,\n            cid: row.cid,\n            effect: row.effect,\n            strength: row.strength,\n            notes: row.notes || null\n          });\n        }\n\n        // Tiny \u201Cheadline\u201D summary for UI: organ -> (+benefit / -risk) counts\n        const organSummary = {};\n        for (const [org, list] of Object.entries(organs)) {\n          let plus = 0,\n            minus = 0,\n            neutral = 0;\n          for (const e of list) {\n            if (e.effect === \"benefit\") plus++;\n            else if (e.effect === \"risk\") minus++;\n            else neutral++;\n          }\n          organSummary[org] = { plus, minus, neutral };\n        }\n\n        return new Response(\n          JSON.stringify(\n            {\n              ok: true,\n              query: { ingredient },\n              found_compounds: compounds.length,\n              compounds,\n              organs,\n              organ_summary: organSummary\n            },\n            null,\n            2\n          ),\n          {\n            status: 200,\n            headers: {\n              \"content-type\": \"application/json; charset=utf-8\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      } catch (e) {\n        return new Response(\n          JSON.stringify({ ok: false, error: String(e?.message || e) }),\n          {\n            status: 500,\n            headers: {\n              \"content-type\": \"application/json\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      }\n    }\n\n    // --- /molecular/compound (get one compound + its organ effects) ---\n    // Usage:\n    //   /molecular/compound?cid=969516\n    //   /molecular/compound?name=curcumin\n    if (pathname === \"/molecular/compound\") {\n      const gate = await requirePremium(env, url);\n      if (!gate.ok) {\n        return new Response(JSON.stringify(gate.body), {\n          status: gate.status,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n      }\n      try {\n        const cid = (url.searchParams.get(\"cid\") || \"\").trim();\n        const name = (url.searchParams.get(\"name\") || \"\").trim().toLowerCase();\n\n        if (!cid && !name) {\n          return new Response(\n            JSON.stringify({\n              ok: false,\n              error: \"Provide ?cid= or ?name=\",\n              examples: [\n                \"/molecular/compound?cid=969516\",\n                \"/molecular/compound?name=curcumin\"\n              ]\n            }),\n            {\n              status: 400,\n              headers: {\n                \"content-type\": \"application/json\",\n                \"access-control-allow-origin\": \"*\"\n              }\n            }\n          );\n        }\n\n        // 1) Find the compound (prefer cid if given; else exact name match fallback to LIKE)\n        let compRow = null;\n        if (cid) {\n          const rs = await env.D1_DB.prepare(\n            `SELECT id, name, common_name, formula, cid, description\n             FROM compounds WHERE cid = ? LIMIT 1`\n          )\n            .bind(cid)\n            .all();\n          compRow = rs?.results?.[0] || null;\n        }\n        if (!compRow && name) {\n          const rsExact = await env.D1_DB.prepare(\n            `SELECT id, name, common_name, formula, cid, description\n             FROM compounds WHERE LOWER(name) = ? LIMIT 1`\n          )\n            .bind(name)\n            .all();\n          compRow = rsExact?.results?.[0] || null;\n\n          if (!compRow) {\n            const rsLike = await env.D1_DB.prepare(\n              `SELECT id, name, common_name, formula, cid, description\n               FROM compounds WHERE LOWER(name) LIKE ? OR LOWER(common_name) LIKE ? \n               ORDER BY name LIMIT 1`\n            )\n              .bind(`%${name}%`, `%${name}%`)\n              .all();\n            compRow = rsLike?.results?.[0] || null;\n          }\n        }\n\n        if (!compRow) {\n          return new Response(\n            JSON.stringify({ ok: false, error: \"compound_not_found\" }),\n            {\n              status: 404,\n              headers: {\n                \"content-type\": \"application/json\",\n                \"access-control-allow-origin\": \"*\"\n              }\n            }\n          );\n        }\n\n        // 2) Fetch organ effects for that compound\n        const effRes = await env.D1_DB.prepare(\n          `SELECT organ, effect, strength, notes\n           FROM compound_organ_effects\n           WHERE compound_id = ?\n           ORDER BY organ`\n        )\n          .bind(compRow.id)\n          .all();\n\n        const effects = effRes?.results || [];\n\n        // 3) Organize a friendly summary counts\n        const organ_summary = {};\n        for (const e of effects) {\n          const k = e.organ || \"unknown\";\n          if (!organ_summary[k])\n            organ_summary[k] = { plus: 0, minus: 0, neutral: 0 };\n          if (e.effect === \"benefit\") organ_summary[k].plus++;\n          else if (e.effect === \"risk\") organ_summary[k].minus++;\n          else organ_summary[k].neutral++;\n        }\n\n        return new Response(\n          JSON.stringify(\n            {\n              ok: true,\n              compound: compRow,\n              effects,\n              organ_summary\n            },\n            null,\n            2\n          ),\n          {\n            status: 200,\n            headers: {\n              \"content-type\": \"application/json; charset=utf-8\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      } catch (e) {\n        return new Response(\n          JSON.stringify({ ok: false, error: String(e?.message || e) }),\n          {\n            status: 500,\n            headers: {\n              \"content-type\": \"application/json\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      }\n    }\n\n    // --- DEBUG: /debug/kv-tier?user_id=...  (reads KV tier directly)\n    if (pathname === \"/debug/kv-tier\") {\n      const uid = (url.searchParams.get(\"user_id\") || \"\").trim();\n      if (!uid) {\n        return new Response(\n          JSON.stringify({ ok: false, error: \"missing user_id\" }),\n          {\n            status: 400,\n            headers: {\n              \"content-type\": \"application/json\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      }\n      try {\n        const key = `tier/user:${uid}`;\n        const val = await (env.LEXICON_CACHE\n          ? env.LEXICON_CACHE.get(key)\n          : null);\n        return new Response(\n          JSON.stringify({ ok: true, user_id: uid, key, value: val ?? null }),\n          {\n            status: 200,\n            headers: {\n              \"content-type\": \"application/json\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      } catch (e) {\n        return new Response(\n          JSON.stringify({ ok: false, error: String(e?.message || e) }),\n          {\n            status: 500,\n            headers: {\n              \"content-type\": \"application/json\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      }\n    }\n\n    // --- DEBUG: /debug/kv-set?user_id=...&tier=premium  (writes KV from the worker)\n    if (pathname === \"/debug/kv-set\") {\n      const uid = (url.searchParams.get(\"user_id\") || \"\").trim();\n      const tier = (url.searchParams.get(\"tier\") || \"\").trim();\n      if (!uid || !tier) {\n        return new Response(\n          JSON.stringify({ ok: false, error: \"missing user_id or tier\" }),\n          {\n            status: 400,\n            headers: {\n              \"content-type\": \"application/json\",\n              \"access-control-allow-origin\": \"*\"\n            }\n          }\n        );\n      }\n      const key = `tier/user:${uid}`;\n      await env.LEXICON_CACHE.put(key, tier);\n      return new Response(JSON.stringify({ ok: true, wrote: { key, tier } }), {\n        status: 200,\n        headers: {\n          \"content-type\": \"application/json\",\n          \"access-control-allow-origin\": \"*\"\n        }\n      });\n    }\n\n    // --- /schema/examples (returns example payloads the iOS UI can rely on)\n    if (pathname === \"/schema/examples\") {\n      const MolecularDrawer = {\n        ok: true,\n        component: \"MolecularDrawer\",\n        version: \"v1\",\n        dish: {\n          id: \"dish_abc123\",\n          place_id: \"place.test.001\",\n          title: \"Garlic Shrimp\",\n          cuisine: \"Seafood\"\n        },\n        compounds: [\n          { name: \"Allicin\", common_name: \"Garlic active\", cid: \"65036\" },\n          { name: \"Histamine\", common_name: \"Biogenic amine\", cid: \"774\" }\n        ],\n        organs: {\n          gut: [\n            {\n              compound: \"Allicin\",\n              effect: \"benefit\",\n              strength: 3,\n              notes: \"Traditional GI support\"\n            },\n            {\n              compound: \"Histamine\",\n              effect: \"risk\",\n              strength: 3,\n              notes: \"Sensitivity in aged items\"\n            }\n          ],\n          liver: [\n            {\n              compound: \"Curcumin\",\n              effect: \"benefit\",\n              strength: 2,\n              notes: \"General antioxidant link\"\n            }\n          ]\n        },\n        organ_summary: {\n          gut: { plus: 1, minus: 1, neutral: 0 },\n          liver: { plus: 1, minus: 0, neutral: 0 }\n        }\n      };\n\n      const RecipeCard = {\n        ok: true,\n        component: \"RecipeCard\",\n        version: \"v1\",\n        dish: {\n          name: \"Chicken Alfredo\",\n          cuisine: \"Italian\"\n        },\n        ingredients: [\n          { name: \"Pasta\", qty: 200, unit: \"g\" },\n          { name: \"Cream\", qty: 1, unit: \"cup\" },\n          { name: \"Butter\", qty: 2, unit: \"tbsp\" },\n          { name: \"Parmesan\", qty: 60, unit: \"g\" },\n          { name: \"Garlic\", qty: 2, unit: \"cloves\" }\n        ],\n        recipe: {\n          steps: [\n            \"Boil pasta until al dente.\",\n            \"Melt butter, add cream, simmer gently.\",\n            \"Stir in parmesan until smooth.\",\n            \"Combine pasta with sauce; finish with garlic.\"\n          ],\n          notes: [\"Salt to taste\", \"Reserve pasta water to loosen sauce\"]\n        },\n        molecular: {\n          compounds: [\n            { name: \"Allicin\", from_ingredient: \"Garlic\", cid: \"65036\" },\n            { name: \"Histamine\", from_ingredient: \"Parmesan\", cid: \"774\" }\n          ],\n          organs: {\n            gut: [\n              {\n                compound: \"Histamine\",\n                effect: \"risk\",\n                strength: 3,\n                notes: \"Biogenic amine in aged cheese\"\n              }\n            ]\n          },\n          organ_summary: { gut: { plus: 0, minus: 1, neutral: 0 } },\n          organ_headlines: [\"Gut: \u26A0\uFE0F Risk\"]\n        },\n        molecular_human: {\n          organ_tips: [\n            \"Gut: may bother sensitive tummies\u2014consider smaller portions or swaps.\"\n          ]\n        },\n        molecular_badge: \"Molecular Insights: 2 compounds \u2022 1 organ\"\n      };\n\n      const InsightsFeed = {\n        ok: true,\n        component: \"InsightsFeed\",\n        version: \"v1\",\n        period: { range: \"last_7_days\" },\n        generated_at: new Date().toISOString(),\n        items: [\n          {\n            organ: \"heart\",\n            icon: \"\u2764\uFE0F\",\n            headline: \"Heart: \uD83D\uDC4D Benefit\",\n            tip: \"Generally friendly in normal portions.\",\n            sentiment: \"Supportive\"\n          },\n          {\n            organ: \"gut\",\n            icon: \"\uD83E\uDDA0\",\n            headline: \"Gut: \u26A0\uFE0F Risk\",\n            tip: \"May bother sensitive tummies\u2014consider smaller portions or swaps.\",\n            sentiment: \"Caution\"\n          }\n        ],\n        badge: \"This week: 2 insights\"\n      };\n\n      const payload = {\n        ok: true,\n        schemas: { MolecularDrawer, RecipeCard, InsightsFeed }\n      };\n      return new Response(JSON.stringify(payload, null, 2), {\n        status: 200,\n        headers: {\n          \"content-type\": \"application/json; charset=utf-8\",\n          \"access-control-allow-origin\": \"*\"\n        }\n      });\n    }\n\n    if (pathname === \"/insights/feed\") {\n      const gate = await requirePremium(env, url);\n      if (!gate.ok) {\n        return new Response(JSON.stringify(gate.body), {\n          status: gate.status,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n      }\n      const ORG_ICON = {\n        heart: \"\u2764\uFE0F\",\n        gut: \"\uD83E\uDDA0\",\n        liver: \"\uD83E\uDDEA\",\n        brain: \"\uD83E\uDDE0\",\n        immune: \"\uD83D\uDEE1\uFE0F\"\n      };\n      const userId = (url.searchParams.get(\"user_id\") || \"\").trim();\n      const userPrefsRaw = await loadUserPrefs(env, userId);\n      const userPrefs =\n        userPrefsRaw && typeof userPrefsRaw === \"object\"\n          ? userPrefsRaw\n          : { allergens: [], fodmap: {} };\n\n      // === Step 20C: live aggregation from R2 results (sorted newest-first, richer items)\n      const liveItems = [];\n      let next_cursor = null;\n      const limitR2 = Math.max(\n        1,\n        Math.min(50, parseInt(url.searchParams.get(\"r2_limit\") || \"10\", 10))\n      );\n      if (env.R2_BUCKET) {\n        const r2Cursor = url.searchParams.get(\"r2_cursor\") || undefined;\n        const listing = await env.R2_BUCKET.list({\n          prefix: \"results/\",\n          limit: Math.max(limitR2, 25),\n          cursor: r2Cursor\n        });\n        const objs = (listing.objects || [])\n          .map((o) => ({\n            key: o.key,\n            uploaded: o.uploaded ? new Date(o.uploaded).getTime() : 0\n          }))\n          .sort((a, b) => b.uploaded - a.uploaded)\n          .slice(0, limitR2);\n\n        for (const obj of objs) {\n          const r = await env.R2_BUCKET.get(obj.key);\n          if (!r) continue;\n          try {\n            const js = JSON.parse(await r.text());\n            const out = js;\n            const tb = js?.tummy_barometer || {};\n            const rawLabel = (tb.label || \"Unknown\").toLowerCase();\n\n            const sentiment =\n              rawLabel === \"avoid\"\n                ? \"Avoid\"\n                : rawLabel === \"caution\"\n                  ? \"Caution\"\n                  : rawLabel === \"mixed\"\n                    ? \"Mixed\"\n                    : rawLabel === \"likely ok\"\n                      ? \"Supportive\"\n                      : \"Unknown\";\n\n            const icon =\n              sentiment === \"Avoid\"\n                ? \"\u26A0\uFE0F\"\n                : sentiment === \"Caution\"\n                  ? \"\u26A0\uFE0F\"\n                  : sentiment === \"Mixed\"\n                    ? \"\u2194\uFE0F\"\n                    : sentiment === \"Supportive\"\n                      ? \"\u2764\uFE0F\"\n                      : \"\uD83E\uDDEC\";\n\n            const flags = js?.flags || {};\n            let organ = \"gut\";\n            if (flags.cardiac_hint) organ = \"heart\";\n            else if (flags.neuro_hint) organ = \"brain\";\n            else if (flags.hepatic_hint) organ = \"liver\";\n            else if (flags.immune_hint) organ = \"immune\";\n            const tip =\n              sentiment === \"Avoid\"\n                ? \"May bother sensitive tummies\u2014consider smaller portions or swaps.\"\n                : sentiment === \"Caution\"\n                  ? \"Moderate risk\u2014portion size matters.\"\n                  : \"Generally friendly in normal portions.\";\n\n            const details_url = new URL(`/${obj.key}`, url).toString();\n            const id = (obj.key || \"\").replace(/^results\\/|\\.json$/g, \"\");\n\n            const feedItem = {\n              id,\n              organ,\n              icon,\n              headline: `${tb.label || \"Unknown\"}: ${js.dish_name || \"Unknown Dish\"}`,\n              tip,\n              sentiment,\n              result_key: obj.key,\n              uploaded_at: new Date(obj.uploaded || Date.now()).toISOString(),\n              details_url,\n              dish_name: js?.dish_name || \"Unknown Dish\",\n              place_id: js?.place_id || null\n            };\n            const pills = derivePillsForUser(js?.ingredient_hits, userPrefs);\n            feedItem.pills_user = pills;\n            if (out?.nutrition_summary) {\n              feedItem.nutrition_summary = out.nutrition_summary;\n              feedItem.nutrition_badges = [\n                `${Math.round(out.nutrition_summary.energyKcal)} kcal`,\n                `${Math.round(out.nutrition_summary.protein_g)} g protein`,\n                `${Math.round(out.nutrition_summary.fat_g)} g fat`,\n                `${Math.round(out.nutrition_summary.carbs_g)} g carbs`\n              ];\n            }\n\n            liveItems.push(feedItem);\n          } catch {\n            continue;\n          }\n        }\n        next_cursor = listing.truncated ? listing.cursor : null;\n      }\n\n      // De-duplicate by (place_id|dish_name)\n      const seen = new Set();\n      const liveItemsDedup = [];\n      for (const it of liveItems) {\n        const key = `${it.place_id || \"unknown\"}|${(it.dish_name || \"\").toLowerCase()}`;\n        if (seen.has(key)) continue;\n        seen.add(key);\n        liveItemsDedup.push(it);\n      }\n\n      const liveSourceItems = liveItemsDedup.length\n        ? liveItemsDedup\n        : liveItems;\n      const staticItems = [\n        {\n          organ: \"gut\",\n          icon: ORG_ICON.gut,\n          headline: \"Gut: \u26A0\uFE0F Risk\",\n          tip: \"May bother sensitive tummies\u2014consider smaller portions or swaps.\",\n          sentiment: \"Caution\"\n        }\n      ];\n\n      const source = (url.searchParams.get(\"source\") || \"auto\").toLowerCase();\n      const items =\n        source === \"live\"\n          ? liveSourceItems\n          : source === \"static\"\n            ? staticItems\n            : liveSourceItems.length\n              ? liveSourceItems\n              : staticItems;\n      const limit = Math.max(\n        1,\n        Math.min(10, parseInt(url.searchParams.get(\"limit\") || \"5\", 10))\n      );\n      const p = (url.searchParams.get(\"period\") || \"\").toLowerCase().trim();\n      const ALLOWED = new Set([\"last_7_days\", \"last_30_days\", \"all_time\"]);\n      const period = ALLOWED.has(p) ? p : \"last_7_days\";\n      const organParam = (url.searchParams.get(\"organ\") || \"\")\n        .toLowerCase()\n        .trim();\n      const filtered = organParam\n        ? items.filter((it) => (it.organ || \"\").toLowerCase() === organParam)\n        : items;\n      const ORDER = {\n        Supportive: 1,\n        Mixed: 2,\n        Caution: 3,\n        Avoid: 4,\n        Unknown: 0\n      };\n      const minParam = (\n        url.searchParams.get(\"min_sentiment\") || \"\"\n      ).toLowerCase();\n      const MIN =\n        { supportive: 1, mixed: 2, caution: 3, avoid: 4 }[minParam] ?? 0;\n      const filteredItems = filtered.filter(\n        (it) => (ORDER[it.sentiment] || 0) >= MIN\n      );\n      const sliced = filteredItems.slice(0, limit);\n\n      const body = {\n        ok: true,\n        component: \"InsightsFeed\",\n        version: \"v1\",\n        period: { range: period },\n        generated_at: new Date().toISOString(),\n        items: sliced,\n        badge: `This week: ${sliced.length} insights`,\n        ...(organParam ? { filter: { organ: organParam } } : {}),\n        user_prefs: userPrefs\n      };\n      body.r2_next_cursor = next_cursor;\n      // Quick totals from current items (not full R2 yet)\n      const summary_counts = { Supportive: 0, Mixed: 0, Caution: 0, Avoid: 0 };\n      for (const it of sliced) {\n        if (summary_counts[it.sentiment] != null)\n          summary_counts[it.sentiment]++;\n      }\n      body.summary_counts = summary_counts;\n      const humanHeadline =\n        period === \"last_7_days\"\n          ? \"Your recent wellness snapshot\"\n          : period === \"last_30_days\"\n            ? \"Monthly wellness summary\"\n            : \"All-time molecular insights\";\n      body.human_headline = humanHeadline;\n      return new Response(JSON.stringify(body, null, 2), {\n        status: 200,\n        headers: {\n          \"content-type\": \"application/json; charset=utf-8\",\n          \"access-control-allow-origin\": \"*\"\n        }\n      });\n    }\n\n    if (pathname === \"/insights/debug/r2-list\") {\n      const gate = await requirePremium(env, url);\n      if (!gate.ok) {\n        return new Response(JSON.stringify(gate.body), {\n          status: gate.status,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n      }\n      if (!env.R2_BUCKET) {\n        return new Response(\n          JSON.stringify({ ok: false, error: \"R2 not bound\" }),\n          {\n            status: 500,\n            headers: { \"content-type\": \"application/json\" }\n          }\n        );\n      }\n\n      const limit = Math.max(\n        1,\n        Math.min(50, parseInt(url.searchParams.get(\"limit\") || \"10\", 10))\n      );\n      const prefix = \"results/\";\n      const listing = await env.R2_BUCKET.list({\n        prefix,\n        limit,\n        include: [\"httpMetadata\"]\n      });\n      const items = (listing.objects || []).map((o) => ({\n        key: o.key,\n        size: o.size,\n        uploaded: o.uploaded ? new Date(o.uploaded).toISOString() : null\n      }));\n      return new Response(\n        JSON.stringify({ ok: true, count: items.length, items }, null, 2),\n        {\n          status: 200,\n          headers: {\n            \"content-type\": \"application/json; charset=utf-8\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        }\n      );\n    }\n\n    if (pathname === \"/insights/debug/status\") {\n      const gate = await requirePremium(env, url);\n      if (!gate.ok)\n        return new Response(JSON.stringify(gate.body), {\n          status: gate.status,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n\n      const okR2 = !!env.R2_BUCKET;\n      const okD1 = !!env.D1_DB;\n      const okKV = !!env.LEXICON_CACHE;\n      const modeHint = okR2 ? \"live\" : \"static\";\n\n      const body = {\n        ok: true,\n        version: \"v1\",\n        active_sources: { R2: okR2, D1: okD1, KV: okKV },\n        default_mode: modeHint,\n        note: okR2\n          ? \"Live Insights pulling from R2 results.\"\n          : \"Static Insights mode (no R2 bucket bound).\"\n      };\n      return new Response(JSON.stringify(body, null, 2), {\n        status: 200,\n        headers: {\n          \"content-type\": \"application/json; charset=utf-8\",\n          \"access-control-allow-origin\": \"*\"\n        }\n      });\n    }\n\n    if (pathname === \"/insights/debug/sample\") {\n      const gate = await requirePremium(env, url);\n      if (!gate.ok) {\n        return new Response(JSON.stringify(gate.body), {\n          status: gate.status,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n      }\n\n      const key =\n        url.searchParams.get(\"key\") ||\n        \"results/0032d323-560f-469f-a496-195812a9efd4.json\";\n      const obj = await env.R2_BUCKET.get(key);\n      if (!obj) {\n        return new Response(\n          JSON.stringify({ ok: false, error: \"not_found\", key }),\n          {\n            status: 404,\n            headers: { \"content-type\": \"application/json\" }\n          }\n        );\n      }\n\n      const text = await obj.text();\n      let js;\n      try {\n        js = JSON.parse(text);\n      } catch {\n        js = null;\n      }\n\n      // Extract key metrics\n      const tb = js?.tummy_barometer || {};\n      const flags = js?.flags || {};\n      const summary = {\n        label: tb.label || \"Unknown\",\n        score: tb.score ?? null,\n        fodmap: flags.fodmap || \"unknown\",\n        gluten: !!flags.gluten_hint,\n        dairy: !!flags.dairy_hint\n      };\n\n      return new Response(\n        JSON.stringify(\n          { ok: true, key, summary, preview: js?.sentences?.slice(0, 3) || [] },\n          null,\n          2\n        ),\n        {\n          status: 200,\n          headers: {\n            \"content-type\": \"application/json; charset=utf-8\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        }\n      );\n    }\n\n    if (pathname === \"/insights/debug/aggregate\") {\n      const gate = await requirePremium(env, url);\n      if (!gate.ok) {\n        return new Response(JSON.stringify(gate.body), {\n          status: gate.status,\n          headers: {\n            \"content-type\": \"application/json\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        });\n      }\n      if (!env.R2_BUCKET) {\n        return new Response(\n          JSON.stringify({ ok: false, error: \"R2 not bound\" }),\n          {\n            status: 500,\n            headers: { \"content-type\": \"application/json\" }\n          }\n        );\n      }\n\n      const limit = Math.max(\n        1,\n        Math.min(50, parseInt(url.searchParams.get(\"limit\") || \"10\", 10))\n      );\n      const listing = await env.R2_BUCKET.list({ prefix: \"results/\", limit });\n      const counts = {\n        Supportive: 0,\n        Mixed: 0,\n        Caution: 0,\n        Avoid: 0,\n        Unknown: 0\n      };\n      const sample = [];\n      for (const obj of listing.objects || []) {\n        const r = await env.R2_BUCKET.get(obj.key);\n        if (!r) continue;\n        try {\n          const js = JSON.parse(await r.text());\n          const label = js?.tummy_barometer?.label || \"Unknown\";\n          counts[label] = (counts[label] || 0) + 1;\n          if (sample.length < 5) {\n            sample.push({\n              key: obj.key,\n              label,\n              score: js?.tummy_barometer?.score ?? null\n            });\n          }\n        } catch {\n          counts.Unknown = (counts.Unknown || 0) + 1;\n        }\n      }\n\n      return new Response(\n        JSON.stringify(\n          { ok: true, scanned: (listing.objects || []).length, counts, sample },\n          null,\n          2\n        ),\n        {\n          status: 200,\n          headers: {\n            \"content-type\": \"application/json; charset=utf-8\",\n            \"access-control-allow-origin\": \"*\"\n          }\n        }\n      );\n    }\n\n    // --- DEBUG: probe Spoonacular directly ---\n    if (pathname === \"/debug/spoonacular\") {\n      const dish = url.searchParams.get(\"dish\") || \"Crunchwrap Supreme\";\n      try {\n        const apiKey = env.SPOONACULAR_API_KEY;\n        const endpoint = `https://api.spoonacular.com/recipes/complexSearch?query=${encodeURIComponent(dish)}&number=1&addRecipeInformation=true&apiKey=${encodeURIComponent(apiKey)}`;\n        const res = await fetch(endpoint, { headers: { \"x-api-key\": apiKey } });\n        const text = await res.text();\n        let jsonOut = null;\n        try {\n          jsonOut = JSON.parse(text);\n        } catch {}\n        return json({\n          ok: res.ok,\n          status: res.status,\n          dish,\n          provider: \"spoonacular\",\n          title: jsonOut?.results?.[0]?.title || null,\n          lines: (jsonOut?.results?.[0]?.extendedIngredients || []).length || 0,\n          body_preview: text.slice(0, 180)\n        });\n      } catch (e) {\n        return json({ ok: false, dish, error: String(e?.message || e) });\n      }\n    }\n\n    // --- DEBUG: probe Zestful by first pulling a recipe then parsing its lines ---\n    if (pathname === \"/debug/zestful\") {\n      const dish = url.searchParams.get(\"dish\") || \"Chicken Alfredo\";\n      try {\n        const spoon = await spoonacularFetch(env, dish, null, \"en\");\n        const lines = Array.isArray(spoon?.ingredients)\n          ? spoon.ingredients\n          : [];\n\n        let parsed = null;\n        if (lines.length && env.ZESTFUL_RAPID_KEY && env.ZESTFUL_RAPID_HOST) {\n          parsed = await callZestful(env, lines);\n        }\n\n        return json({\n          ok: !!parsed,\n          dish,\n          lines_in: lines.length,\n          parsed_count: Array.isArray(parsed) ? parsed.length : 0,\n          sample: Array.isArray(parsed) ? parsed.slice(0, 3) : null\n        });\n      } catch (e) {\n        return json({ ok: false, dish, error: String(e?.message || e) });\n      }\n    }\n\n    // --- DEBUG: raw Zestful (RapidAPI) call with status + body preview ---\n    if (pathname === \"/debug/zestful-raw\") {\n      const dish = url.searchParams.get(\"dish\") || \"Chicken Alfredo\";\n      const host = (env.ZESTFUL_RAPID_HOST || \"zestful.p.rapidapi.com\").trim();\n\n      try {\n        const sp = await spoonacularFetch(env, dish, null, \"en\");\n        const lines = Array.isArray(sp?.ingredients)\n          ? sp.ingredients.slice(0, 10)\n          : [];\n        if (!lines.length)\n          return json({ ok: false, note: \"no lines from provider\", host });\n\n        const res = await fetch(`https://${host}/parseIngredients`, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"X-RapidAPI-Key\": env.ZESTFUL_RAPID_KEY,\n            \"X-RapidAPI-Host\": host\n          },\n          body: JSON.stringify({ ingredients: lines })\n        });\n\n        const text = await res.text();\n        let parsed = null;\n        try {\n          parsed = JSON.parse(text);\n        } catch {}\n\n        return json({\n          ok: res.ok,\n          status: res.status,\n          host,\n          lines_in: lines.length,\n          body_preview: text.slice(0, 240),\n          results_len: Array.isArray(parsed?.results)\n            ? parsed.results.length\n            : null,\n          first_result: Array.isArray(parsed?.results)\n            ? parsed.results[0]\n            : null\n        });\n      } catch (e) {\n        return json({ ok: false, error: String(e?.message || e) });\n      }\n    }\n\n    if (pathname === \"/restaurants/search\" && request.method === \"GET\") {\n      let ctxTB = makeCtx(env);\n      const rid = newRequestId();\n      let trace = {};\n\n      try {\n        const query = searchParams.get(\"query\") || searchParams.get(\"q\") || \"\";\n        const addressRaw = searchParams.get(\"address\") || \"\";\n        const page = Number(searchParams.get(\"page\") || 1);\n        const maxRows = parseInt(searchParams.get(\"maxRows\") || \"15\", 10);\n\n        const lat = searchParams.get(\"lat\");\n        const lng = searchParams.get(\"lng\");\n        const radius = parseInt(searchParams.get(\"radius\") || \"5000\", 10);\n\n        const latNum = lat !== null ? parseFloat(lat) : null;\n        const lngNum = lng !== null ? parseFloat(lng) : null;\n\n        if (!query) {\n          return jsonResponseWithTB(\n            withBodyAnalytics(\n              { ok: false, error: \"missing_query_param\" },\n              ctxTB,\n              rid,\n              { endpoint: \"restaurants-search\" },\n              trace\n            ),\n            400,\n            {},\n            CORS_ALL\n          );\n        }\n\n        // Prefer address job if provided; otherwise try location; otherwise 400\n        let finished = null;\n        let usedHost =\n          env.UBER_RAPID_HOST || \"uber-eats-scraper-api.p.rapidapi.com\";\n\n        if (addressRaw) {\n          const job = await postJobByAddress(\n            {\n              query,\n              address: addressRaw,\n              maxRows,\n              locale: searchParams.get(\"locale\") || \"en-US\",\n              page\n            },\n            env\n          );\n          if (!job) {\n            return notFoundCandidates(ctxTB, rid, trace, {\n              query,\n              address: addressRaw\n            });\n          }\n          // Wait for completion if needed\n          finished = job?.immediate\n            ? job\n            : await waitForJob(env, job, { attempts: 6 });\n        } else if (latNum != null && lngNum != null) {\n          // Location job path first\n          try {\n            const job = await postJobByLocation(\n              { query, lat: latNum, lng: lngNum, radius, maxRows },\n              env\n            );\n            finished = job?.immediate\n              ? job\n              : await waitForJob(env, job, { attempts: 6 });\n          } catch (e) {\n            // Fallback to direct nearby search if job approach fails\n            const nearby = await searchNearbyCandidates(\n              { query, lat: latNum, lng: lngNum, radius, maxRows },\n              env\n            );\n            if (nearby?.ok && Array.isArray(nearby?.rows)) {\n              return jsonResponseWithTB(\n                withBodyAnalytics(\n                  {\n                    ok: true,\n                    source: \"nearby-fallback\",\n                    count: nearby.rows.length,\n                    restaurants: nearby.rows.map((r) => ({\n                      id: r.id || r.slug || r.url || null,\n                      title:\n                        r.title ||\n                        r.name ||\n                        r.displayName ||\n                        r.storeName ||\n                        r.restaurantName ||\n                        null,\n                      raw: r.raw || r\n                    }))\n                  },\n                  ctxTB,\n                  rid,\n                  { endpoint: \"restaurants-search\" },\n                  trace\n                ),\n                200,\n                {},\n                CORS_ALL\n              );\n            }\n            throw e;\n          }\n        } else {\n          return jsonResponseWithTB(\n            withBodyAnalytics(\n              { ok: false, error: \"missing_address_or_latlng\" },\n              ctxTB,\n              rid,\n              { endpoint: \"restaurants-search\" },\n              trace\n            ),\n            400,\n            {},\n            CORS_ALL\n          );\n        }\n\n        // Collect candidates from the finished job\n        const buckets = [\n          finished?.data?.stores,\n          finished?.data?.restaurants,\n          finished?.stores,\n          finished?.restaurants,\n          finished?.data\n        ].filter(Boolean);\n\n        const candidates = [];\n        for (const b of buckets) if (Array.isArray(b)) candidates.push(...b);\n\n        const restaurants = candidates\n          .map((it) => ({\n            id:\n              it?.id ||\n              it?.storeUuid ||\n              it?.storeId ||\n              it?.restaurantId ||\n              it?.slug ||\n              it?.url ||\n              null,\n            title:\n              it?.title ||\n              it?.name ||\n              it?.displayName ||\n              it?.storeName ||\n              it?.restaurantName ||\n              null,\n            raw: it\n          }))\n          .filter((x) => x.title);\n\n        return jsonResponseWithTB(\n          withBodyAnalytics(\n            {\n              ok: true,\n              source: addressRaw ? \"address-job\" : \"location-job\",\n              count: restaurants.length,\n              restaurants\n            },\n            ctxTB,\n            rid,\n            { endpoint: \"restaurants-search\", host: usedHost },\n            trace\n          ),\n          200,\n          {},\n          CORS_ALL\n        );\n      } catch (err) {\n        return errorResponseWith(\n          { ok: false, error: String(err?.message || err) },\n          ctxTB,\n          rid,\n          500,\n          { endpoint: \"restaurants-search\" },\n          trace\n        );\n      }\n    }\n\n    // /restaurants/find \u2192 forward to tb-restaurant-core\n    if (pathname === \"/restaurants/find\") {\n      const id = cid(request.headers);\n      const init = {\n        method: request.method,\n        headers: new Headers(request.headers)\n      };\n      init.headers.set(\"x-correlation-id\", id);\n\n      const res = await env.restaurant_core.fetch(\n        new Request(request.url, init)\n      );\n\n      const out = new Headers(res.headers);\n      out.set(\"x-correlation-id\", id);\n      out.set(\"x-tb-worker\", env.WORKER_NAME || \"tb-dish-processor-production\");\n      out.set(\"x-tb-env\", env.ENV || \"production\");\n      out.set(\"x-tb-git\", env.GIT_SHA || \"n/a\");\n      out.set(\"x-tb-built\", env.BUILT_AT || \"n/a\");\n\n      return new Response(res.body, { status: res.status, headers: out });\n    }\n    // /ingredients/normalize \u2192 tb-recipe-core\n    if (pathname === \"/ingredients/normalize\" && request.method === \"POST\") {\n      const id = ((h) => h.get(\"x-correlation-id\") || crypto.randomUUID())(\n        request.headers\n      );\n      const init = {\n        method: \"POST\",\n        headers: new Headers(request.headers),\n        body: await request.text()\n      };\n      init.headers.set(\"x-correlation-id\", id);\n      const res = await env.recipe_core.fetch(new Request(request.url, init));\n      const out = new Headers(res.headers);\n      out.set(\"x-correlation-id\", id);\n      out.set(\"x-tb-worker\", env.WORKER_NAME || \"tb-dish-processor-production\");\n      out.set(\"x-tb-env\", env.ENV || \"production\");\n      out.set(\"x-tb-git\", env.GIT_SHA || \"n/a\");\n      out.set(\"x-tb-built\", env.BUILT_AT || \"n/a\");\n      return new Response(res.body, { status: res.status, headers: out });\n    }\n    // /recipe/resolve \u2192 tb-recipe-core\n    if (pathname === \"/recipe/resolve\" && request.method === \"POST\") {\n      const id = ((h) => h.get(\"x-correlation-id\") || crypto.randomUUID())(\n        request.headers\n      );\n      const init = {\n        method: \"POST\",\n        headers: new Headers(request.headers),\n        body: await request.text()\n      };\n      init.headers.set(\"x-correlation-id\", id);\n      const res = await env.recipe_core.fetch(new Request(request.url, init));\n      const out = new Headers(res.headers);\n      out.set(\"x-correlation-id\", id);\n      out.set(\"x-tb-worker\", env.WORKER_NAME || \"tb-dish-processor-production\");\n      out.set(\"x-tb-env\", env.ENV || \"production\");\n      out.set(\"x-tb-git\", env.GIT_SHA || \"n/a\");\n      out.set(\"x-tb-built\", env.BUILT_AT || \"n/a\");\n      return new Response(res.body, { status: res.status, headers: out });\n    }\n    if (pathname === \"/debug/zestful-usage\") {\n      const today = new Date().toISOString().slice(0, 10);\n      const key = `zestful:count:${today}`;\n      let raw = null;\n      if (env.MENUS_CACHE) {\n        try {\n          raw = await env.MENUS_CACHE.get(key);\n        } catch {}\n      }\n      const count = raw ? parseInt(raw, 10) : 0;\n      const cap = parseInt(env.ZESTFUL_DAILY_CAP || \"0\", 10);\n      return json({ date: today, count, cap });\n    }\n\n    if (pathname === \"/organs/assess\" && request.method === \"POST\") {\n      const id = _cid(request.headers);\n      const init = {\n        method: \"POST\",\n        headers: new Headers(request.headers),\n        body: await request.text()\n      };\n      init.headers.set(\"x-correlation-id\", id);\n      const res = await env.allergen_organs.fetch(\n        new Request(request.url, init)\n      );\n      const out = new Headers(res.headers);\n      out.set(\"x-correlation-id\", id);\n      out.set(\"x-tb-worker\", env.WORKER_NAME || \"tb-dish-processor-production\");\n      out.set(\"x-tb-env\", env.ENV || \"production\");\n      out.set(\"x-tb-git\", env.GIT_SHA || \"n/a\");\n      out.set(\"x-tb-built\", env.BUILT_AT || \"n/a\");\n      return new Response(res.body, { status: res.status, headers: out });\n    }\n\n    if (pathname === \"/user/prefs\") {\n      if (!env.USER_PREFS_KV) {\n        return json(\n          { ok: false, error: \"USER_PREFS_KV not bound\" },\n          { status: 500 }\n        );\n      }\n\n      if (request.method === \"GET\") {\n        const user_id = url.searchParams.get(\"user_id\") || \"anon\";\n        const key = `prefs:user:${user_id}`;\n        const raw = await env.USER_PREFS_KV.get(key, \"json\");\n        const defaults = {\n          allergens: {\n            dairy: true,\n            gluten: true,\n            soy: false,\n            shellfish: false,\n            garlic_onion: true\n          },\n          fodmap: { strict: false },\n          units: \"us\"\n        };\n        return json({\n          ok: true,\n          user_id,\n          prefs: { ...defaults, ...(raw || {}) }\n        });\n      }\n\n      if (request.method === \"POST\") {\n        const user_id = url.searchParams.get(\"user_id\") || \"anon\";\n        const body = (await request.json().catch(() => ({}))) || {};\n        const key = `prefs:user:${user_id}`;\n        const existing = (await env.USER_PREFS_KV.get(key, \"json\")) || {};\n        const merged = { ...existing, ...body };\n        await env.USER_PREFS_KV.put(key, JSON.stringify(merged));\n        return json({ ok: true, user_id, saved: merged });\n      }\n\n      return new Response(null, {\n        status: 405,\n        headers: { Allow: \"GET, POST\" }\n      });\n    }\n    if (pathname === \"/debug/providers\") {\n      return new Response(\n        JSON.stringify(\n          {\n            providers_order: providerOrder(env),\n            has: {\n              EDAMAM_APP_ID: !!env.EDAMAM_APP_ID,\n              EDAMAM_APP_KEY: !!env.EDAMAM_APP_KEY,\n              SPOONACULAR_KEY: !!env.SPOONACULAR_KEY,\n              OPENAI_API_KEY: !!env.OPENAI_API_KEY\n            }\n          },\n          null,\n          2\n        ),\n        { headers: { \"content-type\": \"application/json; charset=utf-8\" } }\n      );\n    }\n\n    // === Step 20B: future upgrade ===\n    // TODO: read recent R2 analysis files (e.g., results/*.json),\n    // aggregate organ_summary across all recent dishes,\n    // compute average plus/minus counts, derive sentiment, and build items[] dynamically.\n\n    // Welcome / help text\n    return new Response(\n      \"HELLO \u2014 tb-dish-processor is running.\\n\" +\n        \"Try: GET /health, /debug/config, /debug/ping-lexicon, /debug/read-kv-shard?name=..., /debug/warm-lexicon?names=...,\\n\" +\n        \"/debug/refresh-ingredient-shards, /debug/read-index, /debug/job?id=..., /results/<id>.json, /menu/uber-test;\\n\" +\n        \"POST /enqueue\",\n      { status: 200, headers: { \"content-type\": \"text/plain\" } }\n    );\n  }\n};\n\n// ========== Helper utilities ==========\nconst lc = (s) => (s ?? \"\").toLowerCase().normalize(\"NFKC\").trim();\n\n// [39.2] \u2014 mark first-seen boot time in KV (best-effort)\nasync function ensureBootTime(env) {\n  if (!env?.LEXICON_CACHE) return null;\n  try {\n    const key = \"meta/boot_at\";\n    let boot = await env.LEXICON_CACHE.get(key);\n    if (!boot) {\n      boot = new Date().toISOString();\n      await env.LEXICON_CACHE.put(key, boot, { expirationTtl: 30 * 24 * 3600 });\n    }\n    return boot;\n  } catch {\n    return null;\n  }\n}\n\nfunction parseJsonSafe(raw, fallback) {\n  try {\n    if (!raw) return fallback;\n    return JSON.parse(raw);\n  } catch {\n    return fallback;\n  }\n}\nfunction clamp(n, min, max) {\n  return Math.max(min, Math.min(max, n));\n}\n\nfunction canonicalizeIngredientName(name = \"\") {\n  const s = String(name ?? \"\")\n    .toLowerCase()\n    .trim();\n  if (s.includes(\"skim milk\") || s.endsWith(\" milk\") || s === \"milk\")\n    return \"milk\";\n  if (s.includes(\"parmesan\")) return \"parmesan cheese\";\n  if (s.includes(\"garlic\")) return \"garlic\";\n  if (s.includes(\"onion\")) return \"onion\";\n  if (s.includes(\"butter\")) return \"butter\";\n  if (\n    s.includes(\"heavy cream\") ||\n    s.includes(\"whipping cream\") ||\n    s.includes(\"cream\")\n  )\n    return \"cream\";\n  if (s.includes(\"salt\")) return \"salt\";\n  if (s.includes(\"tomato\")) return \"tomato\";\n  if (s.includes(\"flour\") || s.includes(\"wheat\") || s.includes(\"pasta\"))\n    return \"flour\";\n  return s;\n}\n\n// ==== Global limits & TTLs (safe defaults) ====\nconst MENU_TTL_SECONDS = 18 * 3600; // 18 hours cache TTL for menu snapshots\nconst LIMITS = {\n  DEFAULT_TOP: 10,\n  TOP_MIN: 1,\n  TOP_MAX: 25\n};\n\n// [38.8] \u2014 snapshot of effective limits (for QA)\nfunction limitsSnapshot({ maxRows, radius }) {\n  const reqMax = Number.isFinite(Number(maxRows)) ? Number(maxRows) : null;\n  const reqRad = Number.isFinite(Number(radius)) ? Number(radius) : null;\n\n  const effectiveMax = Number.isFinite(Number(maxRows)) ? Number(maxRows) : 15;\n  const effectiveRad = Number.isFinite(Number(radius)) ? Number(radius) : 5000;\n\n  return {\n    maxRows: {\n      requested: reqMax,\n      effective: effectiveMax,\n      min: 1,\n      max: 50,\n      default: 15\n    },\n    radius: {\n      requested: reqRad,\n      effective: effectiveRad,\n      min: 500,\n      max: 25000,\n      default: 5000\n    },\n    cache_ttl_seconds: MENU_TTL_SECONDS\n  };\n}\n\nasync function getZestfulCount(env) {\n  const kv = env.MENUS_CACHE || env.LEXICON_CACHE;\n  if (!kv) return 0;\n\n  const today = new Date().toISOString().slice(0, 10);\n  const key = `zestful:count:${today}`;\n\n  try {\n    const raw = await kv.get(key);\n    return parseInt(raw || \"0\", 10) || 0;\n  } catch (err) {\n    console.log(\n      \"[parse] zestful counter read error:\",\n      err?.message || String(err)\n    );\n    return 0;\n  }\n}\n\nasync function incZestfulCount(env, linesCount = 0) {\n  if (!linesCount || linesCount <= 0) return 0;\n\n  const kv = env.MENUS_CACHE || env.LEXICON_CACHE;\n  if (!kv) return 0;\n\n  const today = new Date().toISOString().slice(0, 10);\n  const key = `zestful:count:${today}`;\n  let current = 0;\n\n  try {\n    current = parseInt((await kv.get(key)) || \"0\", 10) || 0;\n  } catch (err) {\n    console.log(\n      \"[parse] zestful counter read error:\",\n      err?.message || String(err)\n    );\n  }\n\n  const next = current + linesCount;\n  try {\n    await kv.put(key, String(next), { expirationTtl: 60 * 60 * 24 * 31 });\n  } catch (err) {\n    console.log(\n      \"[parse] zestful counter put error:\",\n      err?.message || String(err)\n    );\n  }\n\n  return next;\n}\n\nasync function getShardFromKV(env, name) {\n  if (!env?.LEXICON_CACHE) return { ok: false, name, reason: \"KV not bound\" };\n  const key = `shards/${name}.json`;\n  const raw = await env.LEXICON_CACHE.get(key);\n  if (!raw) return { ok: false, name, reason: \"not_in_kv\" };\n  const js = parseJsonSafe(raw, null);\n  if (!js || !Array.isArray(js.entries))\n    return { ok: false, name, reason: \"bad_format\" };\n  return { ok: true, name, version: js.version ?? null, entries: js.entries };\n}\n\n// Gather terms from one entry\nfunction entryTerms(entry) {\n  const out = new Set();\n  const t = lc(entry?.term);\n  if (t && t.length >= 2) out.add(t);\n  if (Array.isArray(entry?.terms))\n    for (const v of entry.terms) {\n      const s = lc(String(v));\n      if (s && s.length >= 2) out.add(s);\n    }\n  if (Array.isArray(entry?.synonyms))\n    for (const v of entry.synonyms) {\n      const s = lc(String(v));\n      if (s && s.length >= 2) out.add(s);\n    }\n  const alias = lc(entry?.alias);\n  if (alias && alias.length >= 2) out.add(alias);\n  return Array.from(out);\n}\n\n// Word-boundary match for a term\nfunction termMatches(corpus, term) {\n  const t = lc(term);\n  if (t.length < 2) return false;\n  const esc = t.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n  const re = new RegExp(`\\\\b${esc}\\\\b`, \"i\");\n  return re.test(corpus);\n}\n\n// === Risk scoring (allergens + FODMAP -> flags + tummy_barometer) ===\nconst RISK = {\n  allergenWeights: {\n    milk: 18,\n    egg: 12,\n    fish: 16,\n    shellfish: 20,\n    tree_nut: 20,\n    peanut: 22,\n    wheat: 15,\n    soy: 12,\n    sesame: 15,\n    mustard: 8,\n    celery: 8,\n    lupin: 10,\n    sulphite: 6,\n    mollusc: 16,\n    gluten: 15\n  },\n  fodmapWeights: { high: 20, medium: 12, low: 3, unknown: 5 },\n  labels: [\n    { max: 39, name: \"Avoid\" },\n    { max: 69, name: \"Caution\" },\n    { max: 100, name: \"Likely OK\" }\n  ],\n  maxRaw: 100\n};\nconst clamp01 = (x) => Math.max(0, Math.min(1, x));\nconst toScore = (raw, maxRaw = RISK.maxRaw) =>\n  Math.round(clamp01(raw / maxRaw) * 100);\nconst labelFor = (score) =>\n  score <= 39 ? \"Avoid\" : score <= 69 ? \"Caution\" : \"Likely OK\";\n\nfunction extractAllergenKeys(hit) {\n  return inferAllergensFromClassesTags(hit).map((x) =>\n    x.trim().toLowerCase().replace(/\\s+/g, \"_\")\n  );\n}\n\nfunction extractFodmapLevel(hit) {\n  return normalizeFodmapValue(hit.fodmap ?? hit.fodmap_level);\n}\nfunction normalizeFodmapValue(v) {\n  let lvl = v;\n  if (v && typeof v === \"object\") lvl = v.level ?? v.fodmap_level ?? v.value;\n  lvl = String(lvl || \"\").toLowerCase();\n  if ([\"very_high\", \"ultra_high\", \"high\"].includes(lvl)) return \"high\";\n  if ([\"medium\", \"moderate\"].includes(lvl)) return \"medium\";\n  if ([\"low\", \"very_low\", \"trace\"].includes(lvl)) return \"low\";\n  return \"unknown\";\n}\nfunction extractLactoseFromLexHits(rawHits) {\n  for (const h of rawHits || []) {\n    const lac = h && h.lactose;\n    if (lac && typeof lac.level === \"string\") {\n      return {\n        level: String(lac.level).toLowerCase(),\n        reason: lac.reason || \"Lactose level from lexicon.\",\n        source: \"lexicon\"\n      };\n    }\n  }\n  return null;\n}\nfunction inferAllergensFromClassesTags(hit) {\n  const out = new Set(\n    Array.isArray(hit.allergens)\n      ? hit.allergens.map((a) => String(a).toLowerCase())\n      : []\n  );\n  const classes = Array.isArray(hit.classes)\n    ? hit.classes.map((x) => String(x).toLowerCase())\n    : [];\n  const tags = Array.isArray(hit.tags)\n    ? hit.tags.map((x) => String(x).toLowerCase())\n    : [];\n  const canon = String(hit.canonical || \"\").toLowerCase();\n  if (\n    classes.includes(\"dairy\") ||\n    tags.includes(\"dairy\") ||\n    tags.includes(\"milk\") ||\n    /milk|cheese|butter|cream|parmesan|mozzarella|yogurt|yoghurt/.test(canon)\n  )\n    out.add(\"milk\");\n  if (classes.includes(\"gluten\") || tags.includes(\"gluten\")) out.add(\"gluten\");\n  if (\n    tags.includes(\"wheat\") ||\n    /wheat|semolina|breadcrumbs|pasta|flour/.test(canon)\n  )\n    out.add(\"wheat\");\n  if (classes.includes(\"shellfish\") || tags.includes(\"shellfish\"))\n    out.add(\"shellfish\");\n  if (classes.includes(\"fish\") || tags.includes(\"fish\")) out.add(\"fish\");\n  if (classes.includes(\"soy\") || tags.includes(\"soy\")) out.add(\"soy\");\n  if (classes.includes(\"egg\") || tags.includes(\"egg\")) out.add(\"egg\");\n  if (classes.includes(\"sesame\") || tags.includes(\"sesame\")) out.add(\"sesame\");\n  return Array.from(out);\n}\n\nfunction extractLactoseFromHits(hits) {\n  if (!Array.isArray(hits) || !hits.length) return null;\n\n  const rank = { high: 3, moderate: 2, medium: 2, low: 1, none: 0, unknown: 0 };\n  let bestLevel = null;\n  const examples = new Set();\n\n  for (const h of hits) {\n    const fod = h.fodmap || {};\n    const bandRaw = h.lactose_band || (fod && fod.lactose_band) || \"\";\n    const band = String(bandRaw || \"\").toLowerCase();\n    const drivers = Array.isArray(fod.drivers) ? fod.drivers.map(String) : [];\n    const mentionsLactose =\n      drivers.some((d) => d.toLowerCase() === \"lactose\") || !!band;\n\n    if (!mentionsLactose) continue;\n\n    // derive normalized lactose level\n    let lvl = (band || String(fod.level || \"\")).toLowerCase();\n    if (lvl === \"very_high\" || lvl === \"ultra_high\") lvl = \"high\";\n    if (lvl === \"medium\") lvl = \"moderate\";\n    if (!lvl) lvl = \"unknown\";\n\n    if (!bestLevel || rank[lvl] > rank[bestLevel]) bestLevel = lvl;\n\n    const name =\n      h.canonical ||\n      h.term ||\n      (fod && fod.note) ||\n      \"\";\n    if (name) examples.add(name);\n  }\n\n  // If we saw no lactose-related hits at all, return null\n  if (!bestLevel) return null;\n\n  // Even if bestLevel is \"none\", we still want to expose that to the frontend\n  const level = bestLevel;\n\n  let reason;\n  if (level === \"none\") {\n    reason = \"Dairy appears effectively lactose-free or very low in lactose.\";\n  } else if (level === \"low\") {\n    reason = \"Includes low-lactose dairy ingredients.\";\n  } else if (level === \"moderate\") {\n    reason = \"Includes moderate-lactose dairy ingredients.\";\n  } else if (level === \"high\") {\n    reason = \"Includes high-lactose dairy ingredients.\";\n  } else {\n    reason = \"Lactose level inferred from lexicon classification.\";\n  }\n\n  return {\n    level,\n    source: \"lexicon\",\n    reason,\n    examples: Array.from(examples)\n  };\n}\nfunction scoreDishFromHits(hits) {\n  const allergenSet = new Set();\n  const rank = { high: 3, medium: 2, low: 1, unknown: 0 };\n  let worstFodmap = \"unknown\";\n  for (const h of hits || []) {\n    for (const k of extractAllergenKeys(h)) allergenSet.add(k);\n    const f = extractFodmapLevel(h);\n    if (rank[f] > rank[worstFodmap]) worstFodmap = f;\n  }\n  let rawRisk = 0;\n  const reasons = [];\n  for (const k of Array.from(allergenSet).sort()) {\n    let w = RISK.allergenWeights[k] || 0;\n    if (k === \"milk\" && worstFodmap === \"low\") {\n      w = Math.round(w * 0.6);\n      reasons.push({\n        kind: \"allergen\",\n        key: k,\n        weight: w,\n        note: \"trace/low-lactose dairy\"\n      });\n    } else {\n      reasons.push({ kind: \"allergen\", key: k, weight: w });\n    }\n    rawRisk += w;\n  }\n  const fWeight = RISK.fodmapWeights[worstFodmap] || 0;\n  if (fWeight > 0) {\n    reasons.push({ kind: \"fodmap\", level: worstFodmap, weight: fWeight });\n    rawRisk += fWeight;\n  }\n  const score = toScore(rawRisk);\n  const label = labelFor(score);\n  return {\n    flags: { allergens: Array.from(allergenSet).sort(), fodmap: worstFodmap },\n    tummy_barometer: { score, label, reasons },\n    _debug: { rawRisk, worstFodmap }\n  };\n}\n\n// Human-friendly sentences\nfunction buildHumanSentences(flags, tummy_barometer) {\n  const out = [];\n  if (Array.isArray(flags?.allergens) && flags.allergens.length) {\n    const list = flags.allergens.slice(0, 4).join(\", \");\n    out.push(`Allergen risk: ${list}.`);\n  }\n  const f = String(flags?.fodmap || \"unknown\").toLowerCase();\n  if (f === \"high\")\n    out.push(\n      \"FODMAP level appears high; sensitive users should avoid or confirm.\"\n    );\n  else if (f === \"medium\")\n    out.push(\"FODMAP level appears medium; portion size may matter.\");\n  else if (f === \"low\")\n    out.push(\"FODMAP level appears low; small portions are often tolerated.\");\n  else out.push(\"FODMAP level is unclear from ingredients.\");\n\n  if (flags?.onion || flags?.garlic) {\n    const parts = [];\n    if (flags.onion) parts.push(\"onion\");\n    if (flags.garlic) parts.push(\"garlic\");\n    out.push(`Contains allium indicators (${parts.join(\" & \")}).`);\n  }\n  if (flags?.gluten_hint)\n    out.push(\n      \"Gluten indicators present (e.g., pasta/wheat/flour). Ask for gluten-free options if needed.\"\n    );\n\n  const reasons = Array.isArray(tummy_barometer?.reasons)\n    ? tummy_barometer.reasons\n    : [];\n  const notes = [];\n  for (const r of reasons) {\n    if (r.kind === \"allergen\" && r.key)\n      notes.push(`allergen: ${r.key}${r.note ? ` (${r.note})` : \"\"}`);\n    else if (r.kind === \"fodmap\" && r.level) notes.push(`FODMAP: ${r.level}`);\n  }\n  if (notes.length) out.push(`Why: ${notes.join(\"; \")}.`);\n  if (typeof tummy_barometer?.score === \"number\" && tummy_barometer?.label) {\n    out.push(\n      `Overall: ${tummy_barometer.label} (score ${tummy_barometer.score}).`\n    );\n  }\n\n  const MAX = 120;\n  const trimmed = out.map((s) => {\n    if (s.length <= MAX) return s;\n    const core = s.slice(0, MAX - 1).replace(/\\s+$/, \"\");\n    return core.endsWith(\".\") ? core : core + \"\u2026\";\n  });\n  return trimmed.slice(0, 4);\n}\n\nfunction deriveFlags(hits) {\n  let onion = false,\n    garlic = false,\n    dairy_hint = false,\n    gluten_hint = false;\n  for (const h of hits) {\n    const canon = lc(h.canonical || \"\");\n    const term = lc(h.term || \"\");\n    const classes = Array.isArray(h.classes) ? h.classes.map(lc) : [];\n    const tags = Array.isArray(h.tags) ? h.tags.map(lc) : [];\n    if (\n      canon.includes(\"onion\") ||\n      term.includes(\"onion\") ||\n      classes.includes(\"allium\") ||\n      tags.includes(\"onion\")\n    )\n      onion = true;\n    if (\n      canon.includes(\"garlic\") ||\n      term.includes(\"garlic\") ||\n      classes.includes(\"allium\") ||\n      tags.includes(\"garlic\")\n    )\n      garlic = true;\n    if (\n      classes.includes(\"dairy\") ||\n      tags.includes(\"dairy\") ||\n      tags.includes(\"milk\") ||\n      canon.includes(\"milk\") ||\n      canon.includes(\"cheese\") ||\n      canon.includes(\"butter\") ||\n      canon.includes(\"cream\") ||\n      term.includes(\"milk\") ||\n      term.includes(\"cheese\") ||\n      term.includes(\"butter\") ||\n      term.includes(\"cream\")\n    )\n      dairy_hint = true;\n    if (\n      classes.includes(\"gluten\") ||\n      tags.includes(\"gluten\") ||\n      tags.includes(\"wheat\") ||\n      canon.includes(\"gluten\") ||\n      canon.includes(\"wheat\") ||\n      canon.includes(\"flour\") ||\n      canon.includes(\"pasta\") ||\n      canon.includes(\"breadcrumbs\") ||\n      canon.includes(\"semolina\") ||\n      term.includes(\"wheat\") ||\n      term.includes(\"flour\") ||\n      term.includes(\"pasta\") ||\n      term.includes(\"breadcrumbs\") ||\n      term.includes(\"semolina\")\n    )\n      gluten_hint = true;\n  }\n  return { onion, garlic, dairy_hint, gluten_hint };\n}\n\n// Env int helper\nfunction getEnvInt(env, name, defVal) {\n  const raw = env && env[name] != null ? String(env[name]).trim() : \"\";\n  const n = Number(raw);\n  return Number.isFinite(n) ? n : defVal;\n}\n\nasync function rateLimit(env, request, { limit = 60 } = {}) {\n  const kv = env?.USER_PREFS_KV;\n  if (!kv || !request) return null;\n  try {\n    const ip = request.headers.get(\"cf-connecting-ip\") || \"0.0.0.0\";\n    const now = new Date();\n    const bucket = `${now.getUTCFullYear()}${String(now.getUTCMonth() + 1).padStart(2, \"0\")}${String(now.getUTCDate()).padStart(2, \"0\")}${String(now.getUTCHours()).padStart(2, \"0\")}${String(now.getUTCMinutes()).padStart(2, \"0\")}`;\n    const key = `rl:${ip}:${bucket}`;\n    const currentRaw = await kv.get(key);\n    const current = Number.parseInt(currentRaw || \"0\", 10) || 0;\n    if (current >= limit) {\n      return new Response(\n        JSON.stringify({ ok: false, error: \"rate_limited\", limit }),\n        {\n          status: 429,\n          headers: { \"content-type\": \"application/json; charset=utf-8\" }\n        }\n      );\n    }\n    await kv.put(key, String(current + 1), { expirationTtl: 60 });\n    return null;\n  } catch (err) {\n    console.warn(\"[rateLimit] error\", err?.message || err);\n    return null;\n  }\n}\n\nasync function handleHealthz(env) {\n  let d1 = \"ok\";\n  try {\n    if (!env?.D1_DB) throw new Error(\"no D1\");\n    await env.D1_DB.prepare(\"SELECT 1\").first();\n  } catch (err) {\n    if (err) console.warn(\"[healthz] d1 ping failed\", err?.message || err);\n    d1 = \"fail\";\n  }\n\n  const missing = [];\n  for (const name of [\n    \"RAPIDAPI_KEY\",\n    \"LEXICON_API_KEY\",\n    \"OPENAI_API_KEY\",\n    \"SPOONACULAR_KEY\",\n    \"EDAMAM_APP_ID\",\n    \"EDAMAM_APP_KEY\"\n  ]) {\n    if (!env?.[name]) missing.push(name);\n  }\n\n  return okJson({\n    ok: true,\n    d1,\n    secrets_missing: missing,\n    ts: Math.floor(Date.now() / 1000)\n  });\n}\n\n// --- Metrics helpers (D1) -------------------------------------------------\nconst METRICS_TABLE_SQL = `CREATE TABLE IF NOT EXISTS metrics (\n  ts INTEGER DEFAULT (strftime('%s','now')),\n  name TEXT,\n  value INTEGER\n)`;\n\nasync function ensureMetricsTable(env) {\n  if (!env?.D1_DB) return false;\n  if (ensureMetricsTable._ready) return true;\n  try {\n    await env.D1_DB.prepare(METRICS_TABLE_SQL).run();\n    ensureMetricsTable._ready = true;\n    return true;\n  } catch (err) {\n    console.warn(\"[metrics] ensure table failed\", err?.message || err);\n    return false;\n  }\n}\nensureMetricsTable._ready = false;\n\nasync function recordMetric(env, name, delta = 1) {\n  if (!env?.D1_DB || !name) return;\n  const ready = await ensureMetricsTable(env);\n  if (!ready) return;\n  try {\n    await env.D1_DB.prepare(\"INSERT INTO metrics (name, value) VALUES (?, ?)\")\n      .bind(name, delta)\n      .run();\n  } catch (err) {\n    console.warn(\"[metrics] write failed\", err?.message || err);\n  }\n}\n\n// --- Stats helpers (D1) ---\nfunction dayStrUTC(d = new Date()) {\n  return new Date(d.getTime() - d.getTimezoneOffset() * 60000)\n    .toISOString()\n    .slice(0, 10);\n}\nasync function bumpDaily(\n  env,\n  {\n    jobs = 0,\n    lex_ok = 0,\n    lex_live = 0,\n    lex_err = 0,\n    rap_ok = 0,\n    rap_err = 0\n  } = {}\n) {\n  if (!env.D1_DB) return;\n  const day = dayStrUTC();\n  try {\n    await env.D1_DB.prepare(\n      `\n    INSERT INTO daily_stats(day, jobs, lexicon_ok, lexicon_live, lexicon_err, rapid_ok, rapid_err)\n    VALUES (?, ?, ?, ?, ?, ?, ?)\n    ON CONFLICT(day) DO UPDATE SET\n      jobs = jobs + excluded.jobs,\n      lexicon_ok = lexicon_ok + excluded.lexicon_ok,\n      lexicon_live = lexicon_live + excluded.lexicon_live,\n      lexicon_err = lexicon_err + excluded.lexicon_err,\n      rapid_ok = rapid_ok + excluded.rapid_ok,\n      rapid_err = rapid_err + excluded.rapid_err\n  `\n    )\n      .bind(day, jobs, lex_ok, lex_live, lex_err, rap_ok, rap_err)\n      .run();\n    await recordMetric(env, \"d1:daily_stats:upsert_ok\");\n  } catch (err) {\n    await recordMetric(env, \"d1:daily_stats:upsert_fail\");\n    throw err;\n  }\n}\nasync function bumpApi(env, service, { calls = 0, ok = 0, err = 0 } = {}) {\n  if (!env.D1_DB) return;\n  const day = dayStrUTC();\n  try {\n    await env.D1_DB.prepare(\n      `\n    INSERT INTO api_usage(day, service, calls, ok, err)\n    VALUES (?, ?, ?, ?, ?)\n    ON CONFLICT(day, service) DO UPDATE SET\n      calls = calls + excluded.calls,\n      ok    = ok    + excluded.ok,\n      err   = err   + excluded.err\n  `\n    )\n      .bind(day, service, calls, ok, err)\n      .run();\n    await recordMetric(env, \"d1:api_usage:upsert_ok\");\n  } catch (error) {\n    await recordMetric(env, \"d1:api_usage:upsert_fail\");\n    throw error;\n  }\n}\n\n// [40.4] \u2014 lightweight status counters in KV (best-effort)\nconst STATUS_KV_KEY = \"meta/uber_test_status_v1\";\n\nasync function readStatusKV(env) {\n  if (!env?.LEXICON_CACHE) return null;\n  try {\n    const raw = await env.LEXICON_CACHE.get(STATUS_KV_KEY);\n    return raw ? JSON.parse(raw) : null;\n  } catch {\n    return null;\n  }\n}\n\nasync function bumpStatusKV(env, delta = {}) {\n  if (!env?.LEXICON_CACHE) return;\n  try {\n    const cur = (await readStatusKV(env)) || {\n      updated_at: null,\n      counts: {\n        live: 0,\n        cache: 0,\n        address_immediate: 0,\n        address_job: 0,\n        location_job: 0,\n        gps_search: 0,\n        debug: 0,\n        errors_4xx: 0,\n        errors_5xx: 0,\n        ratelimits_429: 0\n      }\n    };\n    for (const [k, v] of Object.entries(delta)) {\n      if (typeof cur.counts[k] !== \"number\") cur.counts[k] = 0;\n      cur.counts[k] += Number(v) || 0;\n    }\n    cur.updated_at = new Date().toISOString();\n    await env.LEXICON_CACHE.put(STATUS_KV_KEY, JSON.stringify(cur), {\n      expirationTtl: 7 * 24 * 3600\n    });\n  } catch {}\n}\n\n// === Menu cache helpers (KV) ===============================================\n// Key format is stable so identical (query,address,us) requests reuse the same value.\nfunction cacheKeyForMenu(query, address, forceUS = false) {\n  const q = String(query || \"\")\n    .trim()\n    .toLowerCase();\n  const a = String(address || \"\")\n    .trim()\n    .toLowerCase();\n  const u = forceUS ? \"us1\" : \"us0\";\n  return `menu/${encodeURIComponent(q)}|${encodeURIComponent(a)}|${u}.json`;\n}\n\n// Read a cached menu snapshot from KV. Returns { savedAt, data } or null.\nasync function readMenuFromCache(env, key) {\n  if (!env?.LEXICON_CACHE) return null;\n  try {\n    const raw = await env.LEXICON_CACHE.get(key);\n    if (!raw) return null;\n    const js = JSON.parse(raw);\n    // Expect shape: { savedAt: ISO, data: { query, address, forceUS, items: [...] } }\n    if (!js || typeof js !== \"object\" || !js.data) return null;\n    return js;\n  } catch {\n    return null;\n  }\n}\n\n// Write a cached menu snapshot to KV (best-effort).\nasync function writeMenuToCache(env, key, data) {\n  if (!env?.LEXICON_CACHE) return false;\n  try {\n    const body = JSON.stringify({ savedAt: new Date().toISOString(), data });\n    await env.LEXICON_CACHE.put(key, body, { expirationTtl: MENU_TTL_SECONDS });\n    return true;\n  } catch {\n    return false;\n  }\n}\n// ==========================================================================\n\n// ---- Network helpers ----\nfunction cleanHost(h) {\n  const s = (h || \"\").trim();\n  return s.replace(/\\s+/g, \"\");\n}\nfunction normalizeBase(u) {\n  return (u || \"\").trim().replace(/\\/+$/, \"\");\n}\nfunction buildLexiconAnalyzeURL(base) {\n  const b = normalizeBase(base);\n  return `${b}/v1/search`;\n}\nfunction buildLexiconAnalyzeCandidates(base) {\n  const b = normalizeBase(base);\n  if (!b) return [];\n  // Try the usual suspects, in order of likelihood\n  return [\n    `${b}/v1/analyze`,\n    `${b}/analyze`,\n    `${b}/api/analyze`,\n    `${b}/v1/lexicon/analyze`\n  ];\n}\n\nasync function callRapid(env, query, address) {\n  const host = cleanHost(env.RAPIDAPI_HOST);\n  const apiKey = env.RAPIDAPI_KEY || env.RAPID_API_KEY;\n  if (!host || !apiKey) throw new Error(\"RapidAPI bindings missing\");\n  const qs = new URLSearchParams({ query, address }).toString();\n  const url = `https://${host}/v1/search?${qs}`;\n  const r = await fetch(url, {\n    headers: {\n      \"X-RapidAPI-Key\": apiKey,\n      \"X-RapidAPI-Host\": host,\n      Accept: \"application/json\"\n    }\n  });\n  if (!r.ok) throw new Error(`RapidAPI ${r.status}`);\n  return r.json();\n}\n\n// Per-ingredient Lexicon classification (phase 1 visibility)\nasync function classifyIngredientsWithLex(env, ingredientsForLex, lang = \"en\") {\n  const perIngredient = [];\n  const allHits = [];\n\n  for (const raw of ingredientsForLex) {\n    const name = (raw || \"\").trim();\n    if (!name || name.length < 2) continue;\n\n    const res = await callLexicon(env, name, lang);\n    const entry = {\n      ingredient: name,\n      ok: !!(res && res.ok),\n      hits: []\n    };\n\n    let localHits = [];\n    if (res && res.ok && res.data && Array.isArray(res.data.hits)) {\n      localHits = res.data.hits;\n      entry.hits = localHits;\n      allHits.push(...localHits);\n    }\n\n    perIngredient.push(entry);\n  }\n\n  return { perIngredient, allHits };\n}\nasync function callLexicon(env, text, lang = \"en\") {\n  const base = normalizeBase(env.LEXICON_API_URL);\n  const key = env.LEXICON_API_KEY || env.API_KEY;\n  if (!base || !key) {\n    throw new Error(\"LEXICON_API_URL or LEXICON_API_KEY missing\");\n  }\n  if (!text) {\n    return { ok: false, reason: \"missing-text\", data: { hits: [] } };\n  }\n\n  // Try correct lexicon endpoint\n  const url = `${base}/v1/search`;\n\n  const payload = {\n    q: text,\n    shard_ids: null, // let server choose shards\n    include_lists: [\"cheeses\", \"seafood\", \"animals\"] // leverage your lactose + allergen lists\n  };\n\n  const res = await fetch(url, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"x-api-key\": key,\n      \"Accept-Language\": lang\n    },\n    body: JSON.stringify(payload)\n  });\n\n  let js = null;\n  try {\n    js = await res.json();\n  } catch {\n    js = null;\n  }\n\n  if (!res.ok || !js) {\n    return {\n      ok: false,\n      status: res.status,\n      reason: \"lexicon-search-failed\",\n      data: { hits: [] }\n    };\n  }\n\n  // js.matches is your API's shape. Normalize to \"hits\" array the rest of the code expects.\n  const matches = Array.isArray(js.matches) ? js.matches : [];\n\n  const hits = matches.map((m) => {\n    const e = m.entry || {};\n    const mapsTo = Array.isArray(e.maps_to) ? e.maps_to : [];\n    const tags = [];\n    // Use maps_to (milk, shellfish, etc.) and category as tags\n    for (const t of mapsTo) tags.push(String(t).toLowerCase());\n    if (e.category) tags.push(String(e.category).toLowerCase());\n    if (m.source) tags.push(String(m.source).toLowerCase());\n\n    // Classes: derive coarse allergen classes from maps_to\n    const classes = [];\n    if (mapsTo.includes(\"milk\")) classes.push(\"dairy\");\n    if (mapsTo.includes(\"shellfish\")) classes.push(\"shellfish\");\n    if (mapsTo.includes(\"fish\")) classes.push(\"fish\");\n    if (mapsTo.includes(\"wheat\") || mapsTo.includes(\"gluten\")) {\n      classes.push(\"gluten\");\n    }\n\n    return {\n      term: e.term || text,\n      canonical: e.canonical || null,\n      classes,\n      tags,\n      // Lexicon can optionally add \"allergens\" later if you extend schema\n      allergens: Array.isArray(e.allergens) ? e.allergens : undefined,\n      fodmap: e.fodmap ?? e.fodmap_level,\n      lactose_band: e.lactose_band || null,\n      milk_source: e.milk_source || null\n    };\n  });\n\n  return {\n    ok: true,\n    mode: \"v1_search\",\n    data: { hits }\n  };\n}\nasync function lexiconAnalyzeViaShards(env, text, lang = \"en\") {\n  const base = normalizeBase(env.LEXICON_API_URL);\n  const key = env.LEXICON_API_KEY;\n\n  let index = null;\n  for (const url of [`${base}/v1/index`, `${base}/v1/shards`]) {\n    try {\n      const r = await fetch(url, { headers: { \"x-api-key\": key } });\n      if (!r.ok) continue;\n      index = await r.json();\n      break;\n    } catch {}\n  }\n\n  const names = index\n    ? pickIngredientShardNamesFromIndex(index)\n    : STATIC_INGREDIENT_SHARDS;\n\n  const entries = [];\n  for (const name of names) {\n    try {\n      const url = `${base}/v1/shards/${name}`;\n      const r = await fetch(url, { headers: { \"x-api-key\": key } });\n      if (!r.ok) continue;\n      const js = await r.json();\n      if (Array.isArray(js?.entries)) {\n        for (const e of js.entries) entries.push(e);\n      }\n    } catch {}\n  }\n\n  const corpus = lc(text || \"\");\n  const stoplist = new Set([\"and\", \"with\", \"of\", \"in\", \"a\", \"the\", \"or\"]);\n  const ingredient_hits_raw = [];\n  const seenCanon = new Set();\n\n  for (const entry of entries) {\n    const canonical = lc(entry?.canonical ?? entry?.name ?? entry?.term ?? \"\");\n    const classes = Array.isArray(entry?.classes) ? entry.classes.map(lc) : [];\n    const tags = Array.isArray(entry?.tags) ? entry.tags.map(lc) : [];\n    const weight = typeof entry?.weight === \"number\" ? entry.weight : undefined;\n\n    const terms = entryTerms(entry).filter((t) => !stoplist.has(t));\n    let matchedTerm = null;\n    for (const t of terms) {\n      if (t.length < 2) continue;\n      if (termMatches(corpus, t)) {\n        matchedTerm = t;\n        break;\n      }\n    }\n    if (!matchedTerm) continue;\n\n    const canonKey = canonical || matchedTerm;\n    if (seenCanon.has(canonKey)) continue;\n    seenCanon.add(canonKey);\n\n    ingredient_hits_raw.push({\n      term: matchedTerm,\n      canonical: canonical || matchedTerm,\n      classes,\n      tags,\n      weight,\n      allergens: Array.isArray(entry?.allergens) ? entry.allergens : undefined,\n      fodmap: entry?.fodmap ?? entry?.fodmap_level,\n      source: \"lexicon_live_shards\"\n    });\n  }\n\n  const HITS_LIMIT = 25;\n  const hits = tidyIngredientHits(ingredient_hits_raw, HITS_LIMIT).map((h) => ({\n    term: h.term,\n    canonical: h.canonical,\n    classes: h.classes,\n    tags: h.tags,\n    allergens: h.allergens,\n    fodmap: h.fodmap,\n    source: h.source\n  }));\n\n  return {\n    hits,\n    from: \"lexicon_live_shards\",\n    shard_count: names.length,\n    entries_scanned: entries.length\n  };\n}\n\n// ---- Response helpers ----\nfunction jsonResponse(data, status = 200) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: { \"content-type\": \"application/json\" }\n  });\n}\n// [37C] \u2500\u2500 Same as jsonResponse, but lets us add extra headers\nfunction jsonResponseWith(data, status = 200, extraHeaders = {}) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: { \"content-type\": \"application/json\", ...extraHeaders }\n  });\n}\n// [38.12] \u2014 JSON response with TummyBuddy analytics headers (+ trace mirrors)\nfunction jsonResponseWithTB(\n  bodyObj,\n  status = 200,\n  { ctx, rid, source = \"\", cache = \"\", warning = false } = {},\n  extraHeaders = {}\n) {\n  const version = ctx?.version || \"unknown\";\n  const served_at = ctx?.served_at || new Date().toISOString();\n  const requestId =\n    rid ||\n    (crypto?.randomUUID && crypto.randomUUID()) ||\n    `${Date.now()}-${Math.random().toString(36).slice(2)}`;\n\n  const traceHost = bodyObj?.trace?.host || \"\";\n  const traceUsed = bodyObj?.trace?.used_path || \"\";\n\n  const base = {\n    \"content-type\": \"application/json\",\n    \"X-TB-Version\": String(version),\n    \"X-TB-Served-At\": String(served_at),\n    \"X-TB-Request-Id\": String(requestId),\n    \"X-TB-Source\": String(source || \"\"),\n    \"X-TB-Cache\": String(cache || \"\"),\n    ...(traceHost ? { \"X-TB-Trace-Host\": String(traceHost) } : {}),\n    ...(traceUsed ? { \"X-TB-Trace-Used-Path\": String(traceUsed) } : {})\n  };\n  if (warning) base[\"X-TB-Warning\"] = \"1\";\n\n  return new Response(JSON.stringify(bodyObj), {\n    status,\n    headers: { ...base, ...extraHeaders }\n  });\n}\n// [38.1] \u2014 attach analytics fields to any JSON body (success paths only)\nfunction withBodyAnalytics(body, ctx, request_id, trace = {}) {\n  return {\n    ...body,\n    served_at: ctx?.served_at || new Date().toISOString(),\n    version: ctx?.version || \"unknown\",\n    request_id:\n      request_id ||\n      (crypto?.randomUUID && crypto.randomUUID()) ||\n      `${Date.now()}-${Math.random().toString(36).slice(2)}`,\n    trace\n  };\n}\n// [37C] \u2500\u2500 Error response with analytics headers\n// [37C] \u2500\u2500 Error response with analytics headers (accepts ctx OR env)\nfunction errorResponseWith(\n  errBody,\n  status = 400,\n  envOrCtx,\n  meta = {},\n  request_id = null\n) {\n  const hasCtx =\n    envOrCtx &&\n    typeof envOrCtx === \"object\" &&\n    \"served_at\" in envOrCtx &&\n    \"version\" in envOrCtx;\n  const served_at = hasCtx ? envOrCtx.served_at : new Date().toISOString();\n  const version = hasCtx ? envOrCtx.version : getVersion(envOrCtx);\n\n  const rid =\n    request_id ||\n    (typeof crypto?.randomUUID === \"function\"\n      ? crypto.randomUUID()\n      : `${Date.now()}-${Math.random().toString(36).slice(2)}`);\n\n  const body = {\n    ...errBody,\n    served_at,\n    version,\n    request_id: rid,\n    ...(meta?.trace ? { trace: meta.trace } : {})\n  };\n\n  return new Response(JSON.stringify(body), {\n    status,\n    headers: {\n      \"content-type\": \"application/json\",\n      \"X-TB-Version\": String(version),\n      \"X-TB-Served-At\": String(served_at),\n      \"X-TB-Error\": \"1\",\n      \"X-TB-Request-Id\": String(rid),\n      ...(meta || {})\n    }\n  });\n}\n// [40.1] \u2014 friendly 429 response with Retry-After header\nfunction rateLimitResponse(\n  ctxOrEnv,\n  rid,\n  trace,\n  secs = 30,\n  source = \"upstream-failure\"\n) {\n  const safeSecs = Math.max(1, Number(secs) || 30);\n  return errorResponseWith(\n    {\n      ok: false,\n      error: \"Our menu provider is rate-limiting right now.\",\n      hint: `Please retry in ~${safeSecs} seconds.`,\n      retry_after_seconds: safeSecs\n    },\n    429,\n    ctxOrEnv,\n    {\n      \"X-TB-Source\": source,\n      \"X-TB-Upstream-Status\": \"429\",\n      \"Retry-After\": String(safeSecs),\n      trace: safeTrace(trace)\n    },\n    rid\n  );\n}\n// [38.4] \u2014 Friendly \"no candidates\" 404 with analytics + examples\nfunction notFoundCandidates(ctxOrEnv, rid, trace, { query, address }) {\n  const examples = [\n    \"/menu/uber-test?query=McDonald%27s&address=Miami,%20FL\",\n    \"/menu/uber-test?query=Starbucks&address=Seattle,%20WA\",\n    \"/menu/uber-test?query=Chipotle&address=Austin,%20TX\"\n  ];\n  return errorResponseWith(\n    {\n      ok: false,\n      error: \"No candidates found near that address.\",\n      hint: \"Try a nearby city, add ZIP, or pick a more exact restaurant name.\",\n      echo: { query, address },\n      examples\n    },\n    404,\n    ctxOrEnv,\n    { \"X-TB-Source\": \"no-candidates\", trace: safeTrace(trace) },\n    rid\n  );\n}\nfunction corsJson(data, status = 200) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: {\n      \"content-type\": \"application/json\",\n      ...CORS_ALL\n    }\n  });\n}\n\n// ---- Handler wrappers (clarity) ----\nfunction handleFetch(request, env, ctx) {\n  return _worker_impl.fetch(request, env, ctx);\n}\nfunction handleQueue(batch, env, ctx) {\n  return _worker_impl.queue ? _worker_impl.queue(batch, env, ctx) : undefined;\n}\nfunction handleScheduled(controller, env, ctx) {\n  return _worker_impl.scheduled\n    ? _worker_impl.scheduled(controller, env, ctx)\n    : undefined;\n}\nfunction normPathname(u) {\n  let p = u.pathname || \"/\";\n  if (p.length > 1 && p.endsWith(\"/\")) p = p.slice(0, -1);\n  return p;\n}\n\nexport default {\n  async fetch(request, env, ctx) {\n    const response = await handleFetch(request, env, ctx);\n    return withTbWhoamiHeaders(response, env);\n  },\n  async queue(batch, env, ctx) {\n    return handleQueue(batch, env, ctx);\n  },\n  async scheduled(controller, env, ctx) {\n    return handleScheduled(controller, env, ctx);\n  }\n};\n"],
  "mappings": "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",
  "names": ["json", "normalizeLLMItems", "dedupeItemsByTitleSection", "callGrokExtract", "callOpenAIExtract", "perServing", "per100g", "env", "ingLines", "cached", "postJobByLocation", "organ_levels", "dishName", "ctx", "url", "flattenedItems", "enqueued", "rows", "rowsUS", "best", "chosen", "fake", "analyze", "cid"]
}
