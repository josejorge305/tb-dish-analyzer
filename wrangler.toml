# ================== BASE (dev/default) ==================
name = "tb-dish-processor"
main = "index.js"
account_id = "68cbbc868956bf7166613432aee13dec"
compatibility_date = "2023-12-01"
compatibility_flags = ["nodejs_compat"]

[ai]
binding = "AI"

[durable_objects]
bindings = []

[[services]]
binding = "metrics_core"
service = "tb-metrics-core"

[vars]
# Base URL for our FatSecret proxy running on Render.
# The proxy will handle OAuth2 token + calls to foods.search / food.get.v5
# and expose a simple JSON API for allergens/lactose per ingredient.
FATSECRET_PROXY_URL = "https://tummy-lexicon-api.onrender.com"
PROXY_API_KEY = "supersecret123"
OPENAI_MODEL_ALLERGEN = "gpt-4.1-mini"


# --- D1 (default env) ---
[[d1_databases]]
binding = "D1_DB"
database_name = "tb-database"
database_id = "055f6987-4353-4752-a4c5-24525e2f5cbb"

[[kv_namespaces]]
binding = "MENUS_CACHE"
id = "f363caa0518e46daa062f511c9d50c75"

[[kv_namespaces]]
binding = "USER_PREFS_KV"
id = "cff5be596e5048059c4b60fe78c49578"
preview_id = "000694bd5dfb422180cb026d4de957dd"

[[kv_namespaces]]
binding = "MENU_CLASSIFIER_CACHE"
id = "923f217b4b474a6b82b4b1063da97ea5"

# --- R2 (default env) ---
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "tb-analysis-cache"

# --- QUEUE PRODUCER (default env) ---
[[queues.producers]]
binding = "ANALYSIS_QUEUE"
queue = "tb-dish-analysis-queue"

[[queues.consumers]]
queue = "tb-dish-analysis-queue"
max_batch_size = 1
max_batch_timeout = 30



# ================== PRODUCTION ENV ==================
[env.production]
# existing production bindings stay above this if you have them (KV, D1, etc.)
[env.production.ai]
binding = "AI"

[env.production.durable_objects]
bindings = []

[[env.production.services]]
binding = "metrics_core"
service = "tb-metrics-core"

[env.production.vars]
ENV = "production"
WORKER_NAME = "tb-dish-processor-production"
GIT_SHA = "manual"
BUILT_AT = "2025-11-11T00:00:00Z"
# === Tuning / feature flags ===
FALLBACK_TRIGGER_UNDER = "50"
HITS_LIMIT = "25"

# === Providers ===
# Code reads ONLY this var for recipe provider order:
# (edamam, spoonacular, openai) â€” adjust as needed
PROVIDERS = "edamam,spoonacular,openai"

# If you add an ingredient parser tier later (zestful/openai), your code can read another var,
# but today the running code path expects PROVIDERS above. Keeping parse hints for future:
PROVIDERS_PARSE = "zestful,openai"

# === External hosts (for consistency with your current code) ===
UBER_RAPID_HOST = "uber-eats-scraper-api.p.rapidapi.com"
RAPIDAPI_BASE_URL = "https://uber-eats-scraper-api.p.rapidapi.com"
RAPIDAPI_HOST    = "uber-eats-scraper-api.p.rapidapi.com"
ZESTFUL_RAPID_HOST = "zestful.p.rapidapi.com"
ZESTFUL_DAILY_CAP  = "5500"
USDA_FDC_HOST      = "api.nal.usda.gov"

# === Internal services / URLs ===
FATSECRET_PROXY_URL = "https://tummy-lexicon-api.onrender.com"
PROXY_API_KEY = "supersecret123"
OPENAI_MODEL_ALLERGEN = "gpt-4.1-mini"


# === Secrets to set (do NOT put values here; set via `wrangler secret put ...`) ===
#   wrangler secret put RAPIDAPI_KEY
#   wrangler secret put OPENAI_API_KEY
#   wrangler secret put SPOONACULAR_KEY
#   wrangler secret put ZESTFUL_RAPID_KEY
#   wrangler secret put EDAMAM_APP_ID
#   wrangler secret put EDAMAM_APP_KEY

# --- D1 (production) ---
[[env.production.d1_databases]]
binding = "D1_DB"
database_name = "tb-database"
database_id = "055f6987-4353-4752-a4c5-24525e2f5cbb"

[[env.production.kv_namespaces]]
binding = "MENUS_CACHE"
id = "f363caa0518e46daa062f511c9d50c75"

[[env.production.kv_namespaces]]
binding = "USER_PREFS_KV"
id = "cff5be596e5048059c4b60fe78c49578"

[[env.production.kv_namespaces]]
binding = "MENU_CLASSIFIER_CACHE"
id = "923f217b4b474a6b82b4b1063da97ea5"

# --- R2 (production) ---
[[env.production.r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "tb-analysis-cache"

# --- QUEUE PRODUCER (production) ---
[[env.production.queues.producers]]
binding = "ANALYSIS_QUEUE"
queue = "tb-dish-analysis-queue"


# --- SERVICE BINDING (production) ---
# If you self-call this Worker (fetch to SELF), this binding matches prod name above.
